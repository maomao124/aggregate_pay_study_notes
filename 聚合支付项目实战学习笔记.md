

[TOC]

---





































# 项目概述









# 项目搭建

## 脚手架

https://github.com/maomao124/sms-backend



脚手架项目模块介绍：

```sh
sms-backend                      # 聚合工程，用于聚合parent、apps、tools等模块
  ├── parent				     # 父工程，nacos配置及依赖包管理
  ├── apps					     # 应用目录
  	   ├── auth				     # 权限服务父工程
  		   ├── auth-entity       # 权限实体
  		   ├── auth-server       # 权限服务
  	   ├── gateway			     # 网关服务
  	   ├── sms            	     # 短信平台父工程
  	        ├──sms-entity		 # 短信平台实体
  	        ├──sms-dao           # 短信平台的数据持久化模块，主要包括mybatis plus的mapper文件和mapper接口
  	        ├──sms-manage		 # 系统管理服务
  	        ├──sms-api			 # 短信接收服务，应用系统调用接口、发送短信
  	        ├──sms-server		 # 短信发送服务，调用短信通道、发送短信
  	        └──sms-sdk			 # 短信SDK，应用系统引入、发送短信
  └── tools				         # 工具工程
  	   ├── tools-common		     # 基础组件：基础配置类、函数、常量、统一异常处理、undertow服务器
  	   ├── tools-core		     # 核心组件：基础实体、返回对象、上下文、异常处理、分布式锁、函数、树
  	   ├── tools-databases	     # 数据源组件：数据源配置、数据权限、查询条件等
  	   ├── tools-dozer		     # 对象转换：dozer配置、工具
  	   ├── tools-redis-cache    # redis分布式缓存工具类和分布式锁服务，缓存工具类解决著名的3个缓存问题
  	   ├── tools-j2cache	     # 缓存组件：j2cache、redis缓存
  	   ├── tools-jwt             # JWT组件：配置、属性、工具
  	   ├── tools-log	         # 日志组件：日志实体、事件、拦截器、工具
  	   ├── tools-swagger2	     # 文档组件：knife4j文档
  	   ├── tools-user            # 用户上下文：用户注解、模型和工具，当前登录用户信息注入模块
   	   ├── tools-validator	     # 表单验证： 后台表单规则验证
  	   ├── tools-xss		     # xss防注入组件
```









## 数据库



```sql
# Create Database
# ------------------------------------------------------------
CREATE DATABASE IF NOT EXISTS aggregate_pay_merchant_service DEFAULT CHARACTER SET = utf8mb4;

Use aggregate_pay_merchant_service;


SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for app
-- ----------------------------
DROP TABLE IF EXISTS `app`;
CREATE TABLE `app`
(
    `ID`          bigint(20) NOT NULL,
    `APP_ID`      varchar(50) DEFAULT NULL,
    `APP_NAME`    varchar(50) DEFAULT NULL COMMENT '商店名称',
    `MERCHANT_ID` bigint(20)  DEFAULT NULL COMMENT '所属商户',
    `PUBLIC_KEY`  varchar(50) DEFAULT NULL COMMENT '应用公钥(RSAWithSHA256)',
    `NOTIFY_URL`  varchar(50) DEFAULT NULL COMMENT '授权回调地址',
    PRIMARY KEY (`ID`) USING BTREE,
    UNIQUE KEY `APP_ID` (`APP_ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8
  ROW_FORMAT = DYNAMIC;

-- ----------------------------
-- Table structure for merchant 商户
-- ----------------------------
DROP TABLE IF EXISTS `merchant`;
CREATE TABLE `merchant`
(
    `ID`                    bigint(20) NOT NULL COMMENT '主键',
    `MERCHANT_NAME`         varchar(50)  DEFAULT NULL COMMENT '商户名称',
    `MERCHANT_NO`           varchar(32)  DEFAULT NULL COMMENT '企业编号',
    `MERCHANT_ADDRESS`      varchar(255) DEFAULT NULL COMMENT '企业地址',
    `MERCHANT_TYPE`         varchar(50)  DEFAULT NULL COMMENT '商户类型',
    `BUSINESS_LICENSES_IMG` varchar(100) DEFAULT NULL COMMENT '营业执照（企业证明）',
    `ID_CARD_FRONT_IMG`     varchar(100) DEFAULT NULL COMMENT '法人身份证正面照片',
    `ID_CARD_AFTER_IMG`     varchar(100) DEFAULT NULL COMMENT '法人身份证反面照片',
    `USERNAME`              varchar(50)  DEFAULT NULL COMMENT '联系人姓名',
    `MOBILE`                varchar(50)  DEFAULT NULL COMMENT '联系人手机号(关联统一账号)',
    `CONTACTS_ADDRESS`      varchar(255) DEFAULT NULL COMMENT '联系人地址',
    `AUDIT_STATUS`          varchar(20)  DEFAULT NULL COMMENT '审核状态 0-未申请,1-已申请待审核,2-审核通过,3-审核拒绝',
    `TENANT_ID`             bigint(20)   DEFAULT NULL COMMENT '租户ID,关联统一用户',
    PRIMARY KEY (`ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8
  ROW_FORMAT = DYNAMIC;

-- ----------------------------
-- Table structure for staff  员工
-- ----------------------------
DROP TABLE IF EXISTS `staff`;
CREATE TABLE `staff`
(
    `ID`              bigint(20) NOT NULL COMMENT '主键',
    `MERCHANT_ID`     bigint(20)  DEFAULT NULL COMMENT '商户ID',
    `FULL_NAME`       varchar(50) DEFAULT NULL COMMENT '姓名',
    `POSITION`        varchar(50) DEFAULT NULL COMMENT '职位',
    `USERNAME`        varchar(50) DEFAULT NULL COMMENT '用户名(关联统一用户)',
    `MOBILE`          varchar(50) DEFAULT NULL COMMENT '手机号(关联统一用户)',
    `STORE_ID`        bigint(20)  DEFAULT NULL COMMENT '员工所属门店',
    `LAST_LOGIN_TIME` datetime    DEFAULT NULL COMMENT '最后一次登录时间',
    `STAFF_STATUS`    bit(1)      DEFAULT NULL COMMENT '0表示禁用，1表示启用',
    PRIMARY KEY (`ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8
  ROW_FORMAT = DYNAMIC;

-- ----------------------------
-- Table structure for store 门店
-- ----------------------------
DROP TABLE IF EXISTS `store`;
CREATE TABLE `store`
(
    `ID`            bigint(20) NOT NULL,
    `STORE_NAME`    varchar(50) DEFAULT NULL COMMENT '门店名称',
    `STORE_NUMBER`  bigint(20)  DEFAULT NULL COMMENT '门店编号',
    `MERCHANT_ID`   bigint(20)  DEFAULT NULL COMMENT '所属商户',
    `PARENT_ID`     bigint(20)  DEFAULT NULL COMMENT '父门店',
    `STORE_STATUS`  bit(1)      DEFAULT NULL COMMENT '0表示禁用，1表示启用',
    `STORE_ADDRESS` varchar(50) DEFAULT NULL COMMENT '门店地址',
    PRIMARY KEY (`ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8
  ROW_FORMAT = DYNAMIC;

-- ----------------------------
-- Table structure for store_staff 门店与员工是多对多关系，所以需要中间表
-- ----------------------------
DROP TABLE IF EXISTS `store_staff`;
CREATE TABLE `store_staff`
(
    `ID`       bigint(20) NOT NULL,
    `STORE_ID` bigint(20) DEFAULT NULL COMMENT '门店标识',
    `STAFF_ID` bigint(20) DEFAULT NULL COMMENT '员工标识',
    PRIMARY KEY (`ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8
  ROW_FORMAT = DYNAMIC;

SET FOREIGN_KEY_CHECKS = 1;



# Create Database 交易服务数据库
# ------------------------------------------------------------
CREATE DATABASE IF NOT EXISTS aggregate_pay_transaction DEFAULT CHARACTER SET = utf8mb4;

Use aggregate_pay_transaction;

SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for app_platform_channel
-- ----------------------------
DROP TABLE IF EXISTS `app_platform_channel`;
CREATE TABLE `app_platform_channel`
(
    `ID`               bigint(20) NOT NULL,
    `APP_ID`           varchar(50) DEFAULT NULL COMMENT '应用id',
    `PLATFORM_CHANNEL` varchar(50) DEFAULT NULL COMMENT '平台支付渠道',
    PRIMARY KEY (`ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8
  ROW_FORMAT = DYNAMIC COMMENT ='说明了应用选择了平台中的哪些支付渠道';

-- ----------------------------
-- Table structure for pay_channel 支付渠道
-- ----------------------------
DROP TABLE IF EXISTS `pay_channel`;
CREATE TABLE `pay_channel`
(
    `ID`           bigint(20) NOT NULL,
    `CHANNEL_NAME` varchar(50) DEFAULT NULL COMMENT '原始支付渠道名称',
    `CHANNEL_CODE` varchar(50) DEFAULT NULL COMMENT '原始支付渠道编码',
    PRIMARY KEY (`ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8
  ROW_FORMAT = DYNAMIC;

-- ----------------------------
-- Table structure for pay_channel_param 支付参数
-- ----------------------------
DROP TABLE IF EXISTS `pay_channel_param`;
CREATE TABLE `pay_channel_param`
(
    `ID`                      bigint(20) NOT NULL,
    `CHANNEL_NAME`            varchar(50) DEFAULT NULL COMMENT '配置名称',
    `MERCHANT_ID`             bigint(20)  DEFAULT NULL COMMENT '商户ID',
    `PAY_CHANNEL`             varchar(50) DEFAULT NULL COMMENT '原始支付渠道编码',
    `PARAM`                   text COMMENT '支付参数',
    `APP_PLATFORM_CHANNEL_ID` bigint(20)  DEFAULT NULL COMMENT '应用与支付渠道绑定ID',
    PRIMARY KEY (`ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8
  ROW_FORMAT = DYNAMIC COMMENT ='某商户针对某一种原始支付渠道的配置参数';

-- ----------------------------
-- Table structure for pay_order 订单
-- ----------------------------
DROP TABLE IF EXISTS `pay_order`;
CREATE TABLE `pay_order`
(
    `ID`                     bigint(20)  NOT NULL,
    `TRADE_NO`               varchar(50) NOT NULL COMMENT '聚合支付订单号',
    `MERCHANT_ID`            bigint(20)  NOT NULL COMMENT '所属商户',
    `STORE_ID`               bigint(20)   DEFAULT NULL COMMENT '商户下门店',
    `APP_ID`                 varchar(50) NOT NULL COMMENT '所属应用',
    `PAY_CHANNEL`            varchar(50)  DEFAULT NULL COMMENT '原始支付渠道编码',
    `PAY_CHANNEL_MCH_ID`     varchar(50)  DEFAULT NULL COMMENT '原始渠道商户id',
    `PAY_CHANNEL_MCH_APP_ID` varchar(50)  DEFAULT NULL COMMENT '原始渠道商户应用id',
    `PAY_CHANNEL_TRADE_NO`   varchar(50)  DEFAULT NULL COMMENT '原始渠道订单号',
    `CHANNEL`                varchar(50)  DEFAULT NULL COMMENT '聚合支付的渠道',
    `OUT_TRADE_NO`           varchar(50)  DEFAULT NULL COMMENT '商户订单号',
    `SUBJECT`                varchar(50)  DEFAULT NULL COMMENT '商品标题',
    `BODY`                   varchar(256) DEFAULT NULL COMMENT '订单描述',
    `CURRENCY`               varchar(50)  DEFAULT NULL COMMENT '币种CNY',
    `TOTAL_AMOUNT`           int(11)      DEFAULT NULL COMMENT '订单总金额，单位为分',
    `OPTIONAL`               varchar(256) DEFAULT NULL COMMENT '用户自定义的参数,商户自定义数据',
    `ANALYSIS`               varchar(256) DEFAULT NULL COMMENT '用于统计分析的数据,用户自定义',
    `EXTRA`                  varchar(512) DEFAULT NULL COMMENT '特定渠道发起时额外参数',
    `TRADE_STATE`            varchar(50)  DEFAULT NULL COMMENT '交易状态支付状态,0-订单生成,1-支付中(目前未使用),2-支付成功,3-业务处理完成,4-关闭',
    `ERROR_CODE`             varchar(50)  DEFAULT NULL COMMENT '渠道支付错误码',
    `ERROR_MSG`              varchar(256) DEFAULT NULL COMMENT '渠道支付错误信息',
    `DEVICE`                 varchar(50)  DEFAULT NULL COMMENT '设备',
    `CLIENT_IP`              varchar(50)  DEFAULT NULL COMMENT '客户端IP',
    `CREATE_TIME`            datetime     DEFAULT NULL COMMENT '创建时间',
    `UPDATE_TIME`            datetime     DEFAULT NULL COMMENT '更新时间',
    `EXPIRE_TIME`            datetime     DEFAULT NULL COMMENT '订单过期时间',
    `PAY_SUCCESS_TIME`       datetime     DEFAULT NULL COMMENT '支付成功时间',
    PRIMARY KEY (`ID`) USING BTREE,
    UNIQUE KEY `unique_TRADE_NO` (`TRADE_NO`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8
  ROW_FORMAT = DYNAMIC;

-- ----------------------------
-- Table structure for payment_bill
-- ----------------------------
DROP TABLE IF EXISTS `payment_bill`;
CREATE TABLE `payment_bill`
(
    `id`                bigint(20)     NOT NULL,
    `merchant_id`       bigint(20)     NOT NULL COMMENT '商户id',
    `merchant_name`     varchar(60)    NOT NULL COMMENT '商户名称',
    `merchant_app_id`   bigint(20)     NOT NULL COMMENT '商户应用Id',
    `merchant_order_no` varchar(60)    NOT NULL COMMENT '商户订单号',
    `channel_order_no`  varchar(60)    NOT NULL COMMENT '渠道订单号',
    `product_name`      varchar(255)   NOT NULL COMMENT '商品名称',
    `create_time`       varchar(60)    DEFAULT NULL COMMENT '创建时间',
    `pos_time`          varchar(60)    NOT NULL COMMENT '交易时间',
    `equipment_no`      varchar(60)    DEFAULT NULL COMMENT '终端号',
    `user_account`      varchar(60)    DEFAULT NULL COMMENT '用户账号/标识信息',
    `total_amount`      decimal(10, 2) DEFAULT NULL COMMENT '订单金额',
    `trade_amount`      decimal(10, 2) NOT NULL COMMENT '实际交易金额',
    `discount_amount`   decimal(10, 2) DEFAULT NULL COMMENT '折扣金额',
    `service_fee`       decimal(10, 4) DEFAULT NULL COMMENT '手续费',
    `refund_order_no`   varchar(60)    DEFAULT NULL COMMENT '退款单号',
    `refund_money`      decimal(10, 2) DEFAULT NULL,
    `platform_channel`  varchar(50)    NOT NULL COMMENT '平台支付渠道',
    `remark`            varchar(255)   DEFAULT NULL COMMENT '备注',
    PRIMARY KEY (`id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8;

-- ----------------------------
-- Table structure for platform_channel
-- ----------------------------
DROP TABLE IF EXISTS `platform_channel`;
CREATE TABLE `platform_channel`
(
    `ID`           bigint(20) NOT NULL,
    `CHANNEL_NAME` varchar(50) DEFAULT NULL COMMENT '平台支付渠道名称',
    `CHANNEL_CODE` varchar(50) DEFAULT NULL COMMENT '平台支付渠道编码',
    PRIMARY KEY (`ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8
  ROW_FORMAT = DYNAMIC;

-- ----------------------------
-- Table structure for platform_pay_channel
-- ----------------------------
DROP TABLE IF EXISTS `platform_pay_channel`;
CREATE TABLE `platform_pay_channel`
(
    `ID`               bigint(20) NOT NULL,
    `PLATFORM_CHANNEL` varchar(20) DEFAULT NULL COMMENT '平台支付渠道编码',
    `PAY_CHANNEL`      varchar(20) DEFAULT NULL COMMENT '原始支付渠道名称',
    PRIMARY KEY (`ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8
  ROW_FORMAT = DYNAMIC;

-- ----------------------------
-- Table structure for refund_order
-- ----------------------------
DROP TABLE IF EXISTS `refund_order`;
CREATE TABLE `refund_order`
(
    `ID`                    bigint(20) NOT NULL,
    `REFUND_NO`             varchar(50)  DEFAULT NULL COMMENT '聚合支付退款订单号',
    `TRADE_NO`              varchar(50)  DEFAULT NULL COMMENT '聚合支付订单号',
    `MERCHANT_ID`           bigint(20)   DEFAULT NULL COMMENT '所属商户',
    `APP_ID`                varchar(50)  DEFAULT NULL COMMENT '所属应用',
    `PAY_CHANNEL`           varchar(50)  DEFAULT NULL COMMENT '原始支付渠道编码',
    `PAY_CHANNEL_MCH_ID`    varchar(50)  DEFAULT NULL COMMENT '原始渠道商户id',
    `PAY_CHANNEL_TRADE_NO`  varchar(50)  DEFAULT NULL COMMENT '原始渠道订单号',
    `PAY_CHANNEL_REFUND_NO` varchar(50)  DEFAULT NULL COMMENT '原始渠道退款订单号',
    `CHANNEL`               varchar(50)  DEFAULT NULL COMMENT '聚合支付的渠道',
    `OUT_TRADE_NO`          varchar(50)  DEFAULT NULL COMMENT '商户订单号',
    `OUT_REFUND_NO`         varchar(50)  DEFAULT NULL COMMENT '商户退款订单号',
    `PAY_CHANNEL_USER`      varchar(50)  DEFAULT NULL COMMENT '原始渠道用户标识,如微信openId,支付宝账号',
    `PAY_CHANNEL_USERNAME`  varchar(50)  DEFAULT NULL COMMENT '原始渠道用户姓名',
    `CURRENCY`              varchar(50)  DEFAULT NULL COMMENT '币种CNY',
    `TOTAL_AMOUNT`          int(11)      DEFAULT NULL COMMENT '订单总金额，单位为分',
    `REFUND_AMOUNT`         int(11)      DEFAULT NULL COMMENT '退款金额,单位分',
    `OPTIONAL`              varchar(256) DEFAULT NULL COMMENT '用户自定义的参数,商户自定义数据',
    `ANALYSIS`              varchar(256) DEFAULT NULL COMMENT '用于统计分析的数据,用户自定义',
    `EXTRA`                 varchar(512) DEFAULT NULL COMMENT '特定渠道发起时额外参数',
    `REFUND_STATE`          varchar(50)  DEFAULT NULL COMMENT '退款状态:0-订单生成,1-退款中,2-退款成功,3-退款失败,4-业务处理完成',
    `REFUND_RESULT`         varchar(50)  DEFAULT NULL COMMENT '退款结果:0-不确认结果,1-等待手动处理,2-确认成功,3-确认失败',
    `ERROR_CODE`            varchar(50)  DEFAULT NULL COMMENT '渠道支付错误码',
    `ERROR_MSG`             varchar(256) DEFAULT NULL COMMENT '渠道支付错误信息',
    `DEVICE`                varchar(50)  DEFAULT NULL COMMENT '设备',
    `CLIENT_IP`             varchar(50)  DEFAULT NULL COMMENT '客户端IP',
    `CREATE_TIME`           datetime     DEFAULT NULL COMMENT '创建时间',
    `UPDATE_TIME`           datetime     DEFAULT NULL COMMENT '更新时间',
    `EXPIRE_TIME`           datetime     DEFAULT NULL COMMENT '订单过期时间',
    `REFUND_SUCCESS_TIME`   datetime     DEFAULT NULL COMMENT '退款成功时间',
    PRIMARY KEY (`ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8
  ROW_FORMAT = DYNAMIC;

SET FOREIGN_KEY_CHECKS = 1;

-- ----------------------------
-- Records of platform_channel
-- ----------------------------
BEGIN;
INSERT INTO `platform_channel`
VALUES (1, '聚合支付B扫C', 'aggregate_pay_b2c');
INSERT INTO `platform_channel`
VALUES (2, '聚合支付C扫B', 'aggregate_pay_c2b');
INSERT INTO `platform_channel`
VALUES (3, '微信Native支付', 'wx_native');
INSERT INTO `platform_channel`
VALUES (4, '支付宝手机网站支付', 'alipay_wap');
COMMIT;
```





```sh
PS C:\Users\mao\Desktop> mysql -u root -p
Enter password: ********
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 41
Server version: 8.0.27 MySQL Community Server - GPL

Copyright (c) 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> # Create Database
mysql> # ------------------------------------------------------------
mysql> CREATE DATABASE IF NOT EXISTS aggregate_pay_merchant_service DEFAULT CHARACTER SET = utf8mb4;
Query OK, 1 row affected (0.01 sec)

mysql>
mysql> Use aggregate_pay_merchant_service;
Database changed
mysql>
mysql>
mysql> SET NAMES utf8mb4;
Query OK, 0 rows affected (0.00 sec)

mysql> SET FOREIGN_KEY_CHECKS = 0;
Query OK, 0 rows affected (0.00 sec)

mysql>
mysql> -- ----------------------------
mysql> -- Table structure for app
mysql> -- ----------------------------
mysql> DROP TABLE IF EXISTS `app`;
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> CREATE TABLE `app`
    -> (
    ->     `ID`          bigint(20) NOT NULL,
    ->     `APP_ID`      varchar(50) DEFAULT NULL,
    ->     `APP_NAME`    varchar(50) DEFAULT NULL COMMENT '商店名称',
    ->     `MERCHANT_ID` bigint(20)  DEFAULT NULL COMMENT '所属商户',
    ->     `PUBLIC_KEY`  varchar(50) DEFAULT NULL COMMENT '应用公钥(RSAWithSHA256)',
    ->     `NOTIFY_URL`  varchar(50) DEFAULT NULL COMMENT '授权回调地址',
    ->     PRIMARY KEY (`ID`) USING BTREE,
    ->     UNIQUE KEY `APP_ID` (`APP_ID`) USING BTREE
    -> ) ENGINE = InnoDB
    ->   DEFAULT CHARSET = utf8mb4
    ->   ROW_FORMAT = DYNAMIC;
Query OK, 0 rows affected, 6 warnings (0.03 sec)

mysql>
mysql> -- ----------------------------
mysql> -- Table structure for merchant 商户
mysql> -- ----------------------------
mysql> DROP TABLE IF EXISTS `merchant`;
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> CREATE TABLE `merchant`
    -> (
    ->     `ID`                    bigint(20) NOT NULL COMMENT '主键',
    ->     `MERCHANT_NAME`         varchar(50)  DEFAULT NULL COMMENT '商户名称',
    ->     `MERCHANT_NO`           varchar(32)  DEFAULT NULL COMMENT '企业编号',
    ->     `MERCHANT_ADDRESS`      varchar(255) DEFAULT NULL COMMENT '企业地址',
    ->     `MERCHANT_TYPE`         varchar(50)  DEFAULT NULL COMMENT '商户类型',
    ->     `BUSINESS_LICENSES_IMG` varchar(100) DEFAULT NULL COMMENT '营业执照（企业证明）',
    ->     `ID_CARD_FRONT_IMG`     varchar(100) DEFAULT NULL COMMENT '法人身份证正面照片',
    ->     `ID_CARD_AFTER_IMG`     varchar(100) DEFAULT NULL COMMENT '法人身份证反面照片',
    ->     `USERNAME`              varchar(50)  DEFAULT NULL COMMENT '联系人姓名',
    ->     `MOBILE`                varchar(50)  DEFAULT NULL COMMENT '联系人手机号(关联统一账号)',
    ->     `CONTACTS_ADDRESS`      varchar(255) DEFAULT NULL COMMENT '联系人地址',
    ->     `AUDIT_STATUS`          varchar(20)  DEFAULT NULL COMMENT '审核状态 0-未申请,1-已申请待审核,2-审核通过,3-审核拒绝',
    ->     `TENANT_ID`             bigint(20)   DEFAULT NULL COMMENT '租户ID,关联统一用户',
    ->     PRIMARY KEY (`ID`) USING BTREE
    -> ) ENGINE = InnoDB
    ->   DEFAULT CHARSET = utf8mb4
    ->   ROW_FORMAT = DYNAMIC;
Query OK, 0 rows affected, 15 warnings (0.01 sec)

mysql>
mysql> -- ----------------------------
mysql> -- Table structure for staff  员工
mysql> -- ----------------------------
mysql> DROP TABLE IF EXISTS `staff`;
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> CREATE TABLE `staff`
    -> (
    ->     `ID`              bigint(20) NOT NULL COMMENT '主键',
    ->     `MERCHANT_ID`     bigint(20)  DEFAULT NULL COMMENT '商户ID',
    ->     `FULL_NAME`       varchar(50) DEFAULT NULL COMMENT '姓名',
    ->     `POSITION`        varchar(50) DEFAULT NULL COMMENT '职位',
    ->     `USERNAME`        varchar(50) DEFAULT NULL COMMENT '用户名(关联统一用户)',
    ->     `MOBILE`          varchar(50) DEFAULT NULL COMMENT '手机号(关联统一用户)',
    ->     `STORE_ID`        bigint(20)  DEFAULT NULL COMMENT '员工所属门店',
    ->     `LAST_LOGIN_TIME` datetime    DEFAULT NULL COMMENT '最后一次登录时间',
    ->     `STAFF_STATUS`    bit(1)      DEFAULT NULL COMMENT '0表示禁用，1表示启用',
    ->     PRIMARY KEY (`ID`) USING BTREE
    -> ) ENGINE = InnoDB
    ->   DEFAULT CHARSET = utf8mb4
    ->   ROW_FORMAT = DYNAMIC;
Query OK, 0 rows affected, 11 warnings (0.01 sec)

mysql>
mysql> -- ----------------------------
mysql> -- Table structure for store 门店
mysql> -- ----------------------------
mysql> DROP TABLE IF EXISTS `store`;
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> CREATE TABLE `store`
    -> (
    ->     `ID`            bigint(20) NOT NULL,
    ->     `STORE_NAME`    varchar(50) DEFAULT NULL COMMENT '门店名称',
    ->     `STORE_NUMBER`  bigint(20)  DEFAULT NULL COMMENT '门店编号',
    ->     `MERCHANT_ID`   bigint(20)  DEFAULT NULL COMMENT '所属商户',
    ->     `PARENT_ID`     bigint(20)  DEFAULT NULL COMMENT '父门店',
    ->     `STORE_STATUS`  bit(1)      DEFAULT NULL COMMENT '0表示禁用，1表示启用',
    ->     `STORE_ADDRESS` varchar(50) DEFAULT NULL COMMENT '门店地址',
    ->     PRIMARY KEY (`ID`) USING BTREE
    -> ) ENGINE = InnoDB
    ->   DEFAULT CHARSET = utf8mb4
    ->   ROW_FORMAT = DYNAMIC;
Query OK, 0 rows affected, 10 warnings (0.01 sec)

mysql>
mysql> -- ----------------------------
mysql> -- Table structure for store_staff 门店与员工是多对多关系，所以需要中间表
mysql> -- ----------------------------
mysql> DROP TABLE IF EXISTS `store_staff`;
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> CREATE TABLE `store_staff`
    -> (
    ->     `ID`       bigint(20) NOT NULL,
    ->     `STORE_ID` bigint(20) DEFAULT NULL COMMENT '门店标识',
    ->     `STAFF_ID` bigint(20) DEFAULT NULL COMMENT '员工标识',
    ->     PRIMARY KEY (`ID`) USING BTREE
    -> ) ENGINE = InnoDB
    ->   DEFAULT CHARSET = utf8mb4
    ->   ROW_FORMAT = DYNAMIC;
Query OK, 0 rows affected, 5 warnings (0.01 sec)

mysql>
mysql> SET FOREIGN_KEY_CHECKS = 1;
Query OK, 0 rows affected (0.00 sec)

mysql>
mysql>
mysql>
mysql> # Create Database 交易服务数据库
mysql> # ------------------------------------------------------------
mysql> CREATE DATABASE IF NOT EXISTS aggregate_pay_transaction DEFAULT CHARACTER SET = utf8mb4;
Query OK, 1 row affected (0.00 sec)

mysql>
mysql> Use aggregate_pay_transaction;
Database changed
mysql>
mysql> SET NAMES utf8mb4;
Query OK, 0 rows affected (0.00 sec)

mysql> SET FOREIGN_KEY_CHECKS = 0;
Query OK, 0 rows affected (0.00 sec)

mysql>
mysql> -- ----------------------------
mysql> -- Table structure for app_platform_channel
mysql> -- ----------------------------
mysql> DROP TABLE IF EXISTS `app_platform_channel`;
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> CREATE TABLE `app_platform_channel`
    -> (
    ->     `ID`               bigint(20) NOT NULL,
    ->     `APP_ID`           varchar(50) DEFAULT NULL COMMENT '应用id',
    ->     `PLATFORM_CHANNEL` varchar(50) DEFAULT NULL COMMENT '平台支付渠道',
    ->     PRIMARY KEY (`ID`) USING BTREE
    -> ) ENGINE = InnoDB
    ->   DEFAULT CHARSET = utf8mb4
    ->   ROW_FORMAT = DYNAMIC COMMENT ='说明了应用选择了平台中的哪些支付渠道';
Query OK, 0 rows affected, 4 warnings (0.01 sec)

mysql>
mysql> -- ----------------------------
mysql> -- Table structure for pay_channel 支付渠道
mysql> -- ----------------------------
mysql> DROP TABLE IF EXISTS `pay_channel`;
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> CREATE TABLE `pay_channel`
    -> (
    ->     `ID`           bigint(20) NOT NULL,
    ->     `CHANNEL_NAME` varchar(50) DEFAULT NULL COMMENT '原始支付渠道名称',
    ->     `CHANNEL_CODE` varchar(50) DEFAULT NULL COMMENT '原始支付渠道编码',
    ->     PRIMARY KEY (`ID`) USING BTREE
    -> ) ENGINE = InnoDB
    ->   DEFAULT CHARSET = utf8mb4
    ->   ROW_FORMAT = DYNAMIC;
Query OK, 0 rows affected, 3 warnings (0.01 sec)

mysql>
mysql> -- ----------------------------
mysql> -- Table structure for pay_channel_param 支付参数
mysql> -- ----------------------------
mysql> DROP TABLE IF EXISTS `pay_channel_param`;
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> CREATE TABLE `pay_channel_param`
    -> (
    ->     `ID`                      bigint(20) NOT NULL,
    ->     `CHANNEL_NAME`            varchar(50) DEFAULT NULL COMMENT '配置名称',
    ->     `MERCHANT_ID`             bigint(20)  DEFAULT NULL COMMENT '商户ID',
    ->     `PAY_CHANNEL`             varchar(50) DEFAULT NULL COMMENT '原始支付渠道编码',
    ->     `PARAM`                   text COMMENT '支付参数',
    ->     `APP_PLATFORM_CHANNEL_ID` bigint(20)  DEFAULT NULL COMMENT '应用与支付渠道绑定ID',
    ->     PRIMARY KEY (`ID`) USING BTREE
    -> ) ENGINE = InnoDB
    ->   DEFAULT CHARSET = utf8mb4
    ->   ROW_FORMAT = DYNAMIC COMMENT ='某商户针对某一种原始支付渠道的配置参数';
Query OK, 0 rows affected, 9 warnings (0.01 sec)

mysql>
mysql> -- ----------------------------
mysql> -- Table structure for pay_order 订单
mysql> -- ----------------------------
mysql> DROP TABLE IF EXISTS `pay_order`;
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> CREATE TABLE `pay_order`
    -> (
    ->     `ID`                     bigint(20)  NOT NULL,
    ->     `TRADE_NO`               varchar(50) NOT NULL COMMENT '聚合支付订单号',
    ->     `MERCHANT_ID`            bigint(20)  NOT NULL COMMENT '所属商户',
    ->     `STORE_ID`               bigint(20)   DEFAULT NULL COMMENT '商户下门店',
    ->     `APP_ID`                 varchar(50) NOT NULL COMMENT '所属应用',
    ->     `PAY_CHANNEL`            varchar(50)  DEFAULT NULL COMMENT '原始支付渠道编码',
    ->     `PAY_CHANNEL_MCH_ID`     varchar(50)  DEFAULT NULL COMMENT '原始渠道商户id',
    ->     `PAY_CHANNEL_MCH_APP_ID` varchar(50)  DEFAULT NULL COMMENT '原始渠道商户应用id',
    ->     `PAY_CHANNEL_TRADE_NO`   varchar(50)  DEFAULT NULL COMMENT '原始渠道订单号',
    ->     `CHANNEL`                varchar(50)  DEFAULT NULL COMMENT '聚合支付的渠道',
    ->     `OUT_TRADE_NO`           varchar(50)  DEFAULT NULL COMMENT '商户订单号',
    ->     `SUBJECT`                varchar(50)  DEFAULT NULL COMMENT '商品标题',
    ->     `BODY`                   varchar(256) DEFAULT NULL COMMENT '订单描述',
    ->     `CURRENCY`               varchar(50)  DEFAULT NULL COMMENT '币种CNY',
    ->     `TOTAL_AMOUNT`           int(11)      DEFAULT NULL COMMENT '订单总金额，单位为分',
    ->     `OPTIONAL`               varchar(256) DEFAULT NULL COMMENT '用户自定义的参数,商户自定义数据',
    ->     `ANALYSIS`               varchar(256) DEFAULT NULL COMMENT '用于统计分析的数据,用户自定义',
    ->     `EXTRA`                  varchar(512) DEFAULT NULL COMMENT '特定渠道发起时额外参数',
    ->     `TRADE_STATE`            varchar(50)  DEFAULT NULL COMMENT '交易状态支付状态,0-订单生成,1-支付中(目前未使用),2-支付成功,3-业务处理完成,4-关闭',
    ->     `ERROR_CODE`             varchar(50)  DEFAULT NULL COMMENT '渠道支付错误码',
    ->     `ERROR_MSG`              varchar(256) DEFAULT NULL COMMENT '渠道支付错误信息',
    ->     `DEVICE`                 varchar(50)  DEFAULT NULL COMMENT '设备',
    ->     `CLIENT_IP`              varchar(50)  DEFAULT NULL COMMENT '客户端IP',
    ->     `CREATE_TIME`            datetime     DEFAULT NULL COMMENT '创建时间',
    ->     `UPDATE_TIME`            datetime     DEFAULT NULL COMMENT '更新时间',
    ->     `EXPIRE_TIME`            datetime     DEFAULT NULL COMMENT '订单过期时间',
    ->     `PAY_SUCCESS_TIME`       datetime     DEFAULT NULL COMMENT '支付成功时间',
    ->     PRIMARY KEY (`ID`) USING BTREE,
    ->     UNIQUE KEY `unique_TRADE_NO` (`TRADE_NO`)
    -> ) ENGINE = InnoDB
    ->   DEFAULT CHARSET = utf8mb4
    ->   ROW_FORMAT = DYNAMIC;
Query OK, 0 rows affected, 30 warnings (0.03 sec)

mysql>
mysql> -- ----------------------------
mysql> -- Table structure for payment_bill
mysql> -- ----------------------------
mysql> DROP TABLE IF EXISTS `payment_bill`;
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> CREATE TABLE `payment_bill`
    -> (
    ->     `id`                bigint(20)     NOT NULL,
    ->     `merchant_id`       bigint(20)     NOT NULL COMMENT '商户id',
    ->     `merchant_name`     varchar(60)    NOT NULL COMMENT '商户名称',
    ->     `merchant_app_id`   bigint(20)     NOT NULL COMMENT '商户应用Id',
    ->     `merchant_order_no` varchar(60)    NOT NULL COMMENT '商户订单号',
    ->     `channel_order_no`  varchar(60)    NOT NULL COMMENT '渠道订单号',
    ->     `product_name`      varchar(255)   NOT NULL COMMENT '商品名称',
    ->     `create_time`       varchar(60)    DEFAULT NULL COMMENT '创建时间',
    ->     `pos_time`          varchar(60)    NOT NULL COMMENT '交易时间',
    ->     `equipment_no`      varchar(60)    DEFAULT NULL COMMENT '终端号',
    ->     `user_account`      varchar(60)    DEFAULT NULL COMMENT '用户账号/标识信息',
    ->     `total_amount`      decimal(10, 2) DEFAULT NULL COMMENT '订单金额',
    ->     `trade_amount`      decimal(10, 2) NOT NULL COMMENT '实际交易金额',
    ->     `discount_amount`   decimal(10, 2) DEFAULT NULL COMMENT '折扣金额',
    ->     `service_fee`       decimal(10, 4) DEFAULT NULL COMMENT '手续费',
    ->     `refund_order_no`   varchar(60)    DEFAULT NULL COMMENT '退款单号',
    ->     `refund_money`      decimal(10, 2) DEFAULT NULL,
    ->     `platform_channel`  varchar(50)    NOT NULL COMMENT '平台支付渠道',
    ->     `remark`            varchar(255)   DEFAULT NULL COMMENT '备注',
    ->     PRIMARY KEY (`id`)
    -> ) ENGINE = InnoDB
    ->   DEFAULT CHARSET = utf8mb4;
Query OK, 0 rows affected, 20 warnings (0.02 sec)

mysql>
mysql> -- ----------------------------
mysql> -- Table structure for platform_channel
mysql> -- ----------------------------
mysql> DROP TABLE IF EXISTS `platform_channel`;
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> CREATE TABLE `platform_channel`
    -> (
    ->     `ID`           bigint(20) NOT NULL,
    ->     `CHANNEL_NAME` varchar(50) DEFAULT NULL COMMENT '平台支付渠道名称',
    ->     `CHANNEL_CODE` varchar(50) DEFAULT NULL COMMENT '平台支付渠道编码',
    ->     PRIMARY KEY (`ID`) USING BTREE
    -> ) ENGINE = InnoDB
    ->   DEFAULT CHARSET = utf8mb4
    ->   ROW_FORMAT = DYNAMIC;
Query OK, 0 rows affected, 3 warnings (0.01 sec)

mysql>
mysql> -- ----------------------------
mysql> -- Table structure for platform_pay_channel
mysql> -- ----------------------------
mysql> DROP TABLE IF EXISTS `platform_pay_channel`;
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> CREATE TABLE `platform_pay_channel`
    -> (
    ->     `ID`               bigint(20) NOT NULL,
    ->     `PLATFORM_CHANNEL` varchar(20) DEFAULT NULL COMMENT '平台支付渠道编码',
    ->     `PAY_CHANNEL`      varchar(20) DEFAULT NULL COMMENT '原始支付渠道名称',
    ->     PRIMARY KEY (`ID`) USING BTREE
    -> ) ENGINE = InnoDB
    ->   DEFAULT CHARSET = utf8mb4
    ->   ROW_FORMAT = DYNAMIC;
Query OK, 0 rows affected, 3 warnings (0.01 sec)

mysql>
mysql> -- ----------------------------
mysql> -- Table structure for refund_order
mysql> -- ----------------------------
mysql> DROP TABLE IF EXISTS `refund_order`;
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> CREATE TABLE `refund_order`
    -> (
    ->     `ID`                    bigint(20) NOT NULL,
    ->     `REFUND_NO`             varchar(50)  DEFAULT NULL COMMENT '聚合支付退款订单号',
    ->     `TRADE_NO`              varchar(50)  DEFAULT NULL COMMENT '聚合支付订单号',
    ->     `MERCHANT_ID`           bigint(20)   DEFAULT NULL COMMENT '所属商户',
    ->     `APP_ID`                varchar(50)  DEFAULT NULL COMMENT '所属应用',
    ->     `PAY_CHANNEL`           varchar(50)  DEFAULT NULL COMMENT '原始支付渠道编码',
    ->     `PAY_CHANNEL_MCH_ID`    varchar(50)  DEFAULT NULL COMMENT '原始渠道商户id',
    ->     `PAY_CHANNEL_TRADE_NO`  varchar(50)  DEFAULT NULL COMMENT '原始渠道订单号',
    ->     `PAY_CHANNEL_REFUND_NO` varchar(50)  DEFAULT NULL COMMENT '原始渠道退款订单号',
    ->     `CHANNEL`               varchar(50)  DEFAULT NULL COMMENT '聚合支付的渠道',
    ->     `OUT_TRADE_NO`          varchar(50)  DEFAULT NULL COMMENT '商户订单号',
    ->     `OUT_REFUND_NO`         varchar(50)  DEFAULT NULL COMMENT '商户退款订单号',
    ->     `PAY_CHANNEL_USER`      varchar(50)  DEFAULT NULL COMMENT '原始渠道用户标识,如微信openId,支付宝账号',
    ->     `PAY_CHANNEL_USERNAME`  varchar(50)  DEFAULT NULL COMMENT '原始渠道用户姓名',
    ->     `CURRENCY`              varchar(50)  DEFAULT NULL COMMENT '币种CNY',
    ->     `TOTAL_AMOUNT`          int(11)      DEFAULT NULL COMMENT '订单总金额，单位为分',
    ->     `REFUND_AMOUNT`         int(11)      DEFAULT NULL COMMENT '退款金额,单位分',
    ->     `OPTIONAL`              varchar(256) DEFAULT NULL COMMENT '用户自定义的参数,商户自定义数据',
    ->     `ANALYSIS`              varchar(256) DEFAULT NULL COMMENT '用于统计分析的数据,用户自定义',
    ->     `EXTRA`                 varchar(512) DEFAULT NULL COMMENT '特定渠道发起时额外参数',
    ->     `REFUND_STATE`          varchar(50)  DEFAULT NULL COMMENT '退款状态:0-订单生成,1-退款中,2-退款成功,3-退款失败,4-业务处理完成',
    ->     `REFUND_RESULT`         varchar(50)  DEFAULT NULL COMMENT '退款结果:0-不确认结果,1-等待手动处理,2-确认成功,3-确认失败',
    ->     `ERROR_CODE`            varchar(50)  DEFAULT NULL COMMENT '渠道支付错误码',
    ->     `ERROR_MSG`             varchar(256) DEFAULT NULL COMMENT '渠道支付错误信息',
    ->     `DEVICE`                varchar(50)  DEFAULT NULL COMMENT '设备',
    ->     `CLIENT_IP`             varchar(50)  DEFAULT NULL COMMENT '客户端IP',
    ->     `CREATE_TIME`           datetime     DEFAULT NULL COMMENT '创建时间',
    ->     `UPDATE_TIME`           datetime     DEFAULT NULL COMMENT '更新时间',
    ->     `EXPIRE_TIME`           datetime     DEFAULT NULL COMMENT '订单过期时间',
    ->     `REFUND_SUCCESS_TIME`   datetime     DEFAULT NULL COMMENT '退款成功时间',
    ->     PRIMARY KEY (`ID`) USING BTREE
    -> ) ENGINE = InnoDB
    ->   DEFAULT CHARSET = utf8mb4
    ->   ROW_FORMAT = DYNAMIC;
Query OK, 0 rows affected, 33 warnings (0.02 sec)

mysql>
mysql> SET FOREIGN_KEY_CHECKS = 1;
Query OK, 0 rows affected (0.00 sec)

mysql> show databases;
+--------------------------------+
| Database                       |
+--------------------------------+
| aggregate_pay_merchant_service |
| aggregate_pay_transaction      |
| authority                      |
| cloud_order                    |
| cloud_user                     |
| hotel                          |
| information_schema             |
| mysql                          |
| nacos                          |
| performance_schema             |
| sakila                         |
| seata                          |
| seata_demo                     |
| shop                           |
| sms                            |
| spring_cloud_security          |
| student                        |
| student1                       |
| student_test                   |
| sys                            |
| test                           |
| tx                             |
| world                          |
+--------------------------------+
23 rows in set (0.00 sec)

mysql>
```



![image-20230108225659978](img/聚合支付项目实战学习笔记/image-20230108225659978.png)











## Nacos命名空间

进入Nacos，点击命名空间

![image-20230108204313462](img/聚合支付项目实战学习笔记/image-20230108204313462.png)





点击新建命名空间

![image-20230108204335620](img/聚合支付项目实战学习笔记/image-20230108204335620.png)





添加数据

![image-20230108204613140](img/聚合支付项目实战学习笔记/image-20230108204613140.png)



点击确定



![image-20230108204629224](img/聚合支付项目实战学习笔记/image-20230108204629224.png)



再添加一个命名空间

![image-20230108205532284](img/聚合支付项目实战学习笔记/image-20230108205532284.png)



![image-20230108205549311](img/聚合支付项目实战学习笔记/image-20230108205549311.png)

















## Nacos配置文件







## 搭建项目服务



|服务名| 职责 |
| :--: | :--: |
|商户平台应用(aggregate-pay-merchant-application)| 为前端提供商户管理功能 |
|商户服务父模块(aggregate-pay-merchant) |商户服务父模块|
|商户服务API(aggregate-pay-merchant-api) |定义商户服务提供的接口|
|商户服务(aggregate-pay-merchant-service) |实现商户服务的所有接口|







### 商户平台应用

![image-20230108142757726](img/聚合支付项目实战学习笔记/image-20230108142757726.png)







### 商户服务父模块



![image-20230108143031089](img/聚合支付项目实战学习笔记/image-20230108143031089.png)







### 商户服务API



![image-20230108143214346](img/聚合支付项目实战学习笔记/image-20230108143214346.png)





### 商户服务



![image-20230108143337172](img/聚合支付项目实战学习笔记/image-20230108143337172.png)









## pom文件









## 配置文件















## 测试查询

### 创建接口

在商户service模块下创建接口MerchantService

```java
package mao.aggregate_pay_merchant_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_service.entity.Merchant;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service
 * Interface(接口名): MerchantService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:29
 * Version(版本): 1.0
 * Description(描述)： 商户服务接口
 */

public interface MerchantService extends IService<Merchant>
{
    /**
     * 通过id获取商户信息
     *
     * @param merchantId 商户id
     * @return {@link MerchantDTO}
     */
    MerchantDTO getMerchantById(Long merchantId);
}
```





### 创建接口实现

在商户service模块下创建接口实现类MerchantServiceImpl

```java
package mao.aggregate_pay_merchant_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_service.entity.Merchant;
import mao.aggregate_pay_merchant_service.mapper.MerchantMapper;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.toolsdozer.utils.DozerUtils;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service.impl
 * Class(类名): MerchantServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:38
 * Version(版本): 1.0
 * Description(描述)： 商户服务实现类
 */

@Service
public class MerchantServiceImpl extends ServiceImpl<MerchantMapper, Merchant> implements MerchantService
{

    @Resource
    private DozerUtils dozerUtils;

    @Override
    public MerchantDTO getMerchantById(Long merchantId)
    {
        //查询
        Merchant merchant = this.getById(merchantId);
        //转换，并返回
        return dozerUtils.map(merchant, MerchantDTO.class);
    }
}
```







### 创建单元测试类

```java
package mao.aggregate_pay_merchant_service.service.impl;

import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.transaction.annotation.Transactional;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service.impl
 * Class(测试类名): MerchantServiceImplTest
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:41
 * Version(版本): 1.0
 * Description(描述)： 测试类
 */

@Transactional
@SpringBootTest
class MerchantServiceImplTest
{

    @Autowired
    private MerchantService merchantService;

    @Test
    void getMerchantById()
    {
        MerchantDTO merchantDTO = merchantService.getMerchantById(1L);
        System.out.println(merchantDTO);
    }
}
```



```sh
2023-01-09 15:51:51.138 DEBUG 8012 --- [           main] m.a.mapper.MerchantMapper.selectById     : <==      Total: 1
MerchantDTO(id=1, merchantName=测试商户, merchantNo=1100000, merchantAddress=中国, merchantType=测试类型, businessLicensesImg=img1, idCardFrontImg=img2, idCardAfterImg=img3, username=测试姓名, mobile=18855884488, password=null, contactsAddress=中国, auditStatus=0, tenantId=4)
```







### 新建商户Controller

```java
package mao.aggregate_pay_merchant_service.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.tools_core.base.BaseController;
import mao.tools_core.base.R;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.controller
 * Class(类名): MerchantController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:53
 * Version(版本): 1.0
 * Description(描述)： 商户Controller
 */

@RestController
@Api(tags = "商户")
@RequestMapping("/merchant")
public class MerchantController extends BaseController
{

    @Resource
    private MerchantService merchantService;

    @ApiOperation("根据商户id查询商户信息")
    @GetMapping("/{merchantId}")
    public R<MerchantDTO> getById(@PathVariable Long merchantId)
    {
        return R.success(merchantService.getMerchantById(merchantId));
    }
}
```





### 启动测试

```sh

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::        (v2.2.9.RELEASE)

2023-01-09 20:33:51.030  WARN 21216 --- [           main] c.a.c.n.c.NacosPropertySourceBuilder     : Ignore the empty nacos configuration and get it based on dataId[aggregate-pay-merchant-service] & group[DEFAULT_GROUP]
2023-01-09 20:33:51.046  INFO 21216 --- [           main] b.c.PropertySourceBootstrapConfiguration : Located property source: [BootstrapPropertySource {name='bootstrapProperties-aggregate-pay-merchant-service-dev.yml,DEFAULT_GROUP'}, BootstrapPropertySource {name='bootstrapProperties-aggregate-pay-merchant-service.yml,DEFAULT_GROUP'}, BootstrapPropertySource {name='bootstrapProperties-aggregate-pay-merchant-service,DEFAULT_GROUP'}, BootstrapPropertySource {name='bootstrapProperties-mysql.yml,DEFAULT_GROUP'}, BootstrapPropertySource {name='bootstrapProperties-redis.yml,DEFAULT_GROUP'}, BootstrapPropertySource {name='bootstrapProperties-common.yml,DEFAULT_GROUP'}]
2023-01-09 20:33:51.084  INFO 21216 --- [           main] a.AggregatePayMerchantServiceApplication : The following profiles are active: dev
2023-01-09 20:33:52.187  WARN 21216 --- [           main] o.s.boot.actuate.endpoint.EndpointId     : Endpoint ID 'service-registry' contains invalid characters, please migrate to a valid format.
2023-01-09 20:33:52.337  INFO 21216 --- [           main] o.s.cloud.context.scope.GenericScope     : BeanFactory id=ac20cdc4-b0bc-3f8e-bfa1-79ce3784129d
2023-01-09 20:33:52.486  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'org.springframework.transaction.annotation.ProxyTransactionManagementConfiguration' of type [org.springframework.transaction.annotation.ProxyTransactionManagementConfiguration] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:52.788  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'mybatis-plus-com.baomidou.mybatisplus.autoconfigure.MybatisPlusProperties' of type [com.baomidou.mybatisplus.autoconfigure.MybatisPlusProperties] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:52.798  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'database-mao.tools_databases.properties.DatabaseProperties' of type [mao.tools_databases.properties.DatabaseProperties] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:52.806  INFO 21216 --- [           main] m.a.config.MybatisConfig                 : 初始化 MybatisConfig
2023-01-09 20:33:52.806  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'mybatisConfig' of type [mao.aggregate_pay_merchant_service.config.MybatisConfig$$EnhancerBySpringCGLIB$$f1c67ae1] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:52.813  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'paginationInterceptor' of type [com.baomidou.mybatisplus.extension.plugins.PaginationInterceptor] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:52.820  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'getLeftLikeTypeHandler' of type [mao.tools_databases.mybatis.typehandler.LeftLikeTypeHandler] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:52.825  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'getRightLikeTypeHandler' of type [mao.tools_databases.mybatis.typehandler.RightLikeTypeHandler] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:52.827  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'getFullLikeTypeHandler' of type [mao.tools_databases.mybatis.typehandler.FullLikeTypeHandler] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:52.835  INFO 21216 --- [           main] m.a.config.DatabaseConfig                : 初始化 DatabaseConfig 数据库配置
2023-01-09 20:33:52.836  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'databaseConfig' of type [mao.aggregate_pay_merchant_service.config.DatabaseConfig$$EnhancerBySpringCGLIB$$a6c82855] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:52.918  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'spring.datasource-org.springframework.boot.autoconfigure.jdbc.DataSourceProperties' of type [org.springframework.boot.autoconfigure.jdbc.DataSourceProperties] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:52.923  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'com.alibaba.druid.spring.boot.autoconfigure.stat.DruidFilterConfiguration' of type [com.alibaba.druid.spring.boot.autoconfigure.stat.DruidFilterConfiguration] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:52.937  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'wallConfig' of type [com.alibaba.druid.wall.WallConfig] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:52.970  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'wallFilter' of type [com.alibaba.druid.wall.WallFilter] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:53.051  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'masterDruidDataSource' of type [com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceWrapper] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:53.081  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'org.springframework.boot.autoconfigure.jdbc.DataSourceInitializerInvoker' of type [org.springframework.boot.autoconfigure.jdbc.DataSourceInitializerInvoker] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:53.098  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'masterDataSource' of type [com.p6spy.engine.spy.P6DataSource] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:53.105  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'masterTransactionManager' of type [org.springframework.jdbc.datasource.DataSourceTransactionManager] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:53.112  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'masterTransactionInterceptor' of type [org.springframework.transaction.interceptor.TransactionInterceptor] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:53.113  INFO 21216 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'masterAdvisor' of type [org.springframework.aop.support.DefaultPointcutAdvisor] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2023-01-09 20:33:53.160  INFO 21216 --- [           main] m.a.config.WebConfig                     : 初始化 WebConfig
2023-01-09 20:33:53.391  INFO 21216 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 56040 (http)
2023-01-09 20:33:53.401  INFO 21216 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
2023-01-09 20:33:53.401  INFO 21216 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.37]
2023-01-09 20:33:53.538  INFO 21216 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2023-01-09 20:33:53.539  INFO 21216 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 2443 ms
2023-01-09 20:33:53.761  INFO 21216 --- [           main] m.a.config.ExceptionConfig               : 初始化 ExceptionConfig 全局异常配置
2023-01-09 20:33:53.799  INFO 21216 --- [           main] c.g.d.core.DozerBeanMapperBuilder        : Initializing Dozer. Version: 6.5.0, Thread Name: main
2023-01-09 20:33:53.800  INFO 21216 --- [           main] c.g.dozermapper.core.util.RuntimeUtils   : OSGi support is false
2023-01-09 20:33:53.807  INFO 21216 --- [           main] d.c.c.r.LegacyPropertiesSettingsResolver : Trying to find Dozer configuration file: dozer.properties
2023-01-09 20:33:53.812  INFO 21216 --- [           main] d.c.c.r.LegacyPropertiesSettingsResolver : Failed to find dozer.properties via com.github.dozermapper.core.config.resolvers.LegacyPropertiesSettingsResolver.
2023-01-09 20:33:53.819  INFO 21216 --- [           main] c.g.d.core.el.ELExpressionFactory        : javax.el support is true
2023-01-09 20:33:53.850  INFO 21216 --- [           main] c.g.d.c.b.xml.BeanMappingXMLBuilder      : Using URL [file:/H:/%e7%a8%8b%e5%ba%8f/%e5%a4%a7%e5%9b%9b%e5%af%92%e5%81%87/aggregate-pay/apps/pay/aggregate-pay-merchant/aggregate-pay-merchant-service/target/classes/dozer/global.dozer.xml] to load custom xml mappings
2023-01-09 20:33:54.078  INFO 21216 --- [           main] c.g.d.c.b.xml.SchemaLSResourceResolver   : Trying to resolve XML entity with public ID [null] and system ID [http://dozermapper.github.io/schema/bean-mapping.xsd]
2023-01-09 20:33:54.080  INFO 21216 --- [           main] c.g.d.c.b.xml.SchemaLSResourceResolver   : Resolved public ID [null] and system ID [http://dozermapper.github.io/schema/bean-mapping.xsd]
2023-01-09 20:33:54.101  INFO 21216 --- [           main] c.g.d.c.b.xml.BeanMappingXMLBuilder      : Successfully loaded custom xml mapping.
2023-01-09 20:33:54.102  INFO 21216 --- [           main] c.g.d.c.b.xml.BeanMappingXMLBuilder      : Using URL [file:/H:/%e7%a8%8b%e5%ba%8f/%e5%a4%a7%e5%9b%9b%e5%af%92%e5%81%87/aggregate-pay/apps/pay/aggregate-pay-merchant/aggregate-pay-merchant-service/target/classes/dozer/biz.dozer.xml] to load custom xml mappings
2023-01-09 20:33:54.105  INFO 21216 --- [           main] c.g.d.c.b.xml.SchemaLSResourceResolver   : Trying to resolve XML entity with public ID [null] and system ID [http://dozermapper.github.io/schema/bean-mapping.xsd]
2023-01-09 20:33:54.105  INFO 21216 --- [           main] c.g.d.c.b.xml.SchemaLSResourceResolver   : Resolved public ID [null] and system ID [http://dozermapper.github.io/schema/bean-mapping.xsd]
2023-01-09 20:33:54.110  INFO 21216 --- [           main] c.g.d.c.b.xml.BeanMappingXMLBuilder      : Successfully loaded custom xml mapping.
2023-01-09 20:33:54.124  INFO 21216 --- [           main] m.t.config.DozerAutoConfiguration        : 初始化 DozerAutoConfiguration
2023-01-09 20:33:54.304  INFO 21216 --- [           main] mao.tools_log.utils.AddressUtil          : bean [org.lionsoul.ip2region.DbConfig@3e03046d]
2023-01-09 20:33:54.305  INFO 21216 --- [           main] mao.tools_log.utils.AddressUtil          : bean [org.lionsoul.ip2region.DbSearcher@9b3be1c]
 _ _   |_  _ _|_. ___ _ |    _ 
| | |\/|_)(_| | |_\  |_)||_|_\ 
     /               |         
                        3.2.0 
2023-01-09 20:33:54.499 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.501 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.501 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.501 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.501 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.501 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.501 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.501 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.501 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.501 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.501 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.501 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.501 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.502 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.502 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.502 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.502 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.502 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.502 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.502 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.502 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.502 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.502 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.502 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.MerchantController
2023-01-09 20:33:54.506 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.TestController
2023-01-09 20:33:54.507 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.TestController
2023-01-09 20:33:54.507 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.TestController
2023-01-09 20:33:54.507 DEBUG 21216 --- [           main] m.t.d.BaseDatabaseConfiguration          : 允许带事务的类为：class mao.aggregate_pay_merchant_service.controller.TestController
2023-01-09 20:33:55.126  INFO 21216 --- [           main] com.alibaba.nacos.client.naming          : initializer namespace from System Property :null
2023-01-09 20:33:55.126  INFO 21216 --- [           main] com.alibaba.nacos.client.naming          : initializer namespace from System Environment :null
2023-01-09 20:33:55.126  INFO 21216 --- [           main] com.alibaba.nacos.client.naming          : initializer namespace from System Property :null
2023-01-09 20:33:55.295  INFO 21216 --- [           main] o.s.b.a.e.web.EndpointLinksResolver      : Exposing 4 endpoint(s) beneath base path '/actuator'
2023-01-09 20:33:55.431  WARN 21216 --- [           main] c.n.c.sources.URLConfigurationSource     : No URLs will be polled as dynamic configuration sources.
2023-01-09 20:33:55.431  INFO 21216 --- [           main] c.n.c.sources.URLConfigurationSource     : To enable URLs as dynamic configuration sources, define System property archaius.configurationSource.additionalUrls or make config.properties available on classpath.
2023-01-09 20:33:55.436  WARN 21216 --- [           main] c.n.c.sources.URLConfigurationSource     : No URLs will be polled as dynamic configuration sources.
2023-01-09 20:33:55.436  INFO 21216 --- [           main] c.n.c.sources.URLConfigurationSource     : To enable URLs as dynamic configuration sources, define System property archaius.configurationSource.additionalUrls or make config.properties available on classpath.
2023-01-09 20:33:55.532  INFO 21216 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'
2023-01-09 20:33:55.683  INFO 21216 --- [           main] o.s.s.c.ThreadPoolTaskScheduler          : Initializing ExecutorService 'Nacos-Watch-Task-Scheduler'
2023-01-09 20:33:55.703  INFO 21216 --- [           main] m.tools_log.config.LogAutoConfiguration  : 初始化 LogAutoConfiguration
2023-01-09 20:33:55.721  INFO 21216 --- [           main] pertySourcedRequestMappingHandlerMapping : Mapped URL path [/v2/api-docs] onto method [springfox.documentation.swagger2.web.Swagger2Controller#getDocumentation(String, HttpServletRequest)]
2023-01-09 20:33:55.731  INFO 21216 --- [           main] m.t.config.SwaggerAutoConfiguration      : 初始化swagger接口文档
2023-01-09 20:33:55.732  INFO 21216 --- [           main] m.t.config.SwaggerAutoConfiguration      : 
title：在线文档
group：
description：在线文档
version：1.0
contact：Contact{name='', url='', email=''}
basePackage：
basePath：[]
excludePath：[]
docket：{aggregate_pay=DocketInfo{title='商户服务', group='', description='在线文档', version='1.0', contact=Contact{name='', url='', email=''}, basePackage='mao.aggregate_pay_merchant_service', basePath=[], excludePath=[]}}

2023-01-09 20:33:56.480  INFO 21216 --- [           main] com.alibaba.nacos.client.naming          : new ips(1) service: DEFAULT_GROUP@@aggregate-pay-merchant-service@@DEFAULT -> [{"instanceId":"192.168.3.143#56040#DEFAULT#DEFAULT_GROUP@@aggregate-pay-merchant-service","ip":"192.168.3.143","port":56040,"weight":1.0,"healthy":true,"enabled":true,"ephemeral":false,"clusterName":"DEFAULT","serviceName":"DEFAULT_GROUP@@aggregate-pay-merchant-service","metadata":{"preserved.register.source":"SPRING_CLOUD","management.endpoints.web.base-path":"/actuator","management.context-path":"//actuator"},"ipDeleteTimeout":30000,"instanceHeartBeatTimeOut":15000,"instanceHeartBeatInterval":5000}]
2023-01-09 20:33:56.489  INFO 21216 --- [           main] com.alibaba.nacos.client.naming          : current ips:(1) service: DEFAULT_GROUP@@aggregate-pay-merchant-service@@DEFAULT -> [{"instanceId":"192.168.3.143#56040#DEFAULT#DEFAULT_GROUP@@aggregate-pay-merchant-service","ip":"192.168.3.143","port":56040,"weight":1.0,"healthy":true,"enabled":true,"ephemeral":false,"clusterName":"DEFAULT","serviceName":"DEFAULT_GROUP@@aggregate-pay-merchant-service","metadata":{"preserved.register.source":"SPRING_CLOUD","management.endpoints.web.base-path":"/actuator","management.context-path":"//actuator"},"ipDeleteTimeout":30000,"instanceHeartBeatTimeOut":15000,"instanceHeartBeatInterval":5000}]
2023-01-09 20:33:56.492  INFO 21216 --- [           main] d.s.w.p.DocumentationPluginsBootstrapper : Context refreshed
2023-01-09 20:33:56.519  INFO 21216 --- [           main] d.s.w.p.DocumentationPluginsBootstrapper : Found 1 custom documentation plugin(s)
2023-01-09 20:33:56.560  INFO 21216 --- [           main] s.d.s.w.s.ApiListingReferenceScanner     : Scanning for api listing references
2023-01-09 20:33:56.739  INFO 21216 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 56040 (http) with context path ''
2023-01-09 20:33:56.743  INFO 21216 --- [           main] com.alibaba.nacos.client.naming          : [REGISTER-SERVICE] 51637975-182d-43e2-ab58-d012723411d5 registering service DEFAULT_GROUP@@aggregate-pay-merchant-service with instance: Instance{instanceId='null', ip='192.168.3.143', port=56040, weight=1.0, healthy=true, enabled=true, ephemeral=false, clusterName='DEFAULT', serviceName='null', metadata={preserved.register.source=SPRING_CLOUD, management.endpoints.web.base-path=/actuator, management.context-path=//actuator}}
2023-01-09 20:33:56.897  INFO 21216 --- [           main] c.a.c.n.registry.NacosServiceRegistry    : nacos registry, DEFAULT_GROUP aggregate-pay-merchant-service 192.168.3.143:56040 register finished
2023-01-09 20:33:57.159  INFO 21216 --- [           main] a.AggregatePayMerchantServiceApplication : Started AggregatePayMerchantServiceApplication in 7.778 seconds (JVM running for 9.162)
2023-01-09 20:33:57.167  INFO 21216 --- [           main] c.a.n.client.config.impl.ClientWorker    : [fixed-127.0.0.1_8848-51637975-182d-43e2-ab58-d012723411d5] [subscribe] common.yml+DEFAULT_GROUP+51637975-182d-43e2-ab58-d012723411d5
2023-01-09 20:33:57.168  INFO 21216 --- [           main] c.a.nacos.client.config.impl.CacheData   : [fixed-127.0.0.1_8848-51637975-182d-43e2-ab58-d012723411d5] [add-listener] ok, tenant=51637975-182d-43e2-ab58-d012723411d5, dataId=common.yml, group=DEFAULT_GROUP, cnt=1
2023-01-09 20:33:57.170  INFO 21216 --- [           main] c.a.n.client.config.impl.ClientWorker    : [fixed-127.0.0.1_8848-51637975-182d-43e2-ab58-d012723411d5] [subscribe] aggregate-pay-merchant-service.yml+DEFAULT_GROUP+51637975-182d-43e2-ab58-d012723411d5
2023-01-09 20:33:57.170  INFO 21216 --- [           main] c.a.nacos.client.config.impl.CacheData   : [fixed-127.0.0.1_8848-51637975-182d-43e2-ab58-d012723411d5] [add-listener] ok, tenant=51637975-182d-43e2-ab58-d012723411d5, dataId=aggregate-pay-merchant-service.yml, group=DEFAULT_GROUP, cnt=1
2023-01-09 20:33:57.170  INFO 21216 --- [           main] c.a.n.client.config.impl.ClientWorker    : [fixed-127.0.0.1_8848-51637975-182d-43e2-ab58-d012723411d5] [subscribe] aggregate-pay-merchant-service+DEFAULT_GROUP+51637975-182d-43e2-ab58-d012723411d5
2023-01-09 20:33:57.170  INFO 21216 --- [           main] c.a.nacos.client.config.impl.CacheData   : [fixed-127.0.0.1_8848-51637975-182d-43e2-ab58-d012723411d5] [add-listener] ok, tenant=51637975-182d-43e2-ab58-d012723411d5, dataId=aggregate-pay-merchant-service, group=DEFAULT_GROUP, cnt=1
2023-01-09 20:33:57.172  INFO 21216 --- [           main] c.a.n.client.config.impl.ClientWorker    : [fixed-127.0.0.1_8848-51637975-182d-43e2-ab58-d012723411d5] [subscribe] aggregate-pay-merchant-service-dev.yml+DEFAULT_GROUP+51637975-182d-43e2-ab58-d012723411d5
2023-01-09 20:33:57.172  INFO 21216 --- [           main] c.a.nacos.client.config.impl.CacheData   : [fixed-127.0.0.1_8848-51637975-182d-43e2-ab58-d012723411d5] [add-listener] ok, tenant=51637975-182d-43e2-ab58-d012723411d5, dataId=aggregate-pay-merchant-service-dev.yml, group=DEFAULT_GROUP, cnt=1
2023-01-09 20:33:57.173  INFO 21216 --- [           main] a.AggregatePayMerchantServiceApplication : 应用aggregate-pay-merchant-service启动成功!swagger地址：http://192.168.202.1:56040/doc.html
2023-01-09 20:33:57.173  INFO 21216 --- [           main] a.AggregatePayMerchantServiceApplication : 数据库监控地址：http://192.168.202.1:56040/druid
2023-01-09 20:33:57.173  INFO 21216 --- [           main] a.AggregatePayMerchantServiceApplication : 启动耗时：7958ms
```



访问http://192.168.202.1:56040/doc.html



![image-20230109204015915](img/聚合支付项目实战学习笔记/image-20230109204015915.png)





![image-20230109204028594](img/聚合支付项目实战学习笔记/image-20230109204028594.png)

















# 商户注册

## 需求概述

什么是线下和线上商户？

* 线下场所支付商户

使用线下场所支付的商户是指有实体经营场所的商家，也称为地面商户，一般包含酒店、餐厅、酒吧、美容、 美 发、 媒体、 影楼、 家政、 艺廊、 KTV、 会所等

* 线上支付商户

使用线上支付的商户是指通过互联网进行经营服务的商家，常见的有：电商网站、团购网站、旅游网站等

商户使用平台第一步要在平台进行注册

商户填写手机号、账号、密码、获取验证码申请注册，注册成功后商户成为平台的用户



商户注册的业务流程如下：



![image-20230109204523644](img/聚合支付项目实战学习笔记/image-20230109204523644.png)





1、用户填写手机号、账号、密码等信息

2、点击获取手机验证码

3、输入验证码，点击注册

4、商户注册成功









## 需求分析

### 系统交互流程

![image-20230109211347945](img/聚合支付项目实战学习笔记/image-20230109211347945.png)





商户注册的流程由商户平台应用、商户服务、SaaS平台、验证码服务四个微服务之间进行交互完成，各微服务的职责介绍如下：

* 商户平台应用：此应用主要为商户提供业务功能，包括：商户资质申请、员工管理、门店管理等功能
* 商户服务： 提供商户管理的相关服务接口，供其它微服务调用，主要为商户平台应用提供接口服务，功能包括：商户基本信息管理、资质申请、商户应用管理、渠道参数配置、商户员工信息管理、商户门店管理等
* SaaS平台：聚合支付项目是一个SaaS平台 ，所谓SaaS平台即多个用户租用平台的业务功能，这样用户即可省去软件系统开发的成本，每个商户就是一个租户，所以又称为多租户系统
* 验证码服务：提供获取短信验证码、校验验证码的接口



SaaS平台提供租户管理、账号管理、权限管理、资源管理、套餐管理、系统认证授权等功业务功能。在上图商户注册的流程中，商户注册的账号等信息需要写入SaaS平台，由SaaS平台统一管理账号，分配权限，商户统一通过 SaaS平台登录聚合支付



商户使用手机号进行注册，平台通过校验手机验证码来确认是否本人在注册



交互流程如下：

1. 前端请求商户平台应用进行注册
2. 商户平台应用获取短信验证码
3. 前端携带手机验证码、账号、密码等信息请求商户平台应用确认注册
4. 验证码校验通过后请求商户服务新增商户
5. 商户服务请求SaaS平台新增租户并初始化管理员
6. SaaS平台返回创建成功给商户服务商户服务新增商户下根门店信息
7. 商户服务新增商户下员工信息
8. 注册成功









## 验证码服务

### 搭建

创建子模块aggregate-pay-sms



![image-20230109212602010](img/聚合支付项目实战学习笔记/image-20230109212602010.png)



![image-20230109212647674](img/聚合支付项目实战学习笔记/image-20230109212647674.png)





pom文件：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <artifactId>pay</artifactId>
        <groupId>mao</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>

    <artifactId>aggregate-pay-sms</artifactId>
    <name>${project.artifactId}</name>
    <description>aggregate-pay-sms</description>
    <properties>

    </properties>

    <dependencies>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>

        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-pool2</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-configuration-processor</artifactId>
            <optional>true</optional>
        </dependency>

        <dependency>
            <groupId>mao</groupId>
            <artifactId>tools-swagger2</artifactId>
        </dependency>

        <dependency>
            <groupId>com.github.qcloudsms</groupId>
            <artifactId>qcloudsms</artifactId>
            <version>1.0.6</version>
        </dependency>

        <dependency>
            <groupId>commons-lang</groupId>
            <artifactId>commons-lang</artifactId>
            <version>2.6</version>
            <scope>compile</scope>
        </dependency>

        <!-- nacos 客户端依赖 -->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
        </dependency>

        <!--Nacos配置管理客户端依赖-->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
        </dependency>

        <dependency>
            <groupId>mao</groupId>
            <artifactId>sms-sdk</artifactId>
        </dependency>

    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>

</project>
```







父模块pay的pom文件：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>apps</artifactId>
        <groupId>mao</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>

    <modelVersion>4.0.0</modelVersion>

    <artifactId>pay</artifactId>
    <packaging>pom</packaging>
    <name>${project.artifactId}</name>
    <description>聚合支付系统父工程</description>

    <properties>

    </properties>

    <modules>
        <module>aggregate-pay-common</module>
        <module>aggregate-pay-merchant</module>
        <module>aggregate-pay-merchant-application</module>
        <module>aggregate-pay-sms</module>
    </modules>

    <dependencyManagement>
        <dependencies>

            <dependency>
                <groupId>mao</groupId>
                <artifactId>aggregate-pay-common</artifactId>
                <version>${project.version}</version>
            </dependency>
            <dependency>
                <groupId>mao</groupId>
                <artifactId>aggregate-pay-merchant-application</artifactId>
                <version>${project.version}</version>
            </dependency>
            <dependency>
                <groupId>mao</groupId>
                <artifactId>aggregate-pay-merchant-api</artifactId>
                <version>${project.version}</version>
            </dependency>
            <dependency>
                <groupId>mao</groupId>
                <artifactId>aggregate-pay-merchant-service</artifactId>
                <version>${project.version}</version>
            </dependency>
            <dependency>
                <groupId>mao</groupId>
                <artifactId>aggregate-pay-sms</artifactId>
                <version>${project.version}</version>
            </dependency>

        </dependencies>
    </dependencyManagement>

    <dependencies>

    </dependencies>

</project>
```





bootstrap.yml

```yaml
# @xxx@ 从pom.xml中取值, 所以 @xx@ 标注的值，都不能从nacos中获取
def:
  nacos:
    ip: ${NACOS_IP:@pom.nacos.ip@}
    port: ${NACOS_PORT:@pom.nacos.port@}
    namespace: ${NACOS_ID:@pom.nacos.namespace@}

spring:
  main:
    allow-bean-definition-overriding: true
  application:
    name: @project.artifactId@
  profiles:
    active: @pom.profile.name@
  cloud:
    nacos:
      config: #配置中心相关
        server-addr: ${def.nacos.ip}:${def.nacos.port}
        file-extension: yml
        namespace: ${def.nacos.namespace}
        shared-dataids: common.yml,redis.yml
        refreshable-dataids: common.yml
        enabled: true
      discovery: #服务注册中心相关
        # 是否为临时实例
        ephemeral: false
        server-addr: ${def.nacos.ip}:${def.nacos.port}
        namespace: ${def.nacos.namespace}
        metadata: # 元数据，用于权限服务实时获取各个服务的所有接口
          management.context-path: ${server.servlet.context-path:}${spring.mvc.servlet.path:}${management.endpoints.web.base-path:}


  aop:
    proxy-target-class: true
    auto: true

# 只能配置在bootstrap.yml ，否则会生成 log.path_IS_UNDEFINED 文件夹
# window会自动在 代码所在盘 根目录下自动创建文件夹，  如： D:/data/projects/logs
logging:
  file:
    path: ./logs
    name: ${logging.file.path}/${spring.application.name}/root.log

# 用于/actuator/info
info:
  name: '@project.name@'
  description: '@project.description@'
  version: '@project.version@'
  spring-boot-version: '@spring.boot.version@'
  spring-cloud-version: '@spring.cloud.version@'
```





application.yml

```yaml
server:
  port: 35478
```





**nacos配置：**



aggregate-pay-sms.yml

```yaml

swagger:
  enabled: true
  docket:
    aggregate_pay:
      title: 验证码服务
      base-package: mao.aggregate_pay_sms

sms:
  auth: false
  domain: http://localhost:8771
  accessKeyId: 424b97df0839412f9783304c9c46a01a
  accessKeySecret: 7b2fb98ca7d74360a05c53442fe56c58
```



aggregate-pay-sms-dev.yml

```yaml

# 设置日志级别，root表示根节点，即整体应用日志级别
logging:
  level:
    root: info
    # 为对应组设置日志级别
    mao: debug
```





模块代码结构：

![image-20230110151739681](img/聚合支付项目实战学习笔记/image-20230110151739681.png)















### 关键代码

#### SmsService

短信发送接口

```java
package mao.aggregate_pay_sms.sms;


public interface SmsService
{

    /**
     * 发送短信
     *
     * @param mobile  手机号
     * @param content 内容
     */
    default void send(String mobile, String content)
    {
    }

    /**
     * 发送短信验证码
     *
     * @param mobile        手机号
     * @param code          代码
     * @param effectiveTime 有效时间
     */
    void send(String mobile, String code, int effectiveTime);

    /**
     * 在控制台输出验证码，模拟发送短信
     *
     * @param mobile        手机号
     * @param code          代码
     * @param effectiveTime 有效时间
     */
    void sendOnConsole(String mobile, String code, int effectiveTime);

}
```





#### SmsServiceImpl

短信发送接口实现类

```java
package mao.aggregate_pay_sms.sms;

import lombok.extern.slf4j.Slf4j;
import mao.sms_sdk.dto.R;
import mao.sms_sdk.dto.SmsParamsDTO;
import mao.sms_sdk.service.SmsSendService;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.util.HashMap;
import java.util.Map;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_sms.sms
 * Class(类名): SmsServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 14:23
 * Version(版本): 1.0
 * Description(描述)： 短信发送至短信服务
 */

@Slf4j
@Service
public class SmsServiceImpl implements SmsService
{

    @Resource
    private SmsSendService smsSendService;

    @Override
    public void send(String mobile, String code, int effectiveTime)
    {
        log.info("给手机号" + mobile + "发送验证码：" + code);
        //构建短信发送对象
        SmsParamsDTO smsParamsDTO = new SmsParamsDTO();
        //设置手机号
        smsParamsDTO.setMobile(mobile);
        //设置签名编码，聚合支付平台
        smsParamsDTO.setSignature("DXQM_000000002");
        //设置短信模板编码
        smsParamsDTO.setTemplate("DXMB_000000001");
        //设置参数
        Map<String, String> map = new HashMap<>();
        map.put("code", code);
        smsParamsDTO.setParams(map);
        //发送短信至短信接收服务
        R<Boolean> result = smsSendService.sendSms(smsParamsDTO);
        //查看短信发送结果
        if (result.getIsError())
        {
            log.warn("短信发送失败！手机号：" + mobile + "，失败信息：" + result.getMsg());
            return;
        }
        log.info("给手机号 " + mobile + " 发送短信成功");
    }

    @Override
    public void sendOnConsole(String mobile, String code, int effectiveTime)
    {
        log.info("给手机号" + mobile + "发送验证码：" + code);
    }
}
```





#### BusinessConfig

业务相关的配置类

```java
package mao.aggregate_pay_sms.config;


import mao.aggregate_pay_sms.handler.AbstractVerificationHandler;
import mao.aggregate_pay_sms.handler.SmsNumberVerificationHandler;
import mao.aggregate_pay_sms.sms.SmsService;
import mao.aggregate_pay_sms.sms.qcloud.QCloudSmsService;
import mao.aggregate_pay_sms.store.VerificationStore;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Configuration
public class BusinessConfig
{

    /**
     * 验证存储
     */
    @Autowired
    private VerificationStore verificationStore;

    /**
     * 短信服务
     */
    @Autowired
    private SmsService smsService;

    /**
     * 短信验证处理器数量
     *
     * @return {@link SmsNumberVerificationHandler}
     */
    @Bean
    public SmsNumberVerificationHandler smsNumberVerificationHandler()
    {
        SmsNumberVerificationHandler smsNumberVerificationHandler = new SmsNumberVerificationHandler("sms", 6);
        smsNumberVerificationHandler.setVerificationStore(verificationStore);
        smsNumberVerificationHandler.setSmsService(smsService);
        return smsNumberVerificationHandler;
    }

    /**
     * 验证处理程序映射
     *
     * @return {@link Map}<{@link String}, {@link AbstractVerificationHandler}>
     */
    @Bean
    public Map<String, AbstractVerificationHandler> verificationHandlerMap()
    {
        List<AbstractVerificationHandler> verificationHandlerList = new ArrayList<>();
        verificationHandlerList.add(smsNumberVerificationHandler());

        Map<String, AbstractVerificationHandler> verificationHandlerMap = new HashMap<>();
        for (AbstractVerificationHandler handler : verificationHandlerList)
        {
            verificationHandlerMap.put(handler.getName(), handler);
        }
        return verificationHandlerMap;
    }

}
```





#### VerificationController

```java
package mao.aggregate_pay_sms.controller;


import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiImplicitParams;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_sms.common.domain.RestResponse;
import mao.aggregate_pay_sms.dto.VerificationInfo;
import mao.aggregate_pay_sms.service.VerificationService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.util.Map;

@Api(tags = "验证码服务接口")
@RestController
public class VerificationController
{

    @Autowired
    private VerificationService verificationService;


    /**
     * 生成验证信息
     *
     * @param name          名字，这里的名字统一为sms
     * @param payload       有效载荷，位于请求体里。请求体示例：
     *                      {
     *                      "mobile":"18877888888"
     *                      }
     * @param effectiveTime 有效时间
     * @return {@link RestResponse}<{@link VerificationInfo}>
     * 响应示例：
     * <pre>
     * {
     *   "code": 0,
     *   "msg": "",
     *   "result":
     *   {
     *     "key": "sms:530a167172a24677a1cb0c44541b7be8",
     *     "content": null
     *   }
     * }
     * </pre>
     */
    @ApiOperation(value = "生成验证信息", notes = "生成验证信息")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "name", value = "业务名称", required = true, dataType = "String", paramType = "query"),
                    @ApiImplicitParam(name = "payload", value = "业务携带参数，如手机号 ，邮箱", required = true, paramType = "body"),
                    @ApiImplicitParam(name = "effectiveTime", value = "验证信息有效期(秒)", required = false, dataType = "String", paramType = "query")
            })
    @PostMapping(value = "/generate")
    public RestResponse<VerificationInfo> generateVerificationInfo(@RequestParam("name") String name,
                                                                   @RequestBody Map<String, Object> payload,
                                                                   @RequestParam("effectiveTime") int effectiveTime)
    {
        VerificationInfo verificationInfo = verificationService.generateVerificationInfo(name, payload, effectiveTime);
        return RestResponse.success(verificationInfo);
    }


    /**
     * 验证短信是否正确
     *
     * @param name             名字，这里的名字统一为sms
     * @param verificationKey  验证的key，例如：sms:530a167172a24677a1cb0c44541b7be8
     * @param verificationCode 验证码
     * @return {@link RestResponse}<{@link Boolean}>
     * 响应示例：
     * <pre>
     * {
     *   "code": 0,
     *   "msg": "",
     *   "result": false
     * }
     * </pre>
     */
    @ApiOperation(value = "校验", notes = "校验")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "name", value = "业务名称", required = true, dataType = "String", paramType = "query"),
                    @ApiImplicitParam(name = "verificationKey", value = "验证key", required = true, dataType = "String", paramType = "query"),
                    @ApiImplicitParam(name = "verificationCode", value = "验证码", required = true, dataType = "String", paramType = "query")
            })
    @PostMapping(value = "/verify")
    public RestResponse<Boolean> verify(String name, String verificationKey, String verificationCode)
    {
        Boolean isSuccess = verificationService.verify(name, verificationKey, verificationCode);
        return RestResponse.success(isSuccess);
    }


}
```















### 使用验证码服务

#### 发送验证码

**接口地址**:`/generate`


**请求方式**:`POST`


**请求数据类型**:`application/json`


**响应数据类型**:`*/*`


**接口描述**:生成验证信息



**请求参数**:


| 参数名称      | 参数说明                        | in    | 是否必须 | 数据类型 | schema |
| ------------- | ------------------------------- | ----- | -------- | -------- | ------ |
| name          | 业务名称，短信的业务名称为"sms" | query | true     | string   |        |
| payload       | 业务携带参数，如手机号 ，邮箱   | body  | true     | string   |        |
| effectiveTime | 验证信息有效期(秒)              | query | false    | string   |        |



**响应状态**:


| 状态码 | 说明         | schema                            |
| ------ | ------------ | --------------------------------- |
| 200    | OK           | RestResponse<T>«VerificationInfo» |
| 201    | Created      |                                   |
| 401    | Unauthorized |                                   |
| 403    | Forbidden    |                                   |
| 404    | Not Found    |                                   |



**响应参数**:


| 参数名称            | 参数说明             | 类型             | schema           |
| ------------------- | -------------------- | ---------------- | ---------------- |
| code                | 响应错误编码,0为正常 | integer(int32)   | integer(int32)   |
| msg                 | 响应错误信息         | string           |                  |
| result              | 响应内容             | VerificationInfo | VerificationInfo |
| &emsp;&emsp;content |                      | string           |                  |
| &emsp;&emsp;key     |                      | string           |                  |



**请求体示例：**

```json
{
    "mobile":"18877888888"
}
```



**响应示例**:

```javascript
{
	"code": 0,
	"msg": "",
	"result": 
    {
		"content": "",
		"key": ""
	}
}
```







![image-20230110152426573](img/聚合支付项目实战学习笔记/image-20230110152426573.png)



![image-20230110152436331](img/聚合支付项目实战学习笔记/image-20230110152436331.png)





![image-20230110152445542](img/聚合支付项目实战学习笔记/image-20230110152445542.png)





日志：

```sh
2023-01-10 14:56:27.201  INFO 23012 --- [io-35478-exec-1] m.aggregate_pay_sms.sms.SmsServiceImpl   : 给手机号18877888888发送验证码：641903
2023-01-10 14:56:27.261  INFO 23012 --- [io-35478-exec-1] m.s.service.impl.SmsSendServiceImpl      : httpRequest access success, StatusCode is:200
2023-01-10 14:56:27.262  INFO 23012 --- [io-35478-exec-1] m.s.service.impl.SmsSendServiceImpl      : responseContent is :{"code":-10,"data":null,"msg":"未找到支持当前签名和模板的通道","path":null,"extra":null,"timestamp":"1673333787259","isSuccess":false,"isError":true}
2023-01-10 14:56:27.262  WARN 23012 --- [io-35478-exec-1] m.aggregate_pay_sms.sms.SmsServiceImpl   : 短信发送失败！手机号：18877888888，失败信息：未找到支持当前签名和模板的通道
```













#### 校验验证码

**接口地址**:`/verify`


**请求方式**:`POST`


**请求数据类型**:`application/json`


**响应数据类型**:`*/*`

**接口描述**:校验




**请求参数**:


| 参数名称         | 参数说明 | in    | 是否必须 | 数据类型 | schema |
| ---------------- | -------- | ----- | -------- | -------- | ------ |
| name             | 业务名称 | query | true     | string   |        |
| verificationCode | 验证码   | query | true     | string   |        |
| verificationKey  | 验证key  | query | true     | string   |        |



**响应参数**:


| 参数名称 | 参数说明             | 类型           | schema         |
| -------- | -------------------- | -------------- | -------------- |
| code     | 响应错误编码,0为正常 | integer(int32) | integer(int32) |
| msg      | 响应错误信息         | string         |                |
| result   | 响应内容             | boolean        |                |





**响应示例**:

```javascript
{
	"code": 0,
	"msg": "",
	"result": true
}
```







![image-20230110152932143](img/聚合支付项目实战学习笔记/image-20230110152932143.png)





![image-20230110152946153](img/聚合支付项目实战学习笔记/image-20230110152946153.png)





![image-20230110152953241](img/聚合支付项目实战学习笔记/image-20230110152953241.png)



















### 获取短信验证码

在商户应用模块创建包feign.sms



#### feign接口

创建feign接口VerificationFeignClient

```java
package mao.aggregate_pay_merchant_application.feign.sms;

import mao.aggregate_pay_common.domain.RestResponse;
import mao.aggregate_pay_merchant_application.dto.VerificationInfo;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestParam;

import java.util.Map;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.feign.sms
 * Class(类名): VerificationFeignClient
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 20:16
 * Version(版本): 1.0
 * Description(描述)： 通过feign去远程调用sms的VerificationController
 * FeignClient注解的value为服务名
 */

@FeignClient(value = "aggregate-pay-sms", path = "")
public interface VerificationFeignClient
{
    /**
     * 生成验证信息
     *
     * @param name          名字，这里的名字统一为sms
     * @param payload       有效载荷，位于请求体里。请求体示例：
     *                      {
     *                      "mobile":"18877888888"
     *                      }
     * @param effectiveTime 有效时间
     * @return {@link RestResponse}<{@link VerificationInfo}>
     * 响应示例：
     * <pre>
     * {
     *   "code": 0,
     *   "msg": "",
     *   "result":
     *   {
     *     "key": "sms:530a167172a24677a1cb0c44541b7be8",
     *     "content": null
     *   }
     * }
     * </pre>
     */
    @PostMapping(value = "/generate")
    RestResponse<VerificationInfo> generateVerificationInfo(@RequestParam("name") String name,
                                                            @RequestBody Map<String, Object> payload,
                                                            @RequestParam("effectiveTime") int effectiveTime);


    /**
     * 验证短信是否正确
     *
     * @param name             名字，这里的名字统一为sms
     * @param verificationKey  验证的key，例如：sms:530a167172a24677a1cb0c44541b7be8
     * @param verificationCode 验证码
     * @return {@link RestResponse}<{@link Boolean}>
     * 响应示例：
     * <pre>
     * {
     *   "code": 0,
     *   "msg": "",
     *   "result": false
     * }
     * </pre>
     */
    @PostMapping(value = "/verify")
    RestResponse<Boolean> verify(@RequestParam("name") String name, @RequestParam String verificationKey, @RequestParam String verificationCode);

}
```



注意：要在启动类上添加注解@EnableFeignClients







#### 单元测试



```java
package mao.aggregate_pay_merchant_application.feign.sms;

import mao.aggregate_pay_common.domain.RestResponse;
import mao.aggregate_pay_merchant_application.dto.VerificationInfo;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.util.HashMap;
import java.util.Map;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.feign.sms
 * Class(测试类名): VerificationFeignClientTest
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 20:27
 * Version(版本): 1.0
 * Description(描述)： 测试类
 */

@SpringBootTest
class VerificationFeignClientTest
{
    @Autowired
    private VerificationFeignClient verificationFeignClient;

    @Test
    void generateVerificationInfo()
    {
        Map<String, Object> map = new HashMap<>();
        map.put("mobile", "18166887788");
        RestResponse<VerificationInfo> response = verificationFeignClient.generateVerificationInfo("sms", map, 600);
        System.out.println(response.getCode());
        System.out.println(response.getMsg());
        VerificationInfo verificationInfo = response.getResult();
        System.out.println(verificationInfo.getContent());
        System.out.println(verificationInfo.getKey());
    }

    @Test
    void verify()
    {
        RestResponse<Boolean> response = verificationFeignClient.verify("sms", "sms:cfe3e1fdf1b348cf986a2d612bcae497", "941665");
        System.out.println(response.getResult());
    }
}
```





#### 测试

![image-20230110204440184](img/聚合支付项目实战学习笔记/image-20230110204440184.png)















### 商户平台应用获取验证码

接口交互流程如下：

1. 获取手机号
2. 向验证码服务请求发送验证码并得到响应
3. 响应前端验证码发送结果



在MerchantController类中添加getSMSCode接口方法，此接口供前端调用



```java
package mao.aggregate_pay_merchant_application.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_merchant_application.feign.sms.VerificationFeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import javax.annotation.Resource;
import java.util.HashMap;
import java.util.Map;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.controller
 * Class(类名): MerchantController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 21:49
 * Version(版本): 1.0
 * Description(描述)： 商户
 */

@Slf4j
@RestController
@Api(tags = "商户平台应用接口")
public class MerchantController
{

    @Resource
    private VerificationFeignClient verificationFeignClient;

    /**
     * 发送验证码
     *
     * @param phone 电话
     * @return {@link String} 验证码的key
     */
    @ApiOperation("获取手机验证码")
    @GetMapping("/sms")
    @ApiImplicitParam(value = "手机号", name = "phone", required = true, dataType = "string", paramType = "query")
    public String getSMSCode(@RequestParam("phone") String phone)
    {
        log.info("向手机号:{}发送验证码", phone);
        //向验证码服务请求发送验证码
        Map<String, Object> map = new HashMap<>();
        map.put("mobile", phone);
        return verificationFeignClient.generateVerificationInfo("sms", map, 20 * 60).getResult().getKey();
    }
}
```











## 商户注册

### 系统设计

商户拿到获取的验证码即可提交注册信息，完成商户注册，本节完成商户注册功能

商户注册信息向三个地方写入数据：

当前阶段暂时只向商户表写入数据 ，待接入SaaS系统时向员工表、SaaS系统写入



![image-20230110210121350](img/聚合支付项目实战学习笔记/image-20230110210121350.png)







商户注册表的数据模型如下：



```java
package mao.aggregate_pay_merchant_service.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Builder;
import lombok.Data;
import lombok.EqualsAndHashCode;

import java.io.Serializable;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.entity
 * Class(类名): Merchant
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 14:31
 * Version(版本): 1.0
 * Description(描述)： 商户
 */

@Data
@EqualsAndHashCode
@Builder
@TableName("merchant")
public class Merchant implements Serializable
{
    /**
     * 串行版本uid
     */
    private static final long serialVersionUID = 1L;

    /**
     * 主键
     */
    @TableId(value = "ID", type = IdType.ID_WORKER)
    private Long id;

    /**
     * 商户名称
     */
    @TableField("MERCHANT_NAME")
    private String merchantName;

    /**
     * 企业编号
     */
    @TableField("MERCHANT_NO")
    private Long merchantNo;

    /**
     * 企业地址
     */
    @TableField("MERCHANT_ADDRESS")
    private String merchantAddress;

    /**
     * 商户类型
     */
    @TableField("MERCHANT_TYPE")
    private String merchantType;

    /**
     * 营业执照（企业证明）
     */
    @TableField("BUSINESS_LICENSES_IMG")
    private String businessLicensesImg;

    /**
     * 法人身份证正面照片
     */
    @TableField("ID_CARD_FRONT_IMG")
    private String idCardFrontImg;

    /**
     * 法人身份证反面照片
     */
    @TableField("ID_CARD_AFTER_IMG")
    private String idCardAfterImg;

    /**
     * 联系人姓名
     */
    @TableField("USERNAME")
    private String username;

    /**
     * 联系人手机号(关联统一账号)
     */
    @TableField("MOBILE")
    private String mobile;

    /**
     * 联系人地址
     */
    @TableField("CONTACTS_ADDRESS")
    private String contactsAddress;

    /**
     * 审核状态 0-未申请,1-已申请待审核,2-审核通过,3-审核拒绝
     */
    @TableField("AUDIT_STATUS")
    private String auditStatus;

    /**
     * 租户ID,关联统一用户
     */
    @TableField("TENANT_ID")
    private Long tenantId;
}
```







### 商户服务注册商户

#### 接口定义

在商户服务定义商户注册接口

```java
package mao.aggregate_pay_merchant_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_service.entity.Merchant;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service
 * Interface(接口名): MerchantService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:29
 * Version(版本): 1.0
 * Description(描述)： 商户服务接口
 */

public interface MerchantService extends IService<Merchant>
{
    /**
     * 通过id获取商户信息
     *
     * @param merchantId 商户id
     * @return {@link MerchantDTO}
     */
    MerchantDTO getMerchantById(Long merchantId);


    /**
     * 商户注册
     *
     * @param merchantDTO {@link MerchantDTO} 商户dto
     * @return {@link MerchantDTO}
     */
    MerchantDTO createMerchant(MerchantDTO merchantDTO);

}
```







#### 接口实现

实现MerchantServiceImpl中的createMerchant方法

```java
package mao.aggregate_pay_merchant_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_service.entity.Merchant;
import mao.aggregate_pay_merchant_service.mapper.MerchantMapper;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.toolsdozer.utils.DozerUtils;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service.impl
 * Class(类名): MerchantServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:38
 * Version(版本): 1.0
 * Description(描述)： 商户服务实现类
 */

@Service
public class MerchantServiceImpl extends ServiceImpl<MerchantMapper, Merchant> implements MerchantService
{

    @Resource
    private DozerUtils dozerUtils;

    @Override
    public MerchantDTO getMerchantById(Long merchantId)
    {
        //查询
        Merchant merchant = this.getById(merchantId);
        //转换，并返回
        return dozerUtils.map(merchant, MerchantDTO.class);
    }

    @Override
    public MerchantDTO createMerchant(MerchantDTO merchantDTO)
    {
        //构建商户
        Merchant merchant = new Merchant();
        //设置审核状态
        merchant.setAuditStatus("0");
        //设置手机号
        merchant.setMobile(merchantDTO.getMobile());
        //保存
        this.save(merchant);
        //保存id信息
        merchantDTO.setId(merchant.getId());
        //返回
        return merchantDTO;
    }
}
```







### 商户平台应用注册商户

#### 接口定义

接口描述：

1. 接收商户填写的注册数据
2. 商户平台应用校验手机验证码
3. 请求商户服务进行商户注册
4. 返回注册结果给前端





#### 定义商户注册VO

在商户应用服务里定义

```java
package mao.aggregate_pay_merchant_application.vo;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import java.io.Serializable;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.vo
 * Class(类名): MerchantRegisterVO
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 21:18
 * Version(版本): 1.0
 * Description(描述)： 商户注册vo
 */
@Data
@ApiModel(value = "MerchantRegisterVO", description = "商户注册信息")
public class MerchantRegisterVO implements Serializable
{
    /**
     * 商户手机号
     */
    @ApiModelProperty("商户手机号")
    private String mobile;

    /**
     * 商户用户名
     */
    @ApiModelProperty("商户用户名")
    private String username;

    /**
     * 商户密码
     */
    @ApiModelProperty("商户密码")
    private String password;

    /**
     * 验证码的key
     */
    @ApiModelProperty("验证码的key")
    private String verifiykey;

    /**
     * 验证码
     */
    @ApiModelProperty("验证码")
    private String verifiyCode;
}
```







#### 修改商户服务controller

```java
package mao.aggregate_pay_merchant_service.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.tools_core.base.BaseController;
import mao.tools_core.base.R;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.controller
 * Class(类名): MerchantController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:53
 * Version(版本): 1.0
 * Description(描述)： 商户Controller
 */

@RestController
@Api(tags = "商户")
@RequestMapping("/merchant")
public class MerchantController extends BaseController
{

    @Resource
    private MerchantService merchantService;

    @ApiOperation("根据商户id查询商户信息")
    @GetMapping("/{merchantId}")
    public R<MerchantDTO> getById(@PathVariable Long merchantId)
    {
        return R.success(merchantService.getMerchantById(merchantId));
    }

    @ApiOperation("注册商户")
    @PostMapping
    public R<MerchantDTO> createMerchant(@RequestBody MerchantDTO merchantDTO)
    {
        return R.success(merchantService.createMerchant(merchantDTO));
    }
}

```







#### 编写feign接口

在商户服务api模块里编写



```java
package mao.aggregate_pay_merchant_api.feign;

import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.tools_core.base.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_api.feign
 * Interface(接口名): MerchantFeignClient
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 21:26
 * Version(版本): 1.0
 * Description(描述)： 商户服务feign接口
 */

@FeignClient(value = "aggregate-pay-merchant-service", path = "/merchant")
public interface MerchantFeignClient
{
    @GetMapping("/{merchantId}")
    R<MerchantDTO> getById(@PathVariable Long merchantId);

    @PostMapping
    R<MerchantDTO> createMerchant(@RequestBody MerchantDTO merchantDTO);
}

```









#### 校验验证码实现

在SmsService中定义校验验证码的service接口



```java
package mao.aggregate_pay_merchant_application.service;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.service
 * Interface(接口名): SmsService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 21:34
 * Version(版本): 1.0
 * Description(描述)： 验证码服务
 */

public interface SmsService
{
    /**
     * 校验验证码，校验失败，抛出异常
     *
     * @param verifyKey  验证码的key
     * @param verifyCode 验证码
     */
    void checkVerifyCode(String verifyKey, String verifyCode);
}
```





实现类

```java
package mao.aggregate_pay_merchant_application.service.Impl;

import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_common.domain.RestResponse;
import mao.aggregate_pay_merchant_application.feign.sms.VerificationFeignClient;
import mao.aggregate_pay_merchant_application.service.SmsService;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.service.Impl
 * Class(类名): SmsServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 21:34
 * Version(版本): 1.0
 * Description(描述)： 无
 */

@Slf4j
@Service
public class SmsServiceImpl implements SmsService
{
    @Resource
    private VerificationFeignClient verificationFeignClient;

    @Override
    public void checkVerifyCode(String verifyKey, String verifyCode)
    {
        try
        {
            //发起远程调用
            RestResponse<Boolean> response = verificationFeignClient.verify("sms", verifyKey, verifyCode);
            //判断结果
            if (!response.getResult())
            {
                //失败
                throw new RuntimeException("验证码错误或者验证码已过期");
            }
        }
        catch (Exception e)
        {
            log.error("验证码服务异常：", e);
            throw new RuntimeException("验证码错误或者验证码已过期");
        }

    }
}
```







#### 调用校验验证码

在controller中调用校验验证码

```java
package mao.aggregate_pay_merchant_application.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_merchant_application.feign.sms.VerificationFeignClient;
import mao.aggregate_pay_merchant_application.service.SmsService;
import mao.aggregate_pay_merchant_application.vo.MerchantRegisterVO;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.HashMap;
import java.util.Map;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.controller
 * Class(类名): MerchantController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 21:49
 * Version(版本): 1.0
 * Description(描述)： 商户
 */

@Slf4j
@RestController
@Api(tags = "商户平台应用接口")
public class MerchantController
{

    @Resource
    private VerificationFeignClient verificationFeignClient;

    @Resource
    private SmsService smsService;

    /**
     * 发送验证码
     *
     * @param phone 电话
     * @return {@link String} 验证码的key
     */
    @ApiOperation("获取手机验证码")
    @GetMapping("/sms")
    @ApiImplicitParam(value = "手机号", name = "phone", required = true, dataType = "string", paramType = "query")
    public String getSMSCode(@RequestParam("phone") String phone)
    {
        log.info("向手机号:{}发送验证码", phone);
        //向验证码服务请求发送验证码
        Map<String, Object> map = new HashMap<>();
        map.put("mobile", phone);
        return verificationFeignClient.generateVerificationInfo("sms", map, 20 * 60).getResult().getKey();
    }

    /**
     * 注册商户
     *
     * @param merchantRegister MerchantRegisterVO
     * @return {@link MerchantRegisterVO}
     */
    @PostMapping("/merchants/register")
    @ApiOperation("商户注册")
    @ApiImplicitParam(value = "商户注册信息", name = "merchantRegisterVO", required = true, dataType = "MerchantRegisterVO", paramType = "body")
    public MerchantRegisterVO registerMerchant(@RequestBody MerchantRegisterVO merchantRegister)
    {
        if (merchantRegister.getMobile() == null || merchantRegister.getMobile().equals(""))
        {
            throw new RuntimeException("请输入手机号");
        }
        if (merchantRegister.getVerifiykey() == null || merchantRegister.getVerifiykey().equals(""))
        {
            throw new RuntimeException("验证码的key为空");
        }
        if (merchantRegister.getVerifiyCode() == null || merchantRegister.getVerifiyCode().equals(""))
        {
            throw new RuntimeException("请输入验证码");
        }
        smsService.checkVerifyCode(merchantRegister.getVerifiykey(), merchantRegister.getVerifiyCode());
        return merchantRegister;
    }
}

```









#### 注册商户实现

```java
package mao.aggregate_pay_merchant_application.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.feign.MerchantFeignClient;
import mao.aggregate_pay_merchant_application.feign.sms.VerificationFeignClient;
import mao.aggregate_pay_merchant_application.service.SmsService;
import mao.aggregate_pay_merchant_application.vo.MerchantRegisterVO;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.HashMap;
import java.util.Map;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.controller
 * Class(类名): MerchantController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 21:49
 * Version(版本): 1.0
 * Description(描述)： 商户
 */

@Slf4j
@RestController
@Api(tags = "商户平台应用接口")
public class MerchantController
{

    @Resource
    private VerificationFeignClient verificationFeignClient;

    @Resource
    private SmsService smsService;

    @Resource
    private MerchantFeignClient merchantFeignClient;

    /**
     * 发送验证码
     *
     * @param phone 电话
     * @return {@link String} 验证码的key
     */
    @ApiOperation("获取手机验证码")
    @GetMapping("/sms")
    @ApiImplicitParam(value = "手机号", name = "phone", required = true, dataType = "string", paramType = "query")
    public String getSMSCode(@RequestParam("phone") String phone)
    {
        log.info("向手机号:{}发送验证码", phone);
        //向验证码服务请求发送验证码
        Map<String, Object> map = new HashMap<>();
        map.put("mobile", phone);
        return verificationFeignClient.generateVerificationInfo("sms", map, 20 * 60).getResult().getKey();
    }

    /**
     * 注册商户
     *
     * @param merchantRegisterVO MerchantRegisterVO
     * @return {@link MerchantRegisterVO}
     */
    @PostMapping("/merchants/register")
    @ApiOperation("商户注册")
    @ApiImplicitParam(value = "商户注册信息", name = "merchantRegisterVO", required = true, dataType = "MerchantRegisterVO", paramType = "body")
    public MerchantRegisterVO registerMerchant(@RequestBody MerchantRegisterVO merchantRegisterVO)
    {
        if (merchantRegisterVO.getMobile() == null || merchantRegisterVO.getMobile().equals(""))
        {
            throw new RuntimeException("请输入手机号");
        }
        if (merchantRegisterVO.getVerifiykey() == null || merchantRegisterVO.getVerifiykey().equals(""))
        {
            throw new RuntimeException("验证码的key为空");
        }
        if (merchantRegisterVO.getVerifiyCode() == null || merchantRegisterVO.getVerifiyCode().equals(""))
        {
            throw new RuntimeException("请输入验证码");
        }
        smsService.checkVerifyCode(merchantRegisterVO.getVerifiykey(), merchantRegisterVO.getVerifiyCode());

        //注册商户
        MerchantDTO merchantDTO = new MerchantDTO();
        merchantDTO.setUsername(merchantRegisterVO.getUsername());
        merchantDTO.setMobile(merchantRegisterVO.getMobile());
        merchantDTO.setPassword(merchantRegisterVO.getPassword());
        //远程调用
        merchantFeignClient.createMerchant(merchantDTO);
        //返回
        return merchantRegisterVO;

    }
}
```











### 接口测试

文档地址：http://127.0.0.1:57010/doc.html#/home



![image-20230110221220015](img/聚合支付项目实战学习笔记/image-20230110221220015.png)





获取手机验证码：

![image-20230110221253390](img/聚合支付项目实战学习笔记/image-20230110221253390.png)





![image-20230110221404151](img/聚合支付项目实战学习笔记/image-20230110221404151.png)





商户注册：

![image-20230110221507935](img/聚合支付项目实战学习笔记/image-20230110221507935.png)





![image-20230110221522367](img/聚合支付项目实战学习笔记/image-20230110221522367.png)





日志：

```sh
2023-01-10 22:13:40.829  INFO 14872 --- [io-57010-exec-6] m.a.controller.MerchantController        : 向手机号:18188888888发送验证码
2023-01-10 22:13:40.994 DEBUG 14872 --- [egate-pay-sms-1] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] ---> POST http://aggregate-pay-sms/generate?name=sms&effectiveTime=1200 HTTP/1.1
2023-01-10 22:13:40.994 DEBUG 14872 --- [egate-pay-sms-1] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] Accept-Encoding: gzip
2023-01-10 22:13:40.994 DEBUG 14872 --- [egate-pay-sms-1] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] Accept-Encoding: deflate
2023-01-10 22:13:40.994 DEBUG 14872 --- [egate-pay-sms-1] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] Content-Length: 24
2023-01-10 22:13:40.994 DEBUG 14872 --- [egate-pay-sms-1] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] Content-Type: application/json
2023-01-10 22:13:40.994 DEBUG 14872 --- [egate-pay-sms-1] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] ---> END HTTP (24-byte body)
2023-01-10 22:13:41.128  INFO 14872 --- [egate-pay-sms-1] c.netflix.config.ChainedDynamicProperty  : Flipping property: aggregate-pay-sms.ribbon.ActiveConnectionsLimit to use NEXT property: niws.loadbalancer.availabilityFilteringRule.activeConnectionsLimit = 2147483647
2023-01-10 22:13:41.142  INFO 14872 --- [egate-pay-sms-1] c.netflix.loadbalancer.BaseLoadBalancer  : Client: aggregate-pay-sms instantiated a LoadBalancer: DynamicServerListLoadBalancer:{NFLoadBalancer:name=aggregate-pay-sms,current list of Servers=[],Load balancer stats=Zone stats: {},Server stats: []}ServerList:null
2023-01-10 22:13:41.147  INFO 14872 --- [egate-pay-sms-1] c.n.l.DynamicServerListLoadBalancer      : Using serverListUpdater PollingServerListUpdater
2023-01-10 22:13:41.152  INFO 14872 --- [egate-pay-sms-1] com.alibaba.nacos.client.naming          : new ips(2) service: DEFAULT_GROUP@@aggregate-pay-sms -> [{"instanceId":"192.168.3.143#35478#DEFAULT#DEFAULT_GROUP@@aggregate-pay-sms","ip":"192.168.3.143","port":35478,"weight":1.0,"healthy":true,"enabled":true,"ephemeral":false,"clusterName":"DEFAULT","serviceName":"DEFAULT_GROUP@@aggregate-pay-sms","metadata":{"preserved.register.source":"SPRING_CLOUD","management.endpoints.web.base-path":"/actuator","management.context-path":"/actuator"},"ipDeleteTimeout":30000,"instanceHeartBeatInterval":5000,"instanceHeartBeatTimeOut":15000},{"instanceId":"192.168.3.143#45739#DEFAULT#DEFAULT_GROUP@@aggregate-pay-sms","ip":"192.168.3.143","port":45739,"weight":1.0,"healthy":false,"enabled":true,"ephemeral":false,"clusterName":"DEFAULT","serviceName":"DEFAULT_GROUP@@aggregate-pay-sms","metadata":{"preserved.register.source":"SPRING_CLOUD","management.endpoints.web.base-path":"/actuator","management.context-path":"/actuator"},"ipDeleteTimeout":30000,"instanceHeartBeatInterval":5000,"instanceHeartBeatTimeOut":15000}]
2023-01-10 22:13:41.158  INFO 14872 --- [egate-pay-sms-1] com.alibaba.nacos.client.naming          : current ips:(2) service: DEFAULT_GROUP@@aggregate-pay-sms -> [{"instanceId":"192.168.3.143#45739#DEFAULT#DEFAULT_GROUP@@aggregate-pay-sms","ip":"192.168.3.143","port":45739,"weight":1.0,"healthy":false,"enabled":true,"ephemeral":false,"clusterName":"DEFAULT","serviceName":"DEFAULT_GROUP@@aggregate-pay-sms","metadata":{"preserved.register.source":"SPRING_CLOUD","management.endpoints.web.base-path":"/actuator","management.context-path":"/actuator"},"ipDeleteTimeout":30000,"instanceHeartBeatInterval":5000,"instanceHeartBeatTimeOut":15000},{"instanceId":"192.168.3.143#35478#DEFAULT#DEFAULT_GROUP@@aggregate-pay-sms","ip":"192.168.3.143","port":35478,"weight":1.0,"healthy":true,"enabled":true,"ephemeral":false,"clusterName":"DEFAULT","serviceName":"DEFAULT_GROUP@@aggregate-pay-sms","metadata":{"preserved.register.source":"SPRING_CLOUD","management.endpoints.web.base-path":"/actuator","management.context-path":"/actuator"},"ipDeleteTimeout":30000,"instanceHeartBeatInterval":5000,"instanceHeartBeatTimeOut":15000}]
2023-01-10 22:13:41.167  INFO 14872 --- [egate-pay-sms-1] c.netflix.config.ChainedDynamicProperty  : Flipping property: aggregate-pay-sms.ribbon.ActiveConnectionsLimit to use NEXT property: niws.loadbalancer.availabilityFilteringRule.activeConnectionsLimit = 2147483647
2023-01-10 22:13:41.169  INFO 14872 --- [egate-pay-sms-1] c.n.l.DynamicServerListLoadBalancer      : DynamicServerListLoadBalancer for client aggregate-pay-sms initialized: DynamicServerListLoadBalancer:{NFLoadBalancer:name=aggregate-pay-sms,current list of Servers=[192.168.3.143:35478],Load balancer stats=Zone stats: {unknown=[Zone:unknown;	Instance count:1;	Active connections count: 0;	Circuit breaker tripped count: 0;	Active connections per server: 0.0;]
},Server stats: [[Server:192.168.3.143:35478;	Zone:UNKNOWN;	Total Requests:0;	Successive connection failure:0;	Total blackout seconds:0;	Last connection made:Thu Jan 01 08:00:00 CST 1970;	First connection made: Thu Jan 01 08:00:00 CST 1970;	Active Connections:0;	total failure count in last (1000) msecs:0;	average resp time:0.0;	90 percentile resp time:0.0;	95 percentile resp time:0.0;	min resp time:0.0;	max resp time:0.0;	stddev resp time:0.0]
]}ServerList:com.alibaba.cloud.nacos.ribbon.NacosServerList@1b8d66f4
2023-01-10 22:13:42.164  INFO 14872 --- [erListUpdater-0] c.netflix.config.ChainedDynamicProperty  : Flipping property: aggregate-pay-sms.ribbon.ActiveConnectionsLimit to use NEXT property: niws.loadbalancer.availabilityFilteringRule.activeConnectionsLimit = 2147483647
2023-01-10 22:13:45.768 DEBUG 14872 --- [egate-pay-sms-1] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] <--- HTTP/1.1 200  (4771ms)
2023-01-10 22:13:45.768 DEBUG 14872 --- [egate-pay-sms-1] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] connection: keep-alive
2023-01-10 22:13:45.768 DEBUG 14872 --- [egate-pay-sms-1] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] content-type: application/json;charset=UTF-8
2023-01-10 22:13:45.768 DEBUG 14872 --- [egate-pay-sms-1] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] date: Tue, 10 Jan 2023 14:13:45 GMT
2023-01-10 22:13:45.768 DEBUG 14872 --- [egate-pay-sms-1] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] keep-alive: timeout=60
2023-01-10 22:13:45.768 DEBUG 14872 --- [egate-pay-sms-1] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] transfer-encoding: chunked
2023-01-10 22:13:45.769 DEBUG 14872 --- [egate-pay-sms-1] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] <--- END HTTP (90-byte body)
2023-01-10 22:13:45.785  INFO 14872 --- [io-57010-exec-1] m.a.controller.MerchantController        : 向手机号:18188888888发送验证码
2023-01-10 22:13:45.788 DEBUG 14872 --- [egate-pay-sms-2] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] ---> POST http://aggregate-pay-sms/generate?name=sms&effectiveTime=1200 HTTP/1.1
2023-01-10 22:13:45.788 DEBUG 14872 --- [egate-pay-sms-2] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] Accept-Encoding: gzip
2023-01-10 22:13:45.788 DEBUG 14872 --- [egate-pay-sms-2] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] Accept-Encoding: deflate
2023-01-10 22:13:45.788 DEBUG 14872 --- [egate-pay-sms-2] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] Content-Length: 24
2023-01-10 22:13:45.788 DEBUG 14872 --- [egate-pay-sms-2] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] Content-Type: application/json
2023-01-10 22:13:45.788 DEBUG 14872 --- [egate-pay-sms-2] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] ---> END HTTP (24-byte body)
2023-01-10 22:13:49.870 DEBUG 14872 --- [egate-pay-sms-2] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] <--- HTTP/1.1 200  (4082ms)
2023-01-10 22:13:49.871 DEBUG 14872 --- [egate-pay-sms-2] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] connection: keep-alive
2023-01-10 22:13:49.871 DEBUG 14872 --- [egate-pay-sms-2] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] content-type: application/json;charset=UTF-8
2023-01-10 22:13:49.871 DEBUG 14872 --- [egate-pay-sms-2] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] date: Tue, 10 Jan 2023 14:13:49 GMT
2023-01-10 22:13:49.871 DEBUG 14872 --- [egate-pay-sms-2] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] keep-alive: timeout=60
2023-01-10 22:13:49.871 DEBUG 14872 --- [egate-pay-sms-2] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] transfer-encoding: chunked
2023-01-10 22:13:49.871 DEBUG 14872 --- [egate-pay-sms-2] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#generateVerificationInfo] <--- END HTTP (90-byte body)
2023-01-10 22:14:56.477 DEBUG 14872 --- [egate-pay-sms-3] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#verify] ---> POST http://aggregate-pay-sms/verify?name=sms&verificationKey=sms%3A7fec9cb23a1a41b8ad14aa1872200416&verificationCode=214697 HTTP/1.1
2023-01-10 22:14:56.478 DEBUG 14872 --- [egate-pay-sms-3] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#verify] Accept-Encoding: gzip
2023-01-10 22:14:56.478 DEBUG 14872 --- [egate-pay-sms-3] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#verify] Accept-Encoding: deflate
2023-01-10 22:14:56.478 DEBUG 14872 --- [egate-pay-sms-3] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#verify] ---> END HTTP (0-byte body)
2023-01-10 22:14:56.489 DEBUG 14872 --- [egate-pay-sms-3] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#verify] <--- HTTP/1.1 200  (10ms)
2023-01-10 22:14:56.489 DEBUG 14872 --- [egate-pay-sms-3] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#verify] connection: keep-alive
2023-01-10 22:14:56.489 DEBUG 14872 --- [egate-pay-sms-3] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#verify] content-type: application/json;charset=UTF-8
2023-01-10 22:14:56.489 DEBUG 14872 --- [egate-pay-sms-3] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#verify] date: Tue, 10 Jan 2023 14:14:56 GMT
2023-01-10 22:14:56.489 DEBUG 14872 --- [egate-pay-sms-3] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#verify] keep-alive: timeout=60
2023-01-10 22:14:56.489 DEBUG 14872 --- [egate-pay-sms-3] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#verify] transfer-encoding: chunked
2023-01-10 22:14:56.489 DEBUG 14872 --- [egate-pay-sms-3] m.a.feign.sms.VerificationFeignClient    : [VerificationFeignClient#verify] <--- END HTTP (33-byte body)
2023-01-10 22:14:56.499 DEBUG 14872 --- [chant-service-1] m.a.feign.MerchantFeignClient            : [MerchantFeignClient#createMerchant] ---> POST http://aggregate-pay-merchant-service/merchant HTTP/1.1
2023-01-10 22:14:56.499 DEBUG 14872 --- [chant-service-1] m.a.feign.MerchantFeignClient            : [MerchantFeignClient#createMerchant] Accept-Encoding: gzip
2023-01-10 22:14:56.499 DEBUG 14872 --- [chant-service-1] m.a.feign.MerchantFeignClient            : [MerchantFeignClient#createMerchant] Accept-Encoding: deflate
2023-01-10 22:14:56.499 DEBUG 14872 --- [chant-service-1] m.a.feign.MerchantFeignClient            : [MerchantFeignClient#createMerchant] Content-Length: 281
2023-01-10 22:14:56.499 DEBUG 14872 --- [chant-service-1] m.a.feign.MerchantFeignClient            : [MerchantFeignClient#createMerchant] Content-Type: application/json
2023-01-10 22:14:56.500 DEBUG 14872 --- [chant-service-1] m.a.feign.MerchantFeignClient            : [MerchantFeignClient#createMerchant] ---> END HTTP (281-byte body)
2023-01-10 22:14:56.534  INFO 14872 --- [chant-service-1] c.netflix.config.ChainedDynamicProperty  : Flipping property: aggregate-pay-merchant-service.ribbon.ActiveConnectionsLimit to use NEXT property: niws.loadbalancer.availabilityFilteringRule.activeConnectionsLimit = 2147483647
2023-01-10 22:14:56.536  INFO 14872 --- [chant-service-1] c.netflix.loadbalancer.BaseLoadBalancer  : Client: aggregate-pay-merchant-service instantiated a LoadBalancer: DynamicServerListLoadBalancer:{NFLoadBalancer:name=aggregate-pay-merchant-service,current list of Servers=[],Load balancer stats=Zone stats: {},Server stats: []}ServerList:null
2023-01-10 22:14:56.537  INFO 14872 --- [chant-service-1] c.n.l.DynamicServerListLoadBalancer      : Using serverListUpdater PollingServerListUpdater
2023-01-10 22:14:56.539  INFO 14872 --- [chant-service-1] com.alibaba.nacos.client.naming          : new ips(1) service: DEFAULT_GROUP@@aggregate-pay-merchant-service -> [{"instanceId":"192.168.3.143#56040#DEFAULT#DEFAULT_GROUP@@aggregate-pay-merchant-service","ip":"192.168.3.143","port":56040,"weight":1.0,"healthy":true,"enabled":true,"ephemeral":false,"clusterName":"DEFAULT","serviceName":"DEFAULT_GROUP@@aggregate-pay-merchant-service","metadata":{"preserved.register.source":"SPRING_CLOUD","management.endpoints.web.base-path":"/actuator","management.context-path":"//actuator"},"ipDeleteTimeout":30000,"instanceHeartBeatInterval":5000,"instanceHeartBeatTimeOut":15000}]
2023-01-10 22:14:56.540  INFO 14872 --- [chant-service-1] com.alibaba.nacos.client.naming          : current ips:(1) service: DEFAULT_GROUP@@aggregate-pay-merchant-service -> [{"instanceId":"192.168.3.143#56040#DEFAULT#DEFAULT_GROUP@@aggregate-pay-merchant-service","ip":"192.168.3.143","port":56040,"weight":1.0,"healthy":true,"enabled":true,"ephemeral":false,"clusterName":"DEFAULT","serviceName":"DEFAULT_GROUP@@aggregate-pay-merchant-service","metadata":{"preserved.register.source":"SPRING_CLOUD","management.endpoints.web.base-path":"/actuator","management.context-path":"//actuator"},"ipDeleteTimeout":30000,"instanceHeartBeatInterval":5000,"instanceHeartBeatTimeOut":15000}]
2023-01-10 22:14:56.542  INFO 14872 --- [chant-service-1] c.netflix.config.ChainedDynamicProperty  : Flipping property: aggregate-pay-merchant-service.ribbon.ActiveConnectionsLimit to use NEXT property: niws.loadbalancer.availabilityFilteringRule.activeConnectionsLimit = 2147483647
2023-01-10 22:14:56.542  INFO 14872 --- [chant-service-1] c.n.l.DynamicServerListLoadBalancer      : DynamicServerListLoadBalancer for client aggregate-pay-merchant-service initialized: DynamicServerListLoadBalancer:{NFLoadBalancer:name=aggregate-pay-merchant-service,current list of Servers=[192.168.3.143:56040],Load balancer stats=Zone stats: {unknown=[Zone:unknown;	Instance count:1;	Active connections count: 0;	Circuit breaker tripped count: 0;	Active connections per server: 0.0;]
},Server stats: [[Server:192.168.3.143:56040;	Zone:UNKNOWN;	Total Requests:0;	Successive connection failure:0;	Total blackout seconds:0;	Last connection made:Thu Jan 01 08:00:00 CST 1970;	First connection made: Thu Jan 01 08:00:00 CST 1970;	Active Connections:0;	total failure count in last (1000) msecs:0;	average resp time:0.0;	90 percentile resp time:0.0;	95 percentile resp time:0.0;	min resp time:0.0;	max resp time:0.0;	stddev resp time:0.0]
]}ServerList:com.alibaba.cloud.nacos.ribbon.NacosServerList@74e201a9
2023-01-10 22:14:56.961 DEBUG 14872 --- [chant-service-1] m.a.feign.MerchantFeignClient            : [MerchantFeignClient#createMerchant] <--- HTTP/1.1 200  (460ms)
2023-01-10 22:14:56.961 DEBUG 14872 --- [chant-service-1] m.a.feign.MerchantFeignClient            : [MerchantFeignClient#createMerchant] connection: keep-alive
2023-01-10 22:14:56.961 DEBUG 14872 --- [chant-service-1] m.a.feign.MerchantFeignClient            : [MerchantFeignClient#createMerchant] content-type: application/json;charset=UTF-8
2023-01-10 22:14:56.961 DEBUG 14872 --- [chant-service-1] m.a.feign.MerchantFeignClient            : [MerchantFeignClient#createMerchant] date: Tue, 10 Jan 2023 14:14:56 GMT
2023-01-10 22:14:56.961 DEBUG 14872 --- [chant-service-1] m.a.feign.MerchantFeignClient            : [MerchantFeignClient#createMerchant] keep-alive: timeout=60
2023-01-10 22:14:56.961 DEBUG 14872 --- [chant-service-1] m.a.feign.MerchantFeignClient            : [MerchantFeignClient#createMerchant] transfer-encoding: chunked
2023-01-10 22:14:56.967 DEBUG 14872 --- [chant-service-1] m.a.feign.MerchantFeignClient            : [MerchantFeignClient#createMerchant] <--- END HTTP (412-byte body)
2023-01-10 22:14:57.538  INFO 14872 --- [erListUpdater-0] c.netflix.config.ChainedDynamicProperty  : Flipping property: aggregate-pay-merchant-service.ribbon.ActiveConnectionsLimit to use NEXT property: niws.loadbalancer.availabilityFilteringRule.activeConnectionsLimit = 2147483647
```





查看数据库：



![image-20230110221723988](img/聚合支付项目实战学习笔记/image-20230110221723988.png)





已经有一条数据了









### 全局异常处理

#### 错误代码接口

```java
package mao.aggregate_pay_common.domain;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_common.domain
 * Interface(接口名): ErrorCode
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/7
 * Time(创建时间)： 14:42
 * Version(版本): 1.0
 * Description(描述)： 错误代码接口
 */

public interface ErrorCode
{
    /**
     * 获取错误代码值
     *
     * @return int
     */
    int getCode();

    /**
     * 得到描述信息
     *
     * @return {@link String}
     */
    String getDesc();
}
```





#### 错误代码接口实现类

```java
package mao.aggregate_pay_common.domain;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_common.domain
 * Class(类名): CommonErrorCode
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/7
 * Time(创建时间)： 14:42
 * Version(版本): 1.0
 * Description(描述)： 枚举，支付系统需要的错误码
 */

public enum CommonErrorCode implements ErrorCode
{
    ////////////////////////////////////公用异常编码 //////////////////////////
    E_100101(100101, "传入参数与接口不匹配"),
    E_100102(100102, "验证码错误"),
    E_100103(100103, "验证码为空"),
    E_100104(100104, "查询结果为空"),
    E_100105(100105, "ID格式不正确或超出Long存储范围"),
    E_100106(100106, "上传错误"),
    E_100107(100107, "发送验证码错误"),
    E_100108(100108, "传入对象为空"),
    E_100109(100109, "手机号格式不正确"),
    E_100110(100110, "用户名为空"),
    E_100111(100111, "密码为空"),
    E_100112(100112, "手机号为空"),
    E_100113(100113, "手机号已存在"),
    E_100114(100114, "用户名已存在"),
    E_100115(100115, "密码不正确"),

    ////////////////////////////////////SAAS服务异常编码110 //////////////////////////
    E_110001(110001, "账号不存在"),
    E_110002(110002, "角色编码在同一租户中已存在，不可重复"),
    E_110003(110003, "角色为空"),
    E_110004(110004, "角色已绑定账号，被使用中不可删除"),
    E_110005(110005, "权限集合为空"),
    E_110006(110006, "参数为空"),
    E_110007(110007, "未查询到租户关联的角色"),
    E_110008(110008, "账号被其他租户使用，不可删除"),

    ////////////////////////////////////商户服务异常编码200//////////////////////////
    E_200001(200001, "企业名称不能为空"),
    E_200002(200002, "商户不存在"),
    E_200003(200003, "商户还未通过认证审核，不能创建应用"),
    E_200004(200004, "应用名称已经存在，请使用其他名称"),
    E_200005(200005, "应用不属于当前商户"),
    E_200006(200006, "门店不属于当前商户"),
    E_200007(200007, "二维码生成失败"),
    E_200008(200008, "授权码为空"),
    E_200009(200009, "订单标题为空"),
    E_200010(200010, "订单金额为空"),
    E_200011(200011, "授权码格式有误"),
    E_200012(200012, "租户不存在"),
    E_200013(200013, "员工不存在"),
    E_200014(200014, "商户下未设置根门店"),
    E_200015(200015, "未查询到该门店"),
    E_200016(200016, "资质申请已通过，无需重复申请"),
    E_200017(200017, "商户在当前租户下已经注册，不可重复注册"),

    ////////////////////////////////////交易服务异常编码300//////////////////////////
    E_300001(300001, "支付金额为空"),
    E_300002(300002, "openId为空"),
    E_300003(300003, "appId为空"),
    E_300004(300004, "商户id为空"),
    E_300005(300005, "服务类型编码为空"),
    E_300006(300006, "订单金额转换异常"),
    E_300007(300007, "原始支付渠道为空"),
    E_300008(300008, "已存在相同的支付参数，不可重复配置"),
    E_300009(300009, "传入对象为空或者缺少必要的参数"),
    E_300010(300010, "应用没有绑定服务类型，不允许配置参数"),

    E_300110(300110, "交易单号不能为空"),


    ////////////////////////////////////支付渠道代理服务异常编码400//////////////////
    E_400001(400001, "微信确认支付失败"),
    E_400002(400002, "支付宝确认支付失败"),

    ////////////////////////////////////运营服务异常编码500//////////////////

    ////////////////////////////////////特殊异常编码/////////////////////////////////////
    E_999991(999991, "调用微服务-授权服务 被熔断"),
    E_999992(999992, "调用微服务-用户服务 被熔断"),
    E_999993(999993, "调用微服务-资源服务 被熔断"),
    E_999994(999994, "调用微服务-同步服务 被熔断"),

    E_999910(999910, "调用微服务-没有传tenantId租户Id"),
    E_999911(999911, "调用微服务-没有json-token令牌"),
    E_999912(999912, "调用微服务-json-token令牌解析有误"),
    E_999913(999913, "调用微服务-json-token令牌有误-没有当前租户信息"),
    E_999914(999914, "调用微服务-json-token令牌有误-该租户下没有权限信息"),

    E_NO_AUTHORITY(999997, "没有访问权限"),
    CUSTOM(999998, "自定义异常"),
    /**
     * 未知错误
     */
    UNKNOWN(999999, "未知错误");


    /**
     * 错误代码
     */
    private final int code;

    /**
     * 描述
     */
    private final String desc;

    /**
     * 获取代码
     *
     * @return int
     */
    public int getCode()
    {
        return code;
    }

    /**
     * 得到描述
     *
     * @return {@link String}
     */
    public String getDesc()
    {
        return desc;
    }

    /**
     * 常见错误代码
     *
     * @param code 代码
     * @param desc desc
     */
    CommonErrorCode(int code, String desc)
    {
        this.code = code;
        this.desc = desc;
    }


    /**
     * 设置错误代码
     *
     * @param code 代码
     * @return {@link CommonErrorCode}
     */
    public static CommonErrorCode setErrorCode(int code)
    {
        for (CommonErrorCode errorCode : CommonErrorCode.values())
        {
            if (errorCode.getCode() == code)
            {
                return errorCode;
            }
        }
        return null;
    }
}
```







#### 业务异常

```java
package mao.aggregate_pay_common.domain;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_common.domain
 * Class(类名): BusinessException
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/7
 * Time(创建时间)： 14:41
 * Version(版本): 1.0
 * Description(描述)： 聚合支付系统业务异常
 */

public class BusinessException extends RuntimeException
{
    /**
     * 错误代码
     */
    private ErrorCode errorCode;

    /**
     * 业务异常
     *
     * @param errorCode 错误代码
     */
    public BusinessException(ErrorCode errorCode)
    {
        super();
        this.errorCode = errorCode;
    }

    /**
     * 业务异常
     */
    public BusinessException()
    {
        super();
    }

    /**
     * 设置错误代码
     *
     * @param errorCode 错误代码
     */
    public void setErrorCode(ErrorCode errorCode)
    {
        this.errorCode = errorCode;
    }

    /**
     * 得到错误代码
     *
     * @return {@link ErrorCode}
     */
    public ErrorCode getErrorCode()
    {
        return errorCode;
    }
}
```







#### 全局异常处理

```java
package mao.aggregate_pay_merchant_application.handler;

import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_common.domain.BusinessException;
import mao.aggregate_pay_common.domain.CommonErrorCode;
import mao.aggregate_pay_common.domain.ErrorCode;
import mao.aggregate_pay_common.domain.RestErrorResponse;
import mao.tools_core.exception.BizException;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.handler
 * Class(类名): GlobalExceptionHandler
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 22:22
 * Version(版本): 1.0
 * Description(描述)： 全局异常处理
 */

@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler
{
    /**
     * 处理异常
     *
     * @param e Exception
     * @return {@link RestErrorResponse}
     */
    @ExceptionHandler(value = Exception.class)
    public RestErrorResponse processException(Exception e)
    {
        //解析异常信息
        //如果是系统自定义异常，直接取出errCode和errMessage
        if (e instanceof BusinessException)
        {
            log.info(e.getMessage(), e);
            //解析系统自定义异常信息
            BusinessException businessException = (BusinessException) e;
            ErrorCode errorCode = businessException.getErrorCode();
            //错误代码
            int code = errorCode.getCode();
            //错误信息
            String desc = errorCode.getDesc();
            return new RestErrorResponse(String.valueOf(code), desc);
        }
        //系统业务异常
        if (e instanceof BizException)
        {
            log.info(e.getMessage(), e);
            int code = ((BizException) e).getCode();
            //错误信息
            String desc = e.getMessage();
            return new RestErrorResponse(String.valueOf(code), desc);
        }

        log.error("系统异常：", e);
        return new RestErrorResponse(String.valueOf(CommonErrorCode.UNKNOWN.getCode()), CommonErrorCode.UNKNOWN.getDesc());

    }
}

```





#### 断言远程调用的结果类

```java
package mao.aggregate_pay_merchant_application.handler;

import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_common.domain.BusinessException;
import mao.aggregate_pay_common.domain.ErrorCode;
import mao.tools_core.base.R;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.handler
 * Class(类名): AssertResult
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 22:32
 * Version(版本): 1.0
 * Description(描述)： 断言远程调用的结果
 */

@Slf4j
public class AssertResult
{
    public static void handler(R<?> r)
    {
        //如果响应结果为失败
        if (r.getIsError())
        {
            //抛出业务异常
            ErrorCode errorCode = new ErrorCode()
            {
                @Override
                public int getCode()
                {
                    return r.getCode();
                }

                @Override
                public String getDesc()
                {
                    return r.getMsg();
                }
            };
            throw new BusinessException(errorCode);
        }
    }
}
```











### 校验商户手机号

#### 商户服务实现类

```java
package mao.aggregate_pay_merchant_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_service.entity.Merchant;
import mao.aggregate_pay_merchant_service.mapper.MerchantMapper;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.tools_core.exception.BizException;
import mao.tools_databases.mybatis.conditions.Wraps;
import mao.toolsdozer.utils.DozerUtils;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service.impl
 * Class(类名): MerchantServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:38
 * Version(版本): 1.0
 * Description(描述)： 商户服务实现类
 */

@Service
public class MerchantServiceImpl extends ServiceImpl<MerchantMapper, Merchant> implements MerchantService
{

    @Resource
    private DozerUtils dozerUtils;

    @Override
    public MerchantDTO getMerchantById(Long merchantId)
    {
        //查询
        Merchant merchant = this.getById(merchantId);
        //转换，并返回
        return dozerUtils.map(merchant, MerchantDTO.class);
    }

    @Override
    public MerchantDTO createMerchant(MerchantDTO merchantDTO)
    {
        //校验商户手机号的唯一性,根据商户的手机号查询商户表，如果存在记录则说明已有相同的手机号重复
        int count = this.count(Wraps.<Merchant>lbQ().eq(Merchant::getMobile, merchantDTO.getMobile()));
        if (count > 0)
        {
            throw BizException.wrap("手机号重复");
        }
        //构建商户
        Merchant merchant = new Merchant();
        //设置审核状态
        merchant.setAuditStatus("0");
        //设置手机号
        merchant.setMobile(merchantDTO.getMobile());
        //保存
        this.save(merchant);
        //保存id信息
        merchantDTO.setId(merchant.getId());
        //返回
        return merchantDTO;
    }
}
```





#### 短信服务实现类

```java
package mao.aggregate_pay_merchant_application.service.Impl;

import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_common.domain.RestResponse;
import mao.aggregate_pay_merchant_application.feign.sms.VerificationFeignClient;
import mao.aggregate_pay_merchant_application.service.SmsService;
import mao.tools_core.exception.BizException;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.service.Impl
 * Class(类名): SmsServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 21:34
 * Version(版本): 1.0
 * Description(描述)： 无
 */

@Slf4j
@Service
public class SmsServiceImpl implements SmsService
{
    @Resource
    private VerificationFeignClient verificationFeignClient;

    @Override
    public void checkVerifyCode(String verifyKey, String verifyCode)
    {
        try
        {
            //发起远程调用
            RestResponse<Boolean> response = verificationFeignClient.verify("sms", verifyKey, verifyCode);
            //判断结果
            if (!response.getResult())
            {
                //失败
                throw new BizException("验证码错误或者验证码已过期");
            }
        }
        catch (Exception e)
        {
            log.error("验证码服务异常：", e);
            throw new BizException("验证码错误或者验证码已过期");
        }

    }
}
```





#### 商户平台应用接口

```java
package mao.aggregate_pay_merchant_application.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_common.domain.BusinessException;
import mao.aggregate_pay_common.domain.CommonErrorCode;
import mao.aggregate_pay_common.utils.PhoneUtil;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.feign.MerchantFeignClient;
import mao.aggregate_pay_merchant_application.feign.sms.VerificationFeignClient;
import mao.aggregate_pay_merchant_application.handler.AssertResult;
import mao.aggregate_pay_merchant_application.service.SmsService;
import mao.aggregate_pay_merchant_application.vo.MerchantRegisterVO;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import org.apache.commons.lang3.StringUtils;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.HashMap;
import java.util.Map;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.controller
 * Class(类名): MerchantController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 21:49
 * Version(版本): 1.0
 * Description(描述)： 商户
 */

@Slf4j
@RestController
@Api(tags = "商户平台应用接口")
public class MerchantController
{

    @Resource
    private VerificationFeignClient verificationFeignClient;

    @Resource
    private SmsService smsService;

    @Resource
    private MerchantFeignClient merchantFeignClient;

    /**
     * 发送验证码
     *
     * @param phone 电话
     * @return {@link String} 验证码的key
     */
    @ApiOperation("获取手机验证码")
    @GetMapping("/sms")
    @ApiImplicitParam(value = "手机号", name = "phone", required = true, dataType = "string", paramType = "query")
    public String getSMSCode(@RequestParam("phone") String phone)
    {
        //判断非空
        if (StringUtils.isBlank(phone))
        {
            throw new BusinessException(CommonErrorCode.E_100112);
        }
        //校验手机号的合法性
        if (!PhoneUtil.isMatches(phone))
        {
            throw new BusinessException(CommonErrorCode.E_100109);
        }
        log.info("向手机号:{}发送验证码", phone);
        //向验证码服务请求发送验证码
        Map<String, Object> map = new HashMap<>();
        map.put("mobile", phone);
        return verificationFeignClient.generateVerificationInfo("sms", map, 20 * 60).getResult().getKey();
    }

    /**
     * 注册商户
     *
     * @param merchantRegisterVO MerchantRegisterVO
     * @return {@link MerchantRegisterVO}
     */
    @PostMapping("/merchants/register")
    @ApiOperation("商户注册")
    @ApiImplicitParam(value = "商户注册信息", name = "merchantRegisterVO", required = true, dataType = "MerchantRegisterVO", paramType = "body")
    public MerchantRegisterVO registerMerchant(@RequestBody MerchantRegisterVO merchantRegisterVO)
    {

        if (merchantRegisterVO.getVerifiykey() == null || merchantRegisterVO.getVerifiykey().equals(""))
        {
            throw BizException.wrap("验证码的key为空");
        }
        if (merchantRegisterVO.getVerifiyCode() == null || merchantRegisterVO.getVerifiyCode().equals(""))
        {
            throw BizException.wrap("请输入验证码");
        }
        smsService.checkVerifyCode(merchantRegisterVO.getVerifiykey(), merchantRegisterVO.getVerifiyCode());

        //注册商户
        MerchantDTO merchantDTO = new MerchantDTO();
        merchantDTO.setUsername(merchantRegisterVO.getUsername());
        merchantDTO.setMobile(merchantRegisterVO.getMobile());
        merchantDTO.setPassword(merchantRegisterVO.getPassword());

        if (StringUtils.isBlank(merchantDTO.getMobile()))
        {
            throw new BusinessException(CommonErrorCode.E_100112);
        }
        //校验手机号的合法性
        if (!PhoneUtil.isMatches(merchantDTO.getMobile()))
        {
            throw new BusinessException(CommonErrorCode.E_100109);
        }
        //联系人非空校验
        if (StringUtils.isBlank(merchantDTO.getUsername()))
        {
            throw new BusinessException(CommonErrorCode.E_100110);
        }
        //密码非空校验
        if (StringUtils.isBlank(merchantDTO.getPassword()))
        {
            throw new BusinessException(CommonErrorCode.E_100111);
        }

        //远程调用
        R<MerchantDTO> result = merchantFeignClient.createMerchant(merchantDTO);
        //断言结果
        AssertResult.handler(result);
        //返回
        return merchantRegisterVO;

    }
}
```



























# 商户资质申请

## 需求概述

商户在平台注册成功后，需要完善商户信息，将营业执照、申请人身份证以扫描件的形式上传到平台，由平台运营 人员对商户资质进行审核，审核通过方可使用平台提供的服务

资质申请业务流程如下：

![image-20230111150542003](img/聚合支付项目实战学习笔记/image-20230111150542003.png)





1、商户填写资质信息

![image-20230111150607851](img/聚合支付项目实战学习笔记/image-20230111150607851.png)





2、上传营业执照和法人身份证图片

![image-20230111150636747](img/聚合支付项目实战学习笔记/image-20230111150636747.png)





3、提交资质信息

4、平台运营人员对商户资质信息进行审核

5、审核通过后，完成资质申请









## 需求分析

商户资质申请交互流程如下：

![image-20230111150839251](img/聚合支付项目实战学习笔记/image-20230111150839251.png)





### 七牛云

七牛云是国内一家云服务提供商，本系统与七牛云对接将商户资质照片存储在七牛云

交互流程如下：

1. 前端上传证件照片，请求商户平台应用
2. 商户平台应用请求七牛云上传图片
3. 上传成功返回图片标识给前端
4. 前端携带证件图片标识和资质申请信息提交到商户平台应用
5. 请求商户服务保存资质申请
6. 保存成功返回给前端





### 资质信息存储

商户资质信息存储在商户表，上传的资质证件照片存储Url绝对路径

关于资质申请状态说明如下 ：

1、提交资质申请，审核状态为1（已申请待审核）

2、资质审核后，审核状态为2（审核通过 ）或3（审核不通过 ）









## 七牛云

### 对象存储服务简介

七牛云海量存储系统（KODO）是自主研发的非结构化数据存储管理平台，支持中心和边缘存储。平台经过多年大 规模用户验证已跻身先进技术行列，并广泛应用于海量数据管理的各类场景

https://www.qiniu.com/products/kodo



### 产品优势

* 高可靠
* 低成本：无需前期投入。七牛云对象存储按需使用、按需付费的便捷性，能够有效避免存储及带宽资源的闲置浪费
* 存储加速：边缘存储可充分利用可用链路带宽，数据在边缘节点上传和下载可平均提速 60% 以上
* 易扩展：利用七牛云对象存储，您的存储空间无上限的同时也无需担心扩容问题。您能够实现存储需求的弹性伸缩， 从而提高业务灵活性
* 数据智能化：与七牛云其他产品紧密协同，提供标准 HDFS 访问方式，为大数据和机器学习的海量高速读写场景进行了大 量优化
* 边缘计算：就近集成边缘计算及边缘缓存服务，边缘存储节点具备本地数据处理能力







### 核心功能及服务

*  多媒体数据处理
* 镜像存储
* 上传/下载
* 灵活部署
* 多级备份
* 边缘安全







### 创建对象存储空间

注册账号：

https://portal.qiniu.com/signup



![image-20230111151932302](img/聚合支付项目实战学习笔记/image-20230111151932302.png)



![image-20230111152252487](img/聚合支付项目实战学习笔记/image-20230111152252487.png)







开通对象存储服务：

https://www.qiniu.com/products/kodo



![image-20230111152558452](img/聚合支付项目实战学习笔记/image-20230111152558452.png)





![image-20230111152811707](img/聚合支付项目实战学习笔记/image-20230111152811707.png)





![image-20230111153550716](img/聚合支付项目实战学习笔记/image-20230111153550716.png)





创建成功，获取融合 CDN 测试域名：下载文件时需要使用此域名



![image-20230111153904007](img/聚合支付项目实战学习笔记/image-20230111153904007.png)



![image-20230111154019680](img/聚合支付项目实战学习笔记/image-20230111154019680.png)









获取七牛云服务秘钥：

https://portal.qiniu.com/user/key



![image-20230111193248513](img/聚合支付项目实战学习笔记/image-20230111193248513.png)











## 上传文件测试

官方提供了Java SDK来方便开发

使用此 SDK 构建您的网络应用程序，能让您以非常便捷地方式将数据安全地存储到七牛云上。无论您的网络应用是一个网站程序，还是包括从云端（服务端程序）到终端（手持设备应用）的架构服务或应用，通过七牛云及其 SDK，都能让您应用程序的终端用户高速上传和下载，同时也让您的服务端更加轻盈



Java SDK 属于七牛服务端SDK之一，主要有如下功能：

* 提供生成客户端上传所需的上传凭证的功能
* 提供文件从服务端直接上传七牛的功能
* 提供对七牛空间中文件进行管理的功能
* 提供对七牛空间中文件进行处理的功能
* 提供七牛CDN相关的刷新，预取，日志功能
* 提供七牛视频监控QVS设备管理、流管理等功能



文档地址：

https://developer.qiniu.com/kodo/1239/java











### 工具类

位于common模块中

```java
package mao.aggregate_pay_common.utils;

import com.google.gson.Gson;
import com.qiniu.common.QiniuException;
import com.qiniu.http.Response;
import com.qiniu.storage.Configuration;
import com.qiniu.storage.Region;
import com.qiniu.storage.UploadManager;
import com.qiniu.storage.model.DefaultPutRet;
import com.qiniu.util.Auth;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_common.utils
 * Class(类名): QiniuUtils
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/7
 * Time(创建时间)： 21:15
 * Version(版本): 1.0
 * Description(描述)： 七牛云工具类
 */

public class QiniuUtils
{
    private static final Logger log = LoggerFactory.getLogger(QiniuUtils.class);

    /**
     * 文件上传的工具方法
     *
     * @param fileName  外部传进来，七牛云上的文件名称和此保持一致
     * @param accessKey 访问密钥
     * @param secretKey 秘密密钥
     * @param bucket    桶
     * @param bytes     字节
     * @throws RuntimeException 运行时异常
     */
    public static void upload2qiniu(String accessKey, String secretKey, String bucket, byte[] bytes, String fileName)
            throws RuntimeException
    {

        //构造一个带指定 Region 对象的配置类，指定存储区域，和存储空间选择的区域一致
        Configuration cfg = new Configuration(Region.huanan());
        //...其他参数参考类注释
        UploadManager uploadManager = new UploadManager(cfg);

        //默认不指定key的情况下，以文件内容的hash值作为文件名
        String key = fileName;
        try
        {

            //认证
            Auth auth = Auth.create(accessKey, secretKey);
            //认证通过后得到token（令牌）
            String upToken = auth.uploadToken(bucket);
            try
            {
                //上传文件,参数：字节数组，key，token令牌
                //key: 建议我们自已生成一个不重复的名称
                Response response = uploadManager.put(bytes, key, upToken);
                //解析上传成功的结果
                DefaultPutRet putRet = new Gson().fromJson(response.bodyString(), DefaultPutRet.class);
                //System.out.println(putRet.key);
                //System.out.println(putRet.hash);
                log.info("上传文件到七牛云：" + putRet.key);
            }
            catch (QiniuException ex)
            {
                Response r = ex.response;
                System.err.println(r.toString());
                log.error("上传文件到七牛：{}", ex.getMessage());
                try
                {
                    log.error(r.bodyString());
                }
                catch (QiniuException ex2)
                {
                    //ignore
                }
                throw new RuntimeException(r.bodyString());
            }
        }
        catch (Exception ex)
        {
            log.error("上传文件到七牛：{}", ex.getMessage());
            throw new RuntimeException(ex.getMessage());
        }
    }
}

```





### 单元测试

```java
package mao.aggregate_pay_common.utils;

import com.qiniu.util.IOUtils;
import lombok.SneakyThrows;
import org.junit.jupiter.api.Test;

import java.io.FileInputStream;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_common.utils
 * Class(测试类名): QiniuUtilsTest
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/7
 * Time(创建时间)： 21:17
 * Version(版本): 1.0
 * Description(描述)： 测试类
 */

class QiniuUtilsTest
{

    @SneakyThrows
    @Test
    void upload2qiniu()
    {
        String accessKey = "iCXS8pn-PiJ77RYpkFd9UH5alX9b_0o......";
        String SecretKey = "w65H_JovJdjWpTQwYcFw63OCIVIS_o6......";
        String bucket = "......";
        String fileName = "image-20230110151739681.png";
        String filePath = "C:\\Users\\mao\\Desktop\\image-20230110151739681.png";
        byte[] bytes = IOUtils.toByteArray(new FileInputStream(filePath));
        QiniuUtils.upload2qiniu(accessKey, SecretKey, bucket, bytes, fileName);
    }

}
```







![image-20230111195959114](img/聚合支付项目实战学习笔记/image-20230111195959114.png)







![image-20230111200015344](img/聚合支付项目实战学习笔记/image-20230111200015344.png)





![image-20230111200054228](img/聚合支付项目实战学习笔记/image-20230111200054228.png)

















## 上传证件

### 商户平台应用证件上传

#### 接口定义

接口描述：

1. 前端携带证件信息请求商户平台应用
2. 商户平台应用请求七牛云服务上传证件图片
3. 七牛云返回图片地址给前端



```java
package mao.aggregate_pay_merchant_application.service;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.service
 * Interface(接口名): FileService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/11
 * Time(创建时间)： 20:13
 * Version(版本): 1.0
 * Description(描述)： 文件服务
 */

public interface FileService
{
    /**
     * 上传文件
     *
     * @param bytes    文件字节数组
     * @param fileName 文件名
     * @return 文件访问路径（绝对的url）
     */
    String upload(byte[] bytes, String fileName);
}
```









#### 配置属性类

在商户平台应用服务里添加一个配置属性类QNFileConfigurationProperties



```java
package mao.aggregate_pay_merchant_application.config;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.config
 * Class(类名): QNFileConfigurationProperties
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/11
 * Time(创建时间)： 20:19
 * Version(版本): 1.0
 * Description(描述)： 七牛云配置属性类
 */

@Component
@ConfigurationProperties(prefix = "qn")
public class QNFileConfigurationProperties
{
    /**
     * 七牛云文件地址url的前缀
     */
    private String Url;

    /**
     * 访问密钥
     */
    private String accessKey;

    /**
     * 秘密密钥
     */
    private String secretKey;

    /**
     * 桶
     */
    private String bucket;


    /**
     * 构造方法
     */
    public QNFileConfigurationProperties()
    {
        
    }

    /**
     * 构造方法
     *
     * @param url       url
     * @param accessKey 访问密钥
     * @param secretKey 秘密密钥
     * @param bucket    桶
     */
    public QNFileConfigurationProperties(String url, String accessKey, String secretKey, String bucket)
    {
        Url = url;
        this.accessKey = accessKey;
        this.secretKey = secretKey;
        this.bucket = bucket;
    }

    public String getUrl()
    {
        return Url;
    }

    public void setUrl(String url)
    {
        Url = url;
    }

    public String getAccessKey()
    {
        return accessKey;
    }

    public void setAccessKey(String accessKey)
    {
        this.accessKey = accessKey;
    }

    public String getSecretKey()
    {
        return secretKey;
    }

    public void setSecretKey(String secretKey)
    {
        this.secretKey = secretKey;
    }

    public String getBucket()
    {
        return bucket;
    }

    public void setBucket(String bucket)
    {
        this.bucket = bucket;
    }
}
```







#### nacos配置

```yaml
qn:
  url: ""
  accessKey: ""
  secretKey: ""
  bucket: ""
```









#### 接口实现

```java
package mao.aggregate_pay_merchant_application.service.Impl;

import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_common.domain.BusinessException;
import mao.aggregate_pay_common.domain.CommonErrorCode;
import mao.aggregate_pay_common.utils.QiniuUtils;
import mao.aggregate_pay_merchant_application.config.QNFileConfigurationProperties;
import mao.aggregate_pay_merchant_application.service.FileService;
import org.springframework.stereotype.Service;

import javax.annotation.PostConstruct;
import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.service.Impl
 * Class(类名): FileServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/11
 * Time(创建时间)： 20:30
 * Version(版本): 1.0
 * Description(描述)： 文件服务
 */

@Slf4j
@Service
public class FileServiceImpl implements FileService
{
    @Resource
    private QNFileConfigurationProperties qnFileConfigurationProperties;

    @Override
    public String upload(byte[] bytes, String fileName)
    {
        try
        {
            //调用工具类
            QiniuUtils.upload2qiniu(qnFileConfigurationProperties.getAccessKey(),
                    qnFileConfigurationProperties.getSecretKey(), qnFileConfigurationProperties.getBucket(), bytes, fileName);
            //上传成功返回文件的访问地址
            return qnFileConfigurationProperties.getUrl() + fileName;
        }
        catch (RuntimeException e)
        {
            //抛出异常
            throw new BusinessException(CommonErrorCode.E_100106);
        }
    }

    @PostConstruct
    public void init()
    {
        log.info("初始化 FileServiceImpl ， bucket：" + qnFileConfigurationProperties.getBucket());
    }
}
```







#### MerchantController

```java
package mao.aggregate_pay_merchant_application.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_common.domain.BusinessException;
import mao.aggregate_pay_common.domain.CommonErrorCode;
import mao.aggregate_pay_common.utils.PhoneUtil;
import mao.aggregate_pay_common.utils.RandomUuidUtil;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.feign.MerchantFeignClient;
import mao.aggregate_pay_merchant_application.feign.sms.VerificationFeignClient;
import mao.aggregate_pay_merchant_application.handler.AssertResult;
import mao.aggregate_pay_merchant_application.service.FileService;
import mao.aggregate_pay_merchant_application.service.SmsService;
import mao.aggregate_pay_merchant_application.vo.MerchantRegisterVO;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import org.apache.commons.lang3.StringUtils;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import javax.annotation.Resource;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.controller
 * Class(类名): MerchantController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 21:49
 * Version(版本): 1.0
 * Description(描述)： 商户
 */

@Slf4j
@RestController
@Api(tags = "商户平台应用接口")
public class MerchantController
{

    @Resource
    private VerificationFeignClient verificationFeignClient;

    @Resource
    private SmsService smsService;

    @Resource
    private MerchantFeignClient merchantFeignClient;

    @Resource
    private FileService fileService;

    /**
     * 发送验证码
     *
     * @param phone 电话
     * @return {@link String} 验证码的key
     */
    @ApiOperation("获取手机验证码")
    @GetMapping("/sms")
    @ApiImplicitParam(value = "手机号", name = "phone", required = true, dataType = "string", paramType = "query")
    public String getSMSCode(@RequestParam("phone") String phone)
    {
        //判断非空
        if (StringUtils.isBlank(phone))
        {
            throw new BusinessException(CommonErrorCode.E_100112);
        }
        //校验手机号的合法性
        if (!PhoneUtil.isMatches(phone))
        {
            throw new BusinessException(CommonErrorCode.E_100109);
        }
        log.info("向手机号:{}发送验证码", phone);
        //向验证码服务请求发送验证码
        Map<String, Object> map = new HashMap<>();
        map.put("mobile", phone);
        return verificationFeignClient.generateVerificationInfo("sms", map, 20 * 60).getResult().getKey();
    }

    /**
     * 注册商户
     *
     * @param merchantRegisterVO MerchantRegisterVO
     * @return {@link MerchantRegisterVO}
     */
    @PostMapping("/merchants/register")
    @ApiOperation("商户注册")
    @ApiImplicitParam(value = "商户注册信息", name = "merchantRegisterVO", required = true, dataType = "MerchantRegisterVO", paramType = "body")
    public MerchantRegisterVO registerMerchant(@RequestBody MerchantRegisterVO merchantRegisterVO)
    {

        if (merchantRegisterVO.getVerifiykey() == null || merchantRegisterVO.getVerifiykey().equals(""))
        {
            throw BizException.wrap("验证码的key为空");
        }
        if (merchantRegisterVO.getVerifiyCode() == null || merchantRegisterVO.getVerifiyCode().equals(""))
        {
            throw BizException.wrap("请输入验证码");
        }
        smsService.checkVerifyCode(merchantRegisterVO.getVerifiykey(), merchantRegisterVO.getVerifiyCode());

        //注册商户
        MerchantDTO merchantDTO = new MerchantDTO();
        merchantDTO.setUsername(merchantRegisterVO.getUsername());
        merchantDTO.setMobile(merchantRegisterVO.getMobile());
        merchantDTO.setPassword(merchantRegisterVO.getPassword());

        if (StringUtils.isBlank(merchantDTO.getMobile()))
        {
            throw new BusinessException(CommonErrorCode.E_100112);
        }
        //校验手机号的合法性
        if (!PhoneUtil.isMatches(merchantDTO.getMobile()))
        {
            throw new BusinessException(CommonErrorCode.E_100109);
        }
        //联系人非空校验
        if (StringUtils.isBlank(merchantDTO.getUsername()))
        {
            throw new BusinessException(CommonErrorCode.E_100110);
        }
        //密码非空校验
        if (StringUtils.isBlank(merchantDTO.getPassword()))
        {
            throw new BusinessException(CommonErrorCode.E_100111);
        }

        //远程调用
        R<MerchantDTO> result = merchantFeignClient.createMerchant(merchantDTO);
        //断言结果
        AssertResult.handler(result);
        //返回
        return merchantRegisterVO;

    }

    /**
     * 上传证件照
     *
     * @param multipartFile 多部分文件
     * @return {@link String}
     * @throws IOException io异常
     */
    @ApiOperation("上传证件照")
    @PostMapping("/upload")
    public String upload(@ApiParam(value = "证件照", required = true) @RequestParam("file") MultipartFile multipartFile)
            throws IOException
    {
        //调用fileService上传文件
        //生成的文件名称fileName，要保证它的唯一
        //文件原始名称
        String originalFilename = multipartFile.getOriginalFilename();
        //文件名称
        String fileName = RandomUuidUtil.getUUID() + "_" + originalFilename;
        //byte[] bytes,String fileName
        return fileService.upload(multipartFile.getBytes(), fileName);
    }
}
```











#### 接口测试

![image-20230111204235477](img/聚合支付项目实战学习笔记/image-20230111204235477.png)





点击选择文件

![image-20230111204257292](img/聚合支付项目实战学习笔记/image-20230111204257292.png)





![image-20230111204346262](img/聚合支付项目实战学习笔记/image-20230111204346262.png)





![image-20230111204500284](img/聚合支付项目实战学习笔记/image-20230111204500284.png)





![image-20230111204540757](img/聚合支付项目实战学习笔记/image-20230111204540757.png)





上传成功













## 资质申请

### 商户服务资质申请

#### 接口定义

接收资质申请信息，更新商户信息及审核状态（待审核）



```java
package mao.aggregate_pay_merchant_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_service.entity.Merchant;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service
 * Interface(接口名): MerchantService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:29
 * Version(版本): 1.0
 * Description(描述)： 商户服务接口
 */

public interface MerchantService extends IService<Merchant>
{
    /**
     * 通过id获取商户信息
     *
     * @param merchantId 商户id
     * @return {@link MerchantDTO}
     */
    MerchantDTO getMerchantById(Long merchantId);


    /**
     * 商户注册
     *
     * @param merchantDTO {@link MerchantDTO} 商户dto
     * @return {@link MerchantDTO}
     */
    MerchantDTO createMerchant(MerchantDTO merchantDTO);

    /**
     * 资质申请
     *
     * @param merchantId  商户id
     * @param merchantDTO 资质申请信息
     */
    void applyMerchant(Long merchantId, MerchantDTO merchantDTO);

}
```







#### 接口实现

实现MerchantServiceImpl 中的applyMerchant方法



```java
package mao.aggregate_pay_merchant_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import mao.aggregate_pay_common.domain.CommonErrorCode;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_service.entity.Merchant;
import mao.aggregate_pay_merchant_service.mapper.MerchantMapper;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.tools_core.exception.BizException;
import mao.tools_databases.mybatis.conditions.Wraps;
import mao.toolsdozer.utils.DozerUtils;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service.impl
 * Class(类名): MerchantServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:38
 * Version(版本): 1.0
 * Description(描述)： 商户服务实现类
 */

@Service
public class MerchantServiceImpl extends ServiceImpl<MerchantMapper, Merchant> implements MerchantService
{

    @Resource
    private DozerUtils dozerUtils;

    @Override
    public MerchantDTO getMerchantById(Long merchantId)
    {
        //查询
        Merchant merchant = this.getById(merchantId);
        //转换，并返回
        return dozerUtils.map(merchant, MerchantDTO.class);
    }

    @Override
    public MerchantDTO createMerchant(MerchantDTO merchantDTO)
    {
        //校验商户手机号的唯一性,根据商户的手机号查询商户表，如果存在记录则说明已有相同的手机号重复
        int count = this.count(Wraps.<Merchant>lbQ().eq(Merchant::getMobile, merchantDTO.getMobile()));
        if (count > 0)
        {
            throw BizException.wrap("手机号重复");
        }
        //构建商户
        Merchant merchant = new Merchant();
        //设置审核状态
        merchant.setAuditStatus("0");
        //设置手机号
        merchant.setMobile(merchantDTO.getMobile());
        //保存
        this.save(merchant);
        //保存id信息
        merchantDTO.setId(merchant.getId());
        //返回
        return merchantDTO;
    }

    @Override
    @Transactional
    public void applyMerchant(Long merchantId, MerchantDTO merchantDTO)
    {
        //接收资质申请信息，更新到商户表
        if (merchantDTO == null || merchantId == null)
        {
            throw BizException.wrap("传入对象为空");
        }
        //根据id查询商户
        Merchant merchant = this.getById(merchantId);
        if (merchant == null)
        {
            throw BizException.wrap("商户不存在");
        }
        //对象转换
        Merchant merchant_update = dozerUtils.map(merchantDTO, Merchant.class);
        //已申请待审核
        merchant_update.setAuditStatus("1");
        //租户id
        merchant_update.setTenantId(merchant.getTenantId());
        //设置商户id
        merchant_update.setId(merchantId);
        //更新
        boolean update = this.updateById(merchant_update);
        if (!update)
        {
            throw BizException.wrap("商户资质申请失败");
        }
    }
}

```







#### MerchantController

```java
package mao.aggregate_pay_merchant_service.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.tools_core.base.BaseController;
import mao.tools_core.base.R;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.controller
 * Class(类名): MerchantController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:53
 * Version(版本): 1.0
 * Description(描述)： 商户Controller
 */

@RestController
@Api(tags = "商户")
@RequestMapping("/merchant")
public class MerchantController extends BaseController
{

    @Resource
    private MerchantService merchantService;

    /**
     * 根据商户id查询商户信息
     *
     * @param merchantId 商人id
     * @return {@link R}<{@link MerchantDTO}>
     */
    @ApiOperation("根据商户id查询商户信息")
    @GetMapping("/{merchantId}")
    public R<MerchantDTO> getById(@PathVariable Long merchantId)
    {
        return R.success(merchantService.getMerchantById(merchantId));
    }

    /**
     * 注册商户
     *
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link MerchantDTO}>
     */
    @ApiOperation("注册商户")
    @PostMapping
    public R<MerchantDTO> createMerchant(@RequestBody MerchantDTO merchantDTO)
    {
        return R.success(merchantService.createMerchant(merchantDTO));
    }

    /**
     * 商户资质申请
     *
     * @param merchantId  商人id
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link Boolean}>
     */
    @ApiOperation("商户资质申请")
    @PostMapping("/{merchantId}")
    public R<Boolean> applyMerchant(@PathVariable Long merchantId, @RequestBody MerchantDTO merchantDTO)
    {
        merchantService.applyMerchant(merchantId, merchantDTO);
        return R.success();
    }
}

```







#### 商户服务feign接口

```java
package mao.aggregate_pay_merchant_api.feign;

import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.tools_core.base.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_api.feign
 * Interface(接口名): MerchantFeignClient
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 21:26
 * Version(版本): 1.0
 * Description(描述)： 商户服务feign接口
 */

@FeignClient(value = "aggregate-pay-merchant-service", path = "/merchant")
public interface MerchantFeignClient
{
    /**
     * 根据商户id查询商户信息
     *
     * @param merchantId 商人id
     * @return {@link R}<{@link MerchantDTO}>
     */
    @GetMapping("/{merchantId}")
    R<MerchantDTO> getById(@PathVariable Long merchantId);

    /**
     * 创建商户
     *
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link MerchantDTO}>
     */
    @PostMapping
    R<MerchantDTO> createMerchant(@RequestBody MerchantDTO merchantDTO);

    /**
     * 商户资质申请
     *
     * @param merchantId  商人id
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link Boolean}>
     */
    @PostMapping("/{merchantId}")
    R<Boolean> applyMerchant(@PathVariable Long merchantId, @RequestBody MerchantDTO merchantDTO);
}

```













### 商户平台应用资质申请

#### 接口定义

接口描述：

1. 商户登录平台
2. 商户上传证件，填写资质信息
3. 请求商户平台应用进行资质申请
4. 商户平台应用请求商户服务完成资质申请
5. 返回结果





根据前端编写商户资质申请VO：MerchantDetailVO

```java
package mao.aggregate_pay_merchant_application.vo;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import java.io.Serializable;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.vo
 * Class(类名): MerchantDetailVO
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/11
 * Time(创建时间)： 21:26
 * Version(版本): 1.0
 * Description(描述)： 资质申请信息
 */

@Data
@ApiModel(value = "MerchantDetailVO", description = "商户资质申请信息")
public class MerchantDetailVO implements Serializable
{
    /**
     * 企业名称
     */
    @ApiModelProperty("企业名称")
    private String merchantName;

    /**
     * 企业编号
     */
    @ApiModelProperty("企业编号")
    private String merchantNo;

    /**
     * 企业地址
     */
    @ApiModelProperty("企业地址")
    private String merchantAddress;

    /**
     * 行业类型
     */
    @ApiModelProperty("行业类型")
    private String merchantType;

    /**
     * 营业执照图片
     */
    @ApiModelProperty("营业执照")
    private String businessLicensesImg;

    /**
     * 法人身份证正面
     */
    @ApiModelProperty("法人身份证正面")
    private String idCardFrontImg;

    /**
     * 法人身份证反面
     */
    @ApiModelProperty("法人身份证反面")
    private String idCardAfterImg;

    /**
     * 联系人
     */
    @ApiModelProperty("联系人")
    private String username;

    /**
     * 联系人地址
     */
    @ApiModelProperty("联系人地址")
    private String contactsAddress;
}
```





在MerchantController中定义saveMerchant

```java
/**
 * 商户资质申请
 *
 * @param merchantDetailVO MerchantDetailVO
 */
@ApiOperation("商户资质申请")
@ApiImplicitParams
        ({
                @ApiImplicitParam(name = "merchantDetailVO", value = "商户认证资料", required = true,
                        dataType = "MerchantDetailVO", paramType = "body")
        })
@PostMapping("/my/merchants/save")
public void saveMerchant(@RequestBody MerchantDetailVO merchantDetailVO)
{

}
```







#### 获取商户身份

因前期未实现登录功能，故目前手动指定的商户ID来获取商户id







#### 资质申请实现

编写MerchantController中的saveMerchant方法

```java
package mao.aggregate_pay_merchant_application.controller;

import io.swagger.annotations.*;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_common.domain.BusinessException;
import mao.aggregate_pay_common.domain.CommonErrorCode;
import mao.aggregate_pay_common.utils.PhoneUtil;
import mao.aggregate_pay_common.utils.RandomUuidUtil;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.feign.MerchantFeignClient;
import mao.aggregate_pay_merchant_application.feign.sms.VerificationFeignClient;
import mao.aggregate_pay_merchant_application.handler.AssertResult;
import mao.aggregate_pay_merchant_application.service.FileService;
import mao.aggregate_pay_merchant_application.service.SmsService;
import mao.aggregate_pay_merchant_application.vo.MerchantDetailVO;
import mao.aggregate_pay_merchant_application.vo.MerchantRegisterVO;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import mao.toolsdozer.utils.DozerUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import javax.annotation.Resource;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.controller
 * Class(类名): MerchantController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 21:49
 * Version(版本): 1.0
 * Description(描述)： 商户
 */

@Slf4j
@RestController
@Api(tags = "商户平台应用接口")
public class MerchantController
{

    @Resource
    private VerificationFeignClient verificationFeignClient;

    @Resource
    private SmsService smsService;

    @Resource
    private MerchantFeignClient merchantFeignClient;

    @Resource
    private FileService fileService;

    @Resource
    private DozerUtils dozerUtils;

    /**
     * 发送验证码
     *
     * @param phone 电话
     * @return {@link String} 验证码的key
     */
    @ApiOperation("获取手机验证码")
    @GetMapping("/sms")
    @ApiImplicitParam(value = "手机号", name = "phone", required = true, dataType = "string", paramType = "query")
    public String getSMSCode(@RequestParam("phone") String phone)
    {
        //判断非空
        if (StringUtils.isBlank(phone))
        {
            throw new BusinessException(CommonErrorCode.E_100112);
        }
        //校验手机号的合法性
        if (!PhoneUtil.isMatches(phone))
        {
            throw new BusinessException(CommonErrorCode.E_100109);
        }
        log.info("向手机号:{}发送验证码", phone);
        //向验证码服务请求发送验证码
        Map<String, Object> map = new HashMap<>();
        map.put("mobile", phone);
        return verificationFeignClient.generateVerificationInfo("sms", map, 20 * 60).getResult().getKey();
    }

    /**
     * 注册商户
     *
     * @param merchantRegisterVO MerchantRegisterVO
     * @return {@link MerchantRegisterVO}
     */
    @PostMapping("/merchants/register")
    @ApiOperation("商户注册")
    @ApiImplicitParam(value = "商户注册信息", name = "merchantRegisterVO", required = true, dataType = "MerchantRegisterVO", paramType = "body")
    public MerchantRegisterVO registerMerchant(@RequestBody MerchantRegisterVO merchantRegisterVO)
    {

        if (merchantRegisterVO.getVerifiykey() == null || merchantRegisterVO.getVerifiykey().equals(""))
        {
            throw BizException.wrap("验证码的key为空");
        }
        if (merchantRegisterVO.getVerifiyCode() == null || merchantRegisterVO.getVerifiyCode().equals(""))
        {
            throw BizException.wrap("请输入验证码");
        }
        smsService.checkVerifyCode(merchantRegisterVO.getVerifiykey(), merchantRegisterVO.getVerifiyCode());

        //注册商户
        MerchantDTO merchantDTO = new MerchantDTO();
        merchantDTO.setUsername(merchantRegisterVO.getUsername());
        merchantDTO.setMobile(merchantRegisterVO.getMobile());
        merchantDTO.setPassword(merchantRegisterVO.getPassword());

        if (StringUtils.isBlank(merchantDTO.getMobile()))
        {
            throw new BusinessException(CommonErrorCode.E_100112);
        }
        //校验手机号的合法性
        if (!PhoneUtil.isMatches(merchantDTO.getMobile()))
        {
            throw new BusinessException(CommonErrorCode.E_100109);
        }
        //联系人非空校验
        if (StringUtils.isBlank(merchantDTO.getUsername()))
        {
            throw new BusinessException(CommonErrorCode.E_100110);
        }
        //密码非空校验
        if (StringUtils.isBlank(merchantDTO.getPassword()))
        {
            throw new BusinessException(CommonErrorCode.E_100111);
        }

        //远程调用
        R<MerchantDTO> result = merchantFeignClient.createMerchant(merchantDTO);
        //断言结果
        AssertResult.handler(result);
        //返回
        return merchantRegisterVO;

    }

    /**
     * 上传证件照
     *
     * @param multipartFile 多部分文件
     * @return {@link String}
     * @throws IOException io异常
     */
    @ApiOperation("上传证件照")
    @PostMapping("/upload")
    public String upload(@ApiParam(value = "证件照", required = true) @RequestParam("file") MultipartFile multipartFile)
            throws IOException
    {
        //调用fileService上传文件
        //生成的文件名称fileName，要保证它的唯一
        //文件原始名称
        String originalFilename = multipartFile.getOriginalFilename();
        //文件名称
        String fileName = RandomUuidUtil.getUUID() + "_" + originalFilename;
        //byte[] bytes,String fileName
        return fileService.upload(multipartFile.getBytes(), fileName);
    }


    /**
     * 商户资质申请
     *
     * @param merchantDetailVO MerchantDetailVO
     */
    @ApiOperation("商户资质申请")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "merchantDetailVO", value = "商户认证资料", required = true,
                            dataType = "MerchantDetailVO", paramType = "body")
            })
    @PostMapping("/my/merchants/save")
    public void saveMerchant(@RequestBody MerchantDetailVO merchantDetailVO)
    {
        //商户id
        Long merchantId = 124619633188667425L;
        //转换
        MerchantDTO merchantDTO = dozerUtils.map(merchantDetailVO, MerchantDTO.class);
        //发起远程调用
        R<Boolean> result = merchantFeignClient.applyMerchant(merchantId, merchantDTO);
        //断言结果
        AssertResult.handler(result);
    }

}
```









#### 接口测试



|      参数名称       |     参数说明     | 请求类型 | 是否必须 |     数据类型     |      schema      |
| :-----------------: | :--------------: | :------: | :------- | :--------------: | :--------------: |
|  merchantDetailVO   | 商户资质申请信息 |   body   | true     | MerchantDetailVO | MerchantDetailVO |
| businessLicensesImg |     营业执照     |          | false    |      string      |                  |
|   contactsAddress   |    联系人地址    |          | false    |      string      |                  |
|   idCardAfterImg    |  法人身份证反面  |          | false    |      string      |                  |
|   idCardFrontImg    |  法人身份证正面  |          | false    |      string      |                  |
|   merchantAddress   |     企业地址     |          | false    |      string      |                  |
|    merchantName     |     企业名称     |          | false    |      string      |                  |
|     merchantNo      |     企业编号     |          | false    |      string      |                  |
|    merchantType     |     行业类型     |          | false    |      string      |                  |
|      username       |      联系人      |          | false    |      string      |                  |





![image-20230111215144745](img/聚合支付项目实战学习笔记/image-20230111215144745.png)





日志

```sh
2023-01-11 21:58:19.378 DEBUG 14340 --- [io-56931-exec-4] m.a.mapper.MerchantMapper.selectById     : ==>  Preparing: SELECT ID,ID_CARD_FRONT_IMG,MOBILE,ID_CARD_AFTER_IMG,BUSINESS_LICENSES_IMG,MERCHANT_NAME,TENANT_ID,AUDIT_STATUS,CONTACTS_ADDRESS,MERCHANT_ADDRESS,MERCHANT_TYPE,USERNAME,MERCHANT_NO FROM merchant WHERE ID=? 
2023-01-11 21:58:19.465 DEBUG 14340 --- [io-56931-exec-4] m.a.mapper.MerchantMapper.selectById     : ==> Parameters: 124619633188667425(Long)
 Consume Time：2 ms 2023-01-11 21:58:19
 Execute SQL：SELECT ID,ID_CARD_FRONT_IMG,MOBILE,ID_CARD_AFTER_IMG,BUSINESS_LICENSES_IMG,MERCHANT_NAME,TENANT_ID,AUDIT_STATUS,CONTACTS_ADDRESS,MERCHANT_ADDRESS,MERCHANT_TYPE,USERNAME,MERCHANT_NO FROM merchant WHERE ID=124619633188667425 

2023-01-11 21:58:19.479 DEBUG 14340 --- [io-56931-exec-4] m.a.mapper.MerchantMapper.selectById     : <==      Total: 1
2023-01-11 21:58:19.556 DEBUG 14340 --- [io-56931-exec-4] m.t.datasource.MyMetaObjectHandler       : start update fill ....
2023-01-11 21:58:19.557 DEBUG 14340 --- [io-56931-exec-4] m.a.mapper.MerchantMapper.updateById     : ==>  Preparing: UPDATE merchant SET ID_CARD_FRONT_IMG=?, ID_CARD_AFTER_IMG=?, BUSINESS_LICENSES_IMG=?, MERCHANT_NAME=?, AUDIT_STATUS=?, CONTACTS_ADDRESS=?, MERCHANT_ADDRESS=?, MERCHANT_TYPE=?, USERNAME=? WHERE ID=? 
2023-01-11 21:58:19.562 DEBUG 14340 --- [io-56931-exec-4] m.a.mapper.MerchantMapper.updateById     : ==> Parameters: test3.jpg(String), test2.jpg(String), test.jpg(String), 测试商户(String), 1(String), 中国(String), 中国(String), (String), 133444522(String), 124619633188667425(Long)
2023-01-11 21:58:19.567 DEBUG 14340 --- [io-56931-exec-4] m.a.mapper.MerchantMapper.updateById     : <==    Updates: 1
 Consume Time：4 ms 2023-01-11 21:58:19
 Execute SQL：UPDATE merchant SET ID_CARD_FRONT_IMG='test3.jpg', ID_CARD_AFTER_IMG='test2.jpg', BUSINESS_LICENSES_IMG='test.jpg', MERCHANT_NAME='测试商户', AUDIT_STATUS='1', CONTACTS_ADDRESS='中国', MERCHANT_ADDRESS='中国', MERCHANT_TYPE='', USERNAME='133444522' WHERE ID=124619633188667425
```





查看数据库

![image-20230111215932918](img/聚合支付项目实战学习笔记/image-20230111215932918.png)





![image-20230111215948580](img/聚合支付项目实战学习笔记/image-20230111215948580.png)































# 支付参数配置

## 需求概述

### 理解应用

商户资质审核通过后就可以使用聚合支付平台提供的服务，平台所提供的基础服务正是聚合支付。聚合支付就是将微信、支付宝等支付渠道汇聚为一个支付通道供商户使用

平台提供线上支付和线下支付两个方式，线上支付可通过手机和PC完成，线下支付可通过扫码完成



1. 平台对接微信、支付宝等众多支付渠道
2. 商户创建自己的应用
3. 用户在使用商户某个应用时发起支付到平台
4. 平台根据用户的支付请求使用具体的支付渠道完成支付





#### 支付渠道

支付渠道是指微信、支付宝等第三方支付机构提供的支付渠道，平台是要聚合这些支付渠道，为用户提供一个支付 通道



#### 应用

应用是商户在平台创建的业务标识，比如：商户在自己的XX电商网站使用闪聚支付则会创建“XX电商网站 应用”，商户在自己经营的餐厅使用闪聚支付则会创建“XX餐厅应用”

用户是基于某个应用完成的支付，用户在商户的餐厅支付则支付订单会隶属于“XX餐厅应用”下，用户在XX电商网站支付则支付订单会隶属于“XX电商网站应用”下

平台通过应用来管理商户的支付订单，实现按业务进行订单管理、财务数据统计等功能。比如：可以统计“XX餐厅应用”下的支付订单，统计“XX电商网站应用”下的订单信息







### 理解支付渠道参数配置

为了给用户提供更便利的支付体验而聚合了微信、支付宝等第三方支付渠道为一个支付通道，用户通过平台完成支付，平台最终会请求第三方支付渠道完成支付

所以， 商户不仅是平台的商户，还是第三方支付机构的商户，商户要使用平台就需要开通微信、支付宝等支付渠道，然后在平台配置支付渠道参数



#### 整体流程

1. 商户在支付宝、微信开通支付
2. 商户在平台配置支付渠道参数
3. 平台为商户生成一个支付二维码
4. 用户扫二维码完成支付，当用户用支付宝扫描二维码则自动用支付宝完成支付，当使用微信扫描二维码则自动打开微信进行支付





#### 服务类型

服务类型是平台为商户提供的聚合支付服务通道，共分为线上和线下两大类：

线上支付服务通道：

* 手机APP支付
* PC网页支付
* 手机网页支付
* 小程序支付



线下支付服务通道：

* 收款码支付(C扫B)，商户出示收款码，用户扫收款码完成支付
* B扫C，顾客出示付款码，商户扫描付款码





#### 商户为应用绑定服务类型

用户是基于某个应用进行支付，商户为应用绑定服务类型。比如：商户为”XX餐厅应 用“绑定服务类型为收款码支付，则用户可以C扫B支付；商户为“XX电商网站应用”指定服务类型为“手机网页支付”， 则用户可以通过手机端在XX电商网站完成支付。一个应用可以指定多个服务类型







#### 配置支付渠道参数

第三方支付渠道提供多种支付方式，比如：微信提供如下支付方式和支付宝提供的支付方式

微信支付方式：

![image-20230112143009978](img/聚合支付项目实战学习笔记/image-20230112143009978.png)



支付宝支付方式：

![image-20230112143033225](img/聚合支付项目实战学习笔记/image-20230112143033225.png)







商户需要根据应用所绑定的服务类型来配置支付渠道的参数，比如：应用绑定的服务类型是“收款码支付（c扫 b）”则需要配置微信的“JSAPI支付”和支付宝的“手机网站支付”参数，如果还聚合了百度、京东等第三方支付渠道，且商户还希望顾客可以用百度、京东的App完成支付，此时商户就需要配置百度、京东所提供的“手机网页支付”参数



微信JSAPI支付：微信提供的内嵌于微信App内的网页支付，可用于微信公众号支付

支付宝手机网站支付：支付宝提供的用于手机网页支付方式















## 创建应用

创建应用的流程如下 ：

![image-20230112143722264](img/聚合支付项目实战学习笔记/image-20230112143722264.png)





1. 填写应用基本信息

![image-20230112143742148](img/聚合支付项目实战学习笔记/image-20230112143742148.png)





2. 点击保存信息









## 支付渠道参数配置

支付渠道参数的配置流程 ：

![image-20230112143811760](img/聚合支付项目实战学习笔记/image-20230112143811760.png)



**步骤：**



1. 应用创建成功后，会自动跳转到绑定服务类型页面

![image-20230112143841383](img/聚合支付项目实战学习笔记/image-20230112143841383.png)



2. 点击开启服务为应用绑定服务类型

![image-20230112143910250](img/聚合支付项目实战学习笔记/image-20230112143910250.png)



3. 开启服务后，点击配置实际支付渠道按钮进入参数配置页面

![image-20230112143931038](img/聚合支付项目实战学习笔记/image-20230112143931038.png)





4. 配置参数页面会显示对应服务类型下的原始支付渠道

![image-20230112143955661](img/聚合支付项目实战学习笔记/image-20230112143955661.png)





5. 点击配置参数按钮，为指定原始支付渠道配置

![image-20230112144022436](img/聚合支付项目实战学习笔记/image-20230112144022436.png)





6. 填写支付宝或微信的支付参数



















# 日志服务

## 概述

所有服务都需要打印日志，日志服务就是把所有服务的日志收集起来，统一保存到数据库，日志生产的服务通过feign接口的方式异步的将日志发送到日志服务，日志服务再将日志保存到数据库，此日志并不是控制台打印的日志，而是系统操作日志或者登录日志



模块名称：aggregate-pay-log



## 数据库表

数据库名称：aggregate_pay_log

表：

```sql
# 数据库名称：aggregate_pay_log

DROP TABLE IF EXISTS `opt_log`;
CREATE TABLE `opt_log`
(
    `id`             bigint(20)   NOT NULL COMMENT '主键',
    `request_ip`     varchar(50)       DEFAULT '' COMMENT '操作IP',
    `type`           varchar(5)        DEFAULT 'OPT' COMMENT '日志类型\n#LogType{OPT:操作类型;EX:异常类型}',
    `user_name`      bigint(20)        DEFAULT NULL COMMENT '操作人(商户id)',
    `description`    varchar(255)      DEFAULT '' COMMENT '操作描述',
    `class_path`     varchar(255)      DEFAULT '' COMMENT '类路径',
    `action_method`  varchar(150)      DEFAULT '' COMMENT '请求方法',
    `request_uri`    varchar(50)       DEFAULT '' COMMENT '请求地址',
    `http_method`    varchar(10)       DEFAULT 'GET' COMMENT '请求类型\n#HttpMethod{GET:GET请求;POST:POST请求;PUT:PUT请求;DELETE:DELETE请求;PATCH:PATCH请求;TRACE:TRACE请求;HEAD:HEAD请求;OPTIONS:OPTIONS请求;}',
    `params`         longtext COMMENT '请求参数',
    `result`         longtext COMMENT '返回值',
    `ex_desc`        longtext COMMENT '异常详情信息',
    `ex_detail`      longtext COMMENT '异常描述',
    `start_time`     timestamp(3) NULL DEFAULT NULL COMMENT '开始时间',
    `finish_time`    timestamp(3) NULL DEFAULT NULL COMMENT '完成时间',
    `consuming_time` bigint(20)        DEFAULT '0' COMMENT '消耗时间',
    `ua`             varchar(500)      DEFAULT '' COMMENT '浏览器',
    PRIMARY KEY (`id`) USING BTREE,
    KEY `index_type` (`type`) USING BTREE COMMENT '日志类型',
    KEY `index_user_name` (`user_name`) USING BTREE COMMENT '操作人(商户id)'
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  ROW_FORMAT = DYNAMIC COMMENT ='系统日志';


-- ----------------------------
-- Table structure for `common_login_log`
-- ----------------------------
DROP TABLE IF EXISTS `login_log`;
CREATE TABLE `login_log`
(
    `id`         bigint(20) NOT NULL COMMENT '主键',
    `request_ip` varchar(50)  DEFAULT '' COMMENT '操作IP',
    `user_id`    bigint(20)   DEFAULT NULL COMMENT '登录人ID',
    `username`   varchar(30)  DEFAULT '' COMMENT '登录人账号',
    `mobile`     varchar(12)  DEFAULT '' COMMENT '手机号',
    `tenants`    varchar(255) DEFAULT '' COMMENT '账号所属的多个租户id，json数据保存',
    `login_date` timestamp    DEFAULT NULL COMMENT '登录时间',
    `location`   varchar(50)  DEFAULT '' COMMENT '登录地点',
    PRIMARY KEY (`id`) USING BTREE,
    KEY `IDX_LOGIN_DATE` (`login_date`, username) USING BTREE,
    KEY `IDX_ACCOUNT_IP` (username, `request_ip`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  ROW_FORMAT = DYNAMIC COMMENT ='登录日志';

```











## 搭建服务

### pom文件

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <artifactId>pay</artifactId>
        <groupId>mao</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>

    <artifactId>aggregate-pay-log</artifactId>
    <name>aggregate-pay-log</name>
    <description>聚合支付日志模块</description>

    <dependencies>

        <dependency>
            <groupId>mao</groupId>
            <artifactId>aggregate-pay-entity</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- nacos 客户端依赖 -->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
        </dependency>

        <!--Nacos配置管理客户端依赖-->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
        </dependency>

        <dependency>
            <groupId>mao</groupId>
            <artifactId>tools-databases</artifactId>
        </dependency>

        <dependency>
            <groupId>mao</groupId>
            <artifactId>tools-common</artifactId>
        </dependency>

        <dependency>
            <groupId>mao</groupId>
            <artifactId>tools-core</artifactId>
        </dependency>

        <dependency>
            <groupId>mao</groupId>
            <artifactId>tools-swagger2</artifactId>
        </dependency>

    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>

</project>
```





### 配置文件

#### application.yml

```yaml
server:
  port: 27914
```





#### bootstrap.yml

```yaml
# @xxx@ 从pom.xml中取值, 所以 @xx@ 标注的值，都不能从nacos中获取
def:
  nacos:
    ip: ${NACOS_IP:@pom.nacos.ip@}
    port: ${NACOS_PORT:@pom.nacos.port@}
    namespace: ${NACOS_ID:@pom.nacos.namespace@}

spring:
  main:
    allow-bean-definition-overriding: true
  application:
    name: @project.artifactId@
  profiles:
    active: @pom.profile.name@
  cloud:
    nacos:
      config: #配置中心相关
        server-addr: ${def.nacos.ip}:${def.nacos.port}
        file-extension: yml
        namespace: ${def.nacos.namespace}
        shared-dataids: common.yml,redis.yml,mysql.yml
        refreshable-dataids: common.yml
        enabled: true
      discovery: #服务注册中心相关
        # 是否为临时实例
        ephemeral: false
        server-addr: ${def.nacos.ip}:${def.nacos.port}
        namespace: ${def.nacos.namespace}
        metadata: # 元数据，用于权限服务实时获取各个服务的所有接口
          management.context-path: ${server.servlet.context-path:}${spring.mvc.servlet.path:}${management.endpoints.web.base-path:}


  aop:
    proxy-target-class: true
    auto: true

# 只能配置在bootstrap.yml ，否则会生成 log.path_IS_UNDEFINED 文件夹
# window会自动在 代码所在盘 根目录下自动创建文件夹，  如： D:/data/projects/logs
logging:
  file:
    path: ./logs
    name: ${logging.file.path}/${spring.application.name}/root.log

# 用于/actuator/info
info:
  name: '@project.name@'
  description: '@project.description@'
  version: '@project.version@'
  spring-boot-version: '@spring.boot.version@'
  spring-cloud-version: '@spring.cloud.version@'
```





#### spy.properties

```properties
module.log=com.p6spy.engine.logging.P6LogFactory,com.p6spy.engine.outage.P6OutageFactory
# \u81EA\u5B9A\u4E49\u65E5\u5FD7\u6253\u5370
logMessageFormat=com.baomidou.mybatisplus.extension.p6spy.P6SpyLogger
#\u65E5\u5FD7\u8F93\u51FA\u5230\u63A7\u5236\u53F0
appender=com.baomidou.mybatisplus.extension.p6spy.StdoutLogger
# \u4F7F\u7528\u65E5\u5FD7\u7CFB\u7EDF\u8BB0\u5F55 sql
#appender=com.p6spy.engine.spy.appender.Slf4JLogger
# \u8BBE\u7F6E p6spy driver \u4EE3\u7406
deregisterdrivers=true
# \u53D6\u6D88JDBC URL\u524D\u7F00
useprefix=true
# \u914D\u7F6E\u8BB0\u5F55 Log \u4F8B\u5916,\u53EF\u53BB\u6389\u7684\u7ED3\u679C\u96C6\u6709error,info,batch,debug,statement,commit,rollback,result,resultset.
excludecategories=info,debug,result,commit,resultset
# \u65E5\u671F\u683C\u5F0F
dateformat=yyyy-MM-dd HH:mm:ss
# \u5B9E\u9645\u9A71\u52A8\u53EF\u591A\u4E2A
driverlist=com.mysql.cj.jdbc.Driver
# \u662F\u5426\u5F00\u542F\u6162SQL\u8BB0\u5F55
outagedetection=true
# \u6162SQL\u8BB0\u5F55\u6807\u51C6 2 \u79D2
outagedetectioninterval=2
```









### 实体类

#### OptLog

```java
package mao.aggregate_pay_entity.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.fasterxml.jackson.annotation.JsonFormat;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.*;
import lombok.experimental.Accessors;
import mao.tools_common.enums.HttpMethod;


import java.io.Serializable;
import java.time.LocalDateTime;

import static com.baomidou.mybatisplus.annotation.SqlCondition.LIKE;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_log.entity
 * Class(类名): OptLog
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 14:08
 * Version(版本): 1.0
 * Description(描述)： 操作日志
 */

@Data
@NoArgsConstructor
@AllArgsConstructor
@ToString(callSuper = true)
@EqualsAndHashCode
@Accessors(chain = true)
@TableName("opt_log")
@ApiModel(value = "OptLog", description = "系统日志")
public class OptLog implements Serializable
{
    /**
     * 串行版本uid
     */
    private static final long serialVersionUID = 1L;

    /**
     * id
     */
    @TableId(value = "id", type = IdType.INPUT)
    @ApiModelProperty(value = "主键")
    private Long id;


    /**
     * 操作IP
     */
    @ApiModelProperty(value = "操作IP")
    @TableField(value = "request_ip", condition = LIKE)
    private String requestIp;

    /**
     * 日志类型
     * #LogType{OPT:操作类型;EX:异常类型}
     */
    @ApiModelProperty(value = "日志类型")
    @TableField("type")
    private LogType type;

    /**
     * 操作人
     */
    @ApiModelProperty(value = "操作人(商户id)")
    @TableField(value = "user_name", condition = LIKE)
    private Long userName;

    /**
     * 操作描述
     */
    @ApiModelProperty(value = "操作描述")
    @TableField(value = "description", condition = LIKE)
    private String description;

    /**
     * 类路径
     */
    @ApiModelProperty(value = "类路径")
    @TableField(value = "class_path", condition = LIKE)
    private String classPath;

    /**
     * 请求方法
     */
    @ApiModelProperty(value = "请求方法")
    @TableField(value = "action_method", condition = LIKE)
    private String actionMethod;

    /**
     * 请求地址
     */
    @ApiModelProperty(value = "请求地址")
    @TableField(value = "request_uri", condition = LIKE)
    private String requestUri;

    /**
     * 请求类型
     * #HttpMethod{GET:GET请求;POST:POST请求;PUT:PUT请求;DELETE:DELETE请求;PATCH:PATCH请求;TRACE:TRACE请求;HEAD:HEAD请求;OPTIONS:OPTIONS请求;}
     */
    @ApiModelProperty(value = "请求类型")
    @TableField("http_method")
    private HttpMethod httpMethod;

    /**
     * 请求参数
     */
    @ApiModelProperty(value = "请求参数")
    @TableField("params")
    private String params;

    /**
     * 返回值
     */
    @ApiModelProperty(value = "返回值")
    @TableField("result")
    private String result;

    /**
     * 异常详情信息
     */
    @ApiModelProperty(value = "异常详情信息")
    @TableField("ex_desc")
    private String exDesc;

    /**
     * 异常描述
     */
    @ApiModelProperty(value = "异常描述")
    @TableField("ex_detail")
    private String exDetail;

    /**
     * 开始时间
     */
    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd HH:mm:ss[.SSS]")
    @ApiModelProperty(value = "开始时间")
    @TableField("start_time")
    private LocalDateTime startTime;

    /**
     * 完成时间
     */
    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd HH:mm:ss[.SSS]")
    @ApiModelProperty(value = "完成时间")
    @TableField("finish_time")
    private LocalDateTime finishTime;

    /**
     * 消耗时间
     */
    @ApiModelProperty(value = "消耗时间")
    @TableField("consuming_time")
    private Long consumingTime;

    /**
     * 浏览器
     */
    @ApiModelProperty(value = "浏览器")
    @TableField(value = "ua", condition = LIKE)
    private String ua;

}
```





#### LogType

```java
package mao.aggregate_pay_entity.entity;


import com.fasterxml.jackson.annotation.JsonFormat;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import mao.tools_core.base.BaseEnum;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_log.entity
 * Class(类名): LogType
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 14:12
 * Version(版本): 1.0
 * Description(描述)： 无
 */


@Getter
@AllArgsConstructor
@NoArgsConstructor
@ApiModel(value = "LogType", description = "日志类型-枚举")
@JsonFormat(shape = JsonFormat.Shape.OBJECT)
public enum LogType implements BaseEnum
{

    /**
     * OPT="操作类型"
     */
    OPT("正常"),
    /**
     * EX="异常类型"
     */
    EX("异常"),
    ;

    @ApiModelProperty(value = "描述")
    private String desc;


    public static LogType match(String val, LogType def)
    {
        for (LogType enm : LogType.values())
        {
            if (enm.name().equalsIgnoreCase(val))
            {
                return enm;
            }
        }
        return def;
    }

    public static LogType get(String val)
    {
        return match(val, null);
    }

    public boolean eq(String val)
    {
        return this.name().equalsIgnoreCase(val);
    }

    public boolean eq(LogType val)
    {
        if (val == null)
        {
            return false;
        }
        return eq(val.name());
    }

    @Override
    @ApiModelProperty(value = "编码", allowableValues = "OPT,EX", example = "OPT")
    public String getCode()
    {
        return this.name();
    }

}
```



![image-20230115141534899](img/聚合支付项目实战学习笔记/image-20230115141534899.png)





#### LoginLog

```java
package mao.aggregate_pay_entity.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.fasterxml.jackson.annotation.JsonFormat;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.*;
import lombok.experimental.Accessors;
import mao.tools_common.enums.HttpMethod;

import java.io.Serializable;
import java.time.LocalDateTime;

import static com.baomidou.mybatisplus.annotation.SqlCondition.LIKE;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_entity.entity
 * Class(类名): LoginLog
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/24
 * Time(创建时间)： 15:10
 * Version(版本): 1.0
 * Description(描述)： 登录日志
 */

@Data
@NoArgsConstructor
@AllArgsConstructor
@ToString(callSuper = true)
@EqualsAndHashCode
@Accessors(chain = true)
@TableName("login_log")
@ApiModel(value = "LoginLog", description = "登录日志")
public class LoginLog implements Serializable
{
    /**
     * 串行版本uid
     */
    private static final long serialVersionUID = 1L;

    /**
     * 主键
     */
    @TableId(value = "id", type = IdType.INPUT)
    @ApiModelProperty(value = "主键")
    private Long id;


    /**
     * 登录IP
     */
    @ApiModelProperty(value = "登录IP")
    @TableField(value = "request_ip", condition = LIKE)
    private String requestIp;


    /**
     * 登录人ID
     */
    @ApiModelProperty(value = "登录人ID")
    @TableField(value = "user_id", condition = LIKE)
    private Long userId;


    /**
     * 用户名
     */
    @ApiModelProperty(value = "用户名")
    @TableField(value = "username")
    private String username;


    /**
     * 手机号
     */
    @ApiModelProperty(value = "手机号")
    @TableField(value = "mobile")
    private String mobile;


    /**
     * 账号所属的多个租户id，json数据保存
     */
    @ApiModelProperty(value = "账号所属的多个租户id，json数据保存")
    @TableField(value = "tenants")
    private String tenants;


    /**
     * 登录时间
     */
    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd HH:mm:ss")
    @ApiModelProperty(value = "登录时间")
    @TableField("login_date")
    private LocalDateTime loginDate;


    /**
     * 登录地点
     */
    @ApiModelProperty(value = "登录地点")
    @TableField("location")
    private String location;
}
```





#### LoginLogDTO

```java
package mao.aggregate_pay_entity.dto;

import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableName;
import com.fasterxml.jackson.annotation.JsonFormat;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.*;
import lombok.experimental.Accessors;

import java.time.LocalDateTime;

import static com.baomidou.mybatisplus.annotation.SqlCondition.LIKE;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_entity.dto
 * Class(类名): LoginLogDTO
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/24
 * Time(创建时间)： 15:21
 * Version(版本): 1.0
 * Description(描述)： LoginLogDTO
 */

@Data
@NoArgsConstructor
@AllArgsConstructor
@ToString(callSuper = true)
@EqualsAndHashCode
@Accessors(chain = true)
@ApiModel(value = "LoginLogDTO", description = "登录日志DTO")
public class LoginLogDTO
{

    /**
     * 登录IP
     */
    @ApiModelProperty(value = "登录IP")
    @TableField(value = "request_ip", condition = LIKE)
    private String requestIp;


    /**
     * 用户名
     */
    @ApiModelProperty(value = "用户名")
    @TableField(value = "username")
    private String username;


    /**
     * 手机号
     */
    @ApiModelProperty(value = "手机号")
    @TableField(value = "mobile")
    private String mobile;


    /**
     * 账号所属的多个租户id，json数据保存
     */
    @ApiModelProperty(value = "账号所属的多个租户id，json数据保存")
    @TableField(value = "tenants")
    private String tenants;


    /**
     * 登录时间
     */
    @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd HH:mm:ss")
    @ApiModelProperty(value = "登录时间")
    @TableField("login_date")
    private LocalDateTime loginDate;


    /**
     * 登录地点
     */
    @ApiModelProperty(value = "登录地点")
    @TableField("location")
    private String location;
}
```



![image-20230124222102278](img/聚合支付项目实战学习笔记/image-20230124222102278.png)









### 操作日志Mapper接口

```java
package mao.aggregate_pay_log.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;

import mao.aggregate_pay_entity.entity.OptLog;
import org.apache.ibatis.annotations.Mapper;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_log.mapper
 * Interface(接口名): OptLogMapper
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 14:17
 * Version(版本): 1.0
 * Description(描述)： 操作日志
 */

@Mapper
public interface OptLogMapper extends BaseMapper<OptLog>
{

}
```





### 操作日志服务

```java
package mao.aggregate_pay_log.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_entity.entity.OptLog;


/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_log.service
 * Class(类名): OptLogService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 14:18
 * Version(版本): 1.0
 * Description(描述)： 操作日志服务
 */

public interface OptLogService extends IService<OptLog>
{

}
```









### 操作日志服务实现类

```java
package mao.aggregate_pay_log.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;

import mao.aggregate_pay_entity.entity.OptLog;
import mao.aggregate_pay_log.mapper.OptLogMapper;
import mao.aggregate_pay_log.service.OptLogService;
import org.springframework.stereotype.Service;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_log.service.impl
 * Class(类名): OptLogServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 14:19
 * Version(版本): 1.0
 * Description(描述)： 操作日志服务实现类
 */

@Service
public class OptLogServiceImpl extends ServiceImpl<OptLogMapper, OptLog> implements OptLogService
{

}
```







### 操作日志controller

```java
package mao.aggregate_pay_log.controller;


import com.baomidou.mybatisplus.core.metadata.IPage;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiImplicitParams;
import io.swagger.annotations.ApiOperation;

import mao.aggregate_pay_entity.entity.OptLog;
import mao.aggregate_pay_log.service.OptLogService;
import mao.tools_core.base.BaseController;
import mao.tools_core.base.R;
import mao.tools_databases.mybatis.conditions.Wraps;
import mao.tools_databases.mybatis.conditions.query.LbqWrapper;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_log.controller
 * Class(类名): OptLogController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 14:31
 * Version(版本): 1.0
 * Description(描述)： 操作日志
 */

@Api(tags = "操作日志")
@RestController
@RequestMapping("/log/opt")
public class OptLogController extends BaseController
{
    @Resource
    private OptLogService optLogService;

    /**
     * 保存操作日志
     *
     * @param optLog 操作日志
     * @return {@link R}<{@link Boolean}>
     */
    @PostMapping
    @ApiOperation("保存操作日志")
    public R<Boolean> save(@RequestBody OptLog optLog)
    {
        boolean save = optLogService.save(optLog);
        if (!save)
        {
            return fail("保存失败");
        }
        return success();
    }


    /**
     * 分页查询系统操作日志
     */
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "current", value = "当前页", dataType = "long", paramType = "query", defaultValue = "1"),
                    @ApiImplicitParam(name = "size", value = "每页显示几条", dataType = "long", paramType = "query", defaultValue = "10"),
            })
    @ApiOperation(value = "分页查询系统操作日志", notes = "分页查询系统操作日志")
    @GetMapping("/page")
    public R<IPage<OptLog>> page()
    {
        IPage<OptLog> page = getPage();
        LbqWrapper<OptLog> query = Wraps.<OptLog>lbQ()
                .orderByDesc(OptLog::getId);
        optLogService.page(page, query);
        return success(page);
    }


    /**
     * 分页查询某个商户的系统操作日志
     */
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "current", value = "当前页", dataType = "long", paramType = "query", defaultValue = "1"),
                    @ApiImplicitParam(name = "size", value = "每页显示几条", dataType = "long", paramType = "query", defaultValue = "10"),
            })
    @ApiOperation(value = "分页查询某个商户的系统操作日志", notes = "分页查询某个商户的系统操作日志")
    @GetMapping("/page/{merchantId}")
    public R<IPage<OptLog>> page(@PathVariable Long merchantId)
    {
        if (merchantId == null || merchantId < 0)
        {
            return R.success(getPage());
        }
        IPage<OptLog> page = getPage();
        LbqWrapper<OptLog> query = Wraps.<OptLog>lbQ()
                .eq(OptLog::getUserName, merchantId)
                .orderByDesc(OptLog::getId);
        optLogService.page(page, query);
        return success(page);
    }

    /**
     * 分页查询某个商户的系统操作日志，给商户看的
     */
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "current", value = "当前页", dataType = "long", paramType = "query", defaultValue = "1"),
                    @ApiImplicitParam(name = "size", value = "每页显示几条", dataType = "long", paramType = "query", defaultValue = "10"),
            })
    @ApiOperation(value = "商户分页查询的系统操作日志", notes = "商户分页查询的系统操作日志")
    @GetMapping("/page2/{merchantId}")
    public R<IPage<OptLog>> page2(@PathVariable Long merchantId)
    {
        if (merchantId == null || merchantId < 0)
        {
            return R.success(getPage());
        }
        IPage<OptLog> page = getPage();
        LbqWrapper<OptLog> query = Wraps.<OptLog>lbQ()
                .select(OptLog::getDescription, OptLog::getId, OptLog::getFinishTime, OptLog::getRequestIp, OptLog::getType)
                .eq(OptLog::getUserName, merchantId)
                .orderByDesc(OptLog::getId);
        optLogService.page(page, query);
        return success(page);
    }


    /**
     * 查询系统操作日志
     */
    @ApiOperation(value = "查询系统操作日志", notes = "查询系统操作日志")
    @GetMapping("/{id}")
    public R<OptLog> get(@PathVariable Long id)
    {
        return success(optLogService.getById(id));
    }

}
```







![image-20230115141804695](img/聚合支付项目实战学习笔记/image-20230115141804695.png)







### 登录日志Mapper接口

```java
package mao.aggregate_pay_log.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import mao.aggregate_pay_entity.entity.LoginLog;
import org.apache.ibatis.annotations.Mapper;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_log.mapper
 * Interface(接口名): LoginLogMapper
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/24
 * Time(创建时间)： 15:24
 * Version(版本): 1.0
 * Description(描述)： 登录日志
 */

@Mapper
public interface LoginLogMapper extends BaseMapper<LoginLog>
{

}
```







### 登录日志服务

```java
package mao.aggregate_pay_log.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_entity.entity.LoginLog;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_log.service
 * Interface(接口名): LoginLogService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/24
 * Time(创建时间)： 15:25
 * Version(版本): 1.0
 * Description(描述)： 登录日志服务
 */

public interface LoginLogService extends IService<LoginLog>
{

}
```





### 登录日志服务实现类

```java
package mao.aggregate_pay_log.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import mao.aggregate_pay_entity.entity.LoginLog;
import mao.aggregate_pay_log.mapper.LoginLogMapper;
import mao.aggregate_pay_log.service.LoginLogService;
import org.springframework.stereotype.Service;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_log.service.impl
 * Class(类名): LoginLogServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/24
 * Time(创建时间)： 15:25
 * Version(版本): 1.0
 * Description(描述)： 登录日志服务实现类
 */

@Service
public class LoginLogServiceImpl extends ServiceImpl<LoginLogMapper, LoginLog> implements LoginLogService
{

}
```





### 登录日志controller

```java
package mao.aggregate_pay_log.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiImplicitParams;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_entity.entity.LoginLog;
import mao.aggregate_pay_entity.entity.OptLog;
import mao.aggregate_pay_log.service.LoginLogService;
import mao.tools_core.base.BaseController;
import mao.tools_core.base.R;
import mao.tools_databases.mybatis.conditions.Wraps;
import mao.tools_databases.mybatis.conditions.query.LbqWrapper;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_log.controller
 * Class(类名): LoginLogController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/24
 * Time(创建时间)： 15:27
 * Version(版本): 1.0
 * Description(描述)： 登录日志
 */

@Api(tags = "登录日志")
@RestController
@RequestMapping("/log/login")
public class LoginLogController extends BaseController
{
    @Resource
    private LoginLogService loginLogService;

    /**
     * 保存登录日志
     *
     * @param loginLog 登录日志
     * @return {@link R}<{@link Boolean}>
     */
    @PostMapping
    @ApiOperation("保存登录日志")
    public R<Boolean> save(@RequestBody LoginLog loginLog)
    {
        boolean save = loginLogService.save(loginLog);
        if (!save)
        {
            return fail("保存失败");
        }
        return success();
    }

    /**
     * 分页查询系统操作日志
     */
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "current", value = "当前页", dataType = "long", paramType = "query", defaultValue = "1"),
                    @ApiImplicitParam(name = "size", value = "每页显示几条", dataType = "long", paramType = "query", defaultValue = "10"),
            })
    @ApiOperation(value = "分页查询系统登录日志", notes = "分页查询系统登录日志")
    @GetMapping("/page")
    public R<IPage<LoginLog>> page()
    {
        IPage<LoginLog> page = getPage();
        LbqWrapper<LoginLog> query = Wraps.<LoginLog>lbQ()
                .orderByDesc(LoginLog::getId);
        loginLogService.page(page, query);
        return success(page);
    }

    /**
     * 查询系统登录日志
     */
    @ApiOperation(value = "查询系统登录日志", notes = "查询系统登录日志")
    @GetMapping("/{id}")
    public R<LoginLog> get(@PathVariable Long id)
    {
        return success(loginLogService.getById(id));
    }
}
```











## 使用服务

### 添加依赖

在商户平台应用服务的pom文件里添加两个依赖

```xml
<dependency>
    <groupId>mao</groupId>
    <artifactId>tools-log</artifactId>
</dependency>
```

```xml
<dependency>
    <groupId>mao</groupId>
    <artifactId>aggregate-pay-entity</artifactId>
</dependency>
```







### feign接口

创建feign接口

```java
package mao.aggregate_pay_merchant_application.feign.log;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import mao.aggregate_pay_entity.entity.OptLog;
import mao.tools_core.base.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.feign.log
 * Interface(接口名): OptLogFeignClient
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 15:36
 * Version(版本): 1.0
 * Description(描述)： 操作日志feign接口
 */

@FeignClient(value = "aggregate-pay-log", path = "/log/opt")
public interface OptLogFeignClient
{
    /**
     * 保存操作日志
     *
     * @param optLog 操作日志
     * @return {@link R}<{@link Boolean}>
     */
    @PostMapping
    R<Boolean> save(@RequestBody OptLog optLog);


    /**
     * 分页查询系统操作日志，返回值类型为R<Page<OptLog>>
     */

    @GetMapping("/page")
    String page(@RequestParam Long current, @RequestParam Long size);


    /**
     * 分页查询某个商户的系统操作日志，返回值类型为R<Page<OptLog>>
     */
    @GetMapping("/page/{merchantId}")
    String page(@RequestParam Long current, @RequestParam Long size, @PathVariable Long merchantId);

    /**
     * 分页查询某个商户的系统操作日志，给商户看的，返回值类型为R<Page<OptLog>>
     */
    @GetMapping("/page2/{merchantId}")
    String page2(@RequestParam Long current, @RequestParam Long size, @PathVariable Long merchantId);


    /**
     * 查询系统操作日志，返回值类型为R<Page<OptLog>>
     */
    @GetMapping("/{id}")
    String get(@PathVariable Long id);
}
```







### 操作日志服务

创建操作日志服务

```java
package mao.aggregate_pay_merchant_application.service;

import mao.tools_log.entity.OptLogDTO;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.service
 * Interface(接口名): OptLogService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 16:28
 * Version(版本): 1.0
 * Description(描述)： 操作日志服务
 */

public interface OptLogService
{
    /**
     * 保存操作日志到日志服务
     *
     * @param optLogDTO 操作日志dto
     */
    void save(OptLogDTO optLogDTO);
}
```







### 操作日志服务实现类

```java
package mao.aggregate_pay_merchant_application.service.Impl;

import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_entity.entity.OptLog;
import mao.aggregate_pay_merchant_application.feign.log.OptLogFeignClient;
import mao.aggregate_pay_merchant_application.service.OptLogService;
import mao.tools_core.base.R;
import mao.tools_log.entity.OptLogDTO;
import mao.toolsdozer.utils.DozerUtils;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.service.Impl
 * Class(类名): OptLogServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 16:29
 * Version(版本): 1.0
 * Description(描述)： 操作日志服务实现类
 */

@Slf4j
@Service
public class OptLogServiceImpl implements OptLogService
{

    @Resource
    private DozerUtils dozerUtils;

    @Resource
    private OptLogFeignClient optLogFeignClient;

    @Override
    public void save(OptLogDTO optLogDTO)
    {
        //转换对象
        OptLog optLog = dozerUtils.map(optLogDTO, OptLog.class);
        //设置商户id，也就是用户
        //todo
        optLog.setUserName(123456L);
        //打印日志
        log.info("商户id：" + optLog.getUserName() + "  请求：" + optLog.getRequestUri() + "  描述："
                + optLog.getDescription() + "  ip：" + optLog.getRequestIp() + "  耗时：" + optLog.getConsumingTime() + "ms");
        //远程调用，保存
        R<Boolean> r = optLogFeignClient.save(optLog);
        if (r.getIsError())
        {
            //错误，只打印警告信息
            log.warn("日志保存失败！ 信息：" + r.getMsg());
        }
        //保存成功，什么都不做，抛出异常可能就是服务宕机，不在同一线程，不会影响服务
    }
}

```









### 添加操作日志的配置文件

```java
package mao.aggregate_pay_merchant_application.config;

import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_merchant_application.service.OptLogService;
import mao.tools_log.entity.OptLogDTO;
import mao.tools_log.event.SysLogListener;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.annotation.PostConstruct;
import javax.annotation.Resource;
import java.util.function.Consumer;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.config
 * Class(类名): OptLogConfig
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 16:27
 * Version(版本): 1.0
 * Description(描述)： 操作日志配置类
 */

@Slf4j
@Configuration
public class OptLogConfig
{
    @Resource
    private OptLogService optLogService;

    @Bean
    public SysLogListener sysLogListener()
    {
        return new SysLogListener(new Consumer<OptLogDTO>()
        {
            @Override
            public void accept(OptLogDTO optLogDTO)
            {
                optLogService.save(optLogDTO);
            }
        });
    }

    @PostConstruct
    public void init()
    {
        log.info("初始化 OptLogConfig 操作日志配置类");
    }
}
```







### 生成日志

只需要在controller类的方法上添加SysLog注解即可

例如：

```sh
@SysLog(value = "绑定服务类型", recordResponseParam = false)
```





































# 商户应用创建

## 需求分析

### 系统交互流程



![image-20230112144601465](img/聚合支付项目实战学习笔记/image-20230112144601465.png)





1. 前端携带应用信息请求商户平台应用
2. 请求商户服务保存应用信息
3. 商户服务校验并保存商户应用
4. 返回前端创建成功







## 应用创建

### 商户服务创建应用接口

#### 接口定义

接口描述：

1. 校验商户是否通过资质审核，如果商户资质审核没有通过不允许创建应用
2. 生成应用ID，应用Id使用UUID方式生成
3. 保存商户应用信息，应用名称需要校验唯一性



DTO：

```java
package mao.aggregate_pay_merchant_api.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import java.io.Serializable;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_api.dto
 * Class(类名): AppDTO
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:02
 * Version(版本): 1.0
 * Description(描述)： 无
 */

@Data
@ApiModel(value="AppDTO", description="应用程序")
public class AppDTO implements Serializable
{
    /**
     * 串行版本uid
     */
    private static final long serialVersionUID = 1L;

    /**
     * 应用程序id
     */
    private String appId;

    /**
     * 商店名称
     */
    @ApiModelProperty(value = "商店名称")
    private String appName;

    /**
     * 所属商户
     */
    @ApiModelProperty(value = "所属商户")
    private Long merchantId;

    /**
     * 公钥
     */
    @ApiModelProperty(value = "应用公钥(RSAWithSHA256)")
    private String publicKey;

    /**
     * 授权回调地址
     */
    @ApiModelProperty(value = "授权回调地址")
    private String notifyUrl;
}
```





在AppService下定义createApp接口：

```java
package mao.aggregate_pay_merchant_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_merchant_api.dto.AppDTO;
import mao.aggregate_pay_merchant_service.entity.App;
import mao.tools_core.base.R;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service
 * Interface(接口名): AppService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/12
 * Time(创建时间)： 14:56
 * Version(版本): 1.0
 * Description(描述)： 应用
 */

public interface AppService extends IService<App>
{
    /**
     * 创建应用，基于某个商户
     *
     * @param merchantId 商户id
     * @param app        {@link AppDTO}
     * @return {@link AppDTO}
     */
    R<AppDTO> createApp(Long merchantId, AppDTO app);
}
```









#### 接口实现

在AppServiceImpl实现createApp接口实现：

```java
package mao.aggregate_pay_merchant_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_common.utils.RandomUuidUtil;
import mao.aggregate_pay_merchant_api.dto.AppDTO;
import mao.aggregate_pay_merchant_service.entity.App;
import mao.aggregate_pay_merchant_service.entity.Merchant;
import mao.aggregate_pay_merchant_service.mapper.AppMapper;
import mao.aggregate_pay_merchant_service.service.AppService;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.tools_core.base.R;
import mao.tools_databases.mybatis.conditions.Wraps;
import mao.toolsdozer.utils.DozerUtils;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service.impl
 * Class(类名): AppServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/12
 * Time(创建时间)： 14:59
 * Version(版本): 1.0
 * Description(描述)： 应用
 */

@Slf4j
@Service
public class AppServiceImpl extends ServiceImpl<AppMapper, App> implements AppService
{

    @Resource
    private DozerUtils dozerUtils;

    @Resource
    private MerchantService merchantService;

    @Override
    public R<AppDTO> createApp(Long merchantId, AppDTO app)
    {
        //查询商户
        Merchant merchant = merchantService.getOne(Wraps.<Merchant>lbQ().eq(Merchant::getId, merchantId));
        if (merchant == null)
        {
            return R.fail("商户不存在");
        }
        //商户存在，查询审核状态，审核状态： 0-未申请,1-已申请待审核,2-审核通过,3-审核拒绝
        if (!"2".equals(merchant.getAuditStatus()))
        {
            //状态不为2
            return R.fail("商户资质申请未通过");
        }
        //app名字是否存在
        int count = this.count(Wraps.<App>lbQ().eq(App::getAppName, app.getAppName()));
        if (count > 0)
        {
            //存在
            return R.fail("应用名称已被使用");
        }
        //设置id
        app.setAppId(RandomUuidUtil.getUUID());
        //设置商户id
        app.setMerchantId(merchantId);
        //转换
        App app1 = dozerUtils.map(app, App.class);
        //保存
        boolean save = this.save(app1);
        if (!save)
        {
            return R.fail("保存失败");
        }
        //保存成功，主要是返回主键
        return R.success(dozerUtils.map(app1, AppDTO.class));
    }
}
```









#### AppController

```java
package mao.aggregate_pay_merchant_service.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.AppDTO;
import mao.aggregate_pay_merchant_service.service.AppService;
import mao.tools_core.base.R;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.controller
 * Class(类名): AppController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/12
 * Time(创建时间)： 19:56
 * Version(版本): 1.0
 * Description(描述)： app
 */

@RestController
@Api(tags = "应用")
@RequestMapping("/app")
public class AppController
{

    @Resource
    private AppService appService;

    /**
     * 创建应用
     *
     * @param merchantId 商户id
     * @param app        {@link AppDTO}
     * @return {@link R}<{@link AppDTO}>
     */
    @PostMapping("/{merchantId}")
    @ApiOperation("创建应用")
    public R<AppDTO> createApp(@PathVariable Long merchantId, @RequestBody AppDTO app)
    {
        return appService.createApp(merchantId, app);
    }
}
```







#### feign接口

```java
package mao.aggregate_pay_merchant_api.feign;

import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.AppDTO;
import mao.tools_core.base.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_api.feign
 * Interface(接口名): AppFeignClient
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/12
 * Time(创建时间)： 20:00
 * Version(版本): 1.0
 * Description(描述)： feign接口
 */

@FeignClient(value = "aggregate-pay-merchant-service", path = "/app")
public interface AppFeignClient
{
    /**
     * 创建应用
     *
     * @param merchantId 商户id
     * @param app        {@link AppDTO}
     * @return {@link R}<{@link AppDTO}>
     */
    @PostMapping("/{merchantId}")
    R<AppDTO> createApp(@PathVariable Long merchantId, @RequestBody AppDTO app);
}
```











### 商户平台应用创建应用接口

#### AppController

```java
package mao.aggregate_pay_merchant_application.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiImplicitParams;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.AppDTO;
import mao.aggregate_pay_merchant_api.feign.AppFeignClient;
import mao.aggregate_pay_merchant_application.handler.AssertResult;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import org.apache.catalina.security.SecurityUtil;
import org.apache.commons.lang3.StringUtils;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.controller
 * Class(类名): AppController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/12
 * Time(创建时间)： 20:10
 * Version(版本): 1.0
 * Description(描述)： 应用管理
 */

@RestController
@Api(tags = "商户平台‐应用管理")
public class AppController
{
    @Resource
    private AppFeignClient appFeignClient;

    /**
     * 创建应用
     *
     * @param app {@link AppDTO}
     * @return {@link AppDTO}
     */
    @ApiOperation("商户创建应用")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "app", value = "应用信息", required = true, dataType = "AppDTO", paramType = "body")
            })
    @PostMapping(value = "/my/apps")
    public AppDTO createApp(@RequestBody AppDTO app)
    {
        //校验
        if (StringUtils.isBlank(app.getAppName()))
        {
            throw BizException.wrap("应用名称为空");
        }
        if (StringUtils.isBlank(app.getPublicKey()))
        {
            throw BizException.wrap("无法获取到公钥");
        }
        //todo：暂时
        //不能使用前端传过来的商户id
        Long merchantId = 124619633188667425L;

        //远程调用
        R<AppDTO> r = appFeignClient.createApp(merchantId, app);
        //断言
        AssertResult.handler(r);
        //返回
        return r.getData();
    }
}

```









#### 接口测试

![image-20230112202021709](img/聚合支付项目实战学习笔记/image-20230112202021709.png)





![image-20230112202312401](img/聚合支付项目实战学习笔记/image-20230112202312401.png)





响应内容

![image-20230112202340902](img/聚合支付项目实战学习笔记/image-20230112202340902.png)

















## 应用查询

### 商户服务应用查询接口

#### 接口定义

* 根据商户ID查询应用
* 根据应用ID查询详细信息



```java
package mao.aggregate_pay_merchant_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_merchant_api.dto.AppDTO;
import mao.aggregate_pay_merchant_service.entity.App;
import mao.tools_core.base.R;

import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service
 * Interface(接口名): AppService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/12
 * Time(创建时间)： 14:56
 * Version(版本): 1.0
 * Description(描述)： 应用
 */

public interface AppService extends IService<App>
{
    /**
     * 创建应用，基于某个商户
     *
     * @param merchantId 商户id
     * @param app        {@link AppDTO}
     * @return {@link AppDTO}
     */
    R<AppDTO> createApp(Long merchantId, AppDTO app);

    /**
     * 查询商户下的应用列表
     *
     * @param merchantId 商户id
     * @return {@link List}<{@link AppDTO}>
     */
    List<AppDTO> queryAppByMerchantId(Long merchantId);

    /**
     * 根据id查询应用
     *
     * @param id id
     * @return {@link R}<{@link AppDTO}>
     */
    R<AppDTO> getAppById(String id);
}
```







#### 接口实现

```java
package mao.aggregate_pay_merchant_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_common.utils.RandomUuidUtil;
import mao.aggregate_pay_merchant_api.dto.AppDTO;
import mao.aggregate_pay_merchant_service.entity.App;
import mao.aggregate_pay_merchant_service.entity.Merchant;
import mao.aggregate_pay_merchant_service.mapper.AppMapper;
import mao.aggregate_pay_merchant_service.service.AppService;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.tools_core.base.R;
import mao.tools_databases.mybatis.conditions.Wraps;
import mao.tools_redis_cache.utils.RedisUtils;
import mao.toolsdozer.utils.DozerUtils;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.util.List;
import java.util.concurrent.TimeUnit;
import java.util.function.Function;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service.impl
 * Class(类名): AppServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/12
 * Time(创建时间)： 14:59
 * Version(版本): 1.0
 * Description(描述)： 应用
 */

@Slf4j
@Service
public class AppServiceImpl extends ServiceImpl<AppMapper, App> implements AppService
{

    @Resource
    private DozerUtils dozerUtils;

    @Resource
    private MerchantService merchantService;

    @Resource
    private RedisUtils redisUtils;

    @Override
    public R<AppDTO> createApp(Long merchantId, AppDTO app)
    {
        //查询商户
        Merchant merchant = merchantService.getOne(Wraps.<Merchant>lbQ().eq(Merchant::getId, merchantId));
        if (merchant == null)
        {
            return R.fail("商户不存在");
        }
        //商户存在，查询审核状态，审核状态： 0-未申请,1-已申请待审核,2-审核通过,3-审核拒绝
        if (!"2".equals(merchant.getAuditStatus()))
        {
            //状态不为2
            return R.fail("商户资质申请未通过");
        }
        //app名字是否存在
        int count = this.count(Wraps.<App>lbQ().eq(App::getAppName, app.getAppName()));
        if (count > 0)
        {
            //存在
            return R.fail("应用名称已被使用");
        }
        //设置id
        app.setAppId(RandomUuidUtil.getUUID());
        //设置商户id
        app.setMerchantId(merchantId);
        //转换
        App app1 = dozerUtils.map(app, App.class);
        //保存
        boolean save = this.save(app1);
        if (!save)
        {
            return R.fail("保存失败");
        }
        //保存成功，主要是返回主键
        return R.success(dozerUtils.map(app1, AppDTO.class));
    }

    @Override
    public List<AppDTO> queryAppByMerchantId(Long merchantId)
    {
        //查询
        List<App> appList = this.list(Wraps.<App>lbQ().eq(App::getMerchantId, merchantId));
        //转换并返回
        return dozerUtils.mapList(appList, AppDTO.class);
    }

    @Override
    public R<AppDTO> getAppById(String id)
    {
        //查询，添加到缓存
        AppDTO appDTO = redisUtils.query("pay:AppDTO:getAppById:", "pay:AppDTO:getAppById:Lock:", id, AppDTO.class, new Function<String, AppDTO>()
        {
            @Override
            public AppDTO apply(String s)
            {
                App app1 = getOne(Wraps.<App>lbQ().eq(App::getAppId, id));
                return dozerUtils.map(app1, AppDTO.class);
            }
        }, 120L, TimeUnit.SECONDS, 30);
        return R.success(appDTO);
    }
}
```





#### AppController

```java
package mao.aggregate_pay_merchant_service.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.AppDTO;
import mao.aggregate_pay_merchant_service.service.AppService;
import mao.tools_core.base.R;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.controller
 * Class(类名): AppController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/12
 * Time(创建时间)： 19:56
 * Version(版本): 1.0
 * Description(描述)： app
 */

@RestController
@Api(tags = "应用")
@RequestMapping("/app")
public class AppController
{

    @Resource
    private AppService appService;

    /**
     * 创建应用
     *
     * @param merchantId 商户id
     * @param app        {@link AppDTO}
     * @return {@link R}<{@link AppDTO}>
     */
    @PostMapping("/{merchantId}")
    @ApiOperation("创建应用")
    public R<AppDTO> createApp(@PathVariable Long merchantId, @RequestBody AppDTO app)
    {
        return appService.createApp(merchantId, app);
    }

    /**
     * 查询商户下的应用列表
     *
     * @param merchantId 商户id
     * @return {@link R}<{@link List}<{@link AppDTO}>>
     */
    @ApiOperation("查询商户下的应用列表")
    @GetMapping("/queryAppByMerchantId")
    public R<List<AppDTO>> queryAppByMerchantId(@RequestParam Long merchantId)
    {
        return R.success(appService.queryAppByMerchantId(merchantId));
    }

    /**
     * 通过id获取应用
     *
     * @param id id
     * @return {@link R}<{@link AppDTO}>
     */
    @ApiOperation("根据id查询应用")
    @GetMapping("/getAppById")
    public R<AppDTO> getAppById(@RequestParam String id)
    {
        return appService.getAppById(id);
    }
}
```







#### feign接口

```java
package mao.aggregate_pay_merchant_api.feign;

import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.AppDTO;
import mao.tools_core.base.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_api.feign
 * Interface(接口名): AppFeignClient
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/12
 * Time(创建时间)： 20:00
 * Version(版本): 1.0
 * Description(描述)： feign接口
 */

@FeignClient(value = "aggregate-pay-merchant-service", path = "/app")
public interface AppFeignClient
{
    /**
     * 创建应用
     *
     * @param merchantId 商户id
     * @param app        {@link AppDTO}
     * @return {@link R}<{@link AppDTO}>
     */
    @PostMapping("/{merchantId}")
    R<AppDTO> createApp(@PathVariable Long merchantId, @RequestBody AppDTO app);

    /**
     * 查询商户下的应用列表
     *
     * @param merchantId 商户id
     * @return {@link R}<{@link List}<{@link AppDTO}>>
     */
    @GetMapping("/queryAppByMerchantId")
    R<List<AppDTO>> queryAppByMerchantId(@RequestParam Long merchantId);

    /**
     * 通过id获取应用
     *
     * @param id id
     * @return {@link R}<{@link AppDTO}>
     */
    @GetMapping("/getAppById")
    R<AppDTO> getAppById(@RequestParam String id);
}
```













### 商户平台应用查询接口

#### AppController

```java
package mao.aggregate_pay_merchant_application.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiImplicitParams;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.AppDTO;
import mao.aggregate_pay_merchant_api.feign.AppFeignClient;
import mao.aggregate_pay_merchant_application.handler.AssertResult;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import org.apache.catalina.security.SecurityUtil;
import org.apache.commons.lang3.StringUtils;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.controller
 * Class(类名): AppController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/12
 * Time(创建时间)： 20:10
 * Version(版本): 1.0
 * Description(描述)： 应用管理
 */

@RestController
@Api(tags = "商户平台‐应用管理")
public class AppController
{
    @Resource
    private AppFeignClient appFeignClient;

    /**
     * 创建应用
     *
     * @param app {@link AppDTO}
     * @return {@link AppDTO}
     */
    @ApiOperation("商户创建应用")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "app", value = "应用信息", required = true, dataType = "AppDTO", paramType = "body")
            })
    @PostMapping(value = "/my/apps")
    public AppDTO createApp(@RequestBody AppDTO app)
    {
        //校验
        if (StringUtils.isBlank(app.getAppName()))
        {
            throw BizException.wrap("应用名称为空");
        }
        if (StringUtils.isBlank(app.getPublicKey()))
        {
            throw BizException.wrap("无法获取到公钥");
        }
        //todo：暂时
        //不能使用前端传过来的商户id
        Long merchantId = 124619633188667425L;

        //远程调用
        R<AppDTO> r = appFeignClient.createApp(merchantId, app);
        //断言
        AssertResult.handler(r);
        //返回
        return r.getData();
    }


    /**
     * 查询商户下的应用列表
     *
     * @return {@link List}<{@link AppDTO}>
     */
    @ApiOperation("查询商户下的应用列表")
    @GetMapping(value = "/my/apps")
    public List<AppDTO> queryMyApps()
    {
        //商户id
        //todo：暂时
        Long merchantId = 124619633188667425L;
        //远程调用
        R<List<AppDTO>> r = appFeignClient.queryAppByMerchantId(merchantId);
        //断言
        AssertResult.handler(r);
        //返回
        return r.getData();
    }

    /**
     * 根据应用id查询应用信息
     *
     * @param appId 应用id
     * @return {@link AppDTO}
     */
    @ApiOperation("根据应用id查询应用信息")
    @ApiImplicitParam(value = "应用id", name = "appId", dataType = "String", paramType = "path")
    @GetMapping(value = "/my/apps/{appId}")
    public AppDTO getApp(@PathVariable("appId") String appId)
    {
        //查询
        R<AppDTO> r = appFeignClient.getAppById(appId);
        //断言
        AssertResult.handler(r);
        //返回
        return r.getData();
    }
}

```









#### 接口测试

获取商户的应用列表



![image-20230112205753865](img/聚合支付项目实战学习笔记/image-20230112205753865.png)



![image-20230112205811957](img/聚合支付项目实战学习笔记/image-20230112205811957.png)







![image-20230112210113148](img/聚合支付项目实战学习笔记/image-20230112210113148.png)







根据appId获取应用的详细信息

![image-20230112210219561](img/聚合支付项目实战学习笔记/image-20230112210219561.png)





![image-20230112210406879](img/聚合支付项目实战学习笔记/image-20230112210406879.png)























# 支付渠道参数配置

## 需求分析

### 系统交互流程



![image-20230112210923582](img/聚合支付项目实战学习笔记/image-20230112210923582.png)









交易服务职责：提供支付渠道参数配置、订单、发起支付、转账、退款等功能



**第一阶段：应用绑定服务类型**

1. 前端请求商户平台应用获取平台支持的所有服务类型列表
2. 请求交易服务查询列表
3. 返回服务类型列表给前端
4. 前端选择要绑定的服务类型请求商户平台应用

![image-20230112211553254](img/聚合支付项目实战学习笔记/image-20230112211553254.png)

5. 请求交易服务绑定服务类型
6. 返回前端绑定成功







**第二阶段：支付渠道参数配置**

7. 前端请求获取第三方支付渠道列表

![image-20230112211715375](img/聚合支付项目实战学习笔记/image-20230112211715375.png)

8. 请求交易服务获取列表
9. 返回结果给前端
10. 前端请求配置支付渠道参数

![image-20230112211754266](img/聚合支付项目实战学习笔记/image-20230112211754266.png)



11. 商户平台应用请求交易服务保存参数配置

12. 返回前端保存成功









## 搭建交易服务

### 交易服务介绍

交易服务：提供渠道参数配置、订单、发起支付、转账、退款等功能

模块有三个：

* aggregate-pay-transaction：交易服务父模块

* aggregate-pay-transaction-api：定义交易服务提供的接口
* aggregate-pay-transaction-service：实现交易服务的接口实现



|              模块名               |          说明          |
| :-------------------------------: | :--------------------: |
|     aggregate-pay-transaction     |     交易服务父模块     |
|   aggregate-pay-transaction-api   | 定义交易服务提供的接口 |
| aggregate-pay-transaction-service | 实现交易服务的接口实现 |





### 搭建工程

#### 交易服务父工程

在pay模块下创建子模块aggregate-pay-transaction



![image-20230113140912080](img/聚合支付项目实战学习笔记/image-20230113140912080.png)



![image-20230113140948935](img/聚合支付项目实战学习笔记/image-20230113140948935.png)



只需要留下pom文件

![image-20230113141205842](img/聚合支付项目实战学习笔记/image-20230113141205842.png)







#### 交易服务API

在aggregate-pay-transaction模块下创建子模块aggregate-pay-transaction-api



![image-20230113141222069](img/聚合支付项目实战学习笔记/image-20230113141222069.png)





![image-20230113141315855](img/聚合支付项目实战学习笔记/image-20230113141315855.png)









#### 交易服务

在aggregate-pay-transaction模块下创建子模块aggregate-pay-transaction-service



![image-20230113141547702](img/聚合支付项目实战学习笔记/image-20230113141547702.png)













### pom文件











### 配置文件















## 应用绑定服务类型

### 系统设计

* 服务类型表：platform_channel

* 应用表：app



两张表是多对过关系，一个服务类型有多个应用，一个应用有多个服务类型，所以需要中间表

中间表：app_platform_channel



app表结构：

```sql
CREATE TABLE `app`
(
    `ID`          bigint(20) NOT NULL,
    `APP_ID`      varchar(50) DEFAULT NULL,
    `APP_NAME`    varchar(50) DEFAULT NULL COMMENT '商店名称',
    `MERCHANT_ID` bigint(20)  DEFAULT NULL COMMENT '所属商户',
    `PUBLIC_KEY`  varchar(50) DEFAULT NULL COMMENT '应用公钥(RSAWithSHA256)',
    `NOTIFY_URL`  varchar(50) DEFAULT NULL COMMENT '授权回调地址',
    PRIMARY KEY (`ID`) USING BTREE,
    UNIQUE KEY `APP_ID` (`APP_ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  ROW_FORMAT = DYNAMIC;
```



platform_channel表结构：

```sql
CREATE TABLE `platform_channel`
(
    `ID`           bigint(20) NOT NULL,
    `CHANNEL_NAME` varchar(50) DEFAULT NULL COMMENT '平台支付渠道名称',
    `CHANNEL_CODE` varchar(50) DEFAULT NULL COMMENT '平台支付渠道编码',
    PRIMARY KEY (`ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  ROW_FORMAT = DYNAMIC;
```



app_platform_channel表结构：

```sql
CREATE TABLE `app_platform_channel`
(
    `ID`               bigint(20) NOT NULL,
    `APP_ID`           varchar(50) DEFAULT NULL COMMENT '应用id',
    `PLATFORM_CHANNEL` varchar(50) DEFAULT NULL COMMENT '平台支付渠道',
    PRIMARY KEY (`ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  ROW_FORMAT = DYNAMIC COMMENT ='说明了应用选择了平台中的哪些支付渠道';
```











### 交易服务获取平台服务类型

绑定服务类型页面，页面中要列出支持的服务类型





#### 接口定义

接口描述：查询平台支持的所有服务类型



创建服务接口PlatformChannelService

```java
package mao.aggregate_pay_transaction_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.aggregate_pay_transaction_service.entity.PlatformChannel;
import mao.tools_core.base.R;

import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.service
 * Interface(接口名): PlatformChannelService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 22:55
 * Version(版本): 1.0
 * Description(描述)： 服务类型
 */

public interface PlatformChannelService extends IService<PlatformChannel>
{
    /**
     * 获取平台的所有服务类型
     *
     * @return {@link R}<{@link List}<{@link PlatformChannelDTO}>>
     */
    R<List<PlatformChannelDTO>> queryAll();
}

```







#### 接口实现

PlatformChannelServiceImpl类

```java
package mao.aggregate_pay_transaction_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.aggregate_pay_transaction_service.entity.PayChannel;
import mao.aggregate_pay_transaction_service.entity.PlatformChannel;
import mao.aggregate_pay_transaction_service.mapper.PlatformChannelMapper;
import mao.aggregate_pay_transaction_service.service.PlatformChannelService;
import mao.tools_core.base.R;
import mao.tools_redis_cache.entity.RedisData;
import mao.tools_redis_cache.utils.RedisUtils;
import mao.toolsdozer.utils.DozerUtils;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.util.List;
import java.util.concurrent.TimeUnit;
import java.util.function.Function;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.service.impl
 * Class(类名): PlatformChannelServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 22:56
 * Version(版本): 1.0
 * Description(描述)： 服务类型 服务实现类
 */

@Slf4j
@Service
public class PlatformChannelServiceImpl extends ServiceImpl<PlatformChannelMapper, PlatformChannel> implements PlatformChannelService
{
    @Resource
    private DozerUtils dozerUtils;

    @Resource
    private RedisUtils redisUtils;

    @Override
    public R<List<PlatformChannelDTO>> queryAll()
    {
        RedisData redisData = redisUtils.query("pay:List_PlatformChannelDTO:queryAll:",
                "pay:List_PlatformChannelDTO:queryAll:lock", -1,
                RedisData.class, new Function<Integer, RedisData>()
                {
                    @Override
                    public RedisData apply(Integer integer)
                    {
                        //查询所有
                        List<PlatformChannel> platformChannelList = list();
                        //转换
                        List<PlatformChannelDTO> platformChannelDTOList = dozerUtils.mapList(platformChannelList, PlatformChannelDTO.class);
                        //返回
                        RedisData redisData1 = new RedisData();
                        redisData1.setData(platformChannelDTOList);
                        return redisData1;
                    }
                }, 60L, TimeUnit.MINUTES, 60);
        //返回
        List<PlatformChannelDTO> platformChannelDTOList = (List<PlatformChannelDTO>) redisData.getData();
        return R.success(platformChannelDTOList);

    }
}
```







#### 单元测试

```java
package mao.aggregate_pay_transaction_service.service.impl;

import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.aggregate_pay_transaction_service.service.PlatformChannelService;
import mao.tools_core.base.R;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.service.impl
 * Class(测试类名): PlatformChannelServiceImplTest
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 22:59
 * Version(版本): 1.0
 * Description(描述)： 测试类
 */

@SpringBootTest
class PlatformChannelServiceImplTest
{

    @Autowired
    private PlatformChannelService platformChannelService;

    @Test
    void queryAll()
    {
        R<List<PlatformChannelDTO>> listR = platformChannelService.queryAll();
        System.out.println(listR.getData());
    }
}
```





#### PlatformChannelController

```java
package mao.aggregate_pay_transaction_service.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.aggregate_pay_transaction_service.service.PlatformChannelService;
import mao.tools_core.base.R;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.annotation.Resource;
import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.controller
 * Class(类名): PlatformChannelController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 23:06
 * Version(版本): 1.0
 * Description(描述)： 服务类型
 */

@Api(value = "服务类型", tags = "服务类型")
@RestController
@RequestMapping("/PlatformChannel")
public class PlatformChannelController
{
    @Resource
    private PlatformChannelService platformChannelService;


    /**
     * 获取平台所有服务类型
     *
     * @return {@link R}<{@link List}<{@link PlatformChannelDTO}>>
     */
    @GetMapping
    @ApiOperation("获取平台所有服务类型")
    public R<List<PlatformChannelDTO>> queryAll()
    {
        return platformChannelService.queryAll();
    }
}
```









#### feign接口

```java
package mao.aggregate_pay_transaction_api.feign;

import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.tools_core.base.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;

import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_api.feign
 * Interface(接口名): PlatformChannelFeignClient
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 23:10
 * Version(版本): 1.0
 * Description(描述)： 服务类型 FeignClient
 */

@FeignClient(value = "aggregate-pay-transaction-service", path = "/PlatformChannel")
public interface PlatformChannelFeignClient
{
    /**
     * 获取平台所有服务类型
     *
     * @return {@link R}<{@link List}<{@link PlatformChannelDTO}>>
     */
    @GetMapping
    R<List<PlatformChannelDTO>> queryAll();
}
```









### 商户平台应用获取平台服务类型

#### 接口实现

在商户平台应用工程添加依赖：

```xml
        <dependency>
            <groupId>mao</groupId>
            <artifactId>aggregate-pay-transaction-api</artifactId>
        </dependency>
```





添加PlatformParamController

```java
package mao.aggregate_pay_merchant_application.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_merchant_application.handler.AssertResult;
import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.aggregate_pay_transaction_api.feign.PlatformChannelFeignClient;
import mao.tools_core.base.R;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.annotation.Resource;
import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.controller
 * Class(类名): PlatformParamController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 23:21
 * Version(版本): 1.0
 * Description(描述)： 商户平台‐渠道和支付参数
 */

@Slf4j
@RestController
@Api(value = "商户平台‐渠道和支付参数相关", tags = "商户平台‐渠道和支付参数")
public class PlatformParamController
{
    @Resource
    private PlatformChannelFeignClient platformChannelFeignClient;

    @ApiOperation("获取平台服务类型")
    @GetMapping(value = "/my/platform‐channels")
    public List<PlatformChannelDTO> queryPlatformChannel()
    {
        //远程调用
        R<List<PlatformChannelDTO>> r = platformChannelFeignClient.queryAll();
        //断言结果
        AssertResult.handler(r);
        //返回
        return r.getData();
    }

}
```







####  接口测试

http://192.168.202.1:57010/doc.html

![image-20230114232547130](img/聚合支付项目实战学习笔记/image-20230114232547130.png)





![image-20230114232620806](img/聚合支付项目实战学习笔记/image-20230114232620806.png)













### 交易服务绑定服务类型接口

点击开启服务为应用绑定服务类型

![image-20230114232751887](img/聚合支付项目实战学习笔记/image-20230114232751887.png)







#### 接口定义

接口描述：

1. 查询出指定应用就否已绑定选定的服务类型
2. 如果该应用没有绑定该服务类型则进行绑定



在PlatformChannelService接口中定义bindPlatformChannelForApp

```java
package mao.aggregate_pay_transaction_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.aggregate_pay_transaction_service.entity.PlatformChannel;
import mao.tools_core.base.R;

import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.service
 * Interface(接口名): PlatformChannelService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 22:55
 * Version(版本): 1.0
 * Description(描述)： 服务类型
 */

public interface PlatformChannelService extends IService<PlatformChannel>
{
    /**
     * 获取平台的所有服务类型
     *
     * @return {@link R}<{@link List}<{@link PlatformChannelDTO}>>
     */
    R<List<PlatformChannelDTO>> queryAll();


    /**
     * 为app绑定平台服务类型
     *
     * @param appId                应用id
     * @param platformChannelCodes 平台服务类型
     */
    void bindPlatformChannelForApp(String appId, String platformChannelCodes);
}
```





#### 接口实现

```java
package mao.aggregate_pay_transaction_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.aggregate_pay_transaction_service.entity.AppPlatformChannel;
import mao.aggregate_pay_transaction_service.entity.PayChannel;
import mao.aggregate_pay_transaction_service.entity.PlatformChannel;
import mao.aggregate_pay_transaction_service.mapper.AppPlatformChannelMapper;
import mao.aggregate_pay_transaction_service.mapper.PlatformChannelMapper;
import mao.aggregate_pay_transaction_service.service.PlatformChannelService;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import mao.tools_databases.mybatis.conditions.Wraps;
import mao.tools_redis_cache.entity.RedisData;
import mao.tools_redis_cache.utils.RedisUtils;
import mao.toolsdozer.utils.DozerUtils;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.util.List;
import java.util.concurrent.TimeUnit;
import java.util.function.Function;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.service.impl
 * Class(类名): PlatformChannelServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 22:56
 * Version(版本): 1.0
 * Description(描述)： 服务类型 服务实现类
 */

@Slf4j
@Service
public class PlatformChannelServiceImpl extends ServiceImpl<PlatformChannelMapper, PlatformChannel> implements PlatformChannelService
{
    @Resource
    private DozerUtils dozerUtils;

    @Resource
    private RedisUtils redisUtils;

    @Resource
    private AppPlatformChannelMapper appPlatformChannelMapper;

    @Override
    public R<List<PlatformChannelDTO>> queryAll()
    {
        RedisData redisData = redisUtils.query("pay:List_PlatformChannelDTO:queryAll:",
                "pay:List_PlatformChannelDTO:queryAll:lock", -1,
                RedisData.class, new Function<Integer, RedisData>()
                {
                    @Override
                    public RedisData apply(Integer integer)
                    {
                        //查询所有
                        List<PlatformChannel> platformChannelList = list();
                        //转换
                        List<PlatformChannelDTO> platformChannelDTOList = dozerUtils.mapList(platformChannelList, PlatformChannelDTO.class);
                        //返回
                        RedisData redisData1 = new RedisData();
                        redisData1.setData(platformChannelDTOList);
                        return redisData1;
                    }
                }, 60L, TimeUnit.MINUTES, 60);
        //返回
        List<PlatformChannelDTO> platformChannelDTOList = (List<PlatformChannelDTO>) redisData.getData();
        return R.success(platformChannelDTOList);

    }

    @Override
    public void bindPlatformChannelForApp(String appId, String platformChannelCodes)
    {
        //查询平台服务类型code是否存在
        int count = this.count(Wraps.<PlatformChannel>lbQ().eq(PlatformChannel::getChannelCode, platformChannelCodes));
        if (count <= 0)
        {
            throw BizException.wrap("平台服务类型码不存在");
        }
        //根据appId和平台服务类型code查询app_platform_channel
        AppPlatformChannel appPlatformChannel = appPlatformChannelMapper.selectOne(Wraps.<AppPlatformChannel>lbQ()
                .eq(AppPlatformChannel::getAppId, appId)
                .eq(AppPlatformChannel::getPlatformChannel, platformChannelCodes));
        //判断是否已绑定
        if (appPlatformChannel == null)
        {
            //目前还没有绑定
            //绑定
            appPlatformChannel = new AppPlatformChannel();
            appPlatformChannel.setAppId(appId);
            appPlatformChannel.setPlatformChannel(platformChannelCodes);
            //插入
            int insert = appPlatformChannelMapper.insert(appPlatformChannel);
            if (insert <= 0)
            {
                throw BizException.wrap("绑定失败");
            }
        }
        //已经绑定了，什么都不做
    }
}
```









#### PlatformChannelController

```java
package mao.aggregate_pay_transaction_service.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.aggregate_pay_transaction_service.service.PlatformChannelService;
import mao.tools_core.base.R;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.controller
 * Class(类名): PlatformChannelController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 23:06
 * Version(版本): 1.0
 * Description(描述)： 服务类型
 */

@Api(value = "服务类型", tags = "服务类型")
@RestController
@RequestMapping("/PlatformChannel")
public class PlatformChannelController
{
    @Resource
    private PlatformChannelService platformChannelService;


    /**
     * 获取平台所有服务类型
     *
     * @return {@link R}<{@link List}<{@link PlatformChannelDTO}>>
     */
    @GetMapping
    @ApiOperation("获取平台所有服务类型")
    public R<List<PlatformChannelDTO>> queryAll()
    {
        return platformChannelService.queryAll();
    }


    /**
     * 为app绑定平台服务类型
     *
     * @param appId                应用id
     * @param platformChannelCodes 平台服务类型
     */
    @PutMapping("/bind")
    @ApiOperation("为app绑定平台服务类型")
    public R<Boolean> bindPlatformChannelForApp(@RequestParam String appId, @RequestParam String platformChannelCodes)
    {
        platformChannelService.bindPlatformChannelForApp(appId, platformChannelCodes);
        return R.success();
    }
}
```







#### feign接口

```java
package mao.aggregate_pay_transaction_api.feign;

import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.tools_core.base.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_api.feign
 * Interface(接口名): PlatformChannelFeignClient
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 23:10
 * Version(版本): 1.0
 * Description(描述)： 服务类型 FeignClient
 */

@FeignClient(value = "aggregate-pay-transaction-service", path = "/PlatformChannel")
public interface PlatformChannelFeignClient
{
    /**
     * 获取平台所有服务类型
     *
     * @return {@link R}<{@link List}<{@link PlatformChannelDTO}>>
     */
    @GetMapping
    R<List<PlatformChannelDTO>> queryAll();

    
    /**
     * 为app绑定平台服务类型
     *
     * @param appId                应用id
     * @param platformChannelCodes 平台服务类型
     */
    @PutMapping("/bind")
    R<Boolean> bindPlatformChannelForApp(@RequestParam String appId, @RequestParam String platformChannelCodes);
}
```















###  商户平台应用绑定服务类型接口

#### 接口实现

在AppController类中定义bindPlatformForApp方法：

```java
package mao.aggregate_pay_merchant_application.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiImplicitParams;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.AppDTO;
import mao.aggregate_pay_merchant_api.feign.AppFeignClient;
import mao.aggregate_pay_merchant_application.handler.AssertResult;
import mao.aggregate_pay_transaction_api.feign.PlatformChannelFeignClient;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import mao.tools_log.annotation.SysLog;
import org.apache.catalina.security.SecurityUtil;
import org.apache.commons.lang3.StringUtils;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.controller
 * Class(类名): AppController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/12
 * Time(创建时间)： 20:10
 * Version(版本): 1.0
 * Description(描述)： 应用管理
 */

@RestController
@Api(tags = "商户平台‐应用管理")
public class AppController
{
    @Resource
    private AppFeignClient appFeignClient;

    @Resource
    private PlatformChannelFeignClient platformChannelFeignClient;

    /**
     * 创建应用
     *
     * @param app {@link AppDTO}
     * @return {@link AppDTO}
     */
    @ApiOperation("商户创建应用")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "app", value = "应用信息", required = true, dataType = "AppDTO", paramType = "body")
            })
    @PostMapping(value = "/my/apps")
    public AppDTO createApp(@RequestBody AppDTO app)
    {
        //校验
        if (StringUtils.isBlank(app.getAppName()))
        {
            throw BizException.wrap("应用名称为空");
        }
        if (StringUtils.isBlank(app.getPublicKey()))
        {
            throw BizException.wrap("无法获取到公钥");
        }
        //todo：暂时
        //不能使用前端传过来的商户id
        Long merchantId = 124619633188667425L;

        //远程调用
        R<AppDTO> r = appFeignClient.createApp(merchantId, app);
        //断言
        AssertResult.handler(r);
        //返回
        return r.getData();
    }


    /**
     * 查询商户下的应用列表
     *
     * @return {@link List}<{@link AppDTO}>
     */
    @ApiOperation("查询商户下的应用列表")
    @GetMapping(value = "/my/apps")
    public List<AppDTO> queryMyApps()
    {
        //商户id
        //todo：暂时
        Long merchantId = 124619633188667425L;
        //远程调用
        R<List<AppDTO>> r = appFeignClient.queryAppByMerchantId(merchantId);
        //断言
        AssertResult.handler(r);
        //返回
        return r.getData();
    }

    /**
     * 根据应用id查询应用信息
     *
     * @param appId 应用id
     * @return {@link AppDTO}
     */
    @ApiOperation("根据应用id查询应用信息")
    @ApiImplicitParam(value = "应用id", name = "appId", dataType = "String", paramType = "path")
    @GetMapping(value = "/my/apps/{appId}")
    public AppDTO getApp(@PathVariable("appId") String appId)
    {
        //查询
        R<AppDTO> r = appFeignClient.getAppById(appId);
        //断言
        AssertResult.handler(r);
        //返回
        return r.getData();
    }

    /**
     * 绑定服务类型
     *
     * @param appId                应用程序id
     * @param platformChannelCodes 平台通道编码
     */
    @SysLog(value = "绑定服务类型", recordResponseParam = false)
    @ApiOperation("绑定服务类型")
    @PostMapping(value = "/my/apps/{appId}/platform‐channels")
    @ApiImplicitParams({
            @ApiImplicitParam(value = "应用id", name = "appId", dataType = "string", paramType =
                    "path"),
            @ApiImplicitParam(value = "服务类型code", name = "platformChannelCodes", dataType =
                    "string", paramType = "query")
    })
    public void bindPlatformForApp(@PathVariable("appId") String appId,
                                   @RequestParam("platformChannelCodes") String platformChannelCodes)
    {
        if (StringUtils.isBlank(appId))
        {
            throw BizException.wrap("appID为空");
        }
        if (StringUtils.isBlank(platformChannelCodes))
        {
            throw BizException.wrap("platformChannelCodes为空");
        }
        //查询appid是否存在
        R<AppDTO> appById = appFeignClient.getAppById(appId);
        //断言结果
        AssertResult.handler(appById);
        //如果不存在
        if (appById.getData() == null)
        {
            throw BizException.wrap("appId不存在");
        }
        //远程调用
        R<Boolean> r = platformChannelFeignClient.bindPlatformChannelForApp(appId, platformChannelCodes);
        //断言结果
        AssertResult.handler(r);

    }
}
```







#### 接口测试

![image-20230115135435772](img/聚合支付项目实战学习笔记/image-20230115135435772.png)





![image-20230115135617655](img/聚合支付项目实战学习笔记/image-20230115135617655.png)





![image-20230115135633710](img/聚合支付项目实战学习笔记/image-20230115135633710.png)

















### 交易服务查询服务类型绑定状态

#### 接口定义

查询应用是否已经绑定了某个服务类型



创建AppPlatformChannelService

```java
package mao.aggregate_pay_transaction_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_transaction_service.entity.AppPlatformChannel;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.service
 * Interface(接口名): AppPlatformChannelService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/15
 * Time(创建时间)： 14:32
 * Version(版本): 1.0
 * Description(描述)： 无
 */

public interface AppPlatformChannelService extends IService<AppPlatformChannel>
{
    /**
     * 应用是否已经绑定了某个服务类型
     *
     * @param appId           应用程序id
     * @param platformChannel 平台通道
     * @return boolean
     */
    boolean queryAppBindPlatformChannel(String appId, String platformChannel);
}
```







#### 接口实现

创建AppPlatformChannelServiceImpl实现类，实现queryAppBindPlatformChannel方法

```java
package mao.aggregate_pay_transaction_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_transaction_service.entity.AppPlatformChannel;
import mao.aggregate_pay_transaction_service.mapper.AppPlatformChannelMapper;
import mao.aggregate_pay_transaction_service.service.AppPlatformChannelService;
import mao.tools_databases.mybatis.conditions.Wraps;
import org.springframework.stereotype.Service;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.service.impl
 * Class(类名): AppPlatformChannelServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/15
 * Time(创建时间)： 14:33
 * Version(版本): 1.0
 * Description(描述)： 无
 */

@Slf4j
@Service
public class AppPlatformChannelServiceImpl extends ServiceImpl<AppPlatformChannelMapper, AppPlatformChannel> implements AppPlatformChannelService
{

    @Override
    public boolean queryAppBindPlatformChannel(String appId, String platformChannel)
    {
        //查询
        int count = this.count(Wraps.<AppPlatformChannel>lbQ().eq(AppPlatformChannel::getAppId, appId)
                .eq(AppPlatformChannel::getPlatformChannel, platformChannel));
        //判断并返回
        if (count <= 0)
        {
            return false;
        }
        return true;
    }
}
```









#### PlatformChannelController

```java
package mao.aggregate_pay_transaction_service.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.aggregate_pay_transaction_service.service.AppPlatformChannelService;
import mao.aggregate_pay_transaction_service.service.PlatformChannelService;
import mao.tools_core.base.R;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.controller
 * Class(类名): PlatformChannelController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 23:06
 * Version(版本): 1.0
 * Description(描述)： 服务类型
 */

@Api(value = "服务类型", tags = "服务类型")
@RestController
@RequestMapping("/PlatformChannel")
public class PlatformChannelController
{
    @Resource
    private PlatformChannelService platformChannelService;

    @Resource
    private AppPlatformChannelService appPlatformChannelService;


    /**
     * 获取平台所有服务类型
     *
     * @return {@link R}<{@link List}<{@link PlatformChannelDTO}>>
     */
    @GetMapping
    @ApiOperation("获取平台所有服务类型")
    public R<List<PlatformChannelDTO>> queryAll()
    {
        return platformChannelService.queryAll();
    }


    /**
     * 为app绑定平台服务类型
     *
     * @param appId                应用id
     * @param platformChannelCodes 平台服务类型
     */
    @PutMapping("/bind")
    @ApiOperation("为app绑定平台服务类型")
    public R<Boolean> bindPlatformChannelForApp(@RequestParam String appId, @RequestParam String platformChannelCodes)
    {
        platformChannelService.bindPlatformChannelForApp(appId, platformChannelCodes);
        return R.success();
    }

    /**
     * 查询应用是否已经绑定了某个服务类型
     *
     * @param appId           应用程序id
     * @param platformChannel 平台通道
     * @return boolean
     */
    @GetMapping("/bind")
    @ApiOperation("查询应用是否已经绑定了某个服务类型")
    public R<Boolean> queryAppBindPlatformChannel(String appId, String platformChannel)
    {
        return R.success(appPlatformChannelService.queryAppBindPlatformChannel(appId, platformChannel));
    }
}
```







#### feign接口

```java
package mao.aggregate_pay_transaction_api.feign;

import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.tools_core.base.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_api.feign
 * Interface(接口名): PlatformChannelFeignClient
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 23:10
 * Version(版本): 1.0
 * Description(描述)： 服务类型 FeignClient
 */

@FeignClient(value = "aggregate-pay-transaction-service", path = "/PlatformChannel")
public interface PlatformChannelFeignClient
{
    /**
     * 获取平台所有服务类型
     *
     * @return {@link R}<{@link List}<{@link PlatformChannelDTO}>>
     */
    @GetMapping
    R<List<PlatformChannelDTO>> queryAll();


    /**
     * 为app绑定平台服务类型
     *
     * @param appId                应用id
     * @param platformChannelCodes 平台服务类型
     */
    @PutMapping("/bind")
    R<Boolean> bindPlatformChannelForApp(@RequestParam String appId, @RequestParam String platformChannelCodes);


    /**
     * 查询应用是否已经绑定了某个服务类型
     *
     * @param appId           应用程序id
     * @param platformChannel 平台通道
     * @return boolean
     */
    @GetMapping("/bind")
    R<Boolean> queryAppBindPlatformChannel(String appId, String platformChannel);
}
```













### 商户平台查询服务类型绑定状态

#### 接口实现

```java
package mao.aggregate_pay_merchant_application.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiImplicitParams;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.AppDTO;
import mao.aggregate_pay_merchant_api.feign.AppFeignClient;
import mao.aggregate_pay_merchant_application.handler.AssertResult;
import mao.aggregate_pay_transaction_api.feign.PlatformChannelFeignClient;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import mao.tools_log.annotation.SysLog;
import org.apache.catalina.security.SecurityUtil;
import org.apache.commons.lang3.StringUtils;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.controller
 * Class(类名): AppController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/12
 * Time(创建时间)： 20:10
 * Version(版本): 1.0
 * Description(描述)： 应用管理
 */

@RestController
@Api(tags = "商户平台‐应用管理")
public class AppController
{
    @Resource
    private AppFeignClient appFeignClient;

    @Resource
    private PlatformChannelFeignClient platformChannelFeignClient;

    /**
     * 创建应用
     *
     * @param app {@link AppDTO}
     * @return {@link AppDTO}
     */
    @ApiOperation("商户创建应用")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "app", value = "应用信息", required = true, dataType = "AppDTO", paramType = "body")
            })
    @PostMapping(value = "/my/apps")
    public AppDTO createApp(@RequestBody AppDTO app)
    {
        //校验
        if (StringUtils.isBlank(app.getAppName()))
        {
            throw BizException.wrap("应用名称为空");
        }
        if (StringUtils.isBlank(app.getPublicKey()))
        {
            throw BizException.wrap("无法获取到公钥");
        }
        //todo：暂时
        //不能使用前端传过来的商户id
        Long merchantId = 124619633188667425L;

        //远程调用
        R<AppDTO> r = appFeignClient.createApp(merchantId, app);
        //断言
        AssertResult.handler(r);
        //返回
        return r.getData();
    }


    /**
     * 查询商户下的应用列表
     *
     * @return {@link List}<{@link AppDTO}>
     */
    @ApiOperation("查询商户下的应用列表")
    @GetMapping(value = "/my/apps")
    public List<AppDTO> queryMyApps()
    {
        //商户id
        //todo：暂时
        Long merchantId = 124619633188667425L;
        //远程调用
        R<List<AppDTO>> r = appFeignClient.queryAppByMerchantId(merchantId);
        //断言
        AssertResult.handler(r);
        //返回
        return r.getData();
    }

    /**
     * 根据应用id查询应用信息
     *
     * @param appId 应用id
     * @return {@link AppDTO}
     */
    @ApiOperation("根据应用id查询应用信息")
    @ApiImplicitParam(value = "应用id", name = "appId", dataType = "String", paramType = "path")
    @GetMapping(value = "/my/apps/{appId}")
    public AppDTO getApp(@PathVariable("appId") String appId)
    {
        //查询
        R<AppDTO> r = appFeignClient.getAppById(appId);
        //断言
        AssertResult.handler(r);
        //返回
        return r.getData();
    }

    /**
     * 绑定服务类型
     *
     * @param appId                应用程序id
     * @param platformChannelCodes 平台通道编码
     */
    @SysLog(value = "绑定服务类型", recordResponseParam = false)
    @ApiOperation("绑定服务类型")
    @PostMapping(value = "/my/apps/{appId}/platform‐channels")
    @ApiImplicitParams({
            @ApiImplicitParam(value = "应用id", name = "appId", dataType = "string", paramType =
                    "path"),
            @ApiImplicitParam(value = "服务类型code", name = "platformChannelCodes", dataType =
                    "string", paramType = "query")
    })
    public void bindPlatformForApp(@PathVariable("appId") String appId,
                                   @RequestParam("platformChannelCodes") String platformChannelCodes)
    {
        if (StringUtils.isBlank(appId))
        {
            throw BizException.wrap("appID为空");
        }
        if (StringUtils.isBlank(platformChannelCodes))
        {
            throw BizException.wrap("platformChannelCodes为空");
        }
        //查询appid是否存在
        R<AppDTO> appById = appFeignClient.getAppById(appId);
        //断言结果
        AssertResult.handler(appById);
        //如果不存在
        if (appById.getData() == null)
        {
            throw BizException.wrap("appId不存在");
        }
        //远程调用
        R<Boolean> r = platformChannelFeignClient.bindPlatformChannelForApp(appId, platformChannelCodes);
        //断言结果
        AssertResult.handler(r);

    }


    /**
     * 查询应用是否绑定了某个服务类型
     *
     * @param appId           应用程序id
     * @param platformChannel 平台通道
     * @return 1为绑定了，0为没有绑定
     */
    @ApiOperation("查询应用是否绑定了某个服务类型")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "appId", value = "应用appId", required = true, dataType =
                            "String", paramType = "query"),
                    @ApiImplicitParam(name = "platformChannel", value = "服务类型", required = true, dataType =
                            "String", paramType = "query")
            })
    @GetMapping("/my/merchants/apps/platformchannels")
    public int queryAppBindPlatformChannel(@RequestParam String appId, @RequestParam String
            platformChannel)
    {
        //远程调用
        R<Boolean> r = platformChannelFeignClient.queryAppBindPlatformChannel(appId, platformChannel);
        //断言结果
        AssertResult.handler(r);
        //返回
        if (!r.getData())
        {
            return 0;
        }
        return 1;
    }

}
```









#### 接口测试

![image-20230115192536298](img/聚合支付项目实战学习笔记/image-20230115192536298.png)





![image-20230115192543906](img/聚合支付项目实战学习笔记/image-20230115192543906.png)















## 支付渠道参数配置

### 系统设计

支付聚道表：pay_channel

服务类型表：platform_channel



两张表是多对多关系，所以需要中间表

中间表为：platform_pay_channel



pay_channel表结构：

```sql
CREATE TABLE `pay_channel`
(
    `ID`           bigint(20) NOT NULL,
    `CHANNEL_NAME` varchar(50) DEFAULT NULL COMMENT '原始支付渠道名称',
    `CHANNEL_CODE` varchar(50) DEFAULT NULL COMMENT '原始支付渠道编码',
    PRIMARY KEY (`ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  ROW_FORMAT = DYNAMIC;
```





platform_channel表结构：

```sql
CREATE TABLE `platform_channel`
(
    `ID`           bigint(20) NOT NULL,
    `CHANNEL_NAME` varchar(50) DEFAULT NULL COMMENT '平台支付渠道名称',
    `CHANNEL_CODE` varchar(50) DEFAULT NULL COMMENT '平台支付渠道编码',
    PRIMARY KEY (`ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  ROW_FORMAT = DYNAMIC;
```





platform_pay_channel表结构：

```sql
CREATE TABLE `platform_pay_channel`
(
    `ID`               bigint(20) NOT NULL,
    `PLATFORM_CHANNEL` varchar(20) DEFAULT NULL COMMENT '平台支付渠道编码',
    `PAY_CHANNEL`      varchar(20) DEFAULT NULL COMMENT '原始支付渠道名称',
    PRIMARY KEY (`ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  ROW_FORMAT = DYNAMIC;
```







支付聚道参数：pay_channel_param



支付聚道参数表结构：

```sql
CREATE TABLE `pay_channel_param`
(
    `ID`                      bigint(20) NOT NULL,
    `CHANNEL_NAME`            varchar(50) DEFAULT NULL COMMENT '配置名称',
    `MERCHANT_ID`             bigint(20)  DEFAULT NULL COMMENT '商户ID',
    `PAY_CHANNEL`             varchar(50) DEFAULT NULL COMMENT '原始支付渠道编码',
    `PARAM`                   text COMMENT '支付参数',
    `APP_PLATFORM_CHANNEL_ID` bigint(20)  DEFAULT NULL COMMENT '应用与支付渠道绑定ID',
    PRIMARY KEY (`ID`) USING BTREE
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  ROW_FORMAT = DYNAMIC COMMENT ='某商户针对某一种原始支付渠道的配置参数';
```



支付聚道参数表结构的PAY_CHANNEL字段对应支付聚道表中的CHANNEL_CODE字段

支付聚道参数表结构的APP_PLATFORM_CHANNEL_ID字段对应app_platform_channel表中的PLATFORM_CHANNEL字段













### 交易服务原始支付渠道查询接口

配置参数页面会显示对应服务类型下的原始支付渠道

![image-20230115213655729](img/聚合支付项目实战学习笔记/image-20230115213655729.png)







#### 接口定义

要查询某服务类型下的支付渠道，以便下一步为某支付渠道配置参数，可从服务类型与支付渠道对应关系表关联查询



在PayChannelService接口中定义queryPayChannelByPlatformChannel

```java
package mao.aggregate_pay_transaction_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_transaction_api.dto.PayChannelDTO;
import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.aggregate_pay_transaction_service.entity.PayChannel;
import mao.tools_core.base.R;

import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.service
 * Interface(接口名): PayChannelService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 22:34
 * Version(版本): 1.0
 * Description(描述)： 支付聚道服务
 */

public interface PayChannelService extends IService<PayChannel>
{
    /**
     * 根据平台服务类型获取支付渠道列表
     *
     * @param platformChannelCode 平台渠道代码
     * @return {@link List}<{@link PayChannelDTO}>
     */
    List<PayChannelDTO> queryPayChannelByPlatformChannel(String platformChannelCode);
}
```









#### 接口实现

PlatformChannelMapper接口创建方法selectPayChannelByPlatformChannel

```java
package mao.aggregate_pay_transaction_service.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import mao.aggregate_pay_transaction_api.dto.PayChannelDTO;
import mao.aggregate_pay_transaction_service.entity.PlatformChannel;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Select;

import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.mapper
 * Interface(接口名): PlatformChannelMapper
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 22:02
 * Version(版本): 1.0
 * Description(描述)： 无
 */

@Mapper
public interface PlatformChannelMapper extends BaseMapper<PlatformChannel>
{
    /**
     * 根据服务类型code查询对应的支付渠道
     *
     * @param platformChannelCode 服务类型code
     * @return {@link List}<{@link PayChannelDTO}>
     */
    @Select("SELECT " +
            "  pc.* " +
            "FROM" +
            "  platform_pay_channel ppc," +
            "  pay_channel pc," +
            "  platform_channel pla " +
            "WHERE ppc.PAY_CHANNEL = pc.CHANNEL_CODE " +
            "  AND ppc.PLATFORM_CHANNEL = pla.CHANNEL_CODE " +
            "  AND pla.CHANNEL_CODE = #{platformChannelCode}  ")
    List<PayChannelDTO> selectPayChannelByPlatformChannel(String platformChannelCode);
}
```



支付聚道服务实现类：

```java
package mao.aggregate_pay_transaction_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_transaction_api.dto.PayChannelDTO;
import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.aggregate_pay_transaction_service.entity.PayChannel;
import mao.aggregate_pay_transaction_service.mapper.PayChannelMapper;
import mao.aggregate_pay_transaction_service.mapper.PlatformChannelMapper;
import mao.aggregate_pay_transaction_service.service.PayChannelService;
import mao.tools_core.base.R;
import mao.tools_redis_cache.entity.RedisData;
import mao.tools_redis_cache.utils.RedisUtils;
import mao.toolsdozer.utils.DozerUtils;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.util.List;
import java.util.concurrent.TimeUnit;
import java.util.function.Function;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.service.impl
 * Class(类名): PayChannelServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 22:37
 * Version(版本): 1.0
 * Description(描述)： 支付聚道服务实现类
 */

@Slf4j
@Service
public class PayChannelServiceImpl extends ServiceImpl<PayChannelMapper, PayChannel> implements PayChannelService
{
    @Resource
    private PlatformChannelMapper platformChannelMapper;

    @Resource
    private RedisUtils redisUtils;

    @Override
    public List<PayChannelDTO> queryPayChannelByPlatformChannel(String platformChannelCode)
    {
        RedisData redisData = redisUtils.query("pay:List_PayChannelDTO:queryPayChannelByPlatformChannel:",
                "pay:List_PayChannelDTO:queryPayChannelByPlatformChannel:lock:", platformChannelCode,
                RedisData.class, new Function<String, RedisData>()
                {
                    @Override
                    public RedisData apply(String s)
                    {
                        List<PayChannelDTO> payChannelDTOS = platformChannelMapper.selectPayChannelByPlatformChannel(platformChannelCode);
                        RedisData redisData = new RedisData();
                        redisData.setData(payChannelDTOS);
                        return redisData;
                    }
                },
                300L, TimeUnit.MINUTES, 60);
        return (List<PayChannelDTO>) redisData.getData();

    }
}

```









#### 接口测试

```java
package mao.aggregate_pay_transaction_service.service.impl;

import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.aggregate_pay_transaction_service.service.PayChannelService;
import mao.tools_core.base.R;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.service.impl
 * Class(测试类名): PayChannelServiceImplTest
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 22:50
 * Version(版本): 1.0
 * Description(描述)： 测试类
 */

@SpringBootTest
class PayChannelServiceImplTest
{

    @Autowired
    private PayChannelService payChannelService;

    @Test
    void queryAll()
    {
        System.out.println(payChannelService.list());
    }

    @Test
    void queryPayChannelByPlatformChannel()
    {
        System.out.println(payChannelService.queryPayChannelByPlatformChannel("aggregate_pay_c2b"));
    }
}
```







#### PayChannelController

```java
package mao.aggregate_pay_transaction_service.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_transaction_api.dto.PayChannelDTO;
import mao.aggregate_pay_transaction_service.service.PayChannelService;
import mao.tools_core.base.R;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.annotation.Resource;
import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.controller
 * Class(类名): PayChannelController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/15
 * Time(创建时间)： 21:58
 * Version(版本): 1.0
 * Description(描述)： 支付聚道controller
 */

@Api(value = "支付聚道", tags = "支付聚道")
@RestController
@RequestMapping("/PayChannel")
public class PayChannelController
{

    @Resource
    private PayChannelService payChannelService;

    /**
     * 根据平台服务类型获取支付渠道列表
     *
     * @param platformChannelCode 平台渠道代码
     * @return {@link R}<{@link List}<{@link PayChannelDTO}>>
     */
    @ApiOperation("根据平台服务类型获取支付渠道列表")
    @GetMapping("/platformChannelCode/{platformChannelCode}")
    public R<List<PayChannelDTO>> queryPayChannelByPlatformChannel(@PathVariable String platformChannelCode)
    {
        List<PayChannelDTO> payChannelDTOS = payChannelService.queryPayChannelByPlatformChannel(platformChannelCode);
        return R.success(payChannelDTOS);
    }
}
```











#### feign接口

```java
package mao.aggregate_pay_transaction_api.feign;

import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_transaction_api.dto.PayChannelDTO;
import mao.tools_core.base.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_api.feign
 * Interface(接口名): PayChannelFeignClient
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/15
 * Time(创建时间)： 22:05
 * Version(版本): 1.0
 * Description(描述)： 支付聚道feign接口
 */

@FeignClient(value = "aggregate-pay-transaction-service", path = "/PayChannel")
public interface PayChannelFeignClient
{
    /**
     * 根据平台服务类型获取支付渠道列表
     *
     * @param platformChannelCode 平台渠道代码
     * @return {@link R}<{@link List}<{@link PayChannelDTO}>>
     */
    @GetMapping("/platformChannelCode/{platformChannelCode}")
    R<List<PayChannelDTO>> queryPayChannelByPlatformChannel(@PathVariable String platformChannelCode);
}
```















### 商户平台应用支付渠道查询接口

#### 接口实现

在PlatformParamController类中定义queryPayChannelByPlatformChannel：

```java
package mao.aggregate_pay_merchant_application.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiImplicitParams;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_merchant_application.handler.AssertResult;
import mao.aggregate_pay_transaction_api.dto.PayChannelDTO;
import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.aggregate_pay_transaction_api.feign.PayChannelFeignClient;
import mao.aggregate_pay_transaction_api.feign.PlatformChannelFeignClient;
import mao.tools_core.base.R;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;

import javax.annotation.Resource;
import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.controller
 * Class(类名): PlatformParamController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 23:21
 * Version(版本): 1.0
 * Description(描述)： 商户平台‐渠道和支付参数
 */

@Slf4j
@RestController
@Api(value = "商户平台‐渠道和支付参数相关", tags = "商户平台‐渠道和支付参数")
public class PlatformParamController
{
    @Resource
    private PlatformChannelFeignClient platformChannelFeignClient;

    @Resource
    private PayChannelFeignClient payChannelFeignClient;


    /**
     * 获取平台所有服务类型
     *
     * @return {@link List}<{@link PlatformChannelDTO}>
     */
    @ApiOperation("获取平台服务类型")
    @GetMapping(value = "/my/platform‐channels")
    public List<PlatformChannelDTO> queryPlatformChannel()
    {
        //远程调用
        R<List<PlatformChannelDTO>> r = platformChannelFeignClient.queryAll();
        //断言结果
        AssertResult.handler(r);
        //返回
        return r.getData();
    }

    /**
     * 根据平台服务类型获取支付渠道列表
     *
     * @param platformChannelCode 服务类型编码
     * @return {@link List}<{@link PayChannelDTO}>
     */
    @ApiOperation("根据平台服务类型获取支付渠道列表")
    @ApiImplicitParams(
            {
                    @ApiImplicitParam(name = "platformChannelCode", value = "服务类型编码", required =
                            true, dataType = "String", paramType = "path")
            })
    @GetMapping(value = "/my/pay‐channels/platform‐channel/{platformChannelCode}")
    public List<PayChannelDTO> queryPayChannelByPlatformChannel(@PathVariable String platformChannelCode)
    {
        //远程调用
        R<List<PayChannelDTO>> r = payChannelFeignClient.queryPayChannelByPlatformChannel(platformChannelCode);
        //断言
        AssertResult.handler(r);
        //返回
        return r.getData();
    }


}

```









#### 接口测试

![image-20230116200426972](img/聚合支付项目实战学习笔记/image-20230116200426972.png)





![image-20230116200436616](img/聚合支付项目实战学习笔记/image-20230116200436616.png)















### 交易服务支付渠道参数配置接口

为指定原始支付渠道配置

![image-20230116200603743](img/聚合支付项目实战学习笔记/image-20230116200603743.png)







#### 接口定义

本接口是为应用配置支付渠道参数，前边为应用绑定了服务类型，此接口即为应用所绑定的服务类型配置支付渠道参数。

```java
package mao.aggregate_pay_transaction_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_transaction_api.dto.PayChannelParamDTO;
import mao.aggregate_pay_transaction_service.entity.PayChannelParam;
import mao.tools_core.base.R;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.service
 * Interface(接口名): PayChannelParamService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/16
 * Time(创建时间)： 20:08
 * Version(版本): 1.0
 * Description(描述)： 原始的支付聚道参数服务
 */

public interface PayChannelParamService extends IService<PayChannelParam>
{
    /**
     * 保存支付通道参数
     *
     * @param payChannelParam 原始的支付通道参数
     * @return {@link R}<{@link Boolean}>
     */
    R<Boolean> savePayChannelParam(PayChannelParamDTO payChannelParam);
}
```





#### 接口实现

服务层提供一个接口实现支付渠道参数配置，如果该应用的服务类型已经配置某支付渠道参数则执行更新操作，否则执行添加操作

```java
package mao.aggregate_pay_transaction_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_common.domain.CommonErrorCode;
import mao.aggregate_pay_transaction_api.dto.PayChannelParamDTO;
import mao.aggregate_pay_transaction_service.entity.AppPlatformChannel;
import mao.aggregate_pay_transaction_service.entity.PayChannelParam;
import mao.aggregate_pay_transaction_service.mapper.PayChannelParamMapper;
import mao.aggregate_pay_transaction_service.service.AppPlatformChannelService;
import mao.aggregate_pay_transaction_service.service.PayChannelParamService;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import mao.tools_databases.mybatis.conditions.Wraps;
import mao.toolsdozer.utils.DozerUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.service.impl
 * Class(类名): PayChannelParamServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/16
 * Time(创建时间)： 20:09
 * Version(版本): 1.0
 * Description(描述)： 原始的支付聚道参数服务实现类
 */

@Slf4j
@Service
public class PayChannelParamServiceImpl extends ServiceImpl<PayChannelParamMapper, PayChannelParam> implements PayChannelParamService
{

    @Resource
    private AppPlatformChannelService appPlatformChannelService;

    @Resource
    private DozerUtils dozerUtils;


    @Override
    public R<Boolean> savePayChannelParam(PayChannelParamDTO payChannelParam)
    {
        //去掉id
        payChannelParam.setId(null);
        //根据appid和服务类型查询应用与服务类型绑定id
        Long appPlatformChannelId = selectIdByAppPlatformChannel(payChannelParam.getAppId(),
                payChannelParam.getPlatformChannelCode());
        //判断是否为空
        if (appPlatformChannelId == null)
        {
            //应用未绑定该服务类型不可进行支付渠道参数配置
            throw new BizException("应用没有绑定服务类型");
        }
        //根据应用与服务类型绑定id和支付渠道查询参数信息
        PayChannelParam payChannelParam1 = this.getOne(Wraps.<PayChannelParam>lbQ()
                .eq(PayChannelParam::getAppPlatformChannelId, appPlatformChannelId)
                .eq(PayChannelParam::getPayChannel, payChannelParam.getPayChannel()));
        //判断是否为空
        if (payChannelParam1 == null)
        {
            log.debug("添加支付聚道参数");
            //转换
            PayChannelParam payChannelParam2 = dozerUtils.map(payChannelParam, PayChannelParam.class);
            payChannelParam2.setAppPlatformChannelId(appPlatformChannelId);
            //插入
            this.save(payChannelParam2);
            //返回
            return R.success();
        }
        else
        {
            log.debug("更新支付聚道参数");
            payChannelParam1.setChannelName(payChannelParam.getChannelName());
            //设置参数
            payChannelParam1.setParam(payChannelParam.getParam());
            //更新
            this.updateById(payChannelParam1);
            //返回
            return R.success();
        }

    }


    /**
     * 根据appid和服务类型查询应用与服务类型绑定id
     *
     * @param appId               应用程序id
     * @param platformChannelCode 平台渠道代码
     * @return {@link Long}
     */
    private Long selectIdByAppPlatformChannel(String appId, String platformChannelCode)
    {
        //查询中间表
        AppPlatformChannel appPlatformChannel = appPlatformChannelService.getOne(Wraps.<AppPlatformChannel>lbQ()
                .eq(AppPlatformChannel::getPlatformChannel, platformChannelCode)
                .eq(AppPlatformChannel::getAppId, appId));
        //返回id
        if (appPlatformChannel != null)
        {
            return appPlatformChannel.getId();
        }
        return null;
    }
}

```







#### PayChannelParamController

```java
package mao.aggregate_pay_transaction_service.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_transaction_api.dto.PayChannelParamDTO;
import mao.aggregate_pay_transaction_service.service.PayChannelParamService;
import mao.tools_core.base.R;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.controller
 * Class(类名): PayChannelParamController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/16
 * Time(创建时间)： 20:32
 * Version(版本): 1.0
 * Description(描述)： 原始的支付聚道参数Controller
 */

@Slf4j
@RestController
@Api(value = "支付聚道参数", tags = "支付聚道参数")
@RequestMapping("/PayChannelParam")
public class PayChannelParamController
{
    @Resource
    private PayChannelParamService payChannelParamService;

    /**
     * 保存支付通道参数
     *
     * @param payChannelParam 支付通道参数
     * @return {@link R}<{@link Boolean}>
     */
    @ApiOperation("保存支付通道参数")
    @PostMapping
    public R<Boolean> savePayChannelParam(@RequestBody PayChannelParamDTO payChannelParam)
    {
        return payChannelParamService.savePayChannelParam(payChannelParam);
    }
}
```







#### feign接口

```java
package mao.aggregate_pay_transaction_api.feign;

import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_transaction_api.dto.PayChannelParamDTO;
import mao.tools_core.base.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_api.feign
 * Interface(接口名): PayChannelParamFeignClient
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/16
 * Time(创建时间)： 20:45
 * Version(版本): 1.0
 * Description(描述)： 原始的支付聚道参数feign接口
 */

@FeignClient(value = "aggregate-pay-transaction-service", path = "/PayChannelParam")
public interface PayChannelParamFeignClient
{
    /**
     * 保存支付通道参数
     *
     * @param payChannelParam 支付通道参数
     * @return {@link R}<{@link Boolean}>
     */
    @ApiOperation("保存支付通道参数")
    @PostMapping
    R<Boolean> savePayChannelParam(@RequestBody PayChannelParamDTO payChannelParam);

}
```









### 商户平台应用支付渠道参数配置接口

#### 接口实现

在PlatformParamController类中下定义createPayChannelParam

```java
package mao.aggregate_pay_merchant_application.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiImplicitParams;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_merchant_application.handler.AssertResult;
import mao.aggregate_pay_transaction_api.dto.PayChannelDTO;
import mao.aggregate_pay_transaction_api.dto.PayChannelParamDTO;
import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.aggregate_pay_transaction_api.feign.PayChannelFeignClient;
import mao.aggregate_pay_transaction_api.feign.PayChannelParamFeignClient;
import mao.aggregate_pay_transaction_api.feign.PlatformChannelFeignClient;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import mao.tools_log.annotation.SysLog;
import org.apache.commons.lang3.StringUtils;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.controller
 * Class(类名): PlatformParamController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 23:21
 * Version(版本): 1.0
 * Description(描述)： 商户平台‐渠道和支付参数
 */

@Slf4j
@RestController
@Api(value = "商户平台‐渠道和支付参数相关", tags = "商户平台‐渠道和支付参数")
public class PlatformParamController
{
    @Resource
    private PlatformChannelFeignClient platformChannelFeignClient;

    @Resource
    private PayChannelFeignClient payChannelFeignClient;

    @Resource
    private PayChannelParamFeignClient payChannelParamFeignClient;


    /**
     * 获取平台所有服务类型
     *
     * @return {@link List}<{@link PlatformChannelDTO}>
     */
    @ApiOperation("获取平台服务类型")
    @GetMapping(value = "/my/platform‐channels")
    public List<PlatformChannelDTO> queryPlatformChannel()
    {
        //远程调用
        R<List<PlatformChannelDTO>> r = platformChannelFeignClient.queryAll();
        //断言结果
        AssertResult.handler(r);
        //返回
        return r.getData();
    }

    /**
     * 根据平台服务类型获取支付渠道列表
     *
     * @param platformChannelCode 服务类型编码
     * @return {@link List}<{@link PayChannelDTO}>
     */
    @ApiOperation("根据平台服务类型获取支付渠道列表")
    @ApiImplicitParams(
            {
                    @ApiImplicitParam(name = "platformChannelCode", value = "服务类型编码", required =
                            true, dataType = "String", paramType = "path")
            })
    @GetMapping(value = "/my/pay‐channels/platform‐channel/{platformChannelCode}")
    public List<PayChannelDTO> queryPayChannelByPlatformChannel(@PathVariable String platformChannelCode)
    {
        //远程调用
        R<List<PayChannelDTO>> r = payChannelFeignClient.queryPayChannelByPlatformChannel(platformChannelCode);
        //断言
        AssertResult.handler(r);
        //返回
        return r.getData();
    }


    /**
     * 商户配置支付渠道参数
     *
     * @param payChannelParam 支付通道参数
     */
    @SysLog(value = "商户配置支付渠道参数", recordResponseParam = false)
    @ApiOperation("商户配置支付渠道参数")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "payChannelParam", value = "商户配置支付渠道参数", required =
                            true, dataType = "PayChannelParamDTO", paramType = "body")
            })
    @RequestMapping(value = "/my/pay‐channel‐params", method = {RequestMethod.POST, RequestMethod.PUT})
    public void createPayChannelParam(@RequestBody PayChannelParamDTO payChannelParam)
    {
        //设置商户id，商户id不能从请求里拿
        //todo
        Long merchantId = 12243556L;
        payChannelParam.setMerchantId(merchantId);
        //校验
        if (StringUtils.isBlank(payChannelParam.getAppId()) ||
                StringUtils.isBlank(payChannelParam.getPlatformChannelCode()) ||
                StringUtils.isBlank(payChannelParam.getPayChannel()))
        {
            throw new BizException("传入对象为空或者缺少必要的参数");
        }
        //远程调用
        R<Boolean> r = payChannelParamFeignClient.savePayChannelParam(payChannelParam);
        //断言结果
        AssertResult.handler(r);
    }


}

```









#### 接口测试

![image-20230116205827315](img/聚合支付项目实战学习笔记/image-20230116205827315.png)





![image-20230116205834334](img/聚合支付项目实战学习笔记/image-20230116205834334.png)







![image-20230116205908351](img/聚合支付项目实战学习笔记/image-20230116205908351.png)























## 支付渠道参数查询

### 交易服务渠道参数查询接口

#### 接口定义

有两个方法：

* 根据应用和服务类型获取原始支付参数param，结果可能是多个(支付宝param 微信param)
* 根据应用、服务类型及支付渠道获取原始支付参数param，结果只能是一个



```java
package mao.aggregate_pay_transaction_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_transaction_api.dto.PayChannelParamDTO;
import mao.aggregate_pay_transaction_service.entity.PayChannelParam;
import mao.tools_core.base.R;

import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.service
 * Interface(接口名): PayChannelParamService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/16
 * Time(创建时间)： 20:08
 * Version(版本): 1.0
 * Description(描述)： 原始的支付聚道参数服务
 */

public interface PayChannelParamService extends IService<PayChannelParam>
{
    /**
     * 保存支付通道参数
     *
     * @param payChannelParam 原始的支付通道参数
     * @return {@link R}<{@link Boolean}>
     */
    R<Boolean> savePayChannelParam(PayChannelParamDTO payChannelParam);


    /**
     * 获取指定应用指定服务类型下所包含的原始支付渠道参数列表
     *
     * @param appId           应用id
     * @param platformChannel 服务类型
     * @return {@link List}<{@link PayChannelParamDTO}>
     */
    R<List<PayChannelParamDTO>> queryPayChannelParamByAppAndPlatform(String appId, String platformChannel);


    /**
     * 获取指定应用指定服务类型下所包含的某个原始支付参数
     *
     * @param appId           应用id
     * @param platformChannel 服务类型
     * @param payChannel      支付渠道
     * @return {@link R}<{@link PayChannelParamDTO}>
     */
    R<PayChannelParamDTO> queryParamByAppPlatformAndPayChannel(String appId, String platformChannel, String payChannel);


}
```









#### 接口实现

```java
package mao.aggregate_pay_transaction_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_common.domain.CommonErrorCode;
import mao.aggregate_pay_transaction_api.dto.PayChannelParamDTO;
import mao.aggregate_pay_transaction_service.entity.AppPlatformChannel;
import mao.aggregate_pay_transaction_service.entity.PayChannelParam;
import mao.aggregate_pay_transaction_service.mapper.PayChannelParamMapper;
import mao.aggregate_pay_transaction_service.service.AppPlatformChannelService;
import mao.aggregate_pay_transaction_service.service.PayChannelParamService;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import mao.tools_databases.mybatis.conditions.Wraps;
import mao.toolsdozer.utils.DozerUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.service.impl
 * Class(类名): PayChannelParamServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/16
 * Time(创建时间)： 20:09
 * Version(版本): 1.0
 * Description(描述)： 原始的支付聚道参数服务实现类
 */

@Slf4j
@Service
public class PayChannelParamServiceImpl extends ServiceImpl<PayChannelParamMapper, PayChannelParam> implements PayChannelParamService
{

    @Resource
    private AppPlatformChannelService appPlatformChannelService;

    @Resource
    private DozerUtils dozerUtils;


    @Override
    public R<Boolean> savePayChannelParam(PayChannelParamDTO payChannelParam)
    {
        //去掉id
        payChannelParam.setId(null);
        //根据appid和服务类型查询应用与服务类型绑定id
        Long appPlatformChannelId = selectIdByAppPlatformChannel(payChannelParam.getAppId(),
                payChannelParam.getPlatformChannelCode());
        //判断是否为空
        if (appPlatformChannelId == null)
        {
            //应用未绑定该服务类型不可进行支付渠道参数配置
            throw new BizException("应用没有绑定服务类型");
        }
        //根据应用与服务类型绑定id和支付渠道查询参数信息
        PayChannelParam payChannelParam1 = this.getOne(Wraps.<PayChannelParam>lbQ()
                .eq(PayChannelParam::getAppPlatformChannelId, appPlatformChannelId)
                .eq(PayChannelParam::getPayChannel, payChannelParam.getPayChannel()));
        //判断是否为空
        if (payChannelParam1 == null)
        {
            log.debug("添加支付聚道参数");
            //转换
            PayChannelParam payChannelParam2 = dozerUtils.map(payChannelParam, PayChannelParam.class);
            payChannelParam2.setAppPlatformChannelId(appPlatformChannelId);
            //插入
            this.save(payChannelParam2);
            //返回
            return R.success();
        }
        else
        {
            log.debug("更新支付聚道参数");
            payChannelParam1.setChannelName(payChannelParam.getChannelName());
            //设置参数
            payChannelParam1.setParam(payChannelParam.getParam());
            //更新
            this.updateById(payChannelParam1);
            //返回
            return R.success();
        }

    }

    @Override
    public R<List<PayChannelParamDTO>> queryPayChannelParamByAppAndPlatform(String appId, String platformChannel)
    {
        //查出应用id和服务类型代码在app_platform_channel主键
        Long appPlatformChannelId = selectIdByAppPlatformChannel(appId, platformChannel);
        if (appPlatformChannelId == null)
        {
            //应用未绑定该服务类型不可进行支付渠道参数配置
            throw new BizException("应用没有绑定服务类型");
        }
        //查询
        List<PayChannelParam> payChannelParamList = this.list(Wraps.<PayChannelParam>lbQ()
                .eq(PayChannelParam::getAppPlatformChannelId, appPlatformChannelId));
        //转换
        List<PayChannelParamDTO> payChannelParamDTOList = dozerUtils.mapList(payChannelParamList, PayChannelParamDTO.class);
        //返回
        return R.success(payChannelParamDTOList);
    }

    @Override
    public R<PayChannelParamDTO> queryParamByAppPlatformAndPayChannel(String appId, String platformChannel, String payChannel)
    {
        //查出应用id和服务类型代码在app_platform_channel主键
        Long appPlatformChannelId = selectIdByAppPlatformChannel(appId, platformChannel);
        if (appPlatformChannelId == null)
        {
            //应用未绑定该服务类型不可进行支付渠道参数配置
            throw new BizException("应用没有绑定服务类型");
        }
        //查询
        PayChannelParam payChannelParam = this.getOne(Wraps.<PayChannelParam>lbQ()
                .eq(PayChannelParam::getAppPlatformChannelId, appPlatformChannelId)
                .eq(PayChannelParam::getPayChannel, payChannel));
        if (payChannelParam == null)
        {
            return R.success(null);
        }
        //转换
        PayChannelParamDTO payChannelParamDTO = dozerUtils.map(payChannelParam, PayChannelParamDTO.class);
        //返回
        return R.success(payChannelParamDTO);
    }


    /**
     * 根据appid和服务类型查询应用与服务类型绑定id
     *
     * @param appId               应用程序id
     * @param platformChannelCode 平台渠道代码
     * @return {@link Long}
     */
    private Long selectIdByAppPlatformChannel(String appId, String platformChannelCode)
    {
        //查询中间表
        AppPlatformChannel appPlatformChannel = appPlatformChannelService.getOne(Wraps.<AppPlatformChannel>lbQ()
                .eq(AppPlatformChannel::getPlatformChannel, platformChannelCode)
                .eq(AppPlatformChannel::getAppId, appId));
        //返回id
        if (appPlatformChannel != null)
        {
            return appPlatformChannel.getId();
        }
        return null;
    }
}
```







#### PayChannelParamController

```java
package mao.aggregate_pay_transaction_service.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_transaction_api.dto.PayChannelParamDTO;
import mao.aggregate_pay_transaction_service.service.PayChannelParamService;
import mao.tools_core.base.R;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.controller
 * Class(类名): PayChannelParamController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/16
 * Time(创建时间)： 20:32
 * Version(版本): 1.0
 * Description(描述)： 原始的支付聚道参数Controller
 */

@Slf4j
@RestController
@Api(value = "支付聚道参数", tags = "支付聚道参数")
@RequestMapping("/PayChannelParam")
public class PayChannelParamController
{
    @Resource
    private PayChannelParamService payChannelParamService;

    /**
     * 保存支付通道参数
     *
     * @param payChannelParam 支付通道参数
     * @return {@link R}<{@link Boolean}>
     */
    @ApiOperation("保存支付通道参数")
    @PostMapping
    public R<Boolean> savePayChannelParam(@RequestBody PayChannelParamDTO payChannelParam)
    {
        return payChannelParamService.savePayChannelParam(payChannelParam);
    }


    /**
     * 获取指定应用指定服务类型下所包含的原始支付渠道参数列表
     *
     * @param appId           应用id
     * @param platformChannel 服务类型
     * @return {@link List}<{@link PayChannelParamDTO}>
     */
    @ApiOperation("获取指定应用指定服务类型下所包含的原始支付渠道参数列表")
    @GetMapping("/queryPayChannelParamByAppAndPlatform")
    public R<List<PayChannelParamDTO>> queryPayChannelParamByAppAndPlatform(@RequestParam String appId,
                                                                            @RequestParam String platformChannel)
    {
        return payChannelParamService.queryPayChannelParamByAppAndPlatform(appId, platformChannel);
    }


    /**
     * 获取指定应用指定服务类型下所包含的某个原始支付参数
     *
     * @param appId           应用id
     * @param platformChannel 服务类型
     * @param payChannel      支付渠道
     * @return {@link R}<{@link PayChannelParamDTO}>
     */
    @ApiOperation("获取指定应用指定服务类型下所包含的某个原始支付参数")
    @GetMapping("/queryParamByAppPlatformAndPayChannel")
    public R<PayChannelParamDTO> queryParamByAppPlatformAndPayChannel(@RequestParam String appId,
                                                                      @RequestParam String platformChannel,
                                                                      @RequestParam String payChannel)
    {
        return payChannelParamService.queryParamByAppPlatformAndPayChannel(appId, platformChannel, payChannel);
    }
}
```









#### feign接口

```java
package mao.aggregate_pay_transaction_api.feign;

import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_transaction_api.dto.PayChannelParamDTO;
import mao.tools_core.base.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestParam;

import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_api.feign
 * Interface(接口名): PayChannelParamFeignClient
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/16
 * Time(创建时间)： 20:45
 * Version(版本): 1.0
 * Description(描述)： 原始的支付聚道参数feign接口
 */

@FeignClient(value = "aggregate-pay-transaction-service", path = "/PayChannelParam")
public interface PayChannelParamFeignClient
{
    /**
     * 保存支付通道参数
     *
     * @param payChannelParam 支付通道参数
     * @return {@link R}<{@link Boolean}>
     */
    @ApiOperation("保存支付通道参数")
    @PostMapping
    R<Boolean> savePayChannelParam(@RequestBody PayChannelParamDTO payChannelParam);


    /**
     * 获取指定应用指定服务类型下所包含的原始支付渠道参数列表
     *
     * @param appId           应用id
     * @param platformChannel 服务类型
     * @return {@link List}<{@link PayChannelParamDTO}>
     */
    @GetMapping("/queryPayChannelParamByAppAndPlatform")
    R<List<PayChannelParamDTO>> queryPayChannelParamByAppAndPlatform(@RequestParam String appId,
                                                                     @RequestParam String platformChannel);


    /**
     * 获取指定应用指定服务类型下所包含的某个原始支付参数
     *
     * @param appId           应用id
     * @param platformChannel 服务类型
     * @param payChannel      支付渠道
     * @return {@link R}<{@link PayChannelParamDTO}>
     */
    @GetMapping("/queryParamByAppPlatformAndPayChannel")
    R<PayChannelParamDTO> queryParamByAppPlatformAndPayChannel(@RequestParam String appId,
                                                               @RequestParam String platformChannel,
                                                               @RequestParam String payChannel);
}
```











### 商户平台应用查询渠道参数接口

#### 接口实现

两个查询接口：

* 根据应用和服务类型获取原始支付参数列表
* 根据应用、服务类型及支付渠道获取原始支付参数



在PlatformParamController中定义queryPayChannelParam

```java
package mao.aggregate_pay_merchant_application.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiImplicitParams;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_merchant_application.handler.AssertResult;
import mao.aggregate_pay_transaction_api.dto.PayChannelDTO;
import mao.aggregate_pay_transaction_api.dto.PayChannelParamDTO;
import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.aggregate_pay_transaction_api.feign.PayChannelFeignClient;
import mao.aggregate_pay_transaction_api.feign.PayChannelParamFeignClient;
import mao.aggregate_pay_transaction_api.feign.PlatformChannelFeignClient;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import mao.tools_log.annotation.SysLog;
import org.apache.commons.lang3.StringUtils;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.controller
 * Class(类名): PlatformParamController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 23:21
 * Version(版本): 1.0
 * Description(描述)： 商户平台‐渠道和支付参数
 */

@Slf4j
@RestController
@Api(value = "商户平台‐渠道和支付参数相关", tags = "商户平台‐渠道和支付参数")
public class PlatformParamController
{
    @Resource
    private PlatformChannelFeignClient platformChannelFeignClient;

    @Resource
    private PayChannelFeignClient payChannelFeignClient;

    @Resource
    private PayChannelParamFeignClient payChannelParamFeignClient;


    /**
     * 获取平台所有服务类型
     *
     * @return {@link List}<{@link PlatformChannelDTO}>
     */
    @ApiOperation("获取平台服务类型")
    @GetMapping(value = "/my/platform‐channels")
    public List<PlatformChannelDTO> queryPlatformChannel()
    {
        //远程调用
        R<List<PlatformChannelDTO>> r = platformChannelFeignClient.queryAll();
        //断言结果
        AssertResult.handler(r);
        //返回
        return r.getData();
    }

    /**
     * 根据平台服务类型获取支付渠道列表
     *
     * @param platformChannelCode 服务类型编码
     * @return {@link List}<{@link PayChannelDTO}>
     */
    @ApiOperation("根据平台服务类型获取支付渠道列表")
    @ApiImplicitParams(
            {
                    @ApiImplicitParam(name = "platformChannelCode", value = "服务类型编码", required =
                            true, dataType = "String", paramType = "path")
            })
    @GetMapping(value = "/my/pay‐channels/platform‐channel/{platformChannelCode}")
    public List<PayChannelDTO> queryPayChannelByPlatformChannel(@PathVariable String platformChannelCode)
    {
        //远程调用
        R<List<PayChannelDTO>> r = payChannelFeignClient.queryPayChannelByPlatformChannel(platformChannelCode);
        //断言
        AssertResult.handler(r);
        //返回
        return r.getData();
    }


    /**
     * 商户配置支付渠道参数
     *
     * @param payChannelParam 支付通道参数
     */
    @SysLog(value = "商户配置支付渠道参数", recordResponseParam = false)
    @ApiOperation("商户配置支付渠道参数")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "payChannelParam", value = "商户配置支付渠道参数", required =
                            true, dataType = "PayChannelParamDTO", paramType = "body")
            })
    @RequestMapping(value = "/my/pay‐channel‐params", method = {RequestMethod.POST, RequestMethod.PUT})
    public void createPayChannelParam(@RequestBody PayChannelParamDTO payChannelParam)
    {
        //设置商户id，商户id不能从请求里拿
        //todo
        Long merchantId = 12243556L;
        payChannelParam.setMerchantId(merchantId);
        //校验
        if (StringUtils.isBlank(payChannelParam.getAppId()) ||
                StringUtils.isBlank(payChannelParam.getPlatformChannelCode()) ||
                StringUtils.isBlank(payChannelParam.getPayChannel()))
        {
            throw new BizException("传入对象为空或者缺少必要的参数");
        }
        //远程调用
        R<Boolean> r = payChannelParamFeignClient.savePayChannelParam(payChannelParam);
        //断言结果
        AssertResult.handler(r);
    }


    /**
     * 获取指定应用指定服务类型下所包含的原始支付渠道参数列表
     *
     * @param appId           应用id
     * @param platformChannel 平台支付渠道编码
     * @return {@link List}<{@link PayChannelParamDTO}>
     */
    @ApiOperation("获取指定应用指定服务类型下所包含的原始支付渠道参数列表")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "appId", value = "应用id", required = true,
                            dataType = "String", paramType = "path"),
                    @ApiImplicitParam(name = "platformChannel", value = "服务类型",
                            required = true, dataType = "String", paramType = "path")})
    @GetMapping(value = "/my/pay‐channel‐params/apps/{appId}/platform‐ channels/{platformChannel}")
    public List<PayChannelParamDTO> queryPayChannelParam(@PathVariable String appId,
                                                         @PathVariable String platformChannel)
    {
        //查询
        R<List<PayChannelParamDTO>> r = payChannelParamFeignClient.queryPayChannelParamByAppAndPlatform(appId, platformChannel);
        //断言结果
        AssertResult.handler(r);
        //返回
        return r.getData();
    }


    /**
     * 获取指定应用指定服务类型下所包含的某个原始支付参数
     *
     * @param appId           应用id
     * @param platformChannel 平台支付渠道编码
     * @param payChannel      实际支付渠道编码
     * @return {@link PayChannelParamDTO}
     */
    @ApiOperation("获取指定应用指定服务类型下所包含的某个原始支付参数")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "appId", value = "应用id",
                            required = true, dataType = "String", paramType = "path"),
                    @ApiImplicitParam(name = "platformChannel", value = "平台支付渠道编码",
                            required = true, dataType = "String", paramType = "path"),
                    @ApiImplicitParam(name = "payChannel", value = "实际支付渠道编码",
                            required = true, dataType = "String", paramType = "path")})
    @GetMapping(value = "/my/pay‐channel‐params/apps/{appId}/platform‐ channels/{platformChannel}/pay‐channels/{payChannel}")
    public PayChannelParamDTO queryPayChannelParam(@PathVariable String appId,
                                                   @PathVariable String platformChannel, @PathVariable String payChannel)
    {
        //查询
        R<PayChannelParamDTO> r = payChannelParamFeignClient.queryParamByAppPlatformAndPayChannel(appId, platformChannel, payChannel);
        //断言结果
        AssertResult.handler(r);
        //返回
        return r.getData();
    }


}
```









#### 接口测试

![image-20230116214844377](img/聚合支付项目实战学习笔记/image-20230116214844377.png)





![image-20230116214855097](img/聚合支付项目实战学习笔记/image-20230116214855097.png)





![image-20230116215038169](img/聚合支付项目实战学习笔记/image-20230116215038169.png)





![image-20230116215117348](img/聚合支付项目实战学习笔记/image-20230116215117348.png)





![image-20230116215151008](img/聚合支付项目实战学习笔记/image-20230116215151008.png)













## 支付渠道参数缓存

### 需求分析

渠道参数查询频繁，每一次支付都会查询渠道参数，为提供查询性能这里我们将渠道参数缓存到redis中

查询渠道参数，先从Redis查询，如果Redis存在则返回渠道参数，否则从数据库查询同时将查询到的渠道参数存储 在Redis中，并发较大，还需要解决缓存的缓存穿透、缓存击穿和缓存雪崩问题







### 实现



```java
package mao.aggregate_pay_transaction_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_common.domain.CommonErrorCode;
import mao.aggregate_pay_transaction_api.dto.PayChannelParamDTO;
import mao.aggregate_pay_transaction_service.entity.AppPlatformChannel;
import mao.aggregate_pay_transaction_service.entity.PayChannelParam;
import mao.aggregate_pay_transaction_service.mapper.PayChannelParamMapper;
import mao.aggregate_pay_transaction_service.service.AppPlatformChannelService;
import mao.aggregate_pay_transaction_service.service.PayChannelParamService;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import mao.tools_databases.mybatis.conditions.Wraps;
import mao.tools_redis_cache.entity.RedisData;
import mao.tools_redis_cache.utils.RedisUtils;
import mao.toolsdozer.utils.DozerUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.util.List;
import java.util.concurrent.TimeUnit;
import java.util.function.Function;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.service.impl
 * Class(类名): PayChannelParamServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/16
 * Time(创建时间)： 20:09
 * Version(版本): 1.0
 * Description(描述)： 原始的支付聚道参数服务实现类
 */

@Slf4j
@Service
public class PayChannelParamServiceImpl extends ServiceImpl<PayChannelParamMapper, PayChannelParam> implements PayChannelParamService
{

    @Resource
    private AppPlatformChannelService appPlatformChannelService;

    @Resource
    private DozerUtils dozerUtils;

    @Resource
    private RedisUtils redisUtils;

    @Resource
    private StringRedisTemplate stringRedisTemplate;


    @Override
    public R<Boolean> savePayChannelParam(PayChannelParamDTO payChannelParam)
    {
        //去掉id
        payChannelParam.setId(null);
        //根据appid和服务类型查询应用与服务类型绑定id
        Long appPlatformChannelId = selectIdByAppPlatformChannel(payChannelParam.getAppId(),
                payChannelParam.getPlatformChannelCode());
        //判断是否为空
        if (appPlatformChannelId == null)
        {
            //应用未绑定该服务类型不可进行支付渠道参数配置
            throw new BizException("应用没有绑定服务类型");
        }
        //根据应用与服务类型绑定id和支付渠道查询参数信息
        PayChannelParam payChannelParam1 = this.getOne(Wraps.<PayChannelParam>lbQ()
                .eq(PayChannelParam::getAppPlatformChannelId, appPlatformChannelId)
                .eq(PayChannelParam::getPayChannel, payChannelParam.getPayChannel()));

        //让缓存过期
        String redisKey1 = payChannelParam.getAppId() + "__" + payChannelParam.getPlatformChannelCode();
        String redisKey2 = payChannelParam.getAppId() + "__" + payChannelParam.getPlatformChannelCode() + "__" + payChannelParam.getPayChannel();
        stringRedisTemplate.delete("pay:List_PayChannelParamDTO:query1:" + redisKey1);
        stringRedisTemplate.delete("pay:PayChannelParamDTO:query2:" + redisKey2);

        //判断是否为空
        if (payChannelParam1 == null)
        {
            log.debug("添加支付聚道参数");
            //转换
            PayChannelParam payChannelParam2 = dozerUtils.map(payChannelParam, PayChannelParam.class);
            payChannelParam2.setAppPlatformChannelId(appPlatformChannelId);
            //插入
            this.save(payChannelParam2);
            //返回
            return R.success();
        }
        else
        {
            log.debug("更新支付聚道参数");
            payChannelParam1.setChannelName(payChannelParam.getChannelName());
            //设置参数
            payChannelParam1.setParam(payChannelParam.getParam());
            //更新
            this.updateById(payChannelParam1);
            //返回
            return R.success();
        }
    }

    @Override
    public R<List<PayChannelParamDTO>> queryPayChannelParamByAppAndPlatform(String appId, String platformChannel)
    {
        //redisKey
        String redisKey = appId + "__" + platformChannel;
        //查询
        RedisData redisData = redisUtils.query("pay:List_PayChannelParamDTO:query1:"
                , "pay:List_PayChannelParamDTO:query1:lock:"
                , redisKey, RedisData.class, new Function<String, RedisData>()
                {
                    @Override
                    public RedisData apply(String s)
                    {
                        //查询数据库
                        List<PayChannelParamDTO> payChannelParamDTOList = queryPayChannelParamByAppAndPlatformByDatabase(appId, platformChannel);
                        //封装
                        RedisData redisData = new RedisData();
                        redisData.setData(payChannelParamDTOList);
                        //返回
                        return redisData;
                    }
                }, 300L, TimeUnit.MINUTES, 120);

        List<PayChannelParamDTO> payChannelParamDTOList = (List<PayChannelParamDTO>) redisData.getData();
        //返回
        return R.success(payChannelParamDTOList);
    }


    /**
     * 获取指定应用指定服务类型下所包含的原始支付渠道参数列表，从数据库里查询
     *
     * @param appId           应用id
     * @param platformChannel 平台通道
     * @return {@link List}<{@link PayChannelParamDTO}>
     */
    private List<PayChannelParamDTO> queryPayChannelParamByAppAndPlatformByDatabase(String appId, String platformChannel)
    {
        //查出应用id和服务类型代码在app_platform_channel主键
        Long appPlatformChannelId = selectIdByAppPlatformChannel(appId, platformChannel);
        if (appPlatformChannelId == null)
        {
            //应用未绑定该服务类型不可进行支付渠道参数配置
            throw new BizException("应用没有绑定服务类型");
        }
        //查询
        List<PayChannelParam> payChannelParamList = this.list(Wraps.<PayChannelParam>lbQ()
                .eq(PayChannelParam::getAppPlatformChannelId, appPlatformChannelId));
        //转换
        return dozerUtils.mapList(payChannelParamList, PayChannelParamDTO.class);
    }


    @Override
    public R<PayChannelParamDTO> queryParamByAppPlatformAndPayChannel(String appId, String platformChannel, String payChannel)
    {
        //redisKey
        String redisKey = appId + "__" + platformChannel + "__" + payChannel;
        //查询
        PayChannelParamDTO payChannelParamDTO = redisUtils.query("pay:PayChannelParamDTO:query2:"
                , "pay:PayChannelParamDTO:query2:lock:"
                , redisKey, PayChannelParamDTO.class, new Function<String, PayChannelParamDTO>()
                {
                    @Override
                    public PayChannelParamDTO apply(String s)
                    {
                        //查询数据库
                        return queryParamByAppPlatformAndPayChannelBydatabase(appId, platformChannel, payChannel);
                    }
                }, 300L, TimeUnit.MINUTES, 120);

        //返回
        return R.success(payChannelParamDTO);
    }


    /**
     * 获取指定应用指定服务类型下所包含的某个原始支付参数，从数据库里查询
     *
     * @param appId           应用程序id
     * @param platformChannel 平台通道
     * @param payChannel      支付通道
     * @return {@link R}<{@link PayChannelParamDTO}>
     */
    private PayChannelParamDTO queryParamByAppPlatformAndPayChannelBydatabase(String appId, String platformChannel, String payChannel)
    {
        //查出应用id和服务类型代码在app_platform_channel主键
        Long appPlatformChannelId = selectIdByAppPlatformChannel(appId, platformChannel);
        if (appPlatformChannelId == null)
        {
            //应用未绑定该服务类型不可进行支付渠道参数配置
            throw new BizException("应用没有绑定服务类型");
        }
        //查询
        PayChannelParam payChannelParam = this.getOne(Wraps.<PayChannelParam>lbQ()
                .eq(PayChannelParam::getAppPlatformChannelId, appPlatformChannelId)
                .eq(PayChannelParam::getPayChannel, payChannel));
        if (payChannelParam == null)
        {
            return null;
        }
        //转换
        return dozerUtils.map(payChannelParam, PayChannelParamDTO.class);
    }


    /**
     * 根据appid和服务类型查询应用与服务类型绑定id
     *
     * @param appId               应用程序id
     * @param platformChannelCode 平台渠道代码
     * @return {@link Long}
     */
    private Long selectIdByAppPlatformChannel(String appId, String platformChannelCode)
    {
        //查询中间表
        AppPlatformChannel appPlatformChannel = appPlatformChannelService.getOne(Wraps.<AppPlatformChannel>lbQ()
                .eq(AppPlatformChannel::getPlatformChannel, platformChannelCode)
                .eq(AppPlatformChannel::getAppId, appId));
        //返回id
        if (appPlatformChannel != null)
        {
            return appPlatformChannel.getId();
        }
        return null;
    }
}

```











### 单元测试

```java
package mao.aggregate_pay_transaction_service.service.impl;

import mao.aggregate_pay_transaction_api.dto.PayChannelParamDTO;
import mao.aggregate_pay_transaction_service.service.PayChannelParamService;
import mao.tools_core.base.R;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_transaction_service.service.impl
 * Class(测试类名): PayChannelParamServiceImplTest
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/17
 * Time(创建时间)： 14:07
 * Version(版本): 1.0
 * Description(描述)： 测试类
 */

@SpringBootTest
class PayChannelParamServiceImplTest
{

    @Autowired
    private PayChannelParamService payChannelParamService;

    @Test
    void queryPayChannelParamByAppAndPlatform()
    {
        R<List<PayChannelParamDTO>> aggregate_pay_c2b =
                payChannelParamService.queryPayChannelParamByAppAndPlatform("7a6e88fba94742069ef3bc40ee70ef18",
                        "aggregate_pay_c2b");
        System.out.println(aggregate_pay_c2b.getData());
    }

    @Test
    void queryPayChannelParamByAppAndPlatform2()
    {
        R<List<PayChannelParamDTO>> aggregate_pay_c2b =
                payChannelParamService.queryPayChannelParamByAppAndPlatform("7a6e88fba94742069ef3bc40ee70ef18",
                        "aggregate_pay_c2b");
        System.out.println(aggregate_pay_c2b.getData());
    }

    @Test
    void queryParamByAppPlatformAndPayChannel()
    {
        R<PayChannelParamDTO> aggregate_pay_c2b =
                payChannelParamService.queryParamByAppPlatformAndPayChannel("7a6e88fba94742069ef3bc40ee70ef18",
                        "aggregate_pay_c2b", "32");
        System.out.println(aggregate_pay_c2b.getData());
    }

    @Test
    void queryParamByAppPlatformAndPayChannel2()
    {
        R<PayChannelParamDTO> aggregate_pay_c2b =
                payChannelParamService.queryParamByAppPlatformAndPayChannel("7a6e88fba94742069ef3bc40ee70ef18",
                        "aggregate_pay_c2b", "32");
        System.out.println(aggregate_pay_c2b.getData());
    }
}
```

























# 对接SaaS

## 基础概念

### SaaS

SaaS是Software-as-a-Service（软件即服务）的简称，它是一种通过互联网提供软件服务的模式，与传统软件相比有如下几点区别：

* SaaS软件不再是用户向软件供应商定制软件或进行二次开发，而是供应商将软件部署在自己的服务器上并通过互联网提供在线服务
* 软件供应商负责搭建一切网络设备、软硬件运行平台等基础设施，并全权负责运营和维护软件
* 用户根据实际需要通过互联网订购所需要的软件服务，按照订购服务的多少和时间长短支付费用
* 用户不需要一次性支付很大一笔软件定制费，只需支付一些租用费用就可以使用软件，风险非常低，当发现软件不满足需求或不适合公司管理模式可以停止续租



对于许多中小型企业来说，SaaS模式是采用先进技术的最好途径，它减少了企业购买、构建和维护基础设施和应用程序的成本，大大降低了软件费用



云计算的发展至今有十几年的历史，如今云计算得到了广泛的市场应用，具体包括三个层次：

* IaaS: Infrastructure-as-a-Service（基础设施即服务），也叫Hardware-as-a-Service，将计算机硬件资源打包对 外提供服务，比如云主机、云存储等
* PaaS: Platform-as-a-Service（平台即服务），也叫中间件服务，比如：MySQL数据库服务、ElasticSearch搜索服务等。 
* SaaS: Software-as-a-Service（软件即服务） ，提供具体应用软件服务





### 多租户

当一个使用SaaS模式部署的软件同时有多个企业用户租用时，每一个企业都是独立的租用者，我们通常称他为： 租户(tenant)；同时有多个租用者，那就是多租户(multi-tenant)。多租户（Multi-tenant)是SaaS最重要的核心概 念和关键技术



什么是租户？

* 一个“组织”在某软件平台上购买了部分软件服务(权限集合)，这个“组织”就是这个软件平台的“租户”。“组织”就是指 人们为实现一定的目标，互相协作结合而成的集体或团体，如某企业、某学校、某机构、某商户、甚至某家庭

什么是租户类型？

* 具有相同业务的为同一类租户，比如：“商户”是一类租 户，“XX超市”则是一个具体的商户

什么是用户？

* “用户”是“组织”(租户)内成员，是软件平台的实际使用者，使用者凭身份（用户名）、凭证(密码)登入平台
* “用户”可以在其所在“租户”内新建其它用户，并在“租户”购买的权限集合范围内对其它用户授权，称之为用户、权限“自管理”



整个软件平台被很多个租户共同使用，引入“多租户”的用户架构是为了让组织得到用户、权限“自管理”的支持，并 与其它“租户”的数据隔离







## 对接SaaS步骤

### 业务模型

商户平台应用与SaaS平台模型的对应关系如下：

![image-20230117145000598](img/聚合支付项目实战学习笔记/image-20230117145000598.png)





* 左侧为商户平台，右侧为SaaS平台
* 商户平台的商户对应SaaS平台的租户
* 商户平台的员工对应SaaS平台的用户



门店是什么？

* 门店是商户平台中员工的组织机构，比如：本商户是一个大型超市，该大型超市在很多地方有自己的连锁店，这个连锁店就是门店，每个连锁店都有自己的员工
* 门店是商户平台由于经营需要所设立的组织机构，在SaaS平台中没有对应模型





### 接入步骤

一个商户注册相当于一个租户在SaaS平台注册，下图展示了商户注册时商户服务与SaaS的交互流程：

![image-20230117145700043](img/聚合支付项目实战学习笔记/image-20230117145700043.png)





商户注册，调用SaaS平台的新增租户与用户接口，每个步骤如下：

1. 新增租户，在商户平台新增商户，调用SaaS系统的接口新增租户
2. 新增用户，在商户平台新增员工，调用SaaS的接口新增用户，且自动设置用户和租户的绑定关系，并将该用户设置为该租户的管理员
3. 初始化租户权限，商户注册成功为该租户设置默认权限
4. 更新管理员的权限











## 部署SaaS系统



|          服务名称          |          描述          |
| :------------------------: | :--------------------: |
|   aggregate-pay-gateway    | 聚合支付平台的网关服务 |
|     aggregate-pay-uaa      |    认证和授权父模块    |
|   aggregate-pay-uaa-api    |   认证和授权api模块    |
| aggregate-pay-uaa-service  |     认证和授权服务     |
|     aggregate-pay-user     |       用户父模块       |
|   aggregate-pay-user-api   |      用户api模块       |
| aggregate-pay-user-service |        用户服务        |







### 搭建

#### aggregate-pay-gateway

在pay模块下新建一个子模块aggregate-pay-gateway

![image-20230117150645985](img/聚合支付项目实战学习笔记/image-20230117150645985.png)



![image-20230117150738831](img/聚合支付项目实战学习笔记/image-20230117150738831.png)



![image-20230117150900928](img/聚合支付项目实战学习笔记/image-20230117150900928.png)







#### aggregate-pay-uaa

在pay模块下新建一个子模块aggregate-pay-uaa

![image-20230117151009225](img/聚合支付项目实战学习笔记/image-20230117151009225.png)



![image-20230117151049334](img/聚合支付项目实战学习笔记/image-20230117151049334.png)





#### aggregate-pay-uaa-api

在aggregate-pay-uaa模块下新建一个子模块aggregate-pay-uaa-api

![image-20230117151145007](img/聚合支付项目实战学习笔记/image-20230117151145007.png)



![image-20230117151222456](img/聚合支付项目实战学习笔记/image-20230117151222456.png)



![image-20230117151314363](img/聚合支付项目实战学习笔记/image-20230117151314363.png)







#### aggregate-pay-uaa-service

在aggregate-pay-uaa模块下新建一个子模块aggregate-pay-uaa-service

![image-20230117151359672](img/聚合支付项目实战学习笔记/image-20230117151359672.png)



![image-20230117151521337](img/聚合支付项目实战学习笔记/image-20230117151521337.png)







#### aggregate-pay-user

在pay模块下新建一个子模块aggregate-pay-user

![image-20230117164952654](img/聚合支付项目实战学习笔记/image-20230117164952654.png)



![image-20230117165025896](img/聚合支付项目实战学习笔记/image-20230117165025896.png)



![image-20230117165112666](img/聚合支付项目实战学习笔记/image-20230117165112666.png)









#### aggregate-pay-user-api

在aggregate-pay-user模块下新建一个子模块aggregate-pay-user-api

![image-20230117165145463](img/聚合支付项目实战学习笔记/image-20230117165145463.png)



![image-20230117165222205](img/聚合支付项目实战学习笔记/image-20230117165222205.png)



![image-20230117165309716](img/聚合支付项目实战学习笔记/image-20230117165309716.png)







#### aggregate-pay-user-service

在aggregate-pay-user模块下新建一个子模块aggregate-pay-user-service

![image-20230117165410556](img/聚合支付项目实战学习笔记/image-20230117165410556.png)











### pom文件







### 配置文件





















## 对接SaaS代码实现

根据前边接口SaaS步骤 的分析，需要在商户平台 完成新增员工、新增门店、设置门店管理员等功能



### 商户服务新增门店接口

#### 接口定义

在商户服务定义新增门店接口，商户注册的同时新增默认门店



在MerchantService接口类中定义接口createStore：

```java
package mao.aggregate_pay_merchant_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.aggregate_pay_merchant_service.entity.Merchant;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service
 * Interface(接口名): MerchantService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:29
 * Version(版本): 1.0
 * Description(描述)： 商户服务接口
 */

public interface MerchantService extends IService<Merchant>
{
    /**
     * 通过id获取商户信息
     *
     * @param merchantId 商户id
     * @return {@link MerchantDTO}
     */
    MerchantDTO getMerchantById(Long merchantId);


    /**
     * 商户注册
     *
     * @param merchantDTO {@link MerchantDTO} 商户dto
     * @return {@link MerchantDTO}
     */
    MerchantDTO createMerchant(MerchantDTO merchantDTO);

    /**
     * 资质申请
     *
     * @param merchantId  商户id
     * @param merchantDTO 资质申请信息
     */
    void applyMerchant(Long merchantId, MerchantDTO merchantDTO);


    /**
     * 商户下新增门店
     *
     * @param storeDTO 商店dto
     * @return {@link StoreDTO}
     */
    StoreDTO createStore(StoreDTO storeDTO);
}
```







#### 接口实现



创建StoreService接口

```java
package mao.aggregate_pay_merchant_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_merchant_service.entity.Store;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service
 * Interface(接口名): StoreService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/22
 * Time(创建时间)： 23:00
 * Version(版本): 1.0
 * Description(描述)： 门店服务
 */

public interface StoreService extends IService<Store>
{

}
```



创建StoreService接口实现类

```java
package mao.aggregate_pay_merchant_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_merchant_service.entity.Store;
import mao.aggregate_pay_merchant_service.mapper.StoreMapper;
import mao.aggregate_pay_merchant_service.service.StoreService;
import org.springframework.stereotype.Service;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service.impl
 * Class(类名): StoreServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/22
 * Time(创建时间)： 23:00
 * Version(版本): 1.0
 * Description(描述)： 门店服务实现类
 */

@Slf4j
@Service
public class StoreServiceImpl extends ServiceImpl<StoreMapper, Store> implements StoreService
{

}
```







在MerchantServiceImpl类中实现createStore方法

```java
package mao.aggregate_pay_merchant_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import mao.aggregate_pay_common.domain.CommonErrorCode;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.aggregate_pay_merchant_service.entity.Merchant;
import mao.aggregate_pay_merchant_service.entity.Store;
import mao.aggregate_pay_merchant_service.mapper.MerchantMapper;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.aggregate_pay_merchant_service.service.StoreService;
import mao.tools_core.exception.BizException;
import mao.tools_databases.mybatis.conditions.Wraps;
import mao.toolsdozer.utils.DozerUtils;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service.impl
 * Class(类名): MerchantServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:38
 * Version(版本): 1.0
 * Description(描述)： 商户服务实现类
 */

@Service
public class MerchantServiceImpl extends ServiceImpl<MerchantMapper, Merchant> implements MerchantService
{

    @Resource
    private DozerUtils dozerUtils;

    @Resource
    private StoreService storeService;

    @Override
    public MerchantDTO getMerchantById(Long merchantId)
    {
        //查询
        Merchant merchant = this.getById(merchantId);
        //转换，并返回
        return dozerUtils.map(merchant, MerchantDTO.class);
    }

    @Override
    public MerchantDTO createMerchant(MerchantDTO merchantDTO)
    {
        //校验商户手机号的唯一性,根据商户的手机号查询商户表，如果存在记录则说明已有相同的手机号重复
        int count = this.count(Wraps.<Merchant>lbQ().eq(Merchant::getMobile, merchantDTO.getMobile()));
        if (count > 0)
        {
            throw BizException.wrap("手机号重复");
        }
        //构建商户
        Merchant merchant = new Merchant();
        //设置审核状态
        merchant.setAuditStatus("0");
        //设置手机号
        merchant.setMobile(merchantDTO.getMobile());
        //保存
        this.save(merchant);
        //保存id信息
        merchantDTO.setId(merchant.getId());
        //返回
        return merchantDTO;
    }

    @Override
    @Transactional
    public void applyMerchant(Long merchantId, MerchantDTO merchantDTO)
    {
        //接收资质申请信息，更新到商户表
        if (merchantDTO == null || merchantId == null)
        {
            throw BizException.wrap("传入对象为空");
        }
        //根据id查询商户
        Merchant merchant = this.getById(merchantId);
        if (merchant == null)
        {
            throw BizException.wrap("商户不存在");
        }
        //对象转换
        Merchant merchant_update = dozerUtils.map(merchantDTO, Merchant.class);
        //已申请待审核
        merchant_update.setAuditStatus("1");
        //租户id
        merchant_update.setTenantId(merchant.getTenantId());
        //设置商户id
        merchant_update.setId(merchantId);
        //更新
        boolean update = this.updateById(merchant_update);
        if (!update)
        {
            throw BizException.wrap("商户资质申请失败");
        }
    }

    @Override
    public StoreDTO createStore(StoreDTO storeDTO)
    {
        //转换
        Store store = dozerUtils.map(storeDTO, Store.class);
        //去掉id
        store.setId(null);
        //新增
        boolean save = storeService.save(store);
        if (!save)
        {
            throw BizException.wrap("商户下新增门店失败");
        }
        //设置id
        storeDTO.setId(store.getId());
        //返回
        return storeDTO;
    }
}
```







#### MerchantController

```java
package mao.aggregate_pay_merchant_service.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.tools_core.base.BaseController;
import mao.tools_core.base.R;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.controller
 * Class(类名): MerchantController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:53
 * Version(版本): 1.0
 * Description(描述)： 商户Controller
 */

@RestController
@Api(tags = "商户")
@RequestMapping("/merchant")
public class MerchantController extends BaseController
{

    @Resource
    private MerchantService merchantService;

    /**
     * 根据商户id查询商户信息
     *
     * @param merchantId 商人id
     * @return {@link R}<{@link MerchantDTO}>
     */
    @ApiOperation("根据商户id查询商户信息")
    @GetMapping("/{merchantId}")
    public R<MerchantDTO> getById(@PathVariable Long merchantId)
    {
        return R.success(merchantService.getMerchantById(merchantId));
    }


    /**
     * 注册商户
     *
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link MerchantDTO}>
     */
    @ApiOperation("注册商户")
    @PostMapping
    public R<MerchantDTO> createMerchant(@RequestBody MerchantDTO merchantDTO)
    {
        return R.success(merchantService.createMerchant(merchantDTO));
    }


    /**
     * 商户资质申请
     *
     * @param merchantId  商人id
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link Boolean}>
     */
    @ApiOperation("商户资质申请")
    @PostMapping("/{merchantId}")
    public R<Boolean> applyMerchant(@PathVariable Long merchantId, @RequestBody MerchantDTO merchantDTO)
    {
        merchantService.applyMerchant(merchantId, merchantDTO);
        return R.success();
    }


    /**
     * 商户下新增门店
     *
     * @param storeDTO 商店dto
     * @return {@link StoreDTO}
     */
    @ApiOperation("商户资质申请")
    @PostMapping("/createStore")
    public R<StoreDTO> createStore(@RequestBody StoreDTO storeDTO)
    {
        return success(merchantService.createStore(storeDTO));
    }
}
```





#### feign接口

```java
package mao.aggregate_pay_merchant_api.feign;

import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.tools_core.base.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_api.feign
 * Interface(接口名): MerchantFeignClient
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 21:26
 * Version(版本): 1.0
 * Description(描述)： 商户服务feign接口
 */

@FeignClient(value = "aggregate-pay-merchant-service", path = "/merchant")
public interface MerchantFeignClient
{
    /**
     * 根据商户id查询商户信息
     *
     * @param merchantId 商人id
     * @return {@link R}<{@link MerchantDTO}>
     */
    @GetMapping("/{merchantId}")
    R<MerchantDTO> getById(@PathVariable Long merchantId);

    /**
     * 创建商户
     *
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link MerchantDTO}>
     */
    @PostMapping
    R<MerchantDTO> createMerchant(@RequestBody MerchantDTO merchantDTO);

    /**
     * 商户资质申请
     *
     * @param merchantId  商人id
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link Boolean}>
     */
    @PostMapping("/{merchantId}")
    R<Boolean> applyMerchant(@PathVariable Long merchantId, @RequestBody MerchantDTO merchantDTO);

    /**
     * 商户下新增门店
     *
     * @param storeDTO 商店dto
     * @return {@link StoreDTO}
     */
    @ApiOperation("商户资质申请")
    @PostMapping("/createStore")
    R<StoreDTO> createStore(@RequestBody StoreDTO storeDTO);
}
```









### 商户服务新增员工接口

#### 接口定义

在商户服务定义新增员工接口

* 接收商户填写的员工数据
* 请求商户服务进行新增员工



在MerchantService接口类中定义接口createStaff：

```java
package mao.aggregate_pay_merchant_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StaffDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.aggregate_pay_merchant_service.entity.Merchant;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service
 * Interface(接口名): MerchantService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:29
 * Version(版本): 1.0
 * Description(描述)： 商户服务接口
 */

public interface MerchantService extends IService<Merchant>
{
    /**
     * 通过id获取商户信息
     *
     * @param merchantId 商户id
     * @return {@link MerchantDTO}
     */
    MerchantDTO getMerchantById(Long merchantId);


    /**
     * 商户注册
     *
     * @param merchantDTO {@link MerchantDTO} 商户dto
     * @return {@link MerchantDTO}
     */
    MerchantDTO createMerchant(MerchantDTO merchantDTO);

    /**
     * 资质申请
     *
     * @param merchantId  商户id
     * @param merchantDTO 资质申请信息
     */
    void applyMerchant(Long merchantId, MerchantDTO merchantDTO);


    /**
     * 商户下新增门店
     *
     * @param storeDTO 商店dto
     * @return {@link StoreDTO}
     */
    StoreDTO createStore(StoreDTO storeDTO);

    /**
     * 商户新增员工
     *
     * @param staffDTO 员工dto
     * @return {@link StaffDTO}
     */
    StaffDTO createStaff(StaffDTO staffDTO);
}
```







#### 接口实现



创建StaffService接口

```java
package mao.aggregate_pay_merchant_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_merchant_service.entity.Staff;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service
 * Interface(接口名): StaffService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/23
 * Time(创建时间)： 13:31
 * Version(版本): 1.0
 * Description(描述)： 员工服务
 */

public interface StaffService extends IService<Staff>
{

}
```





创建StaffService接口实现类

```java
package mao.aggregate_pay_merchant_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_merchant_service.entity.Staff;
import mao.aggregate_pay_merchant_service.mapper.StaffMapper;
import mao.aggregate_pay_merchant_service.service.StaffService;
import org.springframework.stereotype.Service;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service.impl
 * Class(类名): StaffServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/23
 * Time(创建时间)： 13:31
 * Version(版本): 1.0
 * Description(描述)： 员工服务实现类
 */

@Slf4j
@Service
public class StaffServiceImpl extends ServiceImpl<StaffMapper, Staff> implements StaffService
{

}
```





在MerchantServiceImpl类中定义createStaff方法

```java
package mao.aggregate_pay_merchant_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import mao.aggregate_pay_common.domain.CommonErrorCode;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StaffDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.aggregate_pay_merchant_service.entity.Merchant;
import mao.aggregate_pay_merchant_service.entity.Staff;
import mao.aggregate_pay_merchant_service.entity.Store;
import mao.aggregate_pay_merchant_service.mapper.MerchantMapper;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.aggregate_pay_merchant_service.service.StaffService;
import mao.aggregate_pay_merchant_service.service.StoreService;
import mao.tools_core.exception.BizException;
import mao.tools_databases.mybatis.conditions.Wraps;
import mao.toolsdozer.utils.DozerUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service.impl
 * Class(类名): MerchantServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:38
 * Version(版本): 1.0
 * Description(描述)： 商户服务实现类
 */

@Service
public class MerchantServiceImpl extends ServiceImpl<MerchantMapper, Merchant> implements MerchantService
{

    @Resource
    private DozerUtils dozerUtils;

    @Resource
    private StoreService storeService;

    @Resource
    private StaffService staffService;

    @Override
    public MerchantDTO getMerchantById(Long merchantId)
    {
        //查询
        Merchant merchant = this.getById(merchantId);
        //转换，并返回
        return dozerUtils.map(merchant, MerchantDTO.class);
    }

    @Override
    public MerchantDTO createMerchant(MerchantDTO merchantDTO)
    {
        //校验商户手机号的唯一性,根据商户的手机号查询商户表，如果存在记录则说明已有相同的手机号重复
        int count = this.count(Wraps.<Merchant>lbQ().eq(Merchant::getMobile, merchantDTO.getMobile()));
        if (count > 0)
        {
            throw BizException.wrap("手机号重复");
        }
        //构建商户
        Merchant merchant = new Merchant();
        //设置审核状态
        merchant.setAuditStatus("0");
        //设置手机号
        merchant.setMobile(merchantDTO.getMobile());
        //保存
        this.save(merchant);
        //保存id信息
        merchantDTO.setId(merchant.getId());
        //返回
        return merchantDTO;
    }

    @Override
    @Transactional
    public void applyMerchant(Long merchantId, MerchantDTO merchantDTO)
    {
        //接收资质申请信息，更新到商户表
        if (merchantDTO == null || merchantId == null)
        {
            throw BizException.wrap("传入对象为空");
        }
        //根据id查询商户
        Merchant merchant = this.getById(merchantId);
        if (merchant == null)
        {
            throw BizException.wrap("商户不存在");
        }
        //对象转换
        Merchant merchant_update = dozerUtils.map(merchantDTO, Merchant.class);
        //已申请待审核
        merchant_update.setAuditStatus("1");
        //租户id
        merchant_update.setTenantId(merchant.getTenantId());
        //设置商户id
        merchant_update.setId(merchantId);
        //更新
        boolean update = this.updateById(merchant_update);
        if (!update)
        {
            throw BizException.wrap("商户资质申请失败");
        }
    }

    @Override
    public StoreDTO createStore(StoreDTO storeDTO)
    {
        //转换
        Store store = dozerUtils.map(storeDTO, Store.class);
        //去掉id
        store.setId(null);
        //新增
        boolean save = storeService.save(store);
        if (!save)
        {
            throw BizException.wrap("新增门店失败");
        }
        //设置id
        storeDTO.setId(store.getId());
        //返回
        return storeDTO;
    }

    @Override
    public StaffDTO createStaff(StaffDTO staffDTO)
    {
        //判断是否为空
        if (StringUtils.isBlank(staffDTO.getMobile()))
        {
            //空
            throw BizException.wrap("手机号为空");
        }
        //判断是否为空
        if (StringUtils.isBlank(staffDTO.getUsername()))
        {
            //空
            throw BizException.wrap("用户名为空");
        }
        //根据手机号和商户id判断员工是否已在指定商户存在
        if (isExistStaffByMobile(staffDTO.getMobile(), staffDTO.getMerchantId()))
        {
            //已经存在
            throw BizException.wrap("手机号已经存在");
        }
        //根据账号判断员工是否已在指定商户存在
        if (isExistStaffByUserName(staffDTO.getUsername(), staffDTO.getMerchantId()))
        {
            //存在
            throw BizException.wrap("用户名已经存在");
        }
        //转换
        Staff staff = dozerUtils.map(staffDTO, Staff.class);
        //去掉id
        staff.setId(null);
        //保存
        staffService.save(staff);
        //设置id
        staffDTO.setId(staff.getId());
        //返回
        return staffDTO;
    }

    /**
     * 根据手机号和商户id判断员工是否已在指定商户存在
     *
     * @param mobile     手机号
     * @param merchantId 商人id
     * @return boolean
     */
    private boolean isExistStaffByMobile(String mobile, Long merchantId)
    {
        int count = staffService.count(Wraps.<Staff>lbQ()
                .eq(Staff::getMobile, mobile)
                .eq(Staff::getMerchantId, merchantId));
        return count > 0;
    }

    /**
     * 根据账号判断员工是否已在指定商户存在
     *
     * @param userName   用户名
     * @param merchantId 商人id
     * @return boolean
     */
    private boolean isExistStaffByUserName(String userName, Long merchantId)
    {
        int count = staffService.count(Wraps.<Staff>lbQ()
                .eq(Staff::getUsername, userName)
                .eq(Staff::getMerchantId, merchantId));
        return count > 0;
    }

}
```







#### MerchantController

```java
package mao.aggregate_pay_merchant_service.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StaffDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.tools_core.base.BaseController;
import mao.tools_core.base.R;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.controller
 * Class(类名): MerchantController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:53
 * Version(版本): 1.0
 * Description(描述)： 商户Controller
 */

@RestController
@Api(tags = "商户")
@RequestMapping("/merchant")
public class MerchantController extends BaseController
{

    @Resource
    private MerchantService merchantService;

    /**
     * 根据商户id查询商户信息
     *
     * @param merchantId 商人id
     * @return {@link R}<{@link MerchantDTO}>
     */
    @ApiOperation("根据商户id查询商户信息")
    @GetMapping("/{merchantId}")
    public R<MerchantDTO> getById(@PathVariable Long merchantId)
    {
        return R.success(merchantService.getMerchantById(merchantId));
    }


    /**
     * 注册商户
     *
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link MerchantDTO}>
     */
    @ApiOperation("注册商户")
    @PostMapping
    public R<MerchantDTO> createMerchant(@RequestBody MerchantDTO merchantDTO)
    {
        return R.success(merchantService.createMerchant(merchantDTO));
    }


    /**
     * 商户资质申请
     *
     * @param merchantId  商人id
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link Boolean}>
     */
    @ApiOperation("商户资质申请")
    @PostMapping("/{merchantId}")
    public R<Boolean> applyMerchant(@PathVariable Long merchantId, @RequestBody MerchantDTO merchantDTO)
    {
        merchantService.applyMerchant(merchantId, merchantDTO);
        return R.success();
    }


    /**
     * 商户下新增门店
     *
     * @param storeDTO 商店dto
     * @return {@link StoreDTO}
     */
    @ApiOperation("商户资质申请")
    @PostMapping("/createStore")
    public R<StoreDTO> createStore(@RequestBody StoreDTO storeDTO)
    {
        return success(merchantService.createStore(storeDTO));
    }


    /**
     * 商户新增员工
     *
     * @param staffDTO 员工dto
     * @return {@link StaffDTO}
     */
    @ApiOperation("商户新增员工")
    @PostMapping("/createStaff")
    public R<StaffDTO> createStaff(@RequestBody StaffDTO staffDTO)
    {
        return success(merchantService.createStaff(staffDTO));
    }
}
```







#### feign接口

```java
package mao.aggregate_pay_merchant_api.feign;

import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StaffDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.tools_core.base.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_api.feign
 * Interface(接口名): MerchantFeignClient
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 21:26
 * Version(版本): 1.0
 * Description(描述)： 商户服务feign接口
 */

@FeignClient(value = "aggregate-pay-merchant-service", path = "/merchant")
public interface MerchantFeignClient
{
    /**
     * 根据商户id查询商户信息
     *
     * @param merchantId 商人id
     * @return {@link R}<{@link MerchantDTO}>
     */
    @GetMapping("/{merchantId}")
    R<MerchantDTO> getById(@PathVariable Long merchantId);

    /**
     * 创建商户
     *
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link MerchantDTO}>
     */
    @PostMapping
    R<MerchantDTO> createMerchant(@RequestBody MerchantDTO merchantDTO);

    /**
     * 商户资质申请
     *
     * @param merchantId  商人id
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link Boolean}>
     */
    @PostMapping("/{merchantId}")
    R<Boolean> applyMerchant(@PathVariable Long merchantId, @RequestBody MerchantDTO merchantDTO);

    /**
     * 商户下新增门店
     *
     * @param storeDTO 商店dto
     * @return {@link StoreDTO}
     */
    @PostMapping("/createStore")
    R<StoreDTO> createStore(@RequestBody StoreDTO storeDTO);


    /**
     * 商户新增员工
     *
     * @param staffDTO 员工dto
     * @return {@link StaffDTO}
     */
    @PostMapping("/createStaff")
    R<StaffDTO> createStaff(@RequestBody StaffDTO staffDTO);
}
```









###  商户服务门店设置管理员接口

#### 接口定义

绑定门店和员工对应关系

在MerchantService接口类中定义bindStaffToStore接口：

```java
package mao.aggregate_pay_merchant_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StaffDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.aggregate_pay_merchant_service.entity.Merchant;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service
 * Interface(接口名): MerchantService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:29
 * Version(版本): 1.0
 * Description(描述)： 商户服务接口
 */

public interface MerchantService extends IService<Merchant>
{
    /**
     * 通过id获取商户信息
     *
     * @param merchantId 商户id
     * @return {@link MerchantDTO}
     */
    MerchantDTO getMerchantById(Long merchantId);


    /**
     * 商户注册
     *
     * @param merchantDTO {@link MerchantDTO} 商户dto
     * @return {@link MerchantDTO}
     */
    MerchantDTO createMerchant(MerchantDTO merchantDTO);

    /**
     * 资质申请
     *
     * @param merchantId  商户id
     * @param merchantDTO 资质申请信息
     */
    void applyMerchant(Long merchantId, MerchantDTO merchantDTO);


    /**
     * 商户下新增门店
     *
     * @param storeDTO 商店dto
     * @return {@link StoreDTO}
     */
    StoreDTO createStore(StoreDTO storeDTO);

    
    /**
     * 商户新增员工
     *
     * @param staffDTO 员工dto
     * @return {@link StaffDTO}
     */
    StaffDTO createStaff(StaffDTO staffDTO);


    /**
     * 为门店设置管理员
     *
     * @param storeId 门店id
     * @param staffId 员工id
     */
    void bindStaffToStore(Long storeId, Long staffId);
}
```





#### 接口实现

创建StoreStaffService接口

```java
package mao.aggregate_pay_merchant_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_merchant_service.entity.StoreStaff;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service
 * Interface(接口名): StoreStaffService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/23
 * Time(创建时间)： 13:51
 * Version(版本): 1.0
 * Description(描述)： 门店-员工关系
 */

public interface StoreStaffService extends IService<StoreStaff>
{

}
```





创建StoreStaffService接口实现类

```java
package mao.aggregate_pay_merchant_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_merchant_service.entity.StoreStaff;
import mao.aggregate_pay_merchant_service.mapper.StoreStaffMapper;
import mao.aggregate_pay_merchant_service.service.StoreStaffService;
import org.springframework.stereotype.Service;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service.impl
 * Class(类名): StoreStaffServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/23
 * Time(创建时间)： 13:51
 * Version(版本): 1.0
 * Description(描述)： 无
 */

@Slf4j
@Service
public class StoreStaffServiceImpl extends ServiceImpl<StoreStaffMapper, StoreStaff> implements StoreStaffService
{

}
```





在MerchantServiceImpl实现bindStaffToStore

```java
package mao.aggregate_pay_merchant_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import mao.aggregate_pay_common.domain.CommonErrorCode;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StaffDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.aggregate_pay_merchant_service.entity.Merchant;
import mao.aggregate_pay_merchant_service.entity.Staff;
import mao.aggregate_pay_merchant_service.entity.Store;
import mao.aggregate_pay_merchant_service.entity.StoreStaff;
import mao.aggregate_pay_merchant_service.mapper.MerchantMapper;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.aggregate_pay_merchant_service.service.StaffService;
import mao.aggregate_pay_merchant_service.service.StoreService;
import mao.aggregate_pay_merchant_service.service.StoreStaffService;
import mao.tools_core.exception.BizException;
import mao.tools_databases.mybatis.conditions.Wraps;
import mao.toolsdozer.utils.DozerUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service.impl
 * Class(类名): MerchantServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:38
 * Version(版本): 1.0
 * Description(描述)： 商户服务实现类
 */

@Service
public class MerchantServiceImpl extends ServiceImpl<MerchantMapper, Merchant> implements MerchantService
{

    @Resource
    private DozerUtils dozerUtils;

    @Resource
    private StoreService storeService;

    @Resource
    private StaffService staffService;

    @Resource
    private StoreStaffService storeStaffService;

    @Override
    public MerchantDTO getMerchantById(Long merchantId)
    {
        //查询
        Merchant merchant = this.getById(merchantId);
        //转换，并返回
        return dozerUtils.map(merchant, MerchantDTO.class);
    }

    @Override
    public MerchantDTO createMerchant(MerchantDTO merchantDTO)
    {
        //校验商户手机号的唯一性,根据商户的手机号查询商户表，如果存在记录则说明已有相同的手机号重复
        int count = this.count(Wraps.<Merchant>lbQ().eq(Merchant::getMobile, merchantDTO.getMobile()));
        if (count > 0)
        {
            throw BizException.wrap("手机号重复");
        }
        //构建商户
        Merchant merchant = new Merchant();
        //设置审核状态
        merchant.setAuditStatus("0");
        //设置手机号
        merchant.setMobile(merchantDTO.getMobile());
        //保存
        this.save(merchant);
        //保存id信息
        merchantDTO.setId(merchant.getId());
        //返回
        return merchantDTO;
    }

    @Override
    @Transactional
    public void applyMerchant(Long merchantId, MerchantDTO merchantDTO)
    {
        //接收资质申请信息，更新到商户表
        if (merchantDTO == null || merchantId == null)
        {
            throw BizException.wrap("传入对象为空");
        }
        //根据id查询商户
        Merchant merchant = this.getById(merchantId);
        if (merchant == null)
        {
            throw BizException.wrap("商户不存在");
        }
        //对象转换
        Merchant merchant_update = dozerUtils.map(merchantDTO, Merchant.class);
        //已申请待审核
        merchant_update.setAuditStatus("1");
        //租户id
        merchant_update.setTenantId(merchant.getTenantId());
        //设置商户id
        merchant_update.setId(merchantId);
        //更新
        boolean update = this.updateById(merchant_update);
        if (!update)
        {
            throw BizException.wrap("商户资质申请失败");
        }
    }

    @Override
    public StoreDTO createStore(StoreDTO storeDTO)
    {
        //转换
        Store store = dozerUtils.map(storeDTO, Store.class);
        //去掉id
        store.setId(null);
        //新增
        boolean save = storeService.save(store);
        if (!save)
        {
            throw BizException.wrap("新增门店失败");
        }
        //设置id
        storeDTO.setId(store.getId());
        //返回
        return storeDTO;
    }

    @Override
    public StaffDTO createStaff(StaffDTO staffDTO)
    {
        //判断是否为空
        if (StringUtils.isBlank(staffDTO.getMobile()))
        {
            //空
            throw BizException.wrap("手机号为空");
        }
        //判断是否为空
        if (StringUtils.isBlank(staffDTO.getUsername()))
        {
            //空
            throw BizException.wrap("用户名为空");
        }
        //根据手机号和商户id判断员工是否已在指定商户存在
        if (isExistStaffByMobile(staffDTO.getMobile(), staffDTO.getMerchantId()))
        {
            //已经存在
            throw BizException.wrap("手机号已经存在");
        }
        //根据账号判断员工是否已在指定商户存在
        if (isExistStaffByUserName(staffDTO.getUsername(), staffDTO.getMerchantId()))
        {
            //存在
            throw BizException.wrap("用户名已经存在");
        }
        //转换
        Staff staff = dozerUtils.map(staffDTO, Staff.class);
        //去掉id
        staff.setId(null);
        //保存
        staffService.save(staff);
        //设置id
        staffDTO.setId(staff.getId());
        //返回
        return staffDTO;
    }

    /**
     * 根据手机号和商户id判断员工是否已在指定商户存在
     *
     * @param mobile     手机号
     * @param merchantId 商人id
     * @return boolean
     */
    private boolean isExistStaffByMobile(String mobile, Long merchantId)
    {
        int count = staffService.count(Wraps.<Staff>lbQ()
                .eq(Staff::getMobile, mobile)
                .eq(Staff::getMerchantId, merchantId));
        return count > 0;
    }

    /**
     * 根据账号判断员工是否已在指定商户存在
     *
     * @param userName   用户名
     * @param merchantId 商人id
     * @return boolean
     */
    private boolean isExistStaffByUserName(String userName, Long merchantId)
    {
        int count = staffService.count(Wraps.<Staff>lbQ()
                .eq(Staff::getUsername, userName)
                .eq(Staff::getMerchantId, merchantId));
        return count > 0;
    }


    @Override
    public void bindStaffToStore(Long storeId, Long staffId)
    {
        //构建实体类对象
        StoreStaff storeStaff = new StoreStaff();
        storeStaff.setStaffId(staffId);
        storeStaff.setStoreId(storeId);
        //保存
        boolean save = storeStaffService.save(storeStaff);
        if (!save)
        {
            throw BizException.wrap("为门店设置管理员失败");
        }
    }

}
```







#### MerchantController

```java
package mao.aggregate_pay_merchant_service.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StaffDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.tools_core.base.BaseController;
import mao.tools_core.base.R;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.controller
 * Class(类名): MerchantController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:53
 * Version(版本): 1.0
 * Description(描述)： 商户Controller
 */

@RestController
@Api(tags = "商户")
@RequestMapping("/merchant")
public class MerchantController extends BaseController
{

    @Resource
    private MerchantService merchantService;

    /**
     * 根据商户id查询商户信息
     *
     * @param merchantId 商人id
     * @return {@link R}<{@link MerchantDTO}>
     */
    @ApiOperation("根据商户id查询商户信息")
    @GetMapping("/{merchantId}")
    public R<MerchantDTO> getById(@PathVariable Long merchantId)
    {
        return R.success(merchantService.getMerchantById(merchantId));
    }


    /**
     * 注册商户
     *
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link MerchantDTO}>
     */
    @ApiOperation("注册商户")
    @PostMapping
    public R<MerchantDTO> createMerchant(@RequestBody MerchantDTO merchantDTO)
    {
        return R.success(merchantService.createMerchant(merchantDTO));
    }


    /**
     * 商户资质申请
     *
     * @param merchantId  商人id
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link Boolean}>
     */
    @ApiOperation("商户资质申请")
    @PostMapping("/{merchantId}")
    public R<Boolean> applyMerchant(@PathVariable Long merchantId, @RequestBody MerchantDTO merchantDTO)
    {
        merchantService.applyMerchant(merchantId, merchantDTO);
        return R.success();
    }


    /**
     * 商户下新增门店
     *
     * @param storeDTO 商店dto
     * @return {@link StoreDTO}
     */
    @ApiOperation("商户资质申请")
    @PostMapping("/createStore")
    public R<StoreDTO> createStore(@RequestBody StoreDTO storeDTO)
    {
        return success(merchantService.createStore(storeDTO));
    }


    /**
     * 商户新增员工
     *
     * @param staffDTO 员工dto
     * @return {@link StaffDTO}
     */
    @ApiOperation("商户新增员工")
    @PostMapping("/createStaff")
    public R<StaffDTO> createStaff(@RequestBody StaffDTO staffDTO)
    {
        return success(merchantService.createStaff(staffDTO));
    }


   /**
     * 为门店设置管理员
     *
     * @param storeId 门店id
     * @param staffId 员工id
     */
    @ApiOperation("为门店设置管理员")
    @PostMapping("/bindStaffToStore/{storeId}/{staffId}")
    R<Boolean> bindStaffToStore(@PathVariable Long storeId, @PathVariable Long staffId)
    {
        merchantService.bindStaffToStore(storeId, staffId);
        return success();
    }
}
```







#### feign接口

```java
package mao.aggregate_pay_merchant_api.feign;

import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StaffDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.tools_core.base.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_api.feign
 * Interface(接口名): MerchantFeignClient
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 21:26
 * Version(版本): 1.0
 * Description(描述)： 商户服务feign接口
 */

@FeignClient(value = "aggregate-pay-merchant-service", path = "/merchant")
public interface MerchantFeignClient
{
    /**
     * 根据商户id查询商户信息
     *
     * @param merchantId 商人id
     * @return {@link R}<{@link MerchantDTO}>
     */
    @GetMapping("/{merchantId}")
    R<MerchantDTO> getById(@PathVariable Long merchantId);

    /**
     * 创建商户
     *
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link MerchantDTO}>
     */
    @PostMapping
    R<MerchantDTO> createMerchant(@RequestBody MerchantDTO merchantDTO);

    /**
     * 商户资质申请
     *
     * @param merchantId  商人id
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link Boolean}>
     */
    @PostMapping("/{merchantId}")
    R<Boolean> applyMerchant(@PathVariable Long merchantId, @RequestBody MerchantDTO merchantDTO);

    /**
     * 商户下新增门店
     *
     * @param storeDTO 商店dto
     * @return {@link StoreDTO}
     */
    @PostMapping("/createStore")
    R<StoreDTO> createStore(@RequestBody StoreDTO storeDTO);


    /**
     * 商户新增员工
     *
     * @param staffDTO 员工dto
     * @return {@link StaffDTO}
     */
    @PostMapping("/createStaff")
    R<StaffDTO> createStaff(@RequestBody StaffDTO staffDTO);


    /**
     * 为门店设置管理员
     *
     * @param storeId 门店id
     * @param staffId 员工id
     */
    @PostMapping("/bindStaffToStore/{storeId}/{staffId}")
    R<Boolean> bindStaffToStore(@PathVariable Long storeId, @PathVariable Long staffId)
}
```









### 商户服务商户注册接口修改

####  接口说明

添加依赖

```xml
<dependency>
    <groupId>mao</groupId>
    <artifactId>aggregate-pay-user-api</artifactId>
</dependency>
```





SaaS系统的用户服务提供注册租户的接口，如下 ：

创建租户如果已存在租户则返回租户信息，否则新增租户、新增租户管理员，同时初始化权限

1. 若管理员用户名已存在，禁止创建
2. 手机号已存在，禁止创建
3. 创建根租户对应账号时，需要手机号，账号的用户名密码





```java
    /**
     * 创建租户如果已存在租户则返回租户信息，否则新增租户、新增租户管理员，同时初始化权限
     * 1.若管理员用户名已存在，禁止创建
     * 2.手机号已存在，禁止创建
     * 3.创建根租户对应账号时，需要手机号，账号的用户名密码
     *
     * @param createTenantRequest 创建租户请求信息
     * @return {@link TenantDTO}
     */
    TenantDTO createTenantAndAccount(CreateTenantRequestDTO createTenantRequest);
```



注意：此接口位于aggregate-pay-user-service模块





#### 接口实现

createTenantAndAccount接口实现类如下，位于aggregate-pay-user-service模块

```java
/**
 * 创建租户如果已存在租户则返回租户信息，否则新增租户、新增租户管理员，同时初始化权限
 * 1.若管理员用户名已存在，禁止创建
 * 2.手机号已存在，禁止创建
 * 3.创建根租户对应账号时，需要手机号，账号的用户名密码
 *
 * @param createTenantRequest 创建租户请求信息
 * @return {@link TenantDTO}
 */
@Override
@Transactional(rollbackFor = Exception.class)
public TenantDTO createTenantAndAccount(CreateTenantRequestDTO createTenantRequest)
{

    //1.判断手机号跟用户名在账号中是否存在
    String mobile = createTenantRequest.getMobile();
    if (isExistAccountByMobile(mobile))
    {
        //为true表示 手机号已存在
        //throw new BusinessException(CommonErrorCode.E_200203);
        AccountDTO account = getAccountByMobile(mobile);
        Long accountId = account.getId();
        Boolean isAdmin = true;
        //获取到租户信息并返回
        TenantDTO tenant = getTenantByAccount(accountId, isAdmin);
        if (tenant == null)
        {
            //创建租户
            Tenant ten = createTenant(createTenantRequest);
            //绑定租户和账号的关系，设置为管理员
            bindTenantAccount(ten.getId(), accountId, true);
            return dozerUtils.map(ten, TenantDTO.class);
        }
        else
        {
            return tenant;
        }

    }
    else
    {
        //2.新增租户
        Tenant tenant = createTenant(createTenantRequest);

        //3.创建管理员账号并绑定租户
        CreateAccountRequestDTO createAccountRequest = new CreateAccountRequestDTO();
        createAccountRequest.setMobile(mobile);
        createAccountRequest.setUsername(createTenantRequest.getUsername());
        createAccountRequest.setPassword(createTenantRequest.getPassword());
        createAccountInTenant(createAccountRequest, tenant.getId());

        //4.初始化套餐
        //设置租户套餐为初始化套餐
        if (tenant.getId() == null)
        {
            throw new BusinessException(CommonErrorCode.E_200012);
        }
        //设置初始化套餐，更新权限
        log.info("初始化套餐");
        initBundle(tenant.getId(), createTenantRequest.getBundleCode());

        return dozerUtils.map(tenant, TenantDTO.class);
    }
}
```





修改商户服务createMerchant方法：

```java
package mao.aggregate_pay_merchant_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import mao.aggregate_pay_common.domain.CommonErrorCode;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StaffDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.aggregate_pay_merchant_service.entity.Merchant;
import mao.aggregate_pay_merchant_service.entity.Staff;
import mao.aggregate_pay_merchant_service.entity.Store;
import mao.aggregate_pay_merchant_service.entity.StoreStaff;
import mao.aggregate_pay_merchant_service.mapper.MerchantMapper;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.aggregate_pay_merchant_service.service.StaffService;
import mao.aggregate_pay_merchant_service.service.StoreService;
import mao.aggregate_pay_merchant_service.service.StoreStaffService;
import mao.aggregate_pay_user_api.dto.tenant.CreateTenantRequestDTO;
import mao.aggregate_pay_user_api.dto.tenant.TenantDTO;
import mao.aggregate_pay_user_api.feign.TenantFeignClientV2;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import mao.tools_databases.mybatis.conditions.Wraps;
import mao.toolsdozer.utils.DozerUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service.impl
 * Class(类名): MerchantServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:38
 * Version(版本): 1.0
 * Description(描述)： 商户服务实现类
 */

@Service
public class MerchantServiceImpl extends ServiceImpl<MerchantMapper, Merchant> implements MerchantService
{

    @Resource
    private DozerUtils dozerUtils;

    @Resource
    private StoreService storeService;

    @Resource
    private StaffService staffService;

    @Resource
    private StoreStaffService storeStaffService;

    @Resource
    private TenantFeignClientV2 tenantFeignClient;

    @Override
    public MerchantDTO getMerchantById(Long merchantId)
    {
        //查询
        Merchant merchant = this.getById(merchantId);
        //转换，并返回
        return dozerUtils.map(merchant, MerchantDTO.class);
    }

//    @Override
//    public MerchantDTO createMerchant(MerchantDTO merchantDTO)
//    {
//        //校验商户手机号的唯一性,根据商户的手机号查询商户表，如果存在记录则说明已有相同的手机号重复
//        int count = this.count(Wraps.<Merchant>lbQ().eq(Merchant::getMobile, merchantDTO.getMobile()));
//        if (count > 0)
//        {
//            throw BizException.wrap("手机号重复");
//        }
//        //构建商户
//        Merchant merchant = new Merchant();
//        //设置审核状态
//        merchant.setAuditStatus("0");
//        //设置手机号
//        merchant.setMobile(merchantDTO.getMobile());
//        //保存
//        this.save(merchant);
//        //保存id信息
//        merchantDTO.setId(merchant.getId());
//        //返回
//        return merchantDTO;
//    }


    @Override
    @Transactional
    public MerchantDTO createMerchant(MerchantDTO merchantDTO)
    {
        //校验商户手机号的唯一性,根据商户的手机号查询商户表，如果存在记录则说明已有相同的手机号重复
        int count = this.count(Wraps.<Merchant>lbQ().eq(Merchant::getMobile, merchantDTO.getMobile()));
        if (count > 0)
        {
            throw BizException.wrap("手机号重复");
        }
        //构建调用参数
        CreateTenantRequestDTO createTenantRequestDTO = new CreateTenantRequestDTO();
        //手机号
        createTenantRequestDTO.setMobile(merchantDTO.getMobile());
        //用户名
        createTenantRequestDTO.setUsername(merchantDTO.getUsername());
        //密码
        createTenantRequestDTO.setPassword(merchantDTO.getPassword());
        //租户类型
        createTenantRequestDTO.setTenantTypeCode("aggregate-pay-merchant");
        //套餐，根据套餐进行分配权限
        createTenantRequestDTO.setBundleCode("aggregate-pay-merchant");
        //租户名称，和账号名一样
        createTenantRequestDTO.setName(merchantDTO.getUsername());
        //调用SaaS接口
        //如果租户在SaaS已经存在，SaaS直接 返回此租户的信息，否则进行添加
        R<TenantDTO> r = tenantFeignClient.createTenantAndInit(createTenantRequestDTO);
        if (r.getIsError())
        {
            //错误，抛出异常
            throw BizException.wrap(r.getCode(), r.getMsg());
        }
        //无错误，取数据
        TenantDTO tenantDTO = r.getData();
        //获取租户的id
        if (tenantDTO == null || tenantDTO.getId() == null)
        {
            //空
            throw BizException.wrap("租户不存在");
        }
        //租户的id
        Long tenantId = tenantDTO.getId();
        //租户id在商户表唯一
        //根据租户id从商户表查询，如果存在记录则不允许添加商户
        int count1 = this.count(Wraps.<Merchant>lbQ().eq(Merchant::getTenantId, tenantId));
        //判断结果
        if (count1 > 0)
        {
            //存在
            throw BizException.wrap("商户在当前租户下已经注册，不可重复注册");
        }
        //对象转换
        Merchant merchant = dozerUtils.map(merchantDTO, Merchant.class);
        //设置所对应的租户的Id
        merchant.setTenantId(tenantId);
        //审核状态为0-未进行资质申请
        merchant.setAuditStatus("0");
        //去掉id
        merchant.setId(null);
        //插入数据
        boolean save = this.save(merchant);
        //判断结果
        if (!save)
        {
            //保存失败
            throw BizException.wrap("商户数据保存失败");
        }
        //新增门店
        StoreDTO storeDTO = new StoreDTO();
        storeDTO.setStoreName("根门店");
        //商户id
        storeDTO.setMerchantId(merchant.getId());
        StoreDTO store = createStore(storeDTO);

        //新增员工
        StaffDTO staffDTO = new StaffDTO();
        //手机号
        staffDTO.setMobile(merchantDTO.getMobile());
        //账号
        staffDTO.setUsername(merchantDTO.getUsername());
        //员所属门店id
        staffDTO.setStoreId(store.getId());
        //商户id
        staffDTO.setMerchantId(merchant.getId());
        //创建
        StaffDTO staff = createStaff(staffDTO);

        //为门店设置管理员
        bindStaffToStore(store.getId(), staff.getId());

        //转换
        dozerUtils.map(merchant, merchantDTO);
        //返回
        return merchantDTO;
    }


    @Override
    @Transactional
    public void applyMerchant(Long merchantId, MerchantDTO merchantDTO)
    {
        //接收资质申请信息，更新到商户表
        if (merchantDTO == null || merchantId == null)
        {
            throw BizException.wrap("传入对象为空");
        }
        //根据id查询商户
        Merchant merchant = this.getById(merchantId);
        if (merchant == null)
        {
            throw BizException.wrap("商户不存在");
        }
        //对象转换
        Merchant merchant_update = dozerUtils.map(merchantDTO, Merchant.class);
        //已申请待审核
        merchant_update.setAuditStatus("1");
        //租户id
        merchant_update.setTenantId(merchant.getTenantId());
        //设置商户id
        merchant_update.setId(merchantId);
        //更新
        boolean update = this.updateById(merchant_update);
        if (!update)
        {
            throw BizException.wrap("商户资质申请失败");
        }
    }

    @Override
    public StoreDTO createStore(StoreDTO storeDTO)
    {
        //转换
        Store store = dozerUtils.map(storeDTO, Store.class);
        //去掉id
        store.setId(null);
        //新增
        boolean save = storeService.save(store);
        if (!save)
        {
            throw BizException.wrap("新增门店失败");
        }
        //设置id
        storeDTO.setId(store.getId());
        //返回
        return storeDTO;
    }

    @Override
    public StaffDTO createStaff(StaffDTO staffDTO)
    {
        //判断是否为空
        if (StringUtils.isBlank(staffDTO.getMobile()))
        {
            //空
            throw BizException.wrap("手机号为空");
        }
        //判断是否为空
        if (StringUtils.isBlank(staffDTO.getUsername()))
        {
            //空
            throw BizException.wrap("用户名为空");
        }
        //根据手机号和商户id判断员工是否已在指定商户存在
        if (isExistStaffByMobile(staffDTO.getMobile(), staffDTO.getMerchantId()))
        {
            //已经存在
            throw BizException.wrap("手机号已经存在");
        }
        //根据账号判断员工是否已在指定商户存在
        if (isExistStaffByUserName(staffDTO.getUsername(), staffDTO.getMerchantId()))
        {
            //存在
            throw BizException.wrap("用户名已经存在");
        }
        //转换
        Staff staff = dozerUtils.map(staffDTO, Staff.class);
        //去掉id
        staff.setId(null);
        //保存
        staffService.save(staff);
        //设置id
        staffDTO.setId(staff.getId());
        //返回
        return staffDTO;
    }

    /**
     * 根据手机号和商户id判断员工是否已在指定商户存在
     *
     * @param mobile     手机号
     * @param merchantId 商人id
     * @return boolean
     */
    private boolean isExistStaffByMobile(String mobile, Long merchantId)
    {
        int count = staffService.count(Wraps.<Staff>lbQ()
                .eq(Staff::getMobile, mobile)
                .eq(Staff::getMerchantId, merchantId));
        return count > 0;
    }

    /**
     * 根据账号判断员工是否已在指定商户存在
     *
     * @param userName   用户名
     * @param merchantId 商人id
     * @return boolean
     */
    private boolean isExistStaffByUserName(String userName, Long merchantId)
    {
        int count = staffService.count(Wraps.<Staff>lbQ()
                .eq(Staff::getUsername, userName)
                .eq(Staff::getMerchantId, merchantId));
        return count > 0;
    }


    @Override
    public void bindStaffToStore(Long storeId, Long staffId)
    {
        //构建实体类对象
        StoreStaff storeStaff = new StoreStaff();
        storeStaff.setStaffId(staffId);
        storeStaff.setStoreId(storeId);
        //保存
        boolean save = storeStaffService.save(storeStaff);
        if (!save)
        {
            throw BizException.wrap("为门店设置管理员失败");
        }
    }
}
```







#### 测试

![image-20230123145053213](img/聚合支付项目实战学习笔记/image-20230123145053213.png)





![image-20230123145316074](img/聚合支付项目实战学习笔记/image-20230123145316074.png)





![image-20230123145346336](img/聚合支付项目实战学习笔记/image-20230123145346336.png)





![image-20230123145447385](img/聚合支付项目实战学习笔记/image-20230123145447385.png)





**查看日志**

商户服务

```sh
2023-01-23 14:53:52.350 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.MerchantMapper.selectCount    : ==>  Preparing: SELECT COUNT( 1 ) FROM merchant WHERE (TENANT_ID = ?) 
2023-01-23 14:53:52.352 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.MerchantMapper.selectCount    : ==> Parameters: 2(Long)
2023-01-23 14:53:52.353 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.MerchantMapper.selectCount    : <==      Total: 1
 Consume Time：0 ms 2023-01-23 14:53:52
 Execute SQL：SELECT COUNT( 1 ) FROM merchant WHERE (TENANT_ID = 2)

2023-01-23 14:53:52.579 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.MerchantMapper.insert         : ==>  Preparing: INSERT INTO merchant ( ID, MOBILE, TENANT_ID, AUDIT_STATUS, USERNAME ) VALUES ( ?, ?, ?, ?, ? ) 
2023-01-23 14:53:52.590 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.MerchantMapper.insert         : ==> Parameters: 129219676143091745(Long), 15672876655(String), 2(Long), 0(String), hello(String)
2023-01-23 14:53:52.592 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.MerchantMapper.insert         : <==    Updates: 1
2023-01-23 14:53:52.607 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.StoreMapper.insert            : ==>  Preparing: INSERT INTO store ( ID, MERCHANT_ID, STORE_NAME ) VALUES ( ?, ?, ? ) 
 Consume Time：1 ms 2023-01-23 14:53:52
 Execute SQL：INSERT INTO merchant ( ID, MOBILE, TENANT_ID, AUDIT_STATUS, USERNAME ) VALUES ( 129219676143091745, '15672876655', 2, '0', 'hello' )

2023-01-23 14:53:52.608 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.StoreMapper.insert            : ==> Parameters: 129219676264726593(Long), 129219676143091745(Long), 根门店(String)
2023-01-23 14:53:52.618 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.StoreMapper.insert            : <==    Updates: 1
2023-01-23 14:53:52.623 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.StaffMapper.selectCount       : ==>  Preparing: SELECT COUNT( 1 ) FROM staff WHERE (MOBILE = ? AND MERCHANT_ID = ?) 
 Consume Time：8 ms 2023-01-23 14:53:52
 Execute SQL：INSERT INTO store ( ID, MERCHANT_ID, STORE_NAME ) VALUES ( 129219676264726593, 129219676143091745, '根门店' )

2023-01-23 14:53:52.624 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.StaffMapper.selectCount       : ==> Parameters: 15672876655(String), 129219676143091745(Long)
2023-01-23 14:53:52.631 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.StaffMapper.selectCount       : <==      Total: 1
2023-01-23 14:53:52.634 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.StaffMapper.selectCount       : ==>  Preparing: SELECT COUNT( 1 ) FROM staff WHERE (USERNAME = ? AND MERCHANT_ID = ?) 
 Consume Time：6 ms 2023-01-23 14:53:52
 Execute SQL：SELECT COUNT( 1 ) FROM staff WHERE (MOBILE = '15672876655' AND MERCHANT_ID = 129219676143091745)

 Consume Time：0 ms 2023-01-23 14:53:52
 Execute SQL：SELECT COUNT( 1 ) FROM staff WHERE (USERNAME = 'hello' AND MERCHANT_ID = 129219676143091745)

2023-01-23 14:53:52.635 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.StaffMapper.selectCount       : ==> Parameters: hello(String), 129219676143091745(Long)
2023-01-23 14:53:52.636 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.StaffMapper.selectCount       : <==      Total: 1
2023-01-23 14:53:52.645 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.StaffMapper.insert            : ==>  Preparing: INSERT INTO staff ( ID, MERCHANT_ID, MOBILE, STORE_ID, USERNAME ) VALUES ( ?, ?, ?, ?, ? ) 
2023-01-23 14:53:52.646 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.StaffMapper.insert            : ==> Parameters: 129219676419915873(Long), 129219676143091745(Long), 15672876655(String), 129219676264726593(Long), hello(String)
2023-01-23 14:53:52.647 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.StaffMapper.insert            : <==    Updates: 1
2023-01-23 14:53:52.650 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.StoreStaffMapper.insert       : ==>  Preparing: INSERT INTO store_staff ( ID, STORE_ID, STAFF_ID ) VALUES ( ?, ?, ? ) 
2023-01-23 14:53:52.651 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.StoreStaffMapper.insert       : ==> Parameters: 129219676445081729(Long), 129219676264726593(Long), 129219676419915873(Long)
2023-01-23 14:53:52.658 DEBUG 10016 --- [io-56040-exec-6] m.a.mapper.StoreStaffMapper.insert       : <==    Updates: 1
 Consume Time：0 ms 2023-01-23 14:53:52
 Execute SQL：INSERT INTO staff ( ID, MERCHANT_ID, MOBILE, STORE_ID, USERNAME ) VALUES ( 129219676419915873, 129219676143091745, '15672876655', 129219676264726593, 'hello' )

 Consume Time：6 ms 2023-01-23 14:53:52
 Execute SQL：INSERT INTO store_staff ( ID, STORE_ID, STAFF_ID ) VALUES ( 129219676445081729, 129219676264726593, 129219676419915873 )

2023-01-23 14:53:52.724  INFO 10016 --- [erListUpdater-0] c.netflix.config.ChainedDynamicProperty  : Flipping property: aggregate-pay-user-service.ribbon.ActiveConnectionsLimit to use NEXT property: niws.loadbalancer.availabilityFilteringRule.activeConnectionsLimit = 2147483647

```





日志服务：

```sh
2023-01-23 14:53:53.521 DEBUG 4076 --- [io-27914-exec-6] m.a.mapper.OptLogMapper.insert           : ==>  Preparing: INSERT INTO opt_log ( id, finish_time, action_method, description, request_ip, request_uri, ua, params, http_method, user_name, type, result, consuming_time, class_path, start_time ) VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? ) 
2023-01-23 14:53:53.669 DEBUG 4076 --- [io-27914-exec-6] m.a.mapper.OptLogMapper.insert           : ==> Parameters: 129219677833396257(Long), 2023-01-23T14:53:52.720(LocalDateTime), registerMerchant(String), 商户平台应用接口-商户注册(String), 172.17.160.1(String), /merchant/merchants/register(String), Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36 Edg/109.0.1518.61(String), [{"mobile":"15672876655","password":"123456","username":"hello","verifiyCode":"593180","verifiykey":"sms:6620148308464705a19d23db2bd3248a"}](String), POST(String), 123456(Long), OPT(String), {"code":0,"isError":false,"isSuccess":true,"msg":"ok","timestamp":1674456832708}(String), 1758(Long), mao.aggregate_pay_merchant_application.controller.MerchantController(String), 2023-01-23T14:53:50.962(LocalDateTime)
 Consume Time：13 ms 2023-01-23 14:53:53
 Execute SQL：INSERT INTO opt_log ( id, finish_time, action_method, description, request_ip, request_uri, ua, params, http_method, user_name, type, result, consuming_time, class_path, start_time ) VALUES ( 129219677833396257, '2023-01-23T14:53:52.720', 'registerMerchant', '商户平台应用接口-商户注册', '172.17.160.1', '/merchant/merchants/register', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36 Edg/109.0.1518.61', '[{"mobile":"15672876655","password":"123456","username":"hello","verifiyCode":"593180","verifiykey":"sms:6620148308464705a19d23db2bd3248a"}]', 'POST', 123456, 'OPT', '{"code":0,"isError":false,"isSuccess":true,"msg":"ok","timestamp":1674456832708}', 1758, 'mao.aggregate_pay_merchant_application.controller.MerchantController', '2023-01-23T14:53:50.962' )

2023-01-23 14:53:53.683 DEBUG 4076 --- [io-27914-exec-6] m.a.mapper.OptLogMapper.insert           : <==    Updates: 1
```





用户服务：

```sh
2023-01-23 14:53:51.886  INFO 1544 --- [io-28692-exec-7] m.a.service.impl.TenantServiceImpl       : 判断手机号在账号中是否存在
2023-01-23 14:53:51.910 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectAccountByMobile            : ==>  Preparing: select count(*) from account where MOBILE=? 
2023-01-23 14:53:51.992 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectAccountByMobile            : ==> Parameters: 15672876655(String)
2023-01-23 14:53:52.005 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectAccountByMobile            : <==      Total: 1
 Consume Time：4 ms 2023-01-23 14:53:51
 Execute SQL：select count(*) from account where MOBILE='15672876655'

2023-01-23 14:53:52.022 DEBUG 1544 --- [io-28692-exec-7] m.a.mapper.TenantMapper.insert           : ==>  Preparing: INSERT INTO tenant ( BUNDLE_CODE, TENANT_TYPE_CODE, NAME ) VALUES ( ?, ?, ? ) 
2023-01-23 14:53:52.032 DEBUG 1544 --- [io-28692-exec-7] m.a.mapper.TenantMapper.insert           : ==> Parameters: aggregate-pay-merchant(String), aggregate-pay-merchant(String), hello_Vp3c2O(String)
2023-01-23 14:53:52.034 DEBUG 1544 --- [io-28692-exec-7] m.a.mapper.TenantMapper.insert           : <==    Updates: 1
 Consume Time：2 ms 2023-01-23 14:53:52
 Execute SQL：INSERT INTO tenant ( BUNDLE_CODE, TENANT_TYPE_CODE, NAME ) VALUES ( 'aggregate-pay-merchant', 'aggregate-pay-merchant', 'hello_Vp3c2O' )

2023-01-23 14:53:52.122  INFO 1544 --- [io-28692-exec-7] m.a.service.impl.TenantServiceImpl       : 创建账号：{"mobile":"15672876655","password":"123456","username":"hello"}
2023-01-23 14:53:52.122  INFO 1544 --- [io-28692-exec-7] m.a.service.impl.TenantServiceImpl       : 判断手机号在账号中是否存在
2023-01-23 14:53:52.123 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectAccountByMobile            : ==>  Preparing: select count(*) from account where MOBILE=? 
2023-01-23 14:53:52.123 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectAccountByMobile            : ==> Parameters: 15672876655(String)
2023-01-23 14:53:52.124 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectAccountByMobile            : <==      Total: 1
2023-01-23 14:53:52.125 DEBUG 1544 --- [io-28692-exec-7] m.a.m.AccountMapper.selectAccountByName  : ==>  Preparing: select count(*) from account where USERNAME=? 
2023-01-23 14:53:52.126 DEBUG 1544 --- [io-28692-exec-7] m.a.m.AccountMapper.selectAccountByName  : ==> Parameters: hello(String)
2023-01-23 14:53:52.127 DEBUG 1544 --- [io-28692-exec-7] m.a.m.AccountMapper.selectAccountByName  : <==      Total: 1
2023-01-23 14:53:52.129 DEBUG 1544 --- [io-28692-exec-7] m.a.mapper.AccountMapper.insert          : ==>  Preparing: INSERT INTO account ( PASSWORD, SALT, MOBILE, USERNAME ) VALUES ( ?, ?, ?, ? ) 
2023-01-23 14:53:52.130 DEBUG 1544 --- [io-28692-exec-7] m.a.mapper.AccountMapper.insert          : ==> Parameters: f8e1d381711059d6f513073b80cdc531(String), jR26R(String), 15672876655(String), hello(String)
2023-01-23 14:53:52.131 DEBUG 1544 --- [io-28692-exec-7] m.a.mapper.AccountMapper.insert          : <==    Updates: 1
 Consume Time：0 ms 2023-01-23 14:53:52
 Execute SQL：select count(*) from account where MOBILE='15672876655'

 Consume Time：0 ms 2023-01-23 14:53:52
 Execute SQL：select count(*) from account where USERNAME='hello'

 Consume Time：1 ms 2023-01-23 14:53:52
 Execute SQL：INSERT INTO account ( PASSWORD, SALT, MOBILE, USERNAME ) VALUES ( 'f8e1d381711059d6f513073b80cdc531', 'jR26R', '15672876655', 'hello' )

2023-01-23 14:53:52.194  INFO 1544 --- [io-28692-exec-7] m.a.service.impl.TenantServiceImpl       : 将创建的账号绑定至某租户
2023-01-23 14:53:52.194  INFO 1544 --- [io-28692-exec-7] m.a.service.impl.TenantServiceImpl       : 绑定账号和租户的关系
2023-01-23 14:53:52.195 DEBUG 1544 --- [io-28692-exec-7] m.a.m.TenantMapper.insertTenantAccount   : ==>  Preparing: insert into tenant_account(TENANT_ID,ACCOUNT_ID,IS_ADMIN) values(?,?,?) 
2023-01-23 14:53:52.197 DEBUG 1544 --- [io-28692-exec-7] m.a.m.TenantMapper.insertTenantAccount   : ==> Parameters: 2(Long), 1(Long), true(Boolean)
2023-01-23 14:53:52.198 DEBUG 1544 --- [io-28692-exec-7] m.a.m.TenantMapper.insertTenantAccount   : <==    Updates: 1
2023-01-23 14:53:52.198  INFO 1544 --- [io-28692-exec-7] m.a.service.impl.TenantServiceImpl       : 初始化套餐
 Consume Time：1 ms 2023-01-23 14:53:52
 Execute SQL：insert into tenant_account(TENANT_ID,ACCOUNT_ID,IS_ADMIN) values(2,1,true)

2023-01-23 14:53:52.220 DEBUG 1544 --- [io-28692-exec-7] m.a.mapper.BundleMapper.selectOne        : ==>  Preparing: SELECT ID,TENANT_TYPE_CODE,NUMBER_OF_APP,CODE,NAME,COMMENT,NUMBER_OF_INVOCATION,INITIALIZE,ABILITY,NUMBER_OF_CONCURRENT FROM bundle WHERE (CODE = ?) 
2023-01-23 14:53:52.221 DEBUG 1544 --- [io-28692-exec-7] m.a.mapper.BundleMapper.selectOne        : ==> Parameters: aggregate-pay-merchant(String)
2023-01-23 14:53:52.225 DEBUG 1544 --- [io-28692-exec-7] m.a.mapper.BundleMapper.selectOne        : <==      Total: 1
 Consume Time：2 ms 2023-01-23 14:53:52
 Execute SQL：SELECT ID,TENANT_TYPE_CODE,NUMBER_OF_APP,CODE,NAME,COMMENT,NUMBER_OF_INVOCATION,INITIALIZE,ABILITY,NUMBER_OF_CONCURRENT FROM bundle WHERE (CODE = 'aggregate-pay-merchant')

2023-01-23 14:53:52.240 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.createRoles                      : ==>  Preparing: INSERT INTO authorization_role(NAME,CODE,TENANT_ID) VALUES (?,?,?) , (?,?,?) 
2023-01-23 14:53:52.241 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.createRoles                      : ==> Parameters: 商户管理员(String), r_001(String), 2(Long), 商户门店收银员(String), r_002(String), 2(Long)
2023-01-23 14:53:52.243 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.createRoles                      : <==    Updates: 2
2023-01-23 14:53:52.247 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectAccountInfoByTenantId      : ==>  Preparing: select a.* from account a join tenant_account ta on ta.ACCOUNT_ID=a.ID join tenant t on t.ID=ta.TENANT_ID where t.id =? AND ta.`IS_ADMIN`= 1 
2023-01-23 14:53:52.252 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectAccountInfoByTenantId      : ==> Parameters: 2(Long)
 Consume Time：1 ms 2023-01-23 14:53:52
 Execute SQL：INSERT INTO authorization_role(NAME,CODE,TENANT_ID) VALUES ('商户管理员','r_001',2) , ('商户门店收银员','r_002',2)

 Consume Time：0 ms 2023-01-23 14:53:52
 Execute SQL：select a.* from account a join tenant_account ta on ta.ACCOUNT_ID=a.ID join tenant t on t.ID=ta.TENANT_ID where t.id =2 AND ta.`IS_ADMIN`= 1

 Consume Time：1 ms 2023-01-23 14:53:52
 Execute SQL：INSERT INTO account_role(USERNAME,ROLE_CODE,TENANT_ID) VALUES ('hello','r_001',2) , ('hello','r_002',2)

 Consume Time：0 ms 2023-01-23 14:53:52
 Execute SQL：SELECT ID,CODE,TENANT_ID,NAME FROM authorization_role WHERE (TENANT_ID = 2 AND CODE = 'r_001')

2023-01-23 14:53:52.253 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectAccountInfoByTenantId      : <==      Total: 1
2023-01-23 14:53:52.254 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.insertAccountRole                : ==>  Preparing: INSERT INTO account_role(USERNAME,ROLE_CODE,TENANT_ID) VALUES (?,?,?) , (?,?,?) 
2023-01-23 14:53:52.255 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.insertAccountRole                : ==> Parameters: hello(String), r_001(String), 2(Long), hello(String), r_002(String), 2(Long)
2023-01-23 14:53:52.257 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.insertAccountRole                : <==    Updates: 2
2023-01-23 14:53:52.261 DEBUG 1544 --- [io-28692-exec-7] m.a.m.AuthorizationRoleMapper.selectOne  : ==>  Preparing: SELECT ID,CODE,TENANT_ID,NAME FROM authorization_role WHERE (TENANT_ID = ? AND CODE = ?) 
2023-01-23 14:53:52.262 DEBUG 1544 --- [io-28692-exec-7] m.a.m.AuthorizationRoleMapper.selectOne  : ==> Parameters: 2(Long), r_001(String)
2023-01-23 14:53:52.263 DEBUG 1544 --- [io-28692-exec-7] m.a.m.AuthorizationRoleMapper.selectOne  : <==      Total: 1
2023-01-23 14:53:52.265 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectPrivilegeByRole            : ==>  Preparing: select p.`CODE` from authorization_privilege p LEFT JOIN authorization_role_privilege rp on rp.PRIVILEGE_ID = p.ID LEFT JOIN authorization_role r on rp.ROLE_ID = r.ID where r.ID=? 
2023-01-23 14:53:52.266 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectPrivilegeByRole            : ==> Parameters: 51(Long)
2023-01-23 14:53:52.268 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectPrivilegeByRole            : <==      Total: 0
2023-01-23 14:53:52.273 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectList                       : ==>  Preparing: SELECT ID,PRIVILEGE_GROUP_ID,CODE,NAME FROM authorization_privilege WHERE (CODE IN (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)) 
2023-01-23 14:53:52.275 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectList                       : ==> Parameters: sj_m_console(String), sj_m_app_list(String), sj_m_transaction_list(String), sj_m_account_check(String), sj_m_payment(String), sj_m_account_list(String), sj_m_enterprise_auth(String), sj_m_store_list(String), sj_m_staff_list(String), sj_o_member_list(String), sj_o_entreprise_list(String), sj_o_audit(String), sj_o_service_type(String), sj_o_account_check(String), sj_o_admin_list(String), sj_o_role_list(String), sj_m_app_create(String), sj_m_payment_set(String), sj_m_store_create(String), sj_m_store_query(String), sj_m_staff_create(String), sj_m_staff_query(String), sj_o_member_query(String), sj_o_enterprise_query(String), sj_o_enterprise_create(String), sj_o_service_create(String), sj_o_service_query(String), sj_o_admin_create(String), sj_o_admin_query(String), sj_o_role_create(String), sj_o_role_query(String), sj_o_role_save(String), sj_m_auth_apply(String), sj_m_console_renew(String), sj_m_console_upgrade(String), sj_m_app_save(String), sj_m_app_modify(String), sj_m_payparam_save(String), sj_m_pay_set(String), sj_m_pay_save(String), sj_m_c2b_qrcode(String), sj_m_b2c_order(String), sj_m_h5_view(String), sj_m_bundle_buy(String), sj_m_enterprise_info_submit(String), sj_m_enterprise_info_cancel(String), sj_o_enterprise_auth_pass(String), sj_o_enterprise_auth_rejection(String), sj_m_store_edit(String), sj_m_staff_edit(String), sj_o_admin_edit(String), sj_o_role_edit(String), sj_m_store_save(String), sj_m_store_del(String), sj_m_staff_save(String)
 Consume Time：1 ms 2023-01-23 14:53:52
 Execute SQL：select p.`CODE` from authorization_privilege p LEFT JOIN authorization_role_privilege rp on rp.PRIVILEGE_ID = p.ID LEFT JOIN authorization_role r on rp.ROLE_ID = r.ID where r.ID=51

 Consume Time：1 ms 2023-01-23 14:53:52
 Execute SQL：SELECT ID,PRIVILEGE_GROUP_ID,CODE,NAME FROM authorization_privilege WHERE (CODE IN ('sj_m_console','sj_m_app_list','sj_m_transaction_list','sj_m_account_check','sj_m_payment','sj_m_account_list','sj_m_enterprise_auth','sj_m_store_list','sj_m_staff_list','sj_o_member_list','sj_o_entreprise_list','sj_o_audit','sj_o_service_type','sj_o_account_check','sj_o_admin_list','sj_o_role_list','sj_m_app_create','sj_m_payment_set','sj_m_store_create','sj_m_store_query','sj_m_staff_create','sj_m_staff_query','sj_o_member_query','sj_o_enterprise_query','sj_o_enterprise_create','sj_o_service_create','sj_o_service_query','sj_o_admin_create','sj_o_admin_query','sj_o_role_create','sj_o_role_query','sj_o_role_save','sj_m_auth_apply','sj_m_console_renew','sj_m_console_upgrade','sj_m_app_save','sj_m_app_modify','sj_m_payparam_save','sj_m_pay_set','sj_m_pay_save','sj_m_c2b_qrcode','sj_m_b2c_order','sj_m_h5_view','sj_m_bundle_buy','sj_m_enterprise_info_submit','sj_m_enterprise_info_cancel','sj_o_enterprise_auth_pass','sj_o_enterprise_auth_rejection','sj_m_store_edit','sj_m_staff_edit','sj_o_admin_edit','sj_o_role_edit','sj_m_store_save','sj_m_store_del','sj_m_staff_save'))

 Consume Time：0 ms 2023-01-23 14:53:52
 Execute SQL：DELETE FROM authorization_role_privilege WHERE (ROLE_ID = 51)

2023-01-23 14:53:52.284 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectList                       : <==      Total: 55
2023-01-23 14:53:52.287 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.delete                           : ==>  Preparing: DELETE FROM authorization_role_privilege WHERE (ROLE_ID = ?) 
2023-01-23 14:53:52.289 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.delete                           : ==> Parameters: 51(Long)
2023-01-23 14:53:52.290 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.delete                           : <==    Updates: 0
2023-01-23 14:53:52.293 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.insertRolePrivilege              : ==>  Preparing: INSERT INTO authorization_role_privilege(ROLE_ID,PRIVILEGE_ID) VALUES (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) , (?,?) 
2023-01-23 14:53:52.297 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.insertRolePrivilege              : ==> Parameters: 51(Long), 1(Long), 51(Long), 2(Long), 51(Long), 3(Long), 51(Long), 4(Long), 51(Long), 5(Long), 51(Long), 6(Long), 51(Long), 7(Long), 51(Long), 8(Long), 51(Long), 9(Long), 51(Long), 10(Long), 51(Long), 11(Long), 51(Long), 12(Long), 51(Long), 13(Long), 51(Long), 14(Long), 51(Long), 15(Long), 51(Long), 16(Long), 51(Long), 17(Long), 51(Long), 18(Long), 51(Long), 19(Long), 51(Long), 20(Long), 51(Long), 21(Long), 51(Long), 22(Long), 51(Long), 23(Long), 51(Long), 24(Long), 51(Long), 25(Long), 51(Long), 26(Long), 51(Long), 27(Long), 51(Long), 28(Long), 51(Long), 29(Long), 51(Long), 30(Long), 51(Long), 59(Long), 51(Long), 60(Long), 51(Long), 61(Long), 51(Long), 62(Long), 51(Long), 63(Long), 51(Long), 64(Long), 51(Long), 65(Long), 51(Long), 66(Long), 51(Long), 67(Long), 51(Long), 68(Long), 51(Long), 69(Long), 51(Long), 70(Long), 51(Long), 71(Long), 51(Long), 72(Long), 51(Long), 73(Long), 51(Long), 74(Long), 51(Long), 76(Long), 51(Long), 77(Long), 51(Long), 81(Long), 51(Long), 82(Long), 51(Long), 83(Long), 51(Long), 84(Long), 51(Long), 85(Long), 51(Long), 86(Long), 51(Long), 87(Long)
2023-01-23 14:53:52.300 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.insertRolePrivilege              : <==    Updates: 55
2023-01-23 14:53:52.302 DEBUG 1544 --- [io-28692-exec-7] m.a.m.AuthorizationRoleMapper.selectOne  : ==>  Preparing: SELECT ID,CODE,TENANT_ID,NAME FROM authorization_role WHERE (TENANT_ID = ? AND CODE = ?) 
2023-01-23 14:53:52.303 DEBUG 1544 --- [io-28692-exec-7] m.a.m.AuthorizationRoleMapper.selectOne  : ==> Parameters: 2(Long), r_002(String)
2023-01-23 14:53:52.304 DEBUG 1544 --- [io-28692-exec-7] m.a.m.AuthorizationRoleMapper.selectOne  : <==      Total: 1
2023-01-23 14:53:52.305 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectPrivilegeByRole            : ==>  Preparing: select p.`CODE` from authorization_privilege p LEFT JOIN authorization_role_privilege rp on rp.PRIVILEGE_ID = p.ID LEFT JOIN authorization_role r on rp.ROLE_ID = r.ID where r.ID=? 
2023-01-23 14:53:52.305 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectPrivilegeByRole            : ==> Parameters: 52(Long)
2023-01-23 14:53:52.306 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectPrivilegeByRole            : <==      Total: 0
2023-01-23 14:53:52.308 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectList                       : ==>  Preparing: SELECT ID,PRIVILEGE_GROUP_ID,CODE,NAME FROM authorization_privilege WHERE (CODE IN (?,?)) 
2023-01-23 14:53:52.308 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectList                       : ==> Parameters: sj_m_account_check(String), sj_m_transaction_list(String)
 Consume Time：2 ms 2023-01-23 14:53:52
 Execute SQL：INSERT INTO authorization_role_privilege(ROLE_ID,PRIVILEGE_ID) VALUES (51,1) , (51,2) , (51,3) , (51,4) , (51,5) , (51,6) , (51,7) , (51,8) , (51,9) , (51,10) , (51,11) , (51,12) , (51,13) , (51,14) , (51,15) , (51,16) , (51,17) , (51,18) , (51,19) , (51,20) , (51,21) , (51,22) , (51,23) , (51,24) , (51,25) , (51,26) , (51,27) , (51,28) , (51,29) , (51,30) , (51,59) , (51,60) , (51,61) , (51,62) , (51,63) , (51,64) , (51,65) , (51,66) , (51,67) , (51,68) , (51,69) , (51,70) , (51,71) , (51,72) , (51,73) , (51,74) , (51,76) , (51,77) , (51,81) , (51,82) , (51,83) , (51,84) , (51,85) , (51,86) , (51,87)

 Consume Time：0 ms 2023-01-23 14:53:52
 Execute SQL：SELECT ID,CODE,TENANT_ID,NAME FROM authorization_role WHERE (TENANT_ID = 2 AND CODE = 'r_002')

 Consume Time：0 ms 2023-01-23 14:53:52
 Execute SQL：select p.`CODE` from authorization_privilege p LEFT JOIN authorization_role_privilege rp on rp.PRIVILEGE_ID = p.ID LEFT JOIN authorization_role r on rp.ROLE_ID = r.ID where r.ID=52

 Consume Time：0 ms 2023-01-23 14:53:52
 Execute SQL：SELECT ID,PRIVILEGE_GROUP_ID,CODE,NAME FROM authorization_privilege WHERE (CODE IN ('sj_m_account_check','sj_m_transaction_list'))

 Consume Time：0 ms 2023-01-23 14:53:52
 Execute SQL：DELETE FROM authorization_role_privilege WHERE (ROLE_ID = 52)

 Consume Time：0 ms 2023-01-23 14:53:52
 Execute SQL：INSERT INTO authorization_role_privilege(ROLE_ID,PRIVILEGE_ID) VALUES (52,4) , (52,3)

2023-01-23 14:53:52.309 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.selectList                       : <==      Total: 2
2023-01-23 14:53:52.311 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.delete                           : ==>  Preparing: DELETE FROM authorization_role_privilege WHERE (ROLE_ID = ?) 
2023-01-23 14:53:52.311 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.delete                           : ==> Parameters: 52(Long)
2023-01-23 14:53:52.312 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.delete                           : <==    Updates: 0
2023-01-23 14:53:52.312 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.insertRolePrivilege              : ==>  Preparing: INSERT INTO authorization_role_privilege(ROLE_ID,PRIVILEGE_ID) VALUES (?,?) , (?,?) 
2023-01-23 14:53:52.313 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.insertRolePrivilege              : ==> Parameters: 52(Long), 4(Long), 52(Long), 3(Long)
2023-01-23 14:53:52.314 DEBUG 1544 --- [io-28692-exec-7] m.a.m.A.insertRolePrivilege              : <==    Updates: 2

```







**查看数据库**

![image-20230123145843946](img/聚合支付项目实战学习笔记/image-20230123145843946.png)





![image-20230123145905207](img/聚合支付项目实战学习笔记/image-20230123145905207.png)





![image-20230123145914993](img/聚合支付项目实战学习笔记/image-20230123145914993.png)





![image-20230123145949976](img/聚合支付项目实战学习笔记/image-20230123145949976.png)



























# 用户认证

## 基本概念

### 什么是认证

拿微信来举例子说明认证相关的基本概念，在初次使用微信前需要注册成为微信用户，然后输入账号和密码即可登录微信，输入账号和密码登录微信的过程就是认证

系统为什么要认证？

认证是为了保护系统的隐私数据与资源，用户的身份合法方可访问该系统的资源

认证 ：用户认证就是判断一个用户的身份是否合法的过程，用户去访问系统资源时系统要求验证用户的身份信 息，身份合法方可继续访问，不合法则拒绝访问。常见的用户身份认证方式有：用户名密码登录，二维码登录，手 机短信登录，指纹认证等方式





### 什么是会话

用户认证通过后，为了避免用户的每次操作都进行认证可将用户的信息保证在会话中。会话就是系统为了保持当前 用户的登录状态所提供的机制，常见的有基于session方式、基于token方式等



#### 基于session的认证方式

它的交互流程是，用户认证成功后，在服务端生成用户相关的数据保存在session(当前会话)中，发给客户端的 sesssion_id 存放到 cookie 中，这样用户客户端请求时带上 session_id 就可以验证服务器端是否存在 session 数据，以此完成用户的合法校验，当用户退出系统或session过期销毁时,客户端的session_id也就无效了



#### 基于token的认证方式

它的交互流程是，用户认证成功后，服务端生成一个token发给客户端，客户端存储token，每次请求时带上token，服务端收到token通过验证后即可确认用户身份

基于session的认证方式由Servlet规范定制，服务端要存储session信息需要占用内存资源，客户端需要支持 cookie；基于token的方式则一般不需要服务端存储token，并且不限制客户端的存储方式。如今移动互联网时代 更多类型的客户端需要接入系统，系统多是采用前后端分离的架构进行实现，所以基于token的方式更适合







### 什么是授权

微信登录成功后用户即可使用微信的功能，比如，发红包、发朋友圈、添加好友等，没有绑定 银行卡的用户是无法发送红包的，绑定银行卡的用户才可以发红包，发红包功能、发朋友圈功能都是微信的资源即功能资源，用户拥有发红包功能的权限才可以正常使用发送红包功能，拥有发朋友圈功能的权限才可以使用发朋友圈功能，这个根据用户的权限来控制用户使用资源的过程就是授权



为什么要授权？

认证是为了保证用户身份的合法性，授权则是为了更细粒度的对隐私数据进行划分，授权是在认证通过后发生的， 控制不同的用户能够访问不同的资源。

授权： 授权是用户认证通过根据用户的权限来控制用户访问资源的过程，拥有资源的访问权限则正常访问，没有权限则拒绝访问













## 分布式系统认证方案

### 分布式认证需求

#### 统一认证授权

分布式系统的每个服务（系统）都会有认证、授权的需求，如果每个服务都实现一套认证授权逻辑会非常冗余，考 虑分布式系统共享性的特点，需要由独立的认证服务来处理系统认证授权的请求



流程：

1. 前端请求UAA认证服务请求认证，认证通过获取 Token
2. 前端携带Token访问各各应用





#### 开放认证体系

考虑分布式系统开放性的特点，UAA认证服务不仅服务于平台自身，并且对第三方系统也要提供认证，平台应提供 扩展和开放的认证机制，以开放API的方式供第三方应用接入，一方应用（内部 系统服务）和三方应用（第三方应 用）均采用统一机制接入

![image-20230123151659457](img/聚合支付项目实战学习笔记/image-20230123151659457.png)





流程：

1. 第三方应用请求UAA认证服务请求认证，认证通过获取Token
2. 第三方应用携带Token访问API代理（专门针对第三方应用接入开发的微服务）
3. API代理访问平台微服务向第三方应用返回业务数据







### 分布式认证方案

#### 选型分析

**基于session的认证方式**

在分布式的环境下，基于session的认证会出现一个问题，每个应用服务都需要在session中存储用户身份信息，通 过负载均衡将本地的请求分配到另一个应用服务需要将session信息带过去，否则会重新认证



![image-20230123151843452](img/聚合支付项目实战学习笔记/image-20230123151843452.png)





这个时候，通常的做法有下面几种：

* Session复制：多台应用服务器之间同步session，使session保持一致，对外透明
* Session黏贴：当用户访问集群中某台服务器后，强制指定后续所有请求均落到此机器上
* Session集中存储：将Session存入分布式缓存中，所有服务器应用实例统一从分布式缓存中存取Session





**基于token的认证方式**

基于token的认证方式，服务端不用存储认证数据，易维护扩展性强， 客户端可以把token存在任意地方，并且可以实现web和app统一认证机制。其缺点也很明显，token由于自包含信息，因此一般数据量较大，而且每次请求都需要传递，因此比较占带宽。另外，token的签名验签操作也会给cpu带来额外的处理负担







#### 技术方案

根据选型的分析，决定采用基于token的认证方式，它的优点是：

* 适合统一认证的机制，客户端、一方应用、三方应用都遵循一致的认证机制
* token认证方式对第三方应用接入更适合，因为它更开放，使用当前有流行的开放协议Oauth2.0、JWT
* 一般情况服务端无需存储会话信息，减轻了服务端的压力





分布式系统认证技术方案见下图：



![image-20230123152207282](img/聚合支付项目实战学习笔记/image-20230123152207282.png)





流程描述：

1. 接入方（需要使用平台资源的统称为接入方）采取OAuth2.0方式请求统一认证服务(UAA)进行认证
2. 认证服务(UAA)调用统一账号服务去查询该用户信息及其权限信息
3. 认证服务(UAA)验证登录用户及第三方应用合法性
4. 若接入方身份合法，认证服务生成jwt令牌返回给接入方，其中jwt中包含了权限信息
5. 接入方携带jwt令牌对API网关内的微服务资源进行访问
6. API网关对令牌解析、并验证接入方的权限是否能够访问本次请求的微服务
7. 如果接入方的权限没问题，API网关将Token转发至微服务
8. 微服务收到请求，明文token中包含登录用户的身份和权限信息，后续微服务使用用户身份及权限信息













## OAuth2.0

### 介绍

OAuth（开放授权）是一个开放标准，允许用户授权第三方应用访问他们存储在另外的服务提供者上的信息，而不 需要将用户名和密码提供给第三方应用或分享他们数据的所有内容。OAuth2.0是OAuth协议的延续版本，但不向 后兼容OAuth 1.0即完全废止了OAuth1.0。很多大公司如Google，Yahoo，Microsoft等都提供了OAUTH认证服 务，这些都足以说明OAUTH标准逐渐成为开放资源授权的标准





### 四种模式

#### 授权码模式

授权码模式流程如下 ：

![image-20230123152707320](img/聚合支付项目实战学习笔记/image-20230123152707320.png)





1. 资源拥有者打开客户端，客户端要求资源拥有者给予授权，它将浏览器被重定向到授权服务器，重定向时会附加客户端的身份信息

```sh
/uaa/oauth/authorize?client_id=p2pweb&response_type=code&scope=app&redirect_uri=http://xx.xx/notify
```



参数列表如下：

* client_id：客户端接入标识
* response_type：授权码模式固定为code
* scope：客户端权限
* redirect_uri：跳转uri，当授权码申请成功后会跳转到此地址，并在后边带上code参数





2. 浏览器出现向授权服务器授权页面，之后将用户同意授权
3. 授权服务器将授权码（AuthorizationCode）转经浏览器发送给client(通过redirect_uri)
4. 客户端拿着授权码向授权服务器索要访问access_token，请求如下：

```sh
/uaa/oauth/token?client_id=p2pweb&client_secret=gdjbcd&grant_type=authorization_code&code=5PgfcD&redirect_uri=http://xx.xx/notify
```



参数列表如下：

* client_id：客户端准入标识
* client_secret：客户端秘钥
* grant_type：授权类型，填写authorization_code，表示授权码模式
* code：授权码，就是刚刚获取的授权码，注意：授权码只使用一次就无效了，需要重新申请
* redirect_uri：申请授权码时的跳转url，一定和申请授权码时用的redirect_uri一致



5. 授权服务器返回令牌



**这种模式是四种模式中最安全的一种模式。一般用于Web服务器端应用或第三方的原生App调用资源服务的时候。 因为在这种模式中access_token不会经过浏览器或移动端的App，而是直接从服务端去交换，这样就最大限度的减 小了令牌泄漏的风险**







#### 密码模式

密码模式使用较多，适应于第一方的单页面应用以及第一方的原生App

密码模式认证流程如下：

![image-20230123153841407](img/聚合支付项目实战学习笔记/image-20230123153841407.png)

   

   

1. 资源拥有者将用户名、密码发送给客户端
2. 客户端拿着资源拥有者的用户名、密码向授权服务器请求令牌（access_token）
3. 授权服务器将令牌（access_token）发送给client



这种模式十分简单，但是却意味着直接将用户敏感信息泄漏给了client，因此这就说明这种模式只能用于client是 我们自己开发的情况下。因此密码模式一般用于我们自己开发的，第一方原生App或第一方单页面应用





#### 客户端模式

![image-20230123154227884](img/聚合支付项目实战学习笔记/image-20230123154227884.png)

认证流程如下：

1. 客户端向授权服务器发送自己的身份信息，并请求令牌（access_token）
2. 确认客户端身份无误后，将令牌（access_token）发送给client







#### 简化模式

![image-20230123154614874](img/聚合支付项目实战学习笔记/image-20230123154614874.png)



认证流程如下：

1. 资源拥有者打开客户端，客户端要求资源拥有者给予授权，它将浏览器被重定向到授权服务器，重定向时会附加客户端的身份信息
2. 浏览器出现向授权服务器授权页面，之后将用户同意授权
3. 授权服务器将授权码将令牌（access_token）以Hash的形式存放在重定向uri的fargment中发送给浏览器











## 统一认证测试

### 认证接口说明

#### 登录

功能说明： 用户登录并返回令牌

访问路径：[授权服务地址]/uaa/oauth/token

请求参数：

* grant_type： 授权类型，可以是authorization_code,implicit,client_credentials,password
* client_id：接入客户端id
* client_secret：接入客户端密钥
* username：登录用户名，认证类型(如密码认证，短信认证，二维码认证等)

{"username":"admin","authenticationType":"password"}

* password：登录密码







#### 解析令牌

功能说明：返回令牌的明文内容，描述的是当前登录的用户及接入客户端的信息

访问路径：[授权服务地址]/uaa/oauth/check_token

请求参数：

* token：令牌







### 接口测试

#### 密码模式认证

注意：参数要填在请求体里



![image-20230123194957674](img/聚合支付项目实战学习笔记/image-20230123194957674.png)





响应数据：

```json
{
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsiYWdncmVnYXRlLXBheS1yZXNvdXJjZSJdLCJwYXlsb2FkIjp7IjIiOnsicmVzb3VyY2VzIjpudWxsLCJ1c2VyX2F1dGhvcml0aWVzIjp7InJfMDAxIjpbInNqX21fY29uc29sZSIsInNqX21fYXBwX2xpc3QiLCJzal9tX3RyYW5zYWN0aW9uX2xpc3QiLCJzal9tX2FjY291bnRfY2hlY2siLCJzal9tX3BheW1lbnQiLCJzal9tX2FjY291bnRfbGlzdCIsInNqX21fZW50ZXJwcmlzZV9hdXRoIiwic2pfbV9zdG9yZV9saXN0Iiwic2pfbV9zdGFmZl9saXN0Iiwic2pfb19tZW1iZXJfbGlzdCIsInNqX29fZW50cmVwcmlzZV9saXN0Iiwic2pfb19hdWRpdCIsInNqX29fc2VydmljZV90eXBlIiwic2pfb19hY2NvdW50X2NoZWNrIiwic2pfb19hZG1pbl9saXN0Iiwic2pfb19yb2xlX2xpc3QiLCJzal9tX2FwcF9jcmVhdGUiLCJzal9tX3BheW1lbnRfc2V0Iiwic2pfbV9zdG9yZV9jcmVhdGUiLCJzal9tX3N0b3JlX3F1ZXJ5Iiwic2pfbV9zdGFmZl9jcmVhdGUiLCJzal9tX3N0YWZmX3F1ZXJ5Iiwic2pfb19tZW1iZXJfcXVlcnkiLCJzal9vX2VudGVycHJpc2VfcXVlcnkiLCJzal9vX2VudGVycHJpc2VfY3JlYXRlIiwic2pfb19zZXJ2aWNlX2NyZWF0ZSIsInNqX29fc2VydmljZV9xdWVyeSIsInNqX29fYWRtaW5fY3JlYXRlIiwic2pfb19hZG1pbl9xdWVyeSIsInNqX29fcm9sZV9jcmVhdGUiLCJzal9vX3JvbGVfcXVlcnkiLCJzal9vX3JvbGVfc2F2ZSIsInNqX21fYXV0aF9hcHBseSIsInNqX21fY29uc29sZV9yZW5ldyIsInNqX21fY29uc29sZV91cGdyYWRlIiwic2pfbV9hcHBfc2F2ZSIsInNqX21fYXBwX21vZGlmeSIsInNqX21fcGF5cGFyYW1fc2F2ZSIsInNqX21fcGF5X3NldCIsInNqX21fcGF5X3NhdmUiLCJzal9tX2MyYl9xcmNvZGUiLCJzal9tX2IyY19vcmRlciIsInNqX21faDVfdmlldyIsInNqX21fYnVuZGxlX2J1eSIsInNqX21fZW50ZXJwcmlzZV9pbmZvX3N1Ym1pdCIsInNqX21fZW50ZXJwcmlzZV9pbmZvX2NhbmNlbCIsInNqX29fZW50ZXJwcmlzZV9hdXRoX3Bhc3MiLCJzal9vX2VudGVycHJpc2VfYXV0aF9yZWplY3Rpb24iLCJzal9tX3N0b3JlX2VkaXQiLCJzal9tX3N0YWZmX2VkaXQiLCJzal9vX2FkbWluX2VkaXQiLCJzal9vX3JvbGVfZWRpdCIsInNqX21fc3RvcmVfc2F2ZSIsInNqX21fc3RvcmVfZGVsIiwic2pfbV9zdGFmZl9zYXZlIl0sInJfMDAyIjpbInNqX21fdHJhbnNhY3Rpb25fbGlzdCIsInNqX21fYWNjb3VudF9jaGVjayJdfX19LCJ1c2VyX25hbWUiOiJoZWxsbyIsInNjb3BlIjpbInJlYWQiXSwibW9iaWxlIjoiMTU2NzI4NzY2NTUiLCJleHAiOjE3MDYwMTA1NTgsImNsaWVudF9hdXRob3JpdGllcyI6WyJST0xFX01FUkNIQU5UIiwiUk9MRV9VU0VSIl0sImp0aSI6IjQ5NTRhZjQ5LTdjYjUtNDhjMi1hMTQwLWE2Y2JmNDc1MTE2YyIsImNsaWVudF9pZCI6Im1lcmNoYW50LXBsYXRmb3JtIn0.tO-DtYgrKGKp8t-mGHX5uSDhsGHdx_ClZtx0cpMmXXI",
    "token_type": "bearer",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsiYWdncmVnYXRlLXBheS1yZXNvdXJjZSJdLCJwYXlsb2FkIjp7IjIiOnsicmVzb3VyY2VzIjpudWxsLCJ1c2VyX2F1dGhvcml0aWVzIjp7InJfMDAxIjpbInNqX21fY29uc29sZSIsInNqX21fYXBwX2xpc3QiLCJzal9tX3RyYW5zYWN0aW9uX2xpc3QiLCJzal9tX2FjY291bnRfY2hlY2siLCJzal9tX3BheW1lbnQiLCJzal9tX2FjY291bnRfbGlzdCIsInNqX21fZW50ZXJwcmlzZV9hdXRoIiwic2pfbV9zdG9yZV9saXN0Iiwic2pfbV9zdGFmZl9saXN0Iiwic2pfb19tZW1iZXJfbGlzdCIsInNqX29fZW50cmVwcmlzZV9saXN0Iiwic2pfb19hdWRpdCIsInNqX29fc2VydmljZV90eXBlIiwic2pfb19hY2NvdW50X2NoZWNrIiwic2pfb19hZG1pbl9saXN0Iiwic2pfb19yb2xlX2xpc3QiLCJzal9tX2FwcF9jcmVhdGUiLCJzal9tX3BheW1lbnRfc2V0Iiwic2pfbV9zdG9yZV9jcmVhdGUiLCJzal9tX3N0b3JlX3F1ZXJ5Iiwic2pfbV9zdGFmZl9jcmVhdGUiLCJzal9tX3N0YWZmX3F1ZXJ5Iiwic2pfb19tZW1iZXJfcXVlcnkiLCJzal9vX2VudGVycHJpc2VfcXVlcnkiLCJzal9vX2VudGVycHJpc2VfY3JlYXRlIiwic2pfb19zZXJ2aWNlX2NyZWF0ZSIsInNqX29fc2VydmljZV9xdWVyeSIsInNqX29fYWRtaW5fY3JlYXRlIiwic2pfb19hZG1pbl9xdWVyeSIsInNqX29fcm9sZV9jcmVhdGUiLCJzal9vX3JvbGVfcXVlcnkiLCJzal9vX3JvbGVfc2F2ZSIsInNqX21fYXV0aF9hcHBseSIsInNqX21fY29uc29sZV9yZW5ldyIsInNqX21fY29uc29sZV91cGdyYWRlIiwic2pfbV9hcHBfc2F2ZSIsInNqX21fYXBwX21vZGlmeSIsInNqX21fcGF5cGFyYW1fc2F2ZSIsInNqX21fcGF5X3NldCIsInNqX21fcGF5X3NhdmUiLCJzal9tX2MyYl9xcmNvZGUiLCJzal9tX2IyY19vcmRlciIsInNqX21faDVfdmlldyIsInNqX21fYnVuZGxlX2J1eSIsInNqX21fZW50ZXJwcmlzZV9pbmZvX3N1Ym1pdCIsInNqX21fZW50ZXJwcmlzZV9pbmZvX2NhbmNlbCIsInNqX29fZW50ZXJwcmlzZV9hdXRoX3Bhc3MiLCJzal9vX2VudGVycHJpc2VfYXV0aF9yZWplY3Rpb24iLCJzal9tX3N0b3JlX2VkaXQiLCJzal9tX3N0YWZmX2VkaXQiLCJzal9vX2FkbWluX2VkaXQiLCJzal9vX3JvbGVfZWRpdCIsInNqX21fc3RvcmVfc2F2ZSIsInNqX21fc3RvcmVfZGVsIiwic2pfbV9zdGFmZl9zYXZlIl0sInJfMDAyIjpbInNqX21fdHJhbnNhY3Rpb25fbGlzdCIsInNqX21fYWNjb3VudF9jaGVjayJdfX19LCJ1c2VyX25hbWUiOiJoZWxsbyIsInNjb3BlIjpbInJlYWQiXSwiYXRpIjoiNDk1NGFmNDktN2NiNS00OGMyLWExNDAtYTZjYmY0NzUxMTZjIiwibW9iaWxlIjoiMTU2NzI4NzY2NTUiLCJleHAiOjE2NzQ3MzM3NTgsImNsaWVudF9hdXRob3JpdGllcyI6WyJST0xFX01FUkNIQU5UIiwiUk9MRV9VU0VSIl0sImp0aSI6IjE4YjAwZjc1LTRjYzMtNDI0Zi1hNTZkLTczYmJjMGViYjBiOCIsImNsaWVudF9pZCI6Im1lcmNoYW50LXBsYXRmb3JtIn0.Fu_kLTqaR8r0Jg3W-PNNn4rO0yce0y78yZzLhfOM5wQ",
    "expires_in": 31535999,
    "scope": "read",
    "jti": "4954af49-7cb5-48c2-a140-a6cbf475116c"
}
```





![image-20230123195036473](img/聚合支付项目实战学习笔记/image-20230123195036473.png)







UAA服务日志：

```sh
2023-01-23 19:49:17.822  INFO 13148 --- [-user-service-1] c.netflix.config.ChainedDynamicProperty  : Flipping property: aggregate-pay-user-service.ribbon.ActiveConnectionsLimit to use NEXT property: niws.loadbalancer.availabilityFilteringRule.activeConnectionsLimit = 2147483647
2023-01-23 19:49:17.838  INFO 13148 --- [-user-service-1] c.netflix.loadbalancer.BaseLoadBalancer  : Client: aggregate-pay-user-service instantiated a LoadBalancer: DynamicServerListLoadBalancer:{NFLoadBalancer:name=aggregate-pay-user-service,current list of Servers=[],Load balancer stats=Zone stats: {},Server stats: []}ServerList:null
2023-01-23 19:49:17.845  INFO 13148 --- [-user-service-1] c.n.l.DynamicServerListLoadBalancer      : Using serverListUpdater PollingServerListUpdater
2023-01-23 19:49:17.850  INFO 13148 --- [-user-service-1] com.alibaba.nacos.client.naming          : new ips(1) service: DEFAULT_GROUP@@aggregate-pay-user-service -> [{"instanceId":"192.168.3.143#28692#DEFAULT#DEFAULT_GROUP@@aggregate-pay-user-service","ip":"192.168.3.143","port":28692,"weight":1.0,"healthy":true,"enabled":true,"ephemeral":false,"clusterName":"DEFAULT","serviceName":"DEFAULT_GROUP@@aggregate-pay-user-service","metadata":{"preserved.register.source":"SPRING_CLOUD","management.endpoints.web.base-path":"/actuator","management.context-path":"//actuator"},"ipDeleteTimeout":30000,"instanceHeartBeatInterval":5000,"instanceHeartBeatTimeOut":15000}]
2023-01-23 19:49:17.857  INFO 13148 --- [-user-service-1] com.alibaba.nacos.client.naming          : current ips:(1) service: DEFAULT_GROUP@@aggregate-pay-user-service -> [{"instanceId":"192.168.3.143#28692#DEFAULT#DEFAULT_GROUP@@aggregate-pay-user-service","ip":"192.168.3.143","port":28692,"weight":1.0,"healthy":true,"enabled":true,"ephemeral":false,"clusterName":"DEFAULT","serviceName":"DEFAULT_GROUP@@aggregate-pay-user-service","metadata":{"preserved.register.source":"SPRING_CLOUD","management.endpoints.web.base-path":"/actuator","management.context-path":"//actuator"},"ipDeleteTimeout":30000,"instanceHeartBeatInterval":5000,"instanceHeartBeatTimeOut":15000}]
2023-01-23 19:49:17.867  INFO 13148 --- [-user-service-1] c.netflix.config.ChainedDynamicProperty  : Flipping property: aggregate-pay-user-service.ribbon.ActiveConnectionsLimit to use NEXT property: niws.loadbalancer.availabilityFilteringRule.activeConnectionsLimit = 2147483647
2023-01-23 19:49:17.870  INFO 13148 --- [-user-service-1] c.n.l.DynamicServerListLoadBalancer      : DynamicServerListLoadBalancer for client aggregate-pay-user-service initialized: DynamicServerListLoadBalancer:{NFLoadBalancer:name=aggregate-pay-user-service,current list of Servers=[192.168.3.143:28692],Load balancer stats=Zone stats: {unknown=[Zone:unknown;	Instance count:1;	Active connections count: 0;	Circuit breaker tripped count: 0;	Active connections per server: 0.0;]
},Server stats: [[Server:192.168.3.143:28692;	Zone:UNKNOWN;	Total Requests:0;	Successive connection failure:0;	Total blackout seconds:0;	Last connection made:Thu Jan 01 08:00:00 CST 1970;	First connection made: Thu Jan 01 08:00:00 CST 1970;	Active Connections:0;	total failure count in last (1000) msecs:0;	average resp time:0.0;	90 percentile resp time:0.0;	95 percentile resp time:0.0;	min resp time:0.0;	max resp time:0.0;	stddev resp time:0.0]
]}ServerList:com.alibaba.cloud.nacos.ribbon.NacosServerList@5f00f23d
2023-01-23 19:49:18.293  INFO 13148 --- [io-43573-exec-8] egrationUserDetailsAuthenticationHandler : loginInfoDTO:{"id":1,"mobile":"15672876655","resources":{},"tenantAuthorizationInfoMap":{2:{"rolePrivilegeMap":{"r_001":["sj_m_console","sj_m_app_list","sj_m_transaction_list","sj_m_account_check","sj_m_payment","sj_m_account_list","sj_m_enterprise_auth","sj_m_store_list","sj_m_staff_list","sj_o_member_list","sj_o_entreprise_list","sj_o_audit","sj_o_service_type","sj_o_account_check","sj_o_admin_list","sj_o_role_list","sj_m_app_create","sj_m_payment_set","sj_m_store_create","sj_m_store_query","sj_m_staff_create","sj_m_staff_query","sj_o_member_query","sj_o_enterprise_query","sj_o_enterprise_create","sj_o_service_create","sj_o_service_query","sj_o_admin_create","sj_o_admin_query","sj_o_role_create","sj_o_role_query","sj_o_role_save","sj_m_auth_apply","sj_m_console_renew","sj_m_console_upgrade","sj_m_app_save","sj_m_app_modify","sj_m_payparam_save","sj_m_pay_set","sj_m_pay_save","sj_m_c2b_qrcode","sj_m_b2c_order","sj_m_h5_view","sj_m_bundle_buy","sj_m_enterprise_info_submit","sj_m_enterprise_info_cancel","sj_o_enterprise_auth_pass","sj_o_enterprise_auth_rejection","sj_m_store_edit","sj_m_staff_edit","sj_o_admin_edit","sj_o_role_edit","sj_m_store_save","sj_m_store_del","sj_m_staff_save"],"r_002":["sj_m_transaction_list","sj_m_account_check"]}}},"tenants":[{"bundleCode":"aggregate-pay-merchant","id":2,"name":"hello_Vp3c2O","tenantTypeCode":"aggregate-pay-merchant"}],"username":"hello"}
2023-01-23 19:49:18.361  INFO 13148 --- [io-43573-exec-8] egrationUserDetailsAuthenticationHandler : @@@@@@@@@@@:{"accountNonExpired":true,"accountNonLocked":true,"authorities":[],"credentialsNonExpired":true,"enabled":true,"mobile":"15672876655","password":"123456","payload":{2:{"user_authorities":{"r_001":["sj_m_console","sj_m_app_list","sj_m_transaction_list","sj_m_account_check","sj_m_payment","sj_m_account_list","sj_m_enterprise_auth","sj_m_store_list","sj_m_staff_list","sj_o_member_list","sj_o_entreprise_list","sj_o_audit","sj_o_service_type","sj_o_account_check","sj_o_admin_list","sj_o_role_list","sj_m_app_create","sj_m_payment_set","sj_m_store_create","sj_m_store_query","sj_m_staff_create","sj_m_staff_query","sj_o_member_query","sj_o_enterprise_query","sj_o_enterprise_create","sj_o_service_create","sj_o_service_query","sj_o_admin_create","sj_o_admin_query","sj_o_role_create","sj_o_role_query","sj_o_role_save","sj_m_auth_apply","sj_m_console_renew","sj_m_console_upgrade","sj_m_app_save","sj_m_app_modify","sj_m_payparam_save","sj_m_pay_set","sj_m_pay_save","sj_m_c2b_qrcode","sj_m_b2c_order","sj_m_h5_view","sj_m_bundle_buy","sj_m_enterprise_info_submit","sj_m_enterprise_info_cancel","sj_o_enterprise_auth_pass","sj_o_enterprise_auth_rejection","sj_m_store_edit","sj_m_staff_edit","sj_o_admin_edit","sj_o_role_edit","sj_m_store_save","sj_m_store_del","sj_m_staff_save"],"r_002":["sj_m_transaction_list","sj_m_account_check"]}}},"tenant":{"tenantId":1},"username":"hello"}
2023-01-23 19:49:18.865  INFO 13148 --- [erListUpdater-0] c.netflix.config.ChainedDynamicProperty  : Flipping property: aggregate-pay-user-service.ribbon.ActiveConnectionsLimit to use NEXT property: niws.loadbalancer.availabilityFilteringRule.activeConnectionsLimit = 2147483647

```





user服务日志：

```sh
2023-01-23 19:49:18.024  WARN 1544 --- [io-28692-exec-8] c.a.druid.pool.DruidAbstractDataSource   : discard long time none received connection. , jdbcUrl : jdbc:mysql://127.0.0.1:3306/aggregate_pay_user?serverTimezone=GMT&characterEncoding=utf8, version : 1.2.8, lastPacketReceivedIdleMillis : 17725693
2023-01-23 19:49:18.177 DEBUG 1544 --- [io-28692-exec-8] m.a.mapper.AccountMapper.selectOne       : ==>  Preparing: SELECT ID,PASSWORD,SALT,MOBILE,USERNAME FROM account WHERE (USERNAME = ?) 
2023-01-23 19:49:18.191 DEBUG 1544 --- [io-28692-exec-8] m.a.mapper.AccountMapper.selectOne       : ==> Parameters: hello(String)
2023-01-23 19:49:18.200 DEBUG 1544 --- [io-28692-exec-8] m.a.mapper.AccountMapper.selectOne       : <==      Total: 1
 Consume Time：6 ms 2023-01-23 19:49:18
 Execute SQL：SELECT ID,PASSWORD,SALT,MOBILE,USERNAME FROM account WHERE (USERNAME = 'hello')

2023-01-23 19:49:18.218 DEBUG 1544 --- [io-28692-exec-8] m.a.m.T.selectAccountInTenant            : ==>  Preparing: select t.* from tenant t left join tenant_account ta ON t.ID=ta.TENANT_ID left join account a on a.ID =ta.ACCOUNT_ID where ta.ACCOUNT_ID=? 
2023-01-23 19:49:18.219 DEBUG 1544 --- [io-28692-exec-8] m.a.m.T.selectAccountInTenant            : ==> Parameters: 1(Long)
2023-01-23 19:49:18.223 DEBUG 1544 --- [io-28692-exec-8] m.a.m.T.selectAccountInTenant            : <==      Total: 1
2023-01-23 19:49:18.225 DEBUG 1544 --- [io-28692-exec-8] m.a.m.A.selectRoleByUsernameInTenants    : ==>  Preparing: SELECT r.id FROM account_role ar, authorization_role r WHERE r.`CODE` = ar.ROLE_CODE AND r.`TENANT_ID` = ar.`TENANT_ID` AND ar.username=? and ar.TENANT_ID in ( ? ) 
2023-01-23 19:49:18.226 DEBUG 1544 --- [io-28692-exec-8] m.a.m.A.selectRoleByUsernameInTenants    : ==> Parameters: hello(String), 2(Long)
 Consume Time：2 ms 2023-01-23 19:49:18
 Execute SQL：select t.* from tenant t left join tenant_account ta ON t.ID=ta.TENANT_ID left join account a on a.ID =ta.ACCOUNT_ID where ta.ACCOUNT_ID=1

 Consume Time：2 ms 2023-01-23 19:49:18
 Execute SQL：SELECT r.id FROM account_role ar, authorization_role r WHERE r.`CODE` = ar.ROLE_CODE AND r.`TENANT_ID` = ar.`TENANT_ID` AND ar.username='hello' and ar.TENANT_ID in ( 2 )

 Consume Time：2 ms 2023-01-23 19:49:18
 Execute SQL：select r.TENANT_ID,r.`CODE` ROLE_CODE,p.`CODE` PRIVILEGE_CODE from authorization_privilege p LEFT JOIN authorization_role_privilege arp ON arp.PRIVILEGE_ID=p.ID LEFT JOIN authorization_role r ON arp.ROLE_ID = r.ID where r.ID IN ( 51 , 52 ) ORDER BY r.TENANT_ID

2023-01-23 19:49:18.230 DEBUG 1544 --- [io-28692-exec-8] m.a.m.A.selectRoleByUsernameInTenants    : <==      Total: 2
2023-01-23 19:49:18.231 DEBUG 1544 --- [io-28692-exec-8] m.a.m.A.selectPrivilegeRoleInTenant      : ==>  Preparing: select r.TENANT_ID,r.`CODE` ROLE_CODE,p.`CODE` PRIVILEGE_CODE from authorization_privilege p LEFT JOIN authorization_role_privilege arp ON arp.PRIVILEGE_ID=p.ID LEFT JOIN authorization_role r ON arp.ROLE_ID = r.ID where r.ID IN ( ? , ? ) ORDER BY r.TENANT_ID 
2023-01-23 19:49:18.236 DEBUG 1544 --- [io-28692-exec-8] m.a.m.A.selectPrivilegeRoleInTenant      : ==> Parameters: 51(Long), 52(Long)
2023-01-23 19:49:18.243 DEBUG 1544 --- [io-28692-exec-8] m.a.m.A.selectPrivilegeRoleInTenant      : <==      Total: 57
2023-01-23 19:49:18.334 DEBUG 1544 --- [io-28692-exec-1] m.a.m.R.selectOne                        : ==>  Preparing: SELECT ID,CODE,TENANT_ID,NAME FROM resource_application WHERE (CODE = ?) 
2023-01-23 19:49:18.335 DEBUG 1544 --- [io-28692-exec-1] m.a.m.R.selectOne                        : ==> Parameters: merchant-platform(String)
2023-01-23 19:49:18.339 DEBUG 1544 --- [io-28692-exec-1] m.a.m.R.selectOne                        : <==      Total: 1
 Consume Time：1 ms 2023-01-23 19:49:18
 Execute SQL：SELECT ID,CODE,TENANT_ID,NAME FROM resource_application WHERE (CODE = 'merchant-platform')
```







#### 解析token

/uaa/oauth/check_token



![image-20230123195818520](img/聚合支付项目实战学习笔记/image-20230123195818520.png)





![image-20230123195830050](img/聚合支付项目实战学习笔记/image-20230123195830050.png)





![image-20230123195942916](img/聚合支付项目实战学习笔记/image-20230123195942916.png)





![image-20230123200021533](img/聚合支付项目实战学习笔记/image-20230123200021533.png)







```json
{
  "aud": [
    "aggregate-pay-resource"
  ],
  "payload": {
    "2": {
      "resources": null,
      "user_authorities": {
        "r_001": [
          "sj_m_console",
          "sj_m_app_list",
          "sj_m_transaction_list",
          "sj_m_account_check",
          "sj_m_payment",
          "sj_m_account_list",
          "sj_m_enterprise_auth",
          "sj_m_store_list",
          "sj_m_staff_list",
          "sj_o_member_list",
          "sj_o_entreprise_list",
          "sj_o_audit",
          "sj_o_service_type",
          "sj_o_account_check",
          "sj_o_admin_list",
          "sj_o_role_list",
          "sj_m_app_create",
          "sj_m_payment_set",
          "sj_m_store_create",
          "sj_m_store_query",
          "sj_m_staff_create",
          "sj_m_staff_query",
          "sj_o_member_query",
          "sj_o_enterprise_query",
          "sj_o_enterprise_create",
          "sj_o_service_create",
          "sj_o_service_query",
          "sj_o_admin_create",
          "sj_o_admin_query",
          "sj_o_role_create",
          "sj_o_role_query",
          "sj_o_role_save",
          "sj_m_auth_apply",
          "sj_m_console_renew",
          "sj_m_console_upgrade",
          "sj_m_app_save",
          "sj_m_app_modify",
          "sj_m_payparam_save",
          "sj_m_pay_set",
          "sj_m_pay_save",
          "sj_m_c2b_qrcode",
          "sj_m_b2c_order",
          "sj_m_h5_view",
          "sj_m_bundle_buy",
          "sj_m_enterprise_info_submit",
          "sj_m_enterprise_info_cancel",
          "sj_o_enterprise_auth_pass",
          "sj_o_enterprise_auth_rejection",
          "sj_m_store_edit",
          "sj_m_staff_edit",
          "sj_o_admin_edit",
          "sj_o_role_edit",
          "sj_m_store_save",
          "sj_m_store_del",
          "sj_m_staff_save"
        ],
        "r_002": [
          "sj_m_transaction_list",
          "sj_m_account_check"
        ]
      }
    }
  },
  "user_name": "hello",
  "scope": [
    "read"
  ],
  "mobile": "15672876655",
  "exp": "1706010558",
  "client_authorities": [
    "ROLE_MERCHANT",
    "ROLE_USER"
  ],
  "jti": "4954af49-7cb5-48c2-a140-a6cbf475116c",
  "client_id": "merchant-platform"
}
```















## JWT

### 什么是JWT？

JSON Web Token（JWT）是一个开放的行业标准（RFC 7519），它定义了一种简洁的、自包含的协议格式，用于在通信双方传递json对象，传递的信息经过数字签名可以被验证和信任。JWT可以使用HMAC算法或使用RSA的公钥/私钥对来签名，防止被篡改



#### JWT令牌的优点

* jwt基于json，非常方便解析。 

* 可以在令牌中自定义丰富的内容，易扩展。 

* 通过非对称加密算法及数字签名技术，JWT防止篡改，安全性高



#### JWT令牌结构

JWT令牌由Header、Payload、Signature三部分组成，每部分中间使用点（.）分隔



* Header：头部包括令牌的类型（即JWT）及使用的哈希算法（如HMAC SHA256或RSA）
* Payload：第二部分是负载，内容也是一个json对象，它是存放有效信息的地方，它可以存放jwt提供的现成字段，比 如： iss（签发者）,exp（过期时间戳）, sub（面向的用户）等，也可自定义字段。 此部分不建议存放敏感信息，因为此部分可以解码还原原始内容
* Signature：第三部分是签名，此部分用于防止jwt内容被篡改。 这个部分使用base64url将前两部分进行编码，编码后使用点 （.）连接组成字符串，最后使用header中声明签名算法进行签名



JWT三个部分只有第三部分是加密的，通过数字签名机制，我们既可以保证数据完整性，也可以对数据来源进行身 份验证









### 什么是签名？

签名是数字签名，发送方将消息原文使用摘要算法生成摘要，再用私钥对摘要进行加密，生成数字签名

传输数据时为了保证数据的完整性可以使用数字签名技术：

* 发送方使用私钥对内容进行数字签名
* 将内容附带数字签名发送给对方
* 对方收到内容和数字签名，使用公钥进行验签（相当于解密的过程），如果发现内容不一致则说明传输过程被篡改



















# 集成测试

## 前期准备

### 商户服务添加获取商户信息缓存

在MerchantServiceImpl类的getMerchantById方法中添加分布式缓存，提升查询性能

```java
package mao.aggregate_pay_merchant_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import mao.aggregate_pay_common.domain.CommonErrorCode;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StaffDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.aggregate_pay_merchant_service.entity.Merchant;
import mao.aggregate_pay_merchant_service.entity.Staff;
import mao.aggregate_pay_merchant_service.entity.Store;
import mao.aggregate_pay_merchant_service.entity.StoreStaff;
import mao.aggregate_pay_merchant_service.mapper.MerchantMapper;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.aggregate_pay_merchant_service.service.StaffService;
import mao.aggregate_pay_merchant_service.service.StoreService;
import mao.aggregate_pay_merchant_service.service.StoreStaffService;
import mao.aggregate_pay_user_api.dto.tenant.CreateTenantRequestDTO;
import mao.aggregate_pay_user_api.dto.tenant.TenantDTO;
import mao.aggregate_pay_user_api.feign.TenantFeignClientV2;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import mao.tools_databases.mybatis.conditions.Wraps;
import mao.tools_redis_cache.utils.RedisUtils;
import mao.toolsdozer.utils.DozerUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.Resource;
import java.util.concurrent.TimeUnit;
import java.util.function.Function;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service.impl
 * Class(类名): MerchantServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:38
 * Version(版本): 1.0
 * Description(描述)： 商户服务实现类
 */

@Service
public class MerchantServiceImpl extends ServiceImpl<MerchantMapper, Merchant> implements MerchantService
{

    @Resource
    private DozerUtils dozerUtils;

    @Resource
    private StoreService storeService;

    @Resource
    private StaffService staffService;

    @Resource
    private StoreStaffService storeStaffService;

    @Resource
    private TenantFeignClientV2 tenantFeignClient;

    @Resource
    private RedisUtils redisUtils;

    @Resource
    private StringRedisTemplate stringRedisTemplate;

    @Override
    public MerchantDTO getMerchantById(Long merchantId)
    {
        return redisUtils.query("pay:MerchantDTO:getMerchantById:",
                "pay:MerchantDTO:getMerchantById:lock:",
                merchantId, MerchantDTO.class, new Function<Long, MerchantDTO>()
                {
                    @Override
                    public MerchantDTO apply(Long aLong)
                    {
                        //查询
                        Merchant merchant = getById(merchantId);
                        //转换，并返回
                        return dozerUtils.map(merchant, MerchantDTO.class);
                    }
                }, 180L, TimeUnit.MINUTES, 120);

    }

//    @Override
//    public MerchantDTO createMerchant(MerchantDTO merchantDTO)
//    {
//        //校验商户手机号的唯一性,根据商户的手机号查询商户表，如果存在记录则说明已有相同的手机号重复
//        int count = this.count(Wraps.<Merchant>lbQ().eq(Merchant::getMobile, merchantDTO.getMobile()));
//        if (count > 0)
//        {
//            throw BizException.wrap("手机号重复");
//        }
//        //构建商户
//        Merchant merchant = new Merchant();
//        //设置审核状态
//        merchant.setAuditStatus("0");
//        //设置手机号
//        merchant.setMobile(merchantDTO.getMobile());
//        //保存
//        this.save(merchant);
//        //保存id信息
//        merchantDTO.setId(merchant.getId());
//        //返回
//        return merchantDTO;
//    }


    @Override
    @Transactional
    public MerchantDTO createMerchant(MerchantDTO merchantDTO)
    {
        //校验商户手机号的唯一性,根据商户的手机号查询商户表，如果存在记录则说明已有相同的手机号重复
        int count = this.count(Wraps.<Merchant>lbQ().eq(Merchant::getMobile, merchantDTO.getMobile()));
        if (count > 0)
        {
            throw BizException.wrap("手机号重复");
        }
        //构建调用参数
        CreateTenantRequestDTO createTenantRequestDTO = new CreateTenantRequestDTO();
        //手机号
        createTenantRequestDTO.setMobile(merchantDTO.getMobile());
        //用户名
        createTenantRequestDTO.setUsername(merchantDTO.getUsername());
        //密码
        createTenantRequestDTO.setPassword(merchantDTO.getPassword());
        //租户类型
        createTenantRequestDTO.setTenantTypeCode("aggregate-pay-merchant");
        //套餐，根据套餐进行分配权限
        createTenantRequestDTO.setBundleCode("aggregate-pay-merchant");
        //租户名称，和账号名一样
        createTenantRequestDTO.setName(merchantDTO.getUsername());
        //调用SaaS接口
        //如果租户在SaaS已经存在，SaaS直接 返回此租户的信息，否则进行添加
        R<TenantDTO> r = tenantFeignClient.createTenantAndInit(createTenantRequestDTO);
        if (r.getIsError())
        {
            //错误，抛出异常
            throw BizException.wrap(r.getCode(), r.getMsg());
        }
        //无错误，取数据
        TenantDTO tenantDTO = r.getData();
        //获取租户的id
        if (tenantDTO == null || tenantDTO.getId() == null)
        {
            //空
            throw BizException.wrap("租户不存在");
        }
        //租户的id
        Long tenantId = tenantDTO.getId();
        //租户id在商户表唯一
        //根据租户id从商户表查询，如果存在记录则不允许添加商户
        int count1 = this.count(Wraps.<Merchant>lbQ().eq(Merchant::getTenantId, tenantId));
        //判断结果
        if (count1 > 0)
        {
            //存在
            throw BizException.wrap("商户在当前租户下已经注册，不可重复注册");
        }
        //对象转换
        Merchant merchant = dozerUtils.map(merchantDTO, Merchant.class);
        //设置所对应的租户的Id
        merchant.setTenantId(tenantId);
        //审核状态为0-未进行资质申请
        merchant.setAuditStatus("0");
        //去掉id
        merchant.setId(null);
        //插入数据
        boolean save = this.save(merchant);
        //判断结果
        if (!save)
        {
            //保存失败
            throw BizException.wrap("商户数据保存失败");
        }
        //新增门店
        StoreDTO storeDTO = new StoreDTO();
        storeDTO.setStoreName("根门店");
        //商户id
        storeDTO.setMerchantId(merchant.getId());
        StoreDTO store = createStore(storeDTO);

        //新增员工
        StaffDTO staffDTO = new StaffDTO();
        //手机号
        staffDTO.setMobile(merchantDTO.getMobile());
        //账号
        staffDTO.setUsername(merchantDTO.getUsername());
        //员所属门店id
        staffDTO.setStoreId(store.getId());
        //商户id
        staffDTO.setMerchantId(merchant.getId());
        //创建
        StaffDTO staff = createStaff(staffDTO);

        //为门店设置管理员
        bindStaffToStore(store.getId(), staff.getId());

        //转换
        dozerUtils.map(merchant, merchantDTO);
        //返回
        //让缓存过期
        String redisKey = "pay:MerchantDTO:getMerchantById:" + merchant.getId();
        stringRedisTemplate.delete(redisKey);
        return merchantDTO;
    }


    @Override
    @Transactional
    public void applyMerchant(Long merchantId, MerchantDTO merchantDTO)
    {
        //接收资质申请信息，更新到商户表
        if (merchantDTO == null || merchantId == null)
        {
            throw BizException.wrap("传入对象为空");
        }
        //根据id查询商户
        Merchant merchant = this.getById(merchantId);
        if (merchant == null)
        {
            throw BizException.wrap("商户不存在");
        }
        //对象转换
        Merchant merchant_update = dozerUtils.map(merchantDTO, Merchant.class);
        //已申请待审核
        merchant_update.setAuditStatus("1");
        //租户id
        merchant_update.setTenantId(merchant.getTenantId());
        //设置商户id
        merchant_update.setId(merchantId);
        //更新
        boolean update = this.updateById(merchant_update);
        if (!update)
        {
            throw BizException.wrap("商户资质申请失败");
        }
        //让缓存过期
        String redisKey = "pay:MerchantDTO:getMerchantById:" + merchant.getId();
        stringRedisTemplate.delete(redisKey);
    }

    @Override
    public StoreDTO createStore(StoreDTO storeDTO)
    {
        //转换
        Store store = dozerUtils.map(storeDTO, Store.class);
        //去掉id
        store.setId(null);
        //新增
        boolean save = storeService.save(store);
        if (!save)
        {
            throw BizException.wrap("新增门店失败");
        }
        //设置id
        storeDTO.setId(store.getId());
        //返回
        return storeDTO;
    }

    @Override
    public StaffDTO createStaff(StaffDTO staffDTO)
    {
        //判断是否为空
        if (StringUtils.isBlank(staffDTO.getMobile()))
        {
            //空
            throw BizException.wrap("手机号为空");
        }
        //判断是否为空
        if (StringUtils.isBlank(staffDTO.getUsername()))
        {
            //空
            throw BizException.wrap("用户名为空");
        }
        //根据手机号和商户id判断员工是否已在指定商户存在
        if (isExistStaffByMobile(staffDTO.getMobile(), staffDTO.getMerchantId()))
        {
            //已经存在
            throw BizException.wrap("手机号已经存在");
        }
        //根据账号判断员工是否已在指定商户存在
        if (isExistStaffByUserName(staffDTO.getUsername(), staffDTO.getMerchantId()))
        {
            //存在
            throw BizException.wrap("用户名已经存在");
        }
        //转换
        Staff staff = dozerUtils.map(staffDTO, Staff.class);
        //去掉id
        staff.setId(null);
        //保存
        staffService.save(staff);
        //设置id
        staffDTO.setId(staff.getId());
        //返回
        return staffDTO;
    }

    /**
     * 根据手机号和商户id判断员工是否已在指定商户存在
     *
     * @param mobile     手机号
     * @param merchantId 商人id
     * @return boolean
     */
    private boolean isExistStaffByMobile(String mobile, Long merchantId)
    {
        int count = staffService.count(Wraps.<Staff>lbQ()
                .eq(Staff::getMobile, mobile)
                .eq(Staff::getMerchantId, merchantId));
        return count > 0;
    }

    /**
     * 根据账号判断员工是否已在指定商户存在
     *
     * @param userName   用户名
     * @param merchantId 商人id
     * @return boolean
     */
    private boolean isExistStaffByUserName(String userName, Long merchantId)
    {
        int count = staffService.count(Wraps.<Staff>lbQ()
                .eq(Staff::getUsername, userName)
                .eq(Staff::getMerchantId, merchantId));
        return count > 0;
    }


    @Override
    public void bindStaffToStore(Long storeId, Long staffId)
    {
        //构建实体类对象
        StoreStaff storeStaff = new StoreStaff();
        storeStaff.setStaffId(staffId);
        storeStaff.setStoreId(storeId);
        //保存
        boolean save = storeStaffService.save(storeStaff);
        if (!save)
        {
            throw BizException.wrap("为门店设置管理员失败");
        }
    }
}
```







### 商户服务根据租户id获取商户信息接口

#### 接口定义

```java
package mao.aggregate_pay_merchant_service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StaffDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.aggregate_pay_merchant_service.entity.Merchant;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service
 * Interface(接口名): MerchantService
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:29
 * Version(版本): 1.0
 * Description(描述)： 商户服务接口
 */

public interface MerchantService extends IService<Merchant>
{
    /**
     * 通过id获取商户信息
     *
     * @param merchantId 商户id
     * @return {@link MerchantDTO}
     */
    MerchantDTO getMerchantById(Long merchantId);


    /**
     * 商户注册
     *
     * @param merchantDTO {@link MerchantDTO} 商户dto
     * @return {@link MerchantDTO}
     */
    MerchantDTO createMerchant(MerchantDTO merchantDTO);

    /**
     * 资质申请
     *
     * @param merchantId  商户id
     * @param merchantDTO 资质申请信息
     */
    void applyMerchant(Long merchantId, MerchantDTO merchantDTO);


    /**
     * 商户下新增门店
     *
     * @param storeDTO 商店dto
     * @return {@link StoreDTO}
     */
    StoreDTO createStore(StoreDTO storeDTO);


    /**
     * 商户新增员工
     *
     * @param staffDTO 员工dto
     * @return {@link StaffDTO}
     */
    StaffDTO createStaff(StaffDTO staffDTO);


    /**
     * 为门店设置管理员
     *
     * @param storeId 门店id
     * @param staffId 员工id
     */
    void bindStaffToStore(Long storeId, Long staffId);


    /**
     * 根据租户id查询商户信息
     *
     * @param tenantId 租户id
     * @return {@link MerchantDTO}
     */
    MerchantDTO getMerchantByTenantId(Long tenantId);

}
```





#### 接口实现

```java
package mao.aggregate_pay_merchant_service.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import mao.aggregate_pay_common.domain.CommonErrorCode;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StaffDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.aggregate_pay_merchant_service.entity.Merchant;
import mao.aggregate_pay_merchant_service.entity.Staff;
import mao.aggregate_pay_merchant_service.entity.Store;
import mao.aggregate_pay_merchant_service.entity.StoreStaff;
import mao.aggregate_pay_merchant_service.mapper.MerchantMapper;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.aggregate_pay_merchant_service.service.StaffService;
import mao.aggregate_pay_merchant_service.service.StoreService;
import mao.aggregate_pay_merchant_service.service.StoreStaffService;
import mao.aggregate_pay_user_api.dto.tenant.CreateTenantRequestDTO;
import mao.aggregate_pay_user_api.dto.tenant.TenantDTO;
import mao.aggregate_pay_user_api.feign.TenantFeignClientV2;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import mao.tools_databases.mybatis.conditions.Wraps;
import mao.tools_redis_cache.utils.RedisUtils;
import mao.toolsdozer.utils.DozerUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.Resource;
import java.util.concurrent.TimeUnit;
import java.util.function.Function;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.service.impl
 * Class(类名): MerchantServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:38
 * Version(版本): 1.0
 * Description(描述)： 商户服务实现类
 */

@Service
public class MerchantServiceImpl extends ServiceImpl<MerchantMapper, Merchant> implements MerchantService
{

    @Resource
    private DozerUtils dozerUtils;

    @Resource
    private StoreService storeService;

    @Resource
    private StaffService staffService;

    @Resource
    private StoreStaffService storeStaffService;

    @Resource
    private TenantFeignClientV2 tenantFeignClient;

    @Resource
    private RedisUtils redisUtils;

    @Resource
    private StringRedisTemplate stringRedisTemplate;

    @Override
    public MerchantDTO getMerchantById(Long merchantId)
    {
        return redisUtils.query("pay:MerchantDTO:getMerchantById:",
                "pay:MerchantDTO:getMerchantById:lock:",
                merchantId, MerchantDTO.class, new Function<Long, MerchantDTO>()
                {
                    @Override
                    public MerchantDTO apply(Long aLong)
                    {
                        //查询
                        Merchant merchant = getById(merchantId);
                        //转换，并返回
                        return dozerUtils.map(merchant, MerchantDTO.class);
                    }
                }, 180L, TimeUnit.MINUTES, 120);

    }

//    @Override
//    public MerchantDTO createMerchant(MerchantDTO merchantDTO)
//    {
//        //校验商户手机号的唯一性,根据商户的手机号查询商户表，如果存在记录则说明已有相同的手机号重复
//        int count = this.count(Wraps.<Merchant>lbQ().eq(Merchant::getMobile, merchantDTO.getMobile()));
//        if (count > 0)
//        {
//            throw BizException.wrap("手机号重复");
//        }
//        //构建商户
//        Merchant merchant = new Merchant();
//        //设置审核状态
//        merchant.setAuditStatus("0");
//        //设置手机号
//        merchant.setMobile(merchantDTO.getMobile());
//        //保存
//        this.save(merchant);
//        //保存id信息
//        merchantDTO.setId(merchant.getId());
//        //返回
//        return merchantDTO;
//    }


    @Override
    @Transactional
    public MerchantDTO createMerchant(MerchantDTO merchantDTO)
    {
        //校验商户手机号的唯一性,根据商户的手机号查询商户表，如果存在记录则说明已有相同的手机号重复
        int count = this.count(Wraps.<Merchant>lbQ().eq(Merchant::getMobile, merchantDTO.getMobile()));
        if (count > 0)
        {
            throw BizException.wrap("手机号重复");
        }
        //构建调用参数
        CreateTenantRequestDTO createTenantRequestDTO = new CreateTenantRequestDTO();
        //手机号
        createTenantRequestDTO.setMobile(merchantDTO.getMobile());
        //用户名
        createTenantRequestDTO.setUsername(merchantDTO.getUsername());
        //密码
        createTenantRequestDTO.setPassword(merchantDTO.getPassword());
        //租户类型
        createTenantRequestDTO.setTenantTypeCode("aggregate-pay-merchant");
        //套餐，根据套餐进行分配权限
        createTenantRequestDTO.setBundleCode("aggregate-pay-merchant");
        //租户名称，和账号名一样
        createTenantRequestDTO.setName(merchantDTO.getUsername());
        //调用SaaS接口
        //如果租户在SaaS已经存在，SaaS直接 返回此租户的信息，否则进行添加
        R<TenantDTO> r = tenantFeignClient.createTenantAndInit(createTenantRequestDTO);
        if (r.getIsError())
        {
            //错误，抛出异常
            throw BizException.wrap(r.getCode(), r.getMsg());
        }
        //无错误，取数据
        TenantDTO tenantDTO = r.getData();
        //获取租户的id
        if (tenantDTO == null || tenantDTO.getId() == null)
        {
            //空
            throw BizException.wrap("租户不存在");
        }
        //租户的id
        Long tenantId = tenantDTO.getId();
        //租户id在商户表唯一
        //根据租户id从商户表查询，如果存在记录则不允许添加商户
        int count1 = this.count(Wraps.<Merchant>lbQ().eq(Merchant::getTenantId, tenantId));
        //判断结果
        if (count1 > 0)
        {
            //存在
            throw BizException.wrap("商户在当前租户下已经注册，不可重复注册");
        }
        //对象转换
        Merchant merchant = dozerUtils.map(merchantDTO, Merchant.class);
        //设置所对应的租户的Id
        merchant.setTenantId(tenantId);
        //审核状态为0-未进行资质申请
        merchant.setAuditStatus("0");
        //去掉id
        merchant.setId(null);
        //插入数据
        boolean save = this.save(merchant);
        //判断结果
        if (!save)
        {
            //保存失败
            throw BizException.wrap("商户数据保存失败");
        }
        //新增门店
        StoreDTO storeDTO = new StoreDTO();
        storeDTO.setStoreName("根门店");
        //商户id
        storeDTO.setMerchantId(merchant.getId());
        StoreDTO store = createStore(storeDTO);

        //新增员工
        StaffDTO staffDTO = new StaffDTO();
        //手机号
        staffDTO.setMobile(merchantDTO.getMobile());
        //账号
        staffDTO.setUsername(merchantDTO.getUsername());
        //员所属门店id
        staffDTO.setStoreId(store.getId());
        //商户id
        staffDTO.setMerchantId(merchant.getId());
        //创建
        StaffDTO staff = createStaff(staffDTO);

        //为门店设置管理员
        bindStaffToStore(store.getId(), staff.getId());

        //转换
        dozerUtils.map(merchant, merchantDTO);
        //返回
        //让缓存过期
        String redisKey = "pay:MerchantDTO:getMerchantById:" + merchant.getId();
        stringRedisTemplate.delete(redisKey);
        String redisKey2 = "pay:MerchantDTO:getMerchantByTenantId:" + tenantId;
        stringRedisTemplate.delete(redisKey2);
        return merchantDTO;
    }


    @Override
    @Transactional
    public void applyMerchant(Long merchantId, MerchantDTO merchantDTO)
    {
        //接收资质申请信息，更新到商户表
        if (merchantDTO == null || merchantId == null)
        {
            throw BizException.wrap("传入对象为空");
        }
        //根据id查询商户
        Merchant merchant = this.getById(merchantId);
        if (merchant == null)
        {
            throw BizException.wrap("商户不存在");
        }
        //对象转换
        Merchant merchant_update = dozerUtils.map(merchantDTO, Merchant.class);
        //已申请待审核
        merchant_update.setAuditStatus("1");
        //租户id
        merchant_update.setTenantId(merchant.getTenantId());
        //设置商户id
        merchant_update.setId(merchantId);
        //更新
        boolean update = this.updateById(merchant_update);
        if (!update)
        {
            throw BizException.wrap("商户资质申请失败");
        }
        //让缓存过期
        String redisKey = "pay:MerchantDTO:getMerchantById:" + merchant.getId();
        stringRedisTemplate.delete(redisKey);
        String redisKey2 = "pay:MerchantDTO:getMerchantByTenantId:" + merchant.getTenantId();
        stringRedisTemplate.delete(redisKey2);
    }

    @Override
    public StoreDTO createStore(StoreDTO storeDTO)
    {
        //转换
        Store store = dozerUtils.map(storeDTO, Store.class);
        //去掉id
        store.setId(null);
        //新增
        boolean save = storeService.save(store);
        if (!save)
        {
            throw BizException.wrap("新增门店失败");
        }
        //设置id
        storeDTO.setId(store.getId());
        //返回
        return storeDTO;
    }

    @Override
    public StaffDTO createStaff(StaffDTO staffDTO)
    {
        //判断是否为空
        if (StringUtils.isBlank(staffDTO.getMobile()))
        {
            //空
            throw BizException.wrap("手机号为空");
        }
        //判断是否为空
        if (StringUtils.isBlank(staffDTO.getUsername()))
        {
            //空
            throw BizException.wrap("用户名为空");
        }
        //根据手机号和商户id判断员工是否已在指定商户存在
        if (isExistStaffByMobile(staffDTO.getMobile(), staffDTO.getMerchantId()))
        {
            //已经存在
            throw BizException.wrap("手机号已经存在");
        }
        //根据账号判断员工是否已在指定商户存在
        if (isExistStaffByUserName(staffDTO.getUsername(), staffDTO.getMerchantId()))
        {
            //存在
            throw BizException.wrap("用户名已经存在");
        }
        //转换
        Staff staff = dozerUtils.map(staffDTO, Staff.class);
        //去掉id
        staff.setId(null);
        //保存
        staffService.save(staff);
        //设置id
        staffDTO.setId(staff.getId());
        //返回
        return staffDTO;
    }

    /**
     * 根据手机号和商户id判断员工是否已在指定商户存在
     *
     * @param mobile     手机号
     * @param merchantId 商人id
     * @return boolean
     */
    private boolean isExistStaffByMobile(String mobile, Long merchantId)
    {
        int count = staffService.count(Wraps.<Staff>lbQ()
                .eq(Staff::getMobile, mobile)
                .eq(Staff::getMerchantId, merchantId));
        return count > 0;
    }

    /**
     * 根据账号判断员工是否已在指定商户存在
     *
     * @param userName   用户名
     * @param merchantId 商人id
     * @return boolean
     */
    private boolean isExistStaffByUserName(String userName, Long merchantId)
    {
        int count = staffService.count(Wraps.<Staff>lbQ()
                .eq(Staff::getUsername, userName)
                .eq(Staff::getMerchantId, merchantId));
        return count > 0;
    }


    @Override
    public void bindStaffToStore(Long storeId, Long staffId)
    {
        //构建实体类对象
        StoreStaff storeStaff = new StoreStaff();
        storeStaff.setStaffId(staffId);
        storeStaff.setStoreId(storeId);
        //保存
        boolean save = storeStaffService.save(storeStaff);
        if (!save)
        {
            throw BizException.wrap("为门店设置管理员失败");
        }
    }

    @Override
    public MerchantDTO getMerchantByTenantId(Long tenantId)
    {
        MerchantDTO merchantDTO = redisUtils.query("pay:MerchantDTO:getMerchantByTenantId:",
                "pay:MerchantDTO:getMerchantByTenantId:lock:",
                tenantId, MerchantDTO.class, new Function<Long, MerchantDTO>()
                {
                    @Override
                    public MerchantDTO apply(Long aLong)
                    {
                        //查询
                        Merchant merchant = getOne(Wraps.<Merchant>lbQ().eq(Merchant::getTenantId, tenantId));
                        //转换
                        MerchantDTO merchantDTO = dozerUtils.map(merchant, MerchantDTO.class);
                        //返回
                        return merchantDTO;
                    }
                }, 180L, TimeUnit.MINUTES, 120);
        //返回
        return merchantDTO;
    }
}
```







#### MerchantController

```java
package mao.aggregate_pay_merchant_service.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StaffDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.aggregate_pay_merchant_service.service.MerchantService;
import mao.tools_core.base.BaseController;
import mao.tools_core.base.R;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_service.controller
 * Class(类名): MerchantController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/9
 * Time(创建时间)： 15:53
 * Version(版本): 1.0
 * Description(描述)： 商户Controller
 */

@RestController
@Api(tags = "商户")
@RequestMapping("/merchant")
public class MerchantController extends BaseController
{

    @Resource
    private MerchantService merchantService;

    /**
     * 根据商户id查询商户信息
     *
     * @param merchantId 商人id
     * @return {@link R}<{@link MerchantDTO}>
     */
    @ApiOperation("根据商户id查询商户信息")
    @GetMapping("/{merchantId}")
    public R<MerchantDTO> getById(@PathVariable Long merchantId)
    {
        return R.success(merchantService.getMerchantById(merchantId));
    }


    /**
     * 注册商户
     *
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link MerchantDTO}>
     */
    @ApiOperation("注册商户")
    @PostMapping
    public R<MerchantDTO> createMerchant(@RequestBody MerchantDTO merchantDTO)
    {
        return R.success(merchantService.createMerchant(merchantDTO));
    }


    /**
     * 商户资质申请
     *
     * @param merchantId  商人id
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link Boolean}>
     */
    @ApiOperation("商户资质申请")
    @PostMapping("/{merchantId}")
    public R<Boolean> applyMerchant(@PathVariable Long merchantId, @RequestBody MerchantDTO merchantDTO)
    {
        merchantService.applyMerchant(merchantId, merchantDTO);
        return R.success();
    }


    /**
     * 商户下新增门店
     *
     * @param storeDTO 商店dto
     * @return {@link R}<{@link StoreDTO}>
     */
    @ApiOperation("商户资质申请")
    @PostMapping("/createStore")
    public R<StoreDTO> createStore(@RequestBody StoreDTO storeDTO)
    {
        return success(merchantService.createStore(storeDTO));
    }


    /**
     * 商户新增员工
     *
     * @param staffDTO 员工dto
     * @return {@link R}<{@link StaffDTO}>
     */
    @ApiOperation("商户新增员工")
    @PostMapping("/createStaff")
    public R<StaffDTO> createStaff(@RequestBody StaffDTO staffDTO)
    {
        return success(merchantService.createStaff(staffDTO));
    }


    /**
     * 为门店设置管理员
     *
     * @param storeId 门店id
     * @param staffId 员工id
     * @return {@link R}<{@link Boolean}>
     */
    @ApiOperation("为门店设置管理员")
    @PostMapping("/bindStaffToStore/{storeId}/{staffId}")
    R<Boolean> bindStaffToStore(@PathVariable Long storeId, @PathVariable Long staffId)
    {
        merchantService.bindStaffToStore(storeId, staffId);
        return success();
    }


    /**
     * 根据租户id查询商户信息
     *
     * @param tenantId 租户id
     * @return {@link R}<{@link MerchantDTO}>
     */
    @ApiOperation("根据租户id查询商户信息")
    @GetMapping("/tenantId/{tenantId}")
    public R<MerchantDTO> getMerchantByTenantId(@PathVariable Long tenantId)
    {
        MerchantDTO merchantDTO = merchantService.getMerchantByTenantId(tenantId);
        return success(merchantDTO);
    }
}
```





#### feign接口

```java
package mao.aggregate_pay_merchant_api.feign;

import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.dto.StaffDTO;
import mao.aggregate_pay_merchant_api.dto.StoreDTO;
import mao.tools_core.base.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_api.feign
 * Interface(接口名): MerchantFeignClient
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 21:26
 * Version(版本): 1.0
 * Description(描述)： 商户服务feign接口
 */

@FeignClient(value = "aggregate-pay-merchant-service", path = "/merchant")
public interface MerchantFeignClient
{
    /**
     * 根据商户id查询商户信息
     *
     * @param merchantId 商人id
     * @return {@link R}<{@link MerchantDTO}>
     */
    @GetMapping("/{merchantId}")
    R<MerchantDTO> getById(@PathVariable Long merchantId);

    /**
     * 创建商户
     *
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link MerchantDTO}>
     */
    @PostMapping
    R<MerchantDTO> createMerchant(@RequestBody MerchantDTO merchantDTO);

    /**
     * 商户资质申请
     *
     * @param merchantId  商人id
     * @param merchantDTO 商人dto
     * @return {@link R}<{@link Boolean}>
     */
    @PostMapping("/{merchantId}")
    R<Boolean> applyMerchant(@PathVariable Long merchantId, @RequestBody MerchantDTO merchantDTO);

    /**
     * 商户下新增门店
     *
     * @param storeDTO 商店dto
     * @return {@link StoreDTO}
     */
    @PostMapping("/createStore")
    R<StoreDTO> createStore(@RequestBody StoreDTO storeDTO);


    /**
     * 商户新增员工
     *
     * @param staffDTO 员工dto
     * @return {@link StaffDTO}
     */
    @PostMapping("/createStaff")
    R<StaffDTO> createStaff(@RequestBody StaffDTO staffDTO);


    /**
     * 为门店设置管理员
     *
     * @param storeId 门店id
     * @param staffId 员工id
     */
    @PostMapping("/bindStaffToStore/{storeId}/{staffId}")
    R<Boolean> bindStaffToStore(@PathVariable Long storeId, @PathVariable Long staffId);


    /**
     * 根据租户id查询商户信息
     *
     * @param tenantId 租户id
     * @return {@link R}<{@link MerchantDTO}>
     */
    @GetMapping("/tenantId/{tenantId}")
    R<MerchantDTO> getMerchantByTenantId(@PathVariable Long tenantId);
}
```





### 服务端解析Token

#### LoginUser

在aggregate-pay-entity模块添加实体类LoginUser

```java
package mao.aggregate_pay_entity.entity;

import lombok.Data;

import java.util.HashMap;
import java.util.Map;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_entity.entity
 * Class(类名): LoginUser
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/23
 * Time(创建时间)： 22:09
 * Version(版本): 1.0
 * Description(描述)： 登录的用户
 */

@Data
public class LoginUser
{
    /**
     * 手机号
     */
    private String mobile;

    /**
     * 有效载荷
     */
    private Map<String, Object> payload = new HashMap<>();

    /**
     * 客户端id
     */
    private String clientId;

    /**
     * 用户名
     */
    private String username;

    /**
     * 租户id
     */
    private Long tenantId;
}
```





#### ApplicationContextHelper

商户平台应用添加ApplicationContextHelper类，用于获取bean

```java
package mao.aggregate_pay_merchant_application.utils;

import org.springframework.beans.BeansException;
import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationContextAware;

import org.springframework.stereotype.Component;

import javax.validation.constraints.NotNull;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.utils
 * Class(类名): ApplicationContextHelper
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/23
 * Time(创建时间)： 22:17
 * Version(版本): 1.0
 * Description(描述)： 无
 */

@Component
public class ApplicationContextHelper implements ApplicationContextAware
{
    private static ApplicationContext applicationContext;

    public ApplicationContextHelper()
    {

    }

    /**
     * 设置应用程序上下文
     *
     * @param applicationContext 应用程序上下文
     * @throws BeansException 豆子例外
     */
    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException
    {
        ApplicationContextHelper.applicationContext = applicationContext;
    }

    /**
     * getBean
     *
     * @param beanName bean名字
     * @return {@link Object}
     */
    public static Object getBean(String beanName)
    {
        return applicationContext != null ? applicationContext.getBean(beanName) : null;
    }

    /**
     * getBean
     *
     * @param c Class字节码
     * @return {@link T}
     */
    public static <T> T getBean(Class<T> c)
    {
        return applicationContext != null ? applicationContext.getBean(c) : null;
    }
}
```





#### SecurityUtil

商户平台应用添加SecurityUtil类，用于获取商户信息

```java
package mao.aggregate_pay_merchant_application.utils;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_common.utils.EncryptUtil;
import mao.aggregate_pay_entity.entity.LoginUser;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.feign.MerchantFeignClient;
import mao.aggregate_pay_merchant_application.handler.AssertResult;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import org.apache.commons.lang3.StringUtils;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.http.HttpServletRequest;
import java.util.Map;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.utils
 * Class(类名): SecurityUtil
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/23
 * Time(创建时间)： 22:12
 * Version(版本): 1.0
 * Description(描述)： 无
 */

@Slf4j
public class SecurityUtil
{
    /**
     * 获取用户
     *
     * @return {@link LoginUser}
     */
    public static LoginUser getUser()
    {
        ServletRequestAttributes servletRequestAttributes = (ServletRequestAttributes) RequestContextHolder
                .getRequestAttributes();

        if (servletRequestAttributes != null)
        {
            HttpServletRequest request = servletRequestAttributes.getRequest();

            Object jwt = request.getAttribute("jsonToken");
            if (jwt instanceof LoginUser)
            {
                return (LoginUser) jwt;
            }
        }
        return new LoginUser();
    }


    /**
     * 根据TenantId查询商户
     *
     * @param tenantId tenantId
     * @return {@link MerchantDTO}
     */
    private static MerchantDTO queryMerchantDtoByTenantId(Long tenantId)
    {
        StringRedisTemplate stringRedisTemplate = ApplicationContextHelper.getBean(StringRedisTemplate.class);
        //redisKey
        String redisKey = "pay:MerchantDTO:getMerchantByTenantId:" + tenantId;
        //从分布式缓存里取数据
        String json = stringRedisTemplate.opsForValue().get(redisKey);
        log.debug("从分布式缓存里取商户数据：" + json);
        //如果为空
        if (StringUtils.isBlank(json))
        {
            //缓存里不存在
            //发起远程调用查询
            MerchantFeignClient merchantFeignClient = ApplicationContextHelper.getBean(MerchantFeignClient.class);
            log.debug("租户id：" + tenantId);
            R<MerchantDTO> r = merchantFeignClient.getMerchantByTenantId(tenantId);
            //断言结果
            AssertResult.handler(r);
            //取数据
            MerchantDTO merchant = r.getData();
            //返回
            return merchant;
        }
        //不为空，转换成对象
        MerchantDTO merchantDTO = JSON.parseObject(json, MerchantDTO.class);
        //返回
        return merchantDTO;
    }


    /**
     * 取得商户id
     *
     * @return {@link Long}
     */
    public static Long getMerchantId()
    {
        //查询
        MerchantDTO merchant = queryMerchantDtoByTenantId(getUser().getTenantId());
        Long merchantId = null;
        if (merchant != null)
        {
            //查询到了，返回
            merchantId = merchant.getId();
        }
        //查询不到，返回空
        return merchantId;
    }

    /**
     * 取得商户id，如果查询结果为空，抛出异常
     *
     * @return {@link Long}
     */
    public static Long getMerchantIdThrowsException()
    {
        //查询
        MerchantDTO merchant = queryMerchantDtoByTenantId(getUser().getTenantId());
        Long merchantId = null;
        if (merchant != null)
        {
            //查询到了，返回
            merchantId = merchant.getId();
            return merchantId;
        }
        //查询不到，抛出异常
        throw BizException.wrap("查询不到当前登录的商户信息");
    }


    /**
     * 取得当前登录的MerchantDTO
     *
     * @return {@link MerchantDTO}
     */
    public static MerchantDTO getMerchant()
    {
        //查询
        MerchantDTO merchant = queryMerchantDtoByTenantId(getUser().getTenantId());
        if (merchant != null)
        {
            //查询到了，返回
            return merchant;
        }
        //查询不到，返回空
        return null;
    }


    /**
     * 取得当前登录的MerchantDTO
     *
     * @return {@link MerchantDTO}
     */
    public static MerchantDTO getMerchantThrowsException()
    {
        //查询
        MerchantDTO merchant = queryMerchantDtoByTenantId(getUser().getTenantId());
        if (merchant != null)
        {
            //查询到了，返回
            return merchant;
        }
        //查询不到，抛出异常
        throw BizException.wrap("查询不到当前登录的商户信息");
    }

    /**
     * 转换明文jsonToken为用户对象
     *
     * @param token 令牌
     * @return {@link LoginUser}
     */
    public static LoginUser convertTokenToLoginUser(String token)
    {
        token = EncryptUtil.decodeUTF8StringBase64(token);
        LoginUser user = new LoginUser();
        JSONObject jsonObject = JSON.parseObject(token);
        String payload = jsonObject.getString("payload");
        Map<String, Object> payloadMap = JSON.parseObject(payload, Map.class);
        user.setPayload(payloadMap);
        user.setClientId(jsonObject.getString("client_id"));
        user.setMobile(jsonObject.getString("mobile"));
        user.setUsername(jsonObject.getString("user_name"));
        return user;
    }
}

```







#### TokenAuthenticationFilter

在商户平台应用中添加token解析过滤器，用于解析网关发过来的jsonToken

```java
package mao.aggregate_pay_merchant_application.filter;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_common.utils.EncryptUtil;
import mao.aggregate_pay_common.utils.StringUtil;
import mao.aggregate_pay_entity.entity.LoginUser;
import mao.aggregate_pay_merchant_application.utils.SecurityUtil;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.filter
 * Class(类名): TokenAuthenticationFilter
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/23
 * Time(创建时间)： 22:28
 * Version(版本): 1.0
 * Description(描述)： token解析过滤器
 */

@Slf4j
@Component
public class TokenAuthenticationFilter extends OncePerRequestFilter
{

    @Override
    protected void doFilterInternal(HttpServletRequest httpServletRequest,
                                    HttpServletResponse httpServletResponse,
                                    FilterChain filterChain)
            throws ServletException, IOException
    {

        // 0.放行静态资源
        String requestURL = httpServletRequest.getRequestURL().toString();
        log.debug("请求的URL:{}", requestURL);
        String[] urls = {".js", ".css", ".ico", ".jpg", ".png", ".gif"};//不需要过滤的资源
        if (StringUtil.isContains(urls, requestURL)
                || requestURL.contains("/v2/api-docs")
                || requestURL.contains("/swagger-resources")
                || requestURL.contains("/swagger-ui.html")
                || requestURL.contains("/druid")
                || requestURL.contains("/doc.html")
                || requestURL.contains("/merchants/register")
                || requestURL.contains("/sms")
                || requestURL.contains("/my/tenants-merchants"))
        {

            log.debug("资源放行：" + requestURL);
            filterChain.doFilter(httpServletRequest, httpServletResponse);
            return;
        }

        // 1.校验json token
        //网关给后端微服务传的token令牌
        String jsonToken = httpServletRequest.getHeader("jsonToken");
        log.debug("jsonToken:{}", jsonToken);

        if (StringUtils.isBlank(jsonToken))
        {
            //throw new BusinessException(CommonErrorCode.E_999911);
            responseMessage(999911, "没有token令牌", httpServletRequest, httpServletResponse);
            return;
        }

        // 2.base64解码 后判断有没有当前租户的权限信息
        String json = EncryptUtil.decodeUTF8StringBase64(jsonToken);
        log.debug("json令牌:{}", json);
        Map tokenMap = JSON.parseObject(json, Map.class);
        log.debug("tokenMap:{}", JSON.toJSONString(tokenMap));

        //需注意payload的值是字符串需要再次转map
        String payload = (String) tokenMap.get("payload");
        log.debug("有效载荷:{}", payload);
        Map payloadMap = JSON.parseObject(payload, Map.class);
        log.debug("payloadMap:{}", JSON.toJSONString(payloadMap));

        //增加将当前登入用户信息放入requestAttribute
        LoginUser loginUser = SecurityUtil.convertTokenToLoginUser(jsonToken);
        //tenantId
        String tenantId = httpServletRequest.getHeader("tenantId");
        if (StringUtils.isNotBlank(tenantId))
        {
            //不为空，设置商户id到loginUser中
            loginUser.setTenantId(Long.parseLong(tenantId));
        }
        //将数据设置到Attribute
        httpServletRequest.setAttribute("jsonToken", loginUser);

        //获取当前租户的权限信息
        Map tenantMap = (Map) payloadMap.get(tenantId);
        log.debug("tenantMap:{}", JSON.toJSONString(tenantMap));
        if (tenantMap == null)
        {
            log.error("json-token中没有当前租户 {} 的信息", tenantId);
            //throw new BusinessException(CommonErrorCode.E_999913);
            responseMessage(999913, "json-token令牌有误-没有当前租户信息", httpServletRequest, httpServletResponse);
            return;
        }


        //取对应的 user_authorities信息 将权限放到几个arraylist集合中  不需要角色
        Map<String, JSONArray> userAuthMap = (Map<String, JSONArray>) tenantMap.get("user_authorities");
        log.debug("userAuthMap:{}", JSON.toJSONString(userAuthMap));
        if (userAuthMap == null)
        {
            log.error("json-token中该租户 {} 下没有权限信息", tenantId);
            //throw new BusinessException(CommonErrorCode.E_999914);
            responseMessage(999914, "json-token令牌有误-该租户下没有权限信息", httpServletRequest, httpServletResponse);
            return;
        }

        List<String> rolePrivileges = new ArrayList<>();
        for (Map.Entry<String, JSONArray> entry : userAuthMap.entrySet())
        {
            //String roleName = entry.getKey();
            List<String> privileges = JSONObject.parseArray(JSON.toJSONString(entry.getValue()), String.class);
            //rolePrivileges.add(roleName);
            rolePrivileges.addAll(privileges);
        }
        log.debug("该租户 {} 拥有的权限最终个数{},分别是{}", tenantId, rolePrivileges.size(), rolePrivileges);
        filterChain.doFilter(httpServletRequest, httpServletResponse);

    }


    public void responseMessage(int code, String desc, HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse)
            throws IOException
    {
        // 由于全局异常处理器无法捕获filter中的异常信息 利用此map将异常信息直接响应到前端
        Map<String, Object> exceptionMap = new HashMap<>();
        exceptionMap.put("code", code);
        exceptionMap.put("desc", desc);
        httpServletResponse.setCharacterEncoding("UTF-8");
        httpServletResponse.setContentType("application/json;charset=UTF-8");
        httpServletResponse.getWriter().print(JSONObject.toJSON(exceptionMap));

    }
}
```







### 商户平台应用获取登录商户信息

商户登录成功，前端获取当前商户的信息

在MerchantController中定义getMyMerchantInfo接口：

```java
/**
 * 获取登录用户的商户信息
 *
 * @return {@link MerchantDTO}
 */
@ApiOperation("获取登录用户的商户信息")
@GetMapping(value = "/my/merchants")
public MerchantDTO getMyMerchantInfo()
{
    return SecurityUtil.getMerchant();
}
```









### 修改以前把商户id写死的代码

#### AppController

```java
package mao.aggregate_pay_merchant_application.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiImplicitParams;
import io.swagger.annotations.ApiOperation;
import mao.aggregate_pay_merchant_api.dto.AppDTO;
import mao.aggregate_pay_merchant_api.feign.AppFeignClient;
import mao.aggregate_pay_merchant_application.handler.AssertResult;
import mao.aggregate_pay_merchant_application.utils.SecurityUtil;
import mao.aggregate_pay_transaction_api.feign.PlatformChannelFeignClient;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import mao.tools_log.annotation.SysLog;
import org.apache.commons.lang3.StringUtils;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.controller
 * Class(类名): AppController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/12
 * Time(创建时间)： 20:10
 * Version(版本): 1.0
 * Description(描述)： 应用管理
 */

@RestController
@Api(tags = "商户平台‐应用管理")
public class AppController
{
    @Resource
    private AppFeignClient appFeignClient;

    @Resource
    private PlatformChannelFeignClient platformChannelFeignClient;

    /**
     * 创建应用
     *
     * @param app {@link AppDTO}
     * @return {@link AppDTO}
     */
    @SysLog(value = "商户创建应用",recordResponseParam = false)
    @ApiOperation("商户创建应用")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "app", value = "应用信息", required = true, dataType = "AppDTO", paramType = "body")
            })
    @PostMapping(value = "/my/apps")
    public AppDTO createApp(@RequestBody AppDTO app)
    {
        //校验
        if (StringUtils.isBlank(app.getAppName()))
        {
            throw BizException.wrap("应用名称为空");
        }
        if (StringUtils.isBlank(app.getPublicKey()))
        {
            throw BizException.wrap("无法获取到公钥");
        }
        //不能使用前端传过来的商户id
        //Long merchantId = 124619633188667425L;
        Long merchantId = SecurityUtil.getMerchantId();

        //远程调用
        R<AppDTO> r = appFeignClient.createApp(merchantId, app);
        //断言
        AssertResult.handler(r);
        //返回
        return r.getData();
    }


    /**
     * 查询商户下的应用列表
     *
     * @return {@link List}<{@link AppDTO}>
     */
    @ApiOperation("查询商户下的应用列表")
    @GetMapping(value = "/my/apps")
    public List<AppDTO> queryMyApps()
    {
        //商户id
        //Long merchantId = 124619633188667425L;
        Long merchantId = SecurityUtil.getMerchantId();
        //远程调用
        R<List<AppDTO>> r = appFeignClient.queryAppByMerchantId(merchantId);
        //断言
        AssertResult.handler(r);
        //返回
        return r.getData();
    }

    /**
     * 根据应用id查询应用信息
     *
     * @param appId 应用id
     * @return {@link AppDTO}
     */
    @ApiOperation("根据应用id查询应用信息")
    @ApiImplicitParam(value = "应用id", name = "appId", dataType = "String", paramType = "path")
    @GetMapping(value = "/my/apps/{appId}")
    public AppDTO getApp(@PathVariable("appId") String appId)
    {
        //查询
        R<AppDTO> r = appFeignClient.getAppById(appId);
        //断言
        AssertResult.handler(r);
        //返回
        return r.getData();
    }

    /**
     * 绑定服务类型
     *
     * @param appId                应用程序id
     * @param platformChannelCodes 平台通道编码
     */
    @SysLog(value = "绑定服务类型", recordResponseParam = false)
    @ApiOperation("绑定服务类型")
    @PostMapping(value = "/my/apps/{appId}/platform‐channels")
    @ApiImplicitParams({
            @ApiImplicitParam(value = "应用id", name = "appId", dataType = "string", paramType =
                    "path"),
            @ApiImplicitParam(value = "服务类型code", name = "platformChannelCodes", dataType =
                    "string", paramType = "query")
    })
    public void bindPlatformForApp(@PathVariable("appId") String appId,
                                   @RequestParam("platformChannelCodes") String platformChannelCodes)
    {
        if (StringUtils.isBlank(appId))
        {
            throw BizException.wrap("appID为空");
        }
        if (StringUtils.isBlank(platformChannelCodes))
        {
            throw BizException.wrap("platformChannelCodes为空");
        }
        //查询appid是否存在
        R<AppDTO> appById = appFeignClient.getAppById(appId);
        //断言结果
        AssertResult.handler(appById);
        //如果不存在
        if (appById.getData() == null)
        {
            throw BizException.wrap("appId不存在");
        }
        //远程调用
        R<Boolean> r = platformChannelFeignClient.bindPlatformChannelForApp(appId, platformChannelCodes);
        //断言结果
        AssertResult.handler(r);

    }


    /**
     * 查询应用是否绑定了某个服务类型
     *
     * @param appId           应用程序id
     * @param platformChannel 平台通道
     * @return 1为绑定了，0为没有绑定
     */
    @ApiOperation("查询应用是否绑定了某个服务类型")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "appId", value = "应用appId", required = true, dataType =
                            "String", paramType = "query"),
                    @ApiImplicitParam(name = "platformChannel", value = "服务类型", required = true, dataType =
                            "String", paramType = "query")
            })
    @GetMapping("/my/merchants/apps/platformchannels")
    public int queryAppBindPlatformChannel(@RequestParam String appId, @RequestParam String
            platformChannel)
    {
        //远程调用
        R<Boolean> r = platformChannelFeignClient.queryAppBindPlatformChannel(appId, platformChannel);
        //断言结果
        AssertResult.handler(r);
        //返回
        if (!r.getData())
        {
            return 0;
        }
        return 1;
    }

}

```





#### MerchantController

```java
package mao.aggregate_pay_merchant_application.controller;

import io.swagger.annotations.*;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_common.domain.BusinessException;
import mao.aggregate_pay_common.domain.CommonErrorCode;
import mao.aggregate_pay_common.utils.PhoneUtil;
import mao.aggregate_pay_common.utils.RandomUuidUtil;
import mao.aggregate_pay_merchant_api.dto.MerchantDTO;
import mao.aggregate_pay_merchant_api.feign.MerchantFeignClient;
import mao.aggregate_pay_merchant_application.feign.sms.VerificationFeignClient;
import mao.aggregate_pay_merchant_application.handler.AssertResult;
import mao.aggregate_pay_merchant_application.service.FileService;
import mao.aggregate_pay_merchant_application.service.SmsService;
import mao.aggregate_pay_merchant_application.utils.SecurityUtil;
import mao.aggregate_pay_merchant_application.vo.MerchantDetailVO;
import mao.aggregate_pay_merchant_application.vo.MerchantRegisterVO;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import mao.tools_log.annotation.SysLog;
import mao.toolsdozer.utils.DozerUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import javax.annotation.Resource;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.controller
 * Class(类名): MerchantController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/10
 * Time(创建时间)： 21:49
 * Version(版本): 1.0
 * Description(描述)： 商户
 */

@Slf4j
@RestController
@Api(tags = "商户平台应用接口")
public class MerchantController
{

    @Resource
    private VerificationFeignClient verificationFeignClient;

    @Resource
    private SmsService smsService;

    @Resource
    private MerchantFeignClient merchantFeignClient;

    @Resource
    private FileService fileService;

    @Resource
    private DozerUtils dozerUtils;

    /**
     * 发送验证码
     *
     * @param phone 电话
     * @return {@link String} 验证码的key
     */
    @ApiOperation("获取手机验证码")
    @GetMapping("/sms")
    @ApiImplicitParam(value = "手机号", name = "phone", required = true, dataType = "string", paramType = "query")
    public String getSMSCode(@RequestParam("phone") String phone)
    {
        //判断非空
        if (StringUtils.isBlank(phone))
        {
            throw new BusinessException(CommonErrorCode.E_100112);
        }
        //校验手机号的合法性
        if (!PhoneUtil.isMatches(phone))
        {
            throw new BusinessException(CommonErrorCode.E_100109);
        }
        log.info("向手机号:{}发送验证码", phone);
        //向验证码服务请求发送验证码
        Map<String, Object> map = new HashMap<>();
        map.put("mobile", phone);
        return verificationFeignClient.generateVerificationInfo("sms", map, 20 * 60).getResult().getKey();
    }

    /**
     * 注册商户
     *
     * @param merchantRegisterVO MerchantRegisterVO
     * @return {@link MerchantRegisterVO}
     */
    //@SysLog(value = "商户注册", recordResponseParam = false)
    @PostMapping("/merchants/register")
    @ApiOperation("商户注册")
    @ApiImplicitParam(value = "商户注册信息", name = "merchantRegisterVO", required = true, dataType = "MerchantRegisterVO", paramType = "body")
    public MerchantRegisterVO registerMerchant(@RequestBody MerchantRegisterVO merchantRegisterVO)
    {

        if (merchantRegisterVO.getVerifiykey() == null || merchantRegisterVO.getVerifiykey().equals(""))
        {
            throw BizException.wrap("验证码的key为空");
        }
        if (merchantRegisterVO.getVerifiyCode() == null || merchantRegisterVO.getVerifiyCode().equals(""))
        {
            throw BizException.wrap("请输入验证码");
        }
        smsService.checkVerifyCode(merchantRegisterVO.getVerifiykey(), merchantRegisterVO.getVerifiyCode());

        //注册商户
        MerchantDTO merchantDTO = new MerchantDTO();
        merchantDTO.setUsername(merchantRegisterVO.getUsername());
        merchantDTO.setMobile(merchantRegisterVO.getMobile());
        merchantDTO.setPassword(merchantRegisterVO.getPassword());

        if (StringUtils.isBlank(merchantDTO.getMobile()))
        {
            throw new BusinessException(CommonErrorCode.E_100112);
        }
        //校验手机号的合法性
        if (!PhoneUtil.isMatches(merchantDTO.getMobile()))
        {
            throw new BusinessException(CommonErrorCode.E_100109);
        }
        //联系人非空校验
        if (StringUtils.isBlank(merchantDTO.getUsername()))
        {
            throw new BusinessException(CommonErrorCode.E_100110);
        }
        //密码非空校验
        if (StringUtils.isBlank(merchantDTO.getPassword()))
        {
            throw new BusinessException(CommonErrorCode.E_100111);
        }

        //远程调用
        R<MerchantDTO> result = merchantFeignClient.createMerchant(merchantDTO);
        //断言结果
        AssertResult.handler(result);
        //返回
        return merchantRegisterVO;

    }

    /**
     * 上传证件照
     *
     * @param multipartFile 多部分文件
     * @return {@link String}
     * @throws IOException io异常
     */
    @ApiOperation("上传证件照")
    @PostMapping("/upload")
    @SysLog(value = "上传证件照", recordResponseParam = false)
    public String upload(@ApiParam(value = "证件照", required = true) @RequestParam("file") MultipartFile multipartFile)
            throws IOException
    {
        //调用fileService上传文件
        //生成的文件名称fileName，要保证它的唯一
        //文件原始名称
        String originalFilename = multipartFile.getOriginalFilename();
        //文件名称
        String fileName = RandomUuidUtil.getUUID() + "_" + originalFilename;
        //byte[] bytes,String fileName
        return fileService.upload(multipartFile.getBytes(), fileName);
    }


    /**
     * 商户资质申请
     *
     * @param merchantDetailVO MerchantDetailVO
     */
    @ApiOperation("商户资质申请")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "merchantDetailVO", value = "商户认证资料", required = true,
                            dataType = "MerchantDetailVO", paramType = "body")
            })
    @SysLog(value = "商户资质申请", recordResponseParam = false)
    @PostMapping("/my/merchants/save")
    public void saveMerchant(@RequestBody MerchantDetailVO merchantDetailVO)
    {
        //Long merchantId = 124619633188667425L;
        Long merchantId = SecurityUtil.getMerchantId();
        //转换
        MerchantDTO merchantDTO = dozerUtils.map(merchantDetailVO, MerchantDTO.class);
        //发起远程调用
        R<Boolean> result = merchantFeignClient.applyMerchant(merchantId, merchantDTO);
        //断言结果
        AssertResult.handler(result);
    }


    /**
     * 获取登录用户的商户信息
     *
     * @return {@link MerchantDTO}
     */
    @ApiOperation("获取登录用户的商户信息")
    @GetMapping(value = "/my/merchants")
    public MerchantDTO getMyMerchantInfo()
    {
        return SecurityUtil.getMerchant();
    }

}
```







#### PlatformParamController

```java
package mao.aggregate_pay_merchant_application.controller;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiImplicitParams;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_merchant_application.handler.AssertResult;
import mao.aggregate_pay_merchant_application.utils.SecurityUtil;
import mao.aggregate_pay_transaction_api.dto.PayChannelDTO;
import mao.aggregate_pay_transaction_api.dto.PayChannelParamDTO;
import mao.aggregate_pay_transaction_api.dto.PlatformChannelDTO;
import mao.aggregate_pay_transaction_api.feign.PayChannelFeignClient;
import mao.aggregate_pay_transaction_api.feign.PayChannelParamFeignClient;
import mao.aggregate_pay_transaction_api.feign.PlatformChannelFeignClient;
import mao.tools_core.base.R;
import mao.tools_core.exception.BizException;
import mao.tools_log.annotation.SysLog;
import org.apache.commons.lang3.StringUtils;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.List;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.controller
 * Class(类名): PlatformParamController
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 23:21
 * Version(版本): 1.0
 * Description(描述)： 商户平台‐渠道和支付参数
 */

@Slf4j
@RestController
@Api(value = "商户平台‐渠道和支付参数相关", tags = "商户平台‐渠道和支付参数")
public class PlatformParamController
{
    @Resource
    private PlatformChannelFeignClient platformChannelFeignClient;

    @Resource
    private PayChannelFeignClient payChannelFeignClient;

    @Resource
    private PayChannelParamFeignClient payChannelParamFeignClient;


    /**
     * 获取平台所有服务类型
     *
     * @return {@link List}<{@link PlatformChannelDTO}>
     */
    @ApiOperation("获取平台服务类型")
    @GetMapping(value = "/my/platform‐channels")
    public List<PlatformChannelDTO> queryPlatformChannel()
    {
        //远程调用
        R<List<PlatformChannelDTO>> r = platformChannelFeignClient.queryAll();
        //断言结果
        AssertResult.handler(r);
        //返回
        return r.getData();
    }

    /**
     * 根据平台服务类型获取支付渠道列表
     *
     * @param platformChannelCode 服务类型编码
     * @return {@link List}<{@link PayChannelDTO}>
     */
    @ApiOperation("根据平台服务类型获取支付渠道列表")
    @ApiImplicitParams(
            {
                    @ApiImplicitParam(name = "platformChannelCode", value = "服务类型编码", required =
                            true, dataType = "String", paramType = "path")
            })
    @GetMapping(value = "/my/pay‐channels/platform‐channel/{platformChannelCode}")
    public List<PayChannelDTO> queryPayChannelByPlatformChannel(@PathVariable String platformChannelCode)
    {
        //远程调用
        R<List<PayChannelDTO>> r = payChannelFeignClient.queryPayChannelByPlatformChannel(platformChannelCode);
        //断言
        AssertResult.handler(r);
        //返回
        return r.getData();
    }


    /**
     * 商户配置支付渠道参数
     *
     * @param payChannelParam 支付通道参数
     */
    @SysLog(value = "商户配置支付渠道参数", recordResponseParam = false)
    @ApiOperation("商户配置支付渠道参数")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "payChannelParam", value = "商户配置支付渠道参数", required =
                            true, dataType = "PayChannelParamDTO", paramType = "body")
            })
    @RequestMapping(value = "/my/pay‐channel‐params", method = {RequestMethod.POST, RequestMethod.PUT})
    public void createPayChannelParam(@RequestBody PayChannelParamDTO payChannelParam)
    {
        //设置商户id，商户id不能从请求里拿
        //Long merchantId = 12243556L;
        Long merchantId = SecurityUtil.getMerchantId();
        payChannelParam.setMerchantId(merchantId);
        //校验
        if (StringUtils.isBlank(payChannelParam.getAppId()) ||
                StringUtils.isBlank(payChannelParam.getPlatformChannelCode()) ||
                StringUtils.isBlank(payChannelParam.getPayChannel()))
        {
            throw new BizException("传入对象为空或者缺少必要的参数");
        }
        //远程调用
        R<Boolean> r = payChannelParamFeignClient.savePayChannelParam(payChannelParam);
        //断言结果
        AssertResult.handler(r);
    }


    /**
     * 获取指定应用指定服务类型下所包含的原始支付渠道参数列表
     *
     * @param appId           应用id
     * @param platformChannel 平台支付渠道编码
     * @return {@link List}<{@link PayChannelParamDTO}>
     */
    @ApiOperation("获取指定应用指定服务类型下所包含的原始支付渠道参数列表")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "appId", value = "应用id", required = true,
                            dataType = "String", paramType = "path"),
                    @ApiImplicitParam(name = "platformChannel", value = "服务类型",
                            required = true, dataType = "String", paramType = "path")})
    @GetMapping(value = "/my/pay‐channel‐params/apps/{appId}/platform‐ channels/{platformChannel}")
    public List<PayChannelParamDTO> queryPayChannelParam(@PathVariable String appId,
                                                         @PathVariable String platformChannel)
    {
        //查询
        R<List<PayChannelParamDTO>> r = payChannelParamFeignClient.queryPayChannelParamByAppAndPlatform(appId, platformChannel);
        //断言结果
        AssertResult.handler(r);
        //返回
        return r.getData();
    }


    /**
     * 获取指定应用指定服务类型下所包含的某个原始支付参数
     *
     * @param appId           应用id
     * @param platformChannel 平台支付渠道编码
     * @param payChannel      实际支付渠道编码
     * @return {@link PayChannelParamDTO}
     */
    @ApiOperation("获取指定应用指定服务类型下所包含的某个原始支付参数")
    @ApiImplicitParams
            ({
                    @ApiImplicitParam(name = "appId", value = "应用id",
                            required = true, dataType = "String", paramType = "path"),
                    @ApiImplicitParam(name = "platformChannel", value = "平台支付渠道编码",
                            required = true, dataType = "String", paramType = "path"),
                    @ApiImplicitParam(name = "payChannel", value = "实际支付渠道编码",
                            required = true, dataType = "String", paramType = "path")})
    @GetMapping(value = "/my/pay‐channel‐params/apps/{appId}/platform‐ channels/{platformChannel}/pay‐channels/{payChannel}")
    public PayChannelParamDTO queryPayChannelParam(@PathVariable String appId,
                                                   @PathVariable String platformChannel, @PathVariable String payChannel)
    {
        //查询
        R<PayChannelParamDTO> r = payChannelParamFeignClient.queryParamByAppPlatformAndPayChannel(appId, platformChannel, payChannel);
        //断言结果
        AssertResult.handler(r);
        //返回
        return r.getData();
    }


}
```







#### OptLogServiceImpl

```java
package mao.aggregate_pay_merchant_application.service.Impl;

import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_entity.entity.OptLog;
import mao.aggregate_pay_merchant_application.feign.log.OptLogFeignClient;
import mao.aggregate_pay_merchant_application.service.OptLogService;
import mao.aggregate_pay_merchant_application.utils.SecurityUtil;
import mao.tools_core.base.R;
import mao.tools_log.entity.OptLogDTO;
import mao.toolsdozer.utils.DozerUtils;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.service.Impl
 * Class(类名): OptLogServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 16:29
 * Version(版本): 1.0
 * Description(描述)： 操作日志服务实现类
 */

@Slf4j
@Service
public class OptLogServiceImpl implements OptLogService
{

    @Resource
    private DozerUtils dozerUtils;

    @Resource
    private OptLogFeignClient optLogFeignClient;

    @Override
    public void save(OptLogDTO optLogDTO)
    {
        //转换对象
        OptLog optLog = dozerUtils.map(optLogDTO, OptLog.class);
        //设置商户id，也就是用户
        Long merchantId = SecurityUtil.getMerchantIdThrowsException();
        optLog.setUserName(merchantId);
        //打印日志
        log.info("商户id：" + optLog.getUserName() + "  请求：" + optLog.getRequestUri() + "  描述："
                + optLog.getDescription() + "  ip：" + optLog.getRequestIp() + "  耗时：" + optLog.getConsumingTime() + "ms");
        //远程调用，保存
        R<Boolean> r = optLogFeignClient.save(optLog);
        if (r.getIsError())
        {
            //错误，只打印警告信息
            log.warn("日志保存失败！ 信息：" + r.getMsg());
        }
        //保存成功，什么都不做，抛出异常可能就是服务宕机，不在同一线程，不会影响服务
    }
}

```











### 修改操作日志入库方式

以前的是使用异步的方式将操作日志通过远程调用的方式将日志数据保存在日志服务的数据库里，现在因为租户id信息是从request里取的数据，如果不在同一线程，那么就无法取到数据，现在要把商户平台应用端日志入库方式由异步方式更改为同步方式，但是如果直接更改为同步方式，会增加单次请求的耗时，降低并发量。可以在操作日志服务里将日志数据发送到消息队列里，并不是同步远程调用，日志服务监听消息队列





#### 添加依赖

```xml
<!--RocketMQ spring boot 依赖-->
<dependency>
    <groupId>org.apache.rocketmq</groupId>
    <artifactId>rocketmq-spring-boot-starter</artifactId>
</dependency>
```



生产者和消费者都要配置



#### 添加nacos配置文件

添加nacos配置文件：rocketMQ.yml

```yaml
rocketmq:
  name-server: 127.0.0.1:9876
  producer:
    # 生产者分组
    group: pay_group
    # 发送消息超时时间，单位：毫秒。默认为 3000
    send-message-timeout: 3000
    # 消息压缩阀值，当消息体的大小超过该阀值后，进行消息压缩。默认为 4 * 1024B
    compress-message-body-threshold: 4096
    # 消息体的最大允许大小。。默认为 4 * 1024 * 1024B
    max-message-size: 4194304
    # 同步发送消息时，失败重试次数。默认为 2 次。
    retry-times-when-send-failed: 2
    # 异步发送消息时，失败重试次数。默认为 2 次。
    retry-times-when-send-async-failed: 2
    # 发送消息给 Broker 时，如果发送失败，是否重试另外一台 Broker 。默认为 false
    retry-next-server: false
    # Access Key ，可阅读 https://github.com/apache/rocketmq/blob/master/docs/cn/acl/user_guide.md 文档
    access-key:
    # Secret Key
    secret-key:
    # 是否开启消息轨迹功能。默认为 true 开启。可阅读 https://github.com/apache/rocketmq/blob/master/docs/cn/msg_trace/user_guide.md 文档
    enable-msg-trace: true
    # 自定义消息轨迹的 Topic 。默认为 RMQ_SYS_TRACE_TOPIC
    customized-trace-topic: RMQ_SYS_TRACE_TOPIC
  #consumer:
    # 配置某个消费分组，是否监听指定 Topic 。结构为 Map<消费者分组, <Topic, Boolean>> 。默认情况下，不配置表示监听。
    #listeners:
      #erbadagang-consumer-group:
        # 关闭 test-consumer-group 对 topic1 的监听消费
        #topic1: false
```





![image-20230124215929547](img/聚合支付项目实战学习笔记/image-20230124215929547.png)





#### 修改bootstrap.yml配置

```yaml
# @xxx@ 从pom.xml中取值, 所以 @xx@ 标注的值，都不能从nacos中获取
def:
  nacos:
    ip: ${NACOS_IP:@pom.nacos.ip@}
    port: ${NACOS_PORT:@pom.nacos.port@}
    namespace: ${NACOS_ID:@pom.nacos.namespace@}

spring:
  main:
    allow-bean-definition-overriding: true
  application:
    name: @project.artifactId@
  profiles:
    active: @pom.profile.name@
  cloud:
    nacos:
      config: #配置中心相关
        server-addr: ${def.nacos.ip}:${def.nacos.port}
        file-extension: yml
        namespace: ${def.nacos.namespace}
        shared-dataids: common.yml,redis.yml,mysql.yml,rocketMQ.yml
        refreshable-dataids: common.yml
        enabled: true
      discovery: #服务注册中心相关
        # 是否为临时实例
        ephemeral: false
        server-addr: ${def.nacos.ip}:${def.nacos.port}
        namespace: ${def.nacos.namespace}
        metadata: # 元数据，用于权限服务实时获取各个服务的所有接口
          management.context-path: ${server.servlet.context-path:}${spring.mvc.servlet.path:}${management.endpoints.web.base-path:}


  aop:
    proxy-target-class: true
    auto: true

# 只能配置在bootstrap.yml ，否则会生成 log.path_IS_UNDEFINED 文件夹
# window会自动在 代码所在盘 根目录下自动创建文件夹，  如： D:/data/projects/logs
logging:
  file:
    path: ./logs
    name: ${logging.file.path}/${spring.application.name}/root.log

# 用于/actuator/info
info:
  name: '@project.name@'
  description: '@project.description@'
  version: '@project.version@'
  spring-boot-version: '@spring.boot.version@'
  spring-cloud-version: '@spring.cloud.version@'
```



生产者和消费者都要配置







#### 添加SysLogListenerSync类

```java
package mao.aggregate_pay_merchant_application.event;

import mao.tools_log.entity.OptLogDTO;
import mao.tools_log.event.SysLogEvent;
import org.springframework.context.event.EventListener;
import org.springframework.core.annotation.Order;
import org.springframework.scheduling.annotation.Async;

import java.util.function.Consumer;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.event
 * Class(类名): SysLogListenerSync
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/24
 * Time(创建时间)： 20:48
 * Version(版本): 1.0
 * Description(描述)： 同步保存，因为如果使用异步保存，不在同一线程里，就无法获取到request里的数据，也就无法获取到租户id和商户id
 */

public class SysLogListenerSync
{
    private final Consumer<OptLogDTO> consumer;

    public SysLogListenerSync(Consumer<OptLogDTO> consumer)
    {
        this.consumer = consumer;
    }

    //@Async
    @Order
    @EventListener(SysLogEvent.class)
    public void saveSysLog(SysLogEvent event)
    {
        OptLogDTO optLog = (OptLogDTO) event.getSource();
        //BaseContextHandler.setDatabase(database);
        consumer.accept(optLog);
    }
}
```







#### 修改配置类OptLogConfig

```java
package mao.aggregate_pay_merchant_application.config;

import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_merchant_application.event.SysLogListenerSync;
import mao.aggregate_pay_merchant_application.service.OptLogService;
import mao.tools_log.entity.OptLogDTO;
import mao.tools_log.event.SysLogListener;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.annotation.PostConstruct;
import javax.annotation.Resource;
import java.util.function.Consumer;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.config
 * Class(类名): OptLogConfig
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 16:27
 * Version(版本): 1.0
 * Description(描述)： 操作日志配置类
 */

@Slf4j
@Configuration
public class OptLogConfig
{
    @Resource
    private OptLogService optLogService;

//    @Bean
//    public SysLogListener sysLogListener()
//    {
//        return new SysLogListener(new Consumer<OptLogDTO>()
//        {
//            @Override
//            public void accept(OptLogDTO optLogDTO)
//            {
//                optLogService.save(optLogDTO);
//            }
//        });
//    }

    @Bean
    public SysLogListenerSync sysLogListenerSync()
    {
        return new SysLogListenerSync(new Consumer<OptLogDTO>()
        {
            @Override
            public void accept(OptLogDTO optLogDTO)
            {
                optLogService.save(optLogDTO);
            }
        });
    }

    @PostConstruct
    public void init()
    {
        log.info("初始化 OptLogConfig 操作日志配置类");
    }
}
```







#### 修改操作日志服务实现类

```java
package mao.aggregate_pay_merchant_application.service.Impl;

import com.alibaba.fastjson.JSON;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_entity.entity.OptLog;
import mao.aggregate_pay_merchant_application.feign.log.OptLogFeignClient;
import mao.aggregate_pay_merchant_application.service.OptLogService;
import mao.aggregate_pay_merchant_application.utils.SecurityUtil;
import mao.tools_core.base.R;
import mao.tools_log.entity.OptLogDTO;
import mao.toolsdozer.utils.DozerUtils;
import org.apache.rocketmq.client.producer.SendCallback;
import org.apache.rocketmq.client.producer.SendResult;
import org.apache.rocketmq.spring.core.RocketMQTemplate;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_merchant_application.service.Impl
 * Class(类名): OptLogServiceImpl
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/14
 * Time(创建时间)： 16:29
 * Version(版本): 1.0
 * Description(描述)： 操作日志服务实现类
 */

@Slf4j
@Service
public class OptLogServiceImpl implements OptLogService
{

    @Resource
    private DozerUtils dozerUtils;

    @Resource
    private OptLogFeignClient optLogFeignClient;

    @Resource
    private RocketMQTemplate rocketMQTemplate;

//    @Override
//    public void save(OptLogDTO optLogDTO)
//    {
//        //转换对象
//        OptLog optLog = dozerUtils.map(optLogDTO, OptLog.class);
//        //设置商户id，也就是用户
//        Long merchantId = SecurityUtil.getMerchantIdThrowsException();
//        optLog.setUserName(merchantId);
//        //打印日志
//        log.info("商户id：" + optLog.getUserName() + "  请求：" + optLog.getRequestUri() + "  描述："
//                + optLog.getDescription() + "  ip：" + optLog.getRequestIp() + "  耗时：" + optLog.getConsumingTime() + "ms");
//        //远程调用，保存
//        R<Boolean> r = optLogFeignClient.save(optLog);
//        if (r.getIsError())
//        {
//            //错误，只打印警告信息
//            log.warn("日志保存失败！ 信息：" + r.getMsg());
//        }
//        //保存成功，什么都不做，抛出异常可能就是服务宕机，不在同一线程，不会影响服务
//    }


    /**
     * 保存到消息队列
     *
     * @param optLogDTO 操作志dto
     */
    @Override
    public void save(OptLogDTO optLogDTO)
    {
        //转换对象
        OptLog optLog = dozerUtils.map(optLogDTO, OptLog.class);
        //设置商户id，也就是用户
        Long merchantId = SecurityUtil.getMerchantIdThrowsException();
        optLog.setUserName(merchantId);
        //打印日志
        log.info("商户id：" + optLog.getUserName() + "  请求：" + optLog.getRequestUri() + "  描述："
                + optLog.getDescription() + "  ip：" + optLog.getRequestIp() + "  耗时：" + optLog.getConsumingTime() + "ms");
        log.debug("发送日志到消息队列");
        String json = JSON.toJSONString(optLog);
        //同步发送
        SendResult sendResult = rocketMQTemplate.syncSend("pay_opt_log_topic", json);
        log.debug("发送结果：" + sendResult.getSendStatus() + "   队列信息：" + sendResult.getMessageQueue());
        //异步发送
        /*rocketMQTemplate.asyncSend("pay_opt_log_topic", json, new SendCallback()
        {
            @Override
            public void onSuccess(SendResult sendResult)
            {
                log.debug("发送结果：" + sendResult.getSendStatus() + "   队列信息：" + sendResult.getMessageQueue());
            }

            @Override
            public void onException(Throwable throwable)
            {
                log.warn("操作日志发送失败：", throwable);
            }
        });*/
    }
}

```







#### 添加RocketMQOptLogCustomer类

此类位于日志服务

```java
package mao.aggregate_pay_log.consumer;

import com.alibaba.fastjson.JSON;
import lombok.extern.slf4j.Slf4j;
import mao.aggregate_pay_entity.entity.OptLog;
import mao.aggregate_pay_log.service.OptLogService;
import org.apache.rocketmq.spring.annotation.RocketMQMessageListener;
import org.apache.rocketmq.spring.core.RocketMQListener;
import org.springframework.stereotype.Component;

import javax.annotation.Resource;

/**
 * Project name(项目名称)：aggregate-pay
 * Package(包名): mao.aggregate_pay_log.consumer
 * Class(类名): RocketMQOptLogCustomer
 * Author(作者）: mao
 * Author QQ：1296193245
 * GitHub：https://github.com/maomao124/
 * Date(创建日期)： 2023/1/24
 * Time(创建时间)： 21:48
 * Version(版本): 1.0
 * Description(描述)： 操作日志，消息队列消费者
 * <p>
 * RocketMQMessageListener注解参数说明：
 * - consumerGroup：消费者订阅组，它是必需的，并且必须是唯一的
 * - topic：主题名字，生产发送的主题名
 * - consumeMode：消费模式，可选择并发或有序接收消息；默认CONCURRENTLY同时接收异步传递的消息
 * - messageModel：消息模式，默认CLUSTERING集群消费；如果希望所有订阅者都接收消息，可以设置广播BROADCASTING
 * - consumeThreadMax：消费者最大线程数，默认64
 * - consumeTimeout：消息阻塞最长时间，默认15分钟
 * - nameServer：服务器地址，默认读取配置文件地址，可以单独为消费者设置指定位置
 * - selectorExpression：消费指定的Tag标签的业务消息
 */

@Slf4j
@Component
@RocketMQMessageListener(consumerGroup = "pay_group", topic = "pay_opt_log_topic")
public class RocketMQOptLogCustomer implements RocketMQListener<String>
{
    @Resource
    private OptLogService optLogService;

    @Override
    public void onMessage(String optLogJson)
    {
        OptLog optLog = JSON.parseObject(optLogJson, OptLog.class);
        log.debug("消费者监听到一条消息  消息主题[pay_opt_log_topic]");
        optLogService.save(optLog);
    }
}

```





















## 部署前端

前端工程位于项目的frontend目录

![image-20230124141515562](img/聚合支付项目实战学习笔记/image-20230124141515562.png)





**安装：npm install**

**启动：npm run serve**





![image-20230124141632746](img/聚合支付项目实战学习笔记/image-20230124141632746.png)





![image-20230124141734179](img/聚合支付项目实战学习笔记/image-20230124141734179.png)









### 商户注册

![image-20230124160914835](img/聚合支付项目实战学习笔记/image-20230124160914835.png)





![image-20230124161025715](img/聚合支付项目实战学习笔记/image-20230124161025715.png)





![image-20230124161819848](img/聚合支付项目实战学习笔记/image-20230124161819848.png)





![image-20230124162058609](img/聚合支付项目实战学习笔记/image-20230124162058609.png)



![image-20230124164135610](img/聚合支付项目实战学习笔记/image-20230124164135610.png)









### 商户登录

![image-20230124164255261](img/聚合支付项目实战学习笔记/image-20230124164255261.png)











使用账号密码登录

![image-20230124165018780](img/聚合支付项目实战学习笔记/image-20230124165018780.png)



![image-20230124184134134](img/聚合支付项目实战学习笔记/image-20230124184134134.png)





![image-20230124165029752](img/聚合支付项目实战学习笔记/image-20230124165029752.png)















### 资质申请

登录后点击支付应用系统，进入资质申请页面

![image-20230124184200627](img/聚合支付项目实战学习笔记/image-20230124184200627.png)





填写资质申请信息，上传商户资质照片和身份证等信息



![image-20230124184238064](img/聚合支付项目实战学习笔记/image-20230124184238064.png)



![image-20230124184251923](img/聚合支付项目实战学习笔记/image-20230124184251923.png)





![image-20230124210317152](img/聚合支付项目实战学习笔记/image-20230124210317152.png)





![image-20230124210326746](img/聚合支付项目实战学习笔记/image-20230124210326746.png)





点击提交

![image-20230124210438476](img/聚合支付项目实战学习笔记/image-20230124210438476.png)





![image-20230124210456736](img/聚合支付项目实战学习笔记/image-20230124210456736.png)







![image-20230124210515926](img/聚合支付项目实战学习笔记/image-20230124210515926.png)







![image-20230124210643186](img/聚合支付项目实战学习笔记/image-20230124210643186.png)











### 创建应用

![image-20230125225200907](img/聚合支付项目实战学习笔记/image-20230125225200907.png)



点击应用管理

![image-20230125225217910](img/聚合支付项目实战学习笔记/image-20230125225217910.png)





点击创建应用，需要手动将资质申请状态更改成2

![image-20230125234048081](img/聚合支付项目实战学习笔记/image-20230125234048081.png)



![image-20230125234146551](img/聚合支付项目实战学习笔记/image-20230125234146551.png)



点击保存









### 支付渠道参数配置

应用创建成功后，会自动跳转到绑定服务类型页面

![image-20230126225143370](img/聚合支付项目实战学习笔记/image-20230126225143370.png)





点击配置

![image-20230126225202347](img/聚合支付项目实战学习笔记/image-20230126225202347.png)





点击开启服务，第二个c扫b

![image-20230126225251005](img/聚合支付项目实战学习笔记/image-20230126225251005.png)



点击配置支付聚道

![image-20230126225311138](img/聚合支付项目实战学习笔记/image-20230126225311138.png)



配置参数页面会显示对应服务类型下的原始支付渠道



点击配置参数按钮，为指定原始支付渠道配置



![image-20230126225358218](img/聚合支付项目实战学习笔记/image-20230126225358218.png)





![image-20230126225451821](img/聚合支付项目实战学习笔记/image-20230126225451821.png)





查看数据库

![image-20230126230004381](img/聚合支付项目实战学习笔记/image-20230126230004381.png)



PARAM具体字段如下：

```json
{"appId":"test123456","rsaPrivateKey":"test","notifyUrl":"testurl","returnUrl":"testurl","url":"https://openapi.alipaydev.com/gateway.do","chareset":"UTF-8","format":"json","alipayPublicKey":"test","signtype":"RSA2"}
```























# C扫B支付

## 需求分析

### 概念

C扫B，即顾客(Customer)扫描商户(Business)提供的二维码来完成支付

流程：

1. 商家出示付款二维码
2. 客户打开支付宝或微信的扫一扫，扫描二维码
3. 确认支付，完成支付





C扫B支付分为两种方式：一是固定金额支付，顾客扫描后无需输入金额直接确认支付即可；另外一种是输入金 额，顾客扫描后需自己输入待支付的金额，然后完成支付

* 固定金额支付：C扫B固定金额比较常见的就是在自动售货机购买饮料时，当你选择一个饮料后屏幕会显示一个二维码，咱们扫描 后只需确认支付即可，无需自己输入饮料的价格
* 输入金额支付：C扫B输入金额支付方式可以让买方自由输入金额，商户提前生成一个二维码，将二维码张贴在结账处，买方扫描 二维码，输入当前消费的金额，完成支付





### 业务流程

![image-20230127135637565](img/聚合支付项目实战学习笔记/image-20230127135637565.png)









## 需求列表

* 为门店生成统一的支付二维码，用户扫一下二维码即可使用微信支付也可使用支付宝完成支付
* 支付平台与微信、支付宝对接，聚合支付平台作为中介，最终的支付动作（银行交易）仍通过微信、支付宝进行
* 平台作为中介调用微信、支付宝的下单接口，完成支付

















# 支付宝接口接入

## 支付产品

### 产品列表

支付宝为普通商户提供如下支付产品：



![image-20230127140304585](img/聚合支付项目实战学习笔记/image-20230127140304585.png)



https://b.alipay.com/signing/productSetV2.htm





#### 当面付

在国内线下场景，商家可通过以下任一方式进行收款。提升商家收银效率，资金实时到账

两种场景如下：

1. 商家通过扫描线下买家支付宝钱包中的条码、二维码等方式完成支付
2. 线下买家通过使用支付宝钱包扫一扫，扫描商家的二维码等方式完成支付





#### APP支付

商家APP集成支付宝提供的支付能力，在线上轻松收款

用户在商家APP消费，自动跳转支付宝完成付款，付款后自动跳回。 轻松享受更全面、更安全的支付服务





#### 刷脸付

无需手机，刷脸支付

当不便使用手机或没有手机时，用户亦可“刷脸”完成——通过线下支付机具读取脸部完成自助结账等支付行为，快捷安全方便。 商家多一种方案，用户多一种选择，同样方便安全





#### 手机网站支付

无需开发APP，手机网站同样能轻松收款

用户在商家手机网站消费，通过浏览器自动跳转支付宝APP或支付宝网页完成付款。 轻松实现和APP支付相同的支付体验





#### 电脑网站支付

PC网站轻松收款，资金马上到账

用户在商家PC网站消费，自动跳转支付宝PC网站收银台完成付款。 交易资金直接打入商家支付宝账户，实时到账









### 线下场所接入支付

线下场所泛指商超、便利店、餐饮、医院、学校、电影院和旅游景区等具有明确经营地址的实体场所



#### 当面付条码支付

商家通过扫描线下买家支付宝钱包中的条码、二维码等方式完成支付

条码支付应用于B扫C的场景，即商户扫客户



#### 手机网站支付

买家用支付宝客户端打开H5网页，点击支付，打开支付宝客户端支付界面，完成支付

手机网站支付应用于C扫B场景，即客户扫商户



平台接入“支付宝手机网站支付”完成C扫B自由输入金额的支付，原因如下：

聚合支付对C扫B的一个需求是用户可自由输入金额，且向用户展示订单信息，存在手机网页交互，所以使用手机 网站支付可以满足需求













## 配置支付宝沙箱环境

接入手机网站支付需要具备如下条件：

* 申请前必须拥有经过实名认证的支付宝账户
* 企业或个体工商户可申请
* 需提供真实有效的营业执照，且支付宝账户名称需与营业执照主体一致
* 网站能正常访问且页面显示完整，网站需要明确经营内容且有完整的商品信息
* 网站必须通过ICP备案。如为个体工商户，网站备案主体需要与支付宝账户主体名称一致
* 如为个体工商户，则团购不开放，且古玩、珠宝等奢侈品、投资类行业无法申请本产品



https://opendocs.alipay.com/open/203





### 概念

沙箱环境是支付宝开放平台为开发者提供的与生产环境完全隔离的联调测试环境，开发者在沙箱环境中完成的接口调用不会对生产环境中的数据造成任何影响。

沙箱为开放的产品提供有限功能范围的支持，可以覆盖产品的绝大部分核心链路和对接逻辑，便于开发者快速学习/尝试/开发/调试。

沙箱环境会自动完成或忽略一些场景的业务门槛，例如：开发者无需等待产品开通，即可直接在沙箱环境调用接口，使得开发集成工作可以与业务流程并行，从而提高项目整体的交付效率。



**注意：**

* 由于沙箱环境并非 100% 与生产环境一致，接口的实际响应逻辑请以生产环境为准，沙箱环境开发调试完成后，仍然需要在生产环境进行测试验收。
* 沙箱环境拥有完全独立的数据体系，沙箱环境下返回的数据（例如用户 ID 等）在生产环境中都是不存在的，开发者不可将沙箱环境返回的数据与生产环境中的数据混淆。







### 操作指引

#### 配置沙箱应用环境

使用开发者账号登录 [开放平台控制台](https://openhome.alipay.com/platform/developerIndex.htm) > **开发工具推荐**，点击 **沙箱** 即可进入沙箱环境



https://openhome.alipay.com/platform/developerIndex.htm



进去后填写信息，验证码登录



![image-20230127142104450](img/聚合支付项目实战学习笔记/image-20230127142104450.png)





点击沙箱



![image-20230127142308027](img/聚合支付项目实战学习笔记/image-20230127142308027.png)







#### 配置接口加签方式

在沙箱进行调试前需要确保已经配置密钥/证书用于加签，支付宝提供了 **系统默认密钥** 及 **自定义密钥** 两种方式进行配置

![image-20230127142529462](img/聚合支付项目实战学习笔记/image-20230127142529462.png)



##### 系统默认密钥

开发者如需使用系统默认密钥/证书，可在 **开发信息** 中选择 **系统默认密钥**。







##### 自定义密钥

开发者如需自定义密钥/证书信息，可在 **开发信息** 中选择 **自定义密钥**。





![image-20230127143030339](img/聚合支付项目实战学习笔记/image-20230127143030339.png)







#### 配置应用网关

应用网关用于接收支付宝沙箱环境的异步通知，如创建门店的被动通知。如果需要测试消息通知接口，需要指定用于接受消息的网关。

选填，若不设置，则无法接收相应的异步通知消息。







#### 服务端代码配置

沙箱环境调试接口时，开发者需调整如下代码配置：

* **支付宝网关地址** 修改为：`https://openapi.alipaydev.com/gateway.do`
* **APPID** 切换为沙箱的 APPID
* **签名方式** 使用 RSA2
* 根据配置的密钥/证书，选择对应加签代码设置商户应用私钥和支付宝公钥。









#### 下载支付宝客户端

![image-20230127144836397](img/聚合支付项目实战学习笔记/image-20230127144836397.png)



![image-20230127144845358](img/聚合支付项目实战学习笔记/image-20230127144845358.png)



![image-20230127144900188](img/聚合支付项目实战学习笔记/image-20230127144900188.png)







#### 沙箱账号

点击沙箱账号

![image-20230127143730449](img/聚合支付项目实战学习笔记/image-20230127143730449.png)





![image-20230127192338220](img/聚合支付项目实战学习笔记/image-20230127192338220.png)



点击充值

![image-20230127192413210](img/聚合支付项目实战学习笔记/image-20230127192413210.png)

















### 登录支付宝

使用沙箱环境的买家账号登录沙箱版本的支付宝



![image-20230127193230479](img/聚合支付项目实战学习笔记/image-20230127193230479.png)





![image-20230127193420838](img/聚合支付项目实战学习笔记/image-20230127193420838.png)





密码为111111



![image-20230127193826924](img/聚合支付项目实战学习笔记/image-20230127193826924.png)















## 生成二维码技术

